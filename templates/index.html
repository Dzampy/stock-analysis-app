<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>InvestPro - Premium Stock Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            /* Brand Colors */
            --primary-500: #667eea;
            --primary-600: #5568d3;
            --primary-700: #4c5fd5;
            --purple-500: #764ba2;
            --purple-600: #6a3f92;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-primary-hover: linear-gradient(135deg, #5568d3 0%, #6a3f92 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-info: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            --gradient-surface: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            --gradient-mesh: 
                radial-gradient(at 0% 0%, rgba(102, 126, 234, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(118, 75, 162, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(102, 126, 234, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(118, 75, 162, 0.1) 0px, transparent 50%);
            
            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-bg-strong: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.18);
            --glass-border-strong: rgba(255, 255, 255, 0.3);
            --glass-blur: blur(20px);
            --glass-blur-strong: blur(30px);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            
            /* Elevation System */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.20);
            --shadow-2xl: 0 24px 64px rgba(0, 0, 0, 0.24);
            --shadow-glow: 0 0 40px rgba(102, 126, 234, 0.3);
            
            /* Border Radius Scale */
            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;
            
            /* Spacing Scale */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            --space-16: 64px;
            --space-20: 80px;
            --space-24: 96px;
            
            /* Typography */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-mono: 'Fira Code', 'SF Mono', Consolas, monospace;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            --font-size-5xl: 3rem;
            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;
            
            /* Legacy Support (keeping for backwards compatibility) */
            --bg-primary: var(--gradient-primary);
            --bg-card: var(--glass-bg-strong);
            --bg-card-hover: rgba(255, 255, 255, 0.95);
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: var(--glass-border);
            --border-light: rgba(255, 255, 255, 0.1);
            --shadow: var(--shadow-md);
            --input-bg: var(--glass-bg);
            --input-border: var(--glass-border-strong);
            --metric-bg: var(--glass-bg);
            --table-header-bg: var(--glass-bg);
            --table-row-hover: var(--glass-bg-strong);
            --toggle-btn-bg: var(--glass-bg);
            --toggle-btn-active: var(--primary-500);
            --news-bg: var(--glass-bg);
            --portfolio-stat-bg: var(--glass-bg);
        }

        .dark-mode {
            /* Glassmorphism for Dark Mode */
            --glass-bg: rgba(30, 30, 30, 0.7);
            --glass-bg-strong: rgba(30, 30, 30, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-border-strong: rgba(255, 255, 255, 0.18);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            
            /* Gradients for Dark Mode */
            --gradient-surface: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            --gradient-mesh: 
                radial-gradient(at 0% 0%, rgba(102, 126, 234, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(118, 75, 162, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(102, 126, 234, 0.15) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(118, 75, 162, 0.15) 0px, transparent 50%);
            
            /* Elevation System for Dark Mode */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.7);
            --shadow-2xl: 0 24px 64px rgba(0, 0, 0, 0.8);
            --shadow-glow: 0 0 40px rgba(102, 126, 234, 0.4);
            
            /* Legacy Support */
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-card: var(--glass-bg-strong);
            --bg-card-hover: rgba(40, 40, 40, 0.9);
            --text-primary: #f5f5f5;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --border-color: var(--glass-border);
            --border-light: rgba(255, 255, 255, 0.05);
            --shadow: var(--shadow-md);
            --input-bg: var(--glass-bg);
            --input-border: var(--glass-border-strong);
            --metric-bg: var(--glass-bg);
            --table-header-bg: var(--glass-bg);
            --table-row-hover: var(--glass-bg-strong);
            --toggle-btn-bg: var(--glass-bg);
            --toggle-btn-active: var(--primary-500);
            --news-bg: var(--glass-bg);
            --portfolio-stat-bg: var(--glass-bg);
            --chart-text: #d0d0d0;
            --chart-grid: rgba(255, 255, 255, 0.1);
            --chart-bg: rgba(30, 30, 30, 0.5);
        }
        
        /* Global dark mode text color fixes */
        .dark-mode * {
            color: inherit;
        }
        
        .dark-mode p,
        .dark-mode div,
        .dark-mode span,
        .dark-mode h1,
        .dark-mode h2,
        .dark-mode h3,
        .dark-mode h4,
        .dark-mode h5,
        .dark-mode h6,
        .dark-mode label,
        .dark-mode td,
        .dark-mode th {
            color: var(--text-primary) !important;
        }
        
        .dark-mode .text-secondary,
        .dark-mode small,
        .dark-mode .help-text {
            color: var(--text-secondary) !important;
        }
        
        .dark-mode input,
        .dark-mode textarea,
        .dark-mode select {
            color: var(--text-primary) !important;
            background-color: var(--input-bg) !important;
        }
        
        .dark-mode canvas {
            background-color: var(--chart-bg) !important;
        }

        .dark-mode .quick-start-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .dark-mode .quick-start-card:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.25) 0%, rgba(118, 75, 162, 0.25) 100%);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .dark-mode .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .dark-mode .feature-item {
            background: rgba(102, 126, 234, 0.1);
        }

        .dark-mode .feature-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        /* ============================================
           GLOBAL STYLES
           ============================================ */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        *:focus {
            outline: none;
        }
        
        *:focus-visible {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
        }
        
        /* Ensure all text uses CSS variables in dark mode */
        .dark-mode {
            color-scheme: dark;
        }
        
        .dark-mode body,
        .dark-mode .card,
        .dark-mode .welcome-section,
        .dark-mode div:not([style*="color:"]):not([class*="chart"]):not([id*="chart"]) {
            color: var(--text-primary) !important;
        }
        
        .dark-mode p:not([style*="color:"]),
        .dark-mode span:not([style*="color:"]),
        .dark-mode h1:not([style*="color:"]),
        .dark-mode h2:not([style*="color:"]),
        .dark-mode h3:not([style*="color:"]),
        .dark-mode h4:not([style*="color:"]),
        .dark-mode h5:not([style*="color:"]),
        .dark-mode h6:not([style*="color:"]),
        .dark-mode label:not([style*="color:"]),
        .dark-mode td:not([style*="color:"]),
        .dark-mode th:not([style*="color:"]) {
            color: var(--text-primary) !important;
        }
        
        .dark-mode .text-secondary,
        .dark-mode small:not([style*="color:"]),
        .dark-mode .help-text:not([style*="color:"]) {
            color: var(--text-secondary) !important;
        }
        
        .dark-mode input:not([type="submit"]):not([type="button"]),
        .dark-mode textarea,
        .dark-mode select {
            color: var(--text-primary) !important;
            background-color: var(--input-bg) !important;
            border-color: var(--input-border) !important;
        }
        
        .dark-mode input::placeholder,
        .dark-mode textarea::placeholder {
            color: var(--text-tertiary) !important;
        }
        
        .dark-mode table,
        .dark-mode table td,
        .dark-mode table th {
            color: var(--text-primary) !important;
        }
        
        .dark-mode .card,
        .dark-mode .welcome-section {
            background: var(--bg-card) !important;
        }
        
        .dark-mode .metric-bg,
        .dark-mode [style*="background: var(--metric-bg)"] {
            background: var(--metric-bg) !important;
        }

        /* ============================================
           PREMIUM ANIMATIONS & KEYFRAMES
           ============================================ */
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            }
            50% {
                opacity: 0.8;
                box-shadow: 0 0 40px rgba(102, 126, 234, 0.6);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-8px);
            }
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes checkmark {
            0% {
                transform: scale(0) rotate(45deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(45deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(45deg);
                opacity: 1;
            }
        }
        
        @keyframes skeleton-loading {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }
        
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Animation Utility Classes */
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .animate-fadeInDown {
            animation: fadeInDown 0.6s ease-out;
        }
        
        .animate-slideInRight {
            animation: slideInRight 0.5s ease-out;
        }
        
        .animate-slideInLeft {
            animation: slideInLeft 0.5s ease-out;
        }
        
        .animate-scaleIn {
            animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .animate-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: var(--font-sans);
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            color: var(--text-primary);
            background: var(--bg-primary);
            background-attachment: fixed;
            min-height: 100vh;
            padding: var(--space-6);
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-mesh);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: var(--line-height-tight);
            color: var(--text-primary);
            margin-bottom: var(--space-4);
        }
        
        h1 {
            font-size: var(--font-size-4xl);
            letter-spacing: -0.02em;
        }
        
        h2 {
            font-size: var(--font-size-3xl);
            letter-spacing: -0.01em;
        }
        
        h3 {
            font-size: var(--font-size-2xl);
        }
        
        h4 {
            font-size: var(--font-size-xl);
        }
        
        h5 {
            font-size: var(--font-size-lg);
        }
        
        h6 {
            font-size: var(--font-size-base);
        }
        
        p {
            margin-bottom: var(--space-4);
            line-height: var(--line-height-relaxed);
        }
        
        .numeric {
            font-family: var(--font-mono);
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
        }
        
        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           PREMIUM NAVIGATION SYSTEM
           ============================================ */
        
        .header {
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur-strong);
            -webkit-backdrop-filter: var(--glass-blur-strong);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            margin-bottom: var(--space-8);
            position: relative;
            z-index: 10;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s ease;
        }
        
        .header:hover {
            border-color: var(--glass-border-strong);
            box-shadow: var(--shadow-2xl);
        }

        .dark-mode-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 2px solid var(--glass-border-strong);
            border-radius: var(--radius-full);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .dark-mode-toggle:hover {
            background: var(--glass-bg-strong);
            transform: scale(1.08) rotate(12deg);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-500);
        }
        
        .dark-mode-toggle:active {
            transform: scale(1) rotate(0deg);
        }

        .nav-button {
            padding: 12px 24px !important;
            background: var(--glass-bg) !important;
            backdrop-filter: var(--glass-blur) !important;
            color: var(--text-primary) !important;
            border: 2px solid var(--glass-border) !important;
            border-radius: var(--radius-lg) !important;
            font-weight: 600 !important;
            font-size: var(--font-size-sm) !important;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: var(--shadow-sm) !important;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            position: relative;
            overflow: hidden;
        }
        
        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md) !important;
            border-color: var(--primary-500) !important;
            color: white !important;
        }
        
        .nav-button:hover::before {
            opacity: 1;
        }
        
        .nav-button.active {
            background: var(--gradient-primary) !important;
            color: white !important;
            border-color: transparent !important;
            box-shadow: var(--shadow-md), 0 0 20px rgba(102, 126, 234, 0.4) !important;
        }
        
        .nav-button.active::before {
            opacity: 1;
        }

        .header h1 {
            font-size: 3.2em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            font-weight: 800;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            margin-bottom: 15px;
            font-weight: 400;
        }

        /* ============================================
           WELCOME SECTION
           ============================================ */
        
        .welcome-section {
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur-strong);
            -webkit-backdrop-filter: var(--glass-blur-strong);
            border: 1px solid var(--glass-border);
            padding: var(--space-16) var(--space-12);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            margin-bottom: var(--space-12);
            animation: fadeInUp 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .welcome-section.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        
        #welcomeSection.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-mesh);
            opacity: 0.5;
            pointer-events: none;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.05) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .welcome-header {
            text-align: center;
            margin-bottom: var(--space-12);
            position: relative;
            z-index: 1;
        }

        .welcome-header h2 {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-4);
            font-weight: 900;
            letter-spacing: -0.03em;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fadeInUp 0.8s ease-out;
            line-height: var(--line-height-tight);
        }

        .welcome-header p {
            font-size: var(--font-size-lg);
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
            line-height: var(--line-height-relaxed);
            animation: fadeInUp 1s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-start-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }

        .quick-start-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            border: 1px solid var(--glass-border);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .quick-start-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .quick-start-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .quick-start-card:hover::before {
            opacity: 1;
        }
        
        .quick-start-card:hover::after {
            left: 100%;
        }

        .quick-start-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl), 0 0 30px rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
        }

        .quick-start-card-icon {
            font-size: 3.5em;
            margin-bottom: 20px;
            display: inline-block;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        .quick-start-card:hover .quick-start-card-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .quick-start-card h3 {
            font-size: 1.5em;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--text-primary) 0%, rgba(102, 126, 234, 0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .quick-start-card p {
            color: var(--text-secondary);
            font-size: 0.98em;
            line-height: 1.7;
            margin-top: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-surface);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::after {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .features-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 40px 0;
        }

        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-5);
            padding: var(--space-6);
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            border-left: 3px solid var(--primary-500);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        
        .feature-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--gradient-primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .feature-item:hover {
            background: var(--gradient-surface);
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
            border-color: transparent;
        }
        
        .feature-item:hover::before {
            transform: scaleY(1);
        }

        .feature-icon {
            font-size: 2.5rem;
            flex-shrink: 0;
            line-height: 1;
        }

        .feature-content h4 {
            font-size: 1.2em;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .feature-content p {
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.6;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            max-width: 350px;
            min-width: 200px;
            width: max-content;
            background-color: var(--bg-card);
            color: var(--text-primary);
            text-align: left;
            border-radius: 12px;
            padding: 14px;
            position: absolute;
            z-index: 10000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            font-size: 0.85em;
            box-shadow: 0 8px 24px var(--shadow);
            border: 2px solid var(--border-color);
            line-height: 1.6;
            pointer-events: none;
            /* Ensure tooltip stays within viewport */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Adjust tooltip position if it would go off screen */
        .tooltip .tooltiptext {
            /* Try to position on the right if too far left */
        }
        
        @media (max-width: 768px) {
            .tooltip .tooltiptext {
                max-width: calc(100vw - 40px);
                left: 50%;
                transform: translateX(-50%) translateY(5px);
            }
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .tooltip .tooltiptext::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--bg-card) transparent transparent transparent;
        }
        
        /* Ensure tooltips are visible and don't overflow */
        .tooltip {
            overflow: visible !important;
        }
        
        /* Better positioning for tooltips near screen edges */
        .tooltip .tooltiptext {
            /* Use viewport units to ensure visibility */
            max-width: min(350px, calc(100vw - 40px));
        }
        
        /* Adjust tooltip position dynamically using JavaScript will be handled by browser */
        /* For now, ensure it doesn't get clipped */
        body {
            overflow-x: auto;
        }
        
        /* Make sure tooltips can overflow their containers */
        .card, .section-content, [class*="card"] {
            overflow: visible !important;
        }

        .info-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 8px;
            cursor: help;
        }

        .help-text {
            background: rgba(102, 126, 234, 0.05);
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.6;
        }

        .feature-highlight {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            color: #10b981;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px;
        }

        /* Autocomplete Dropdown Styles */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 2px solid var(--input-border);
            border-radius: 12px;
            margin-top: 5px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 10000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            width: 100%;
            box-sizing: border-box;
        }

        .autocomplete-section {
            padding: 8px 0;
        }

        .autocomplete-section-title {
            padding: 8px 16px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            background: rgba(102, 126, 234, 0.05);
            border-bottom: 1px solid var(--border-color);
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .autocomplete-item:hover,
        .autocomplete-item.active {
            background: rgba(102, 126, 234, 0.1);
        }

        .autocomplete-item-icon {
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .autocomplete-item-content {
            flex: 1;
            min-width: 0;
        }

        .autocomplete-item-ticker {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1em;
            margin-bottom: 2px;
        }

        .autocomplete-item-name {
            font-size: 0.85em;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .autocomplete-item-meta {
            display: flex;
            gap: 8px;
            font-size: 0.75em;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .autocomplete-item-favorite {
            margin-left: auto;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .autocomplete-item-favorite:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        .autocomplete-item-favorite.active {
            color: #fbbf24;
        }

        .autocomplete-loading {
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .autocomplete-empty {
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .search-container {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow), 0 0 0 1px rgba(255,255,255,0.1);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }

        .search-container::before {
            content: 'ðŸ’¡ Tip: Try popular stocks like AAPL, MSFT, TSLA, GOOGL, or AMZN';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.1);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            white-space: nowrap;
        }

        .search-box {
            display: flex;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* ============================================
           PREMIUM INPUT SYSTEM
           ============================================ */
        
        input, textarea, select {
            font-family: var(--font-sans);
            font-size: var(--font-size-base);
            color: var(--text-primary);
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 2px solid var(--glass-border-strong);
            border-radius: var(--radius-lg);
            padding: 14px 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), var(--shadow-md);
            transform: translateY(-1px);
        }
        
        input::placeholder, textarea::placeholder {
            color: var(--text-tertiary);
        }
        
        .search-box input {
            flex: 1;
            padding: 16px 24px;
            font-size: var(--font-size-base);
        }
        
        .input-group {
            position: relative;
            width: 100%;
        }
        
        .input-icon {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus + .input-icon {
            color: var(--primary-500);
            transform: translateY(-50%) scale(1.1);
        }
        
        .input-with-icon {
            padding-left: var(--space-12);
        }

        /* ============================================
           PREMIUM BUTTON SYSTEM
           ============================================ */
        
        button, .btn {
            font-family: var(--font-sans);
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .search-box button,
        .btn-primary {
            padding: 14px 32px;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-lg);
            font-size: var(--font-size-base);
            font-weight: 600;
            box-shadow: var(--shadow-md);
        }

        .search-box button::before,
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s ease;
        }

        .search-box button:hover::before,
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .search-box button:hover,
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            padding: 12px 28px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            color: var(--text-primary);
            border: 2px solid var(--glass-border-strong);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-base);
        }
        
        .btn-secondary:hover {
            background: var(--glass-bg-strong);
            border-color: var(--primary-500);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            padding: 12px 28px;
            background: var(--gradient-success);
            color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(16, 185, 129, 0.4);
        }
        
        .btn-danger {
            padding: 12px 28px;
            background: var(--gradient-danger);
            color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(239, 68, 68, 0.4);
        }
        
        .btn-sm {
            padding: 8px 20px;
            font-size: var(--font-size-sm);
        }
        
        .btn-lg {
            padding: 16px 40px;
            font-size: var(--font-size-lg);
        }
        
        .icon-btn {
            width: 44px;
            height: 44px;
            padding: 0;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-full);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s ease;
        }
        
        .icon-btn:hover {
            background: var(--glass-bg-strong);
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .search-box button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .search-box button:active {
            transform: translateY(-1px);
        }

        .content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        
        /* Tablet Landscape & Small Desktop (1024px and down) */
        @media (max-width: 1024px) {
            :root {
                --space-8: 24px;
                --space-12: 36px;
                --space-16: 48px;
            }
            
            .content {
                grid-template-columns: 1fr;
            }
            
            .watchlist-sidebar {
                position: relative;
                top: 0;
                max-height: none;
                margin-top: var(--space-6);
            }
            
            div[style*="grid-template-columns: 1fr 350px"] {
                grid-template-columns: 1fr !important;
            }
            
            .header {
                position: relative;
                z-index: 10;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--space-4);
            }
            
            h1 {
                font-size: var(--font-size-3xl);
            }
            
            h2 {
                font-size: var(--font-size-2xl);
            }
        }
        
        /* Tablet Portrait (768px and down) */
        @media (max-width: 768px) {
            :root {
                --font-size-base: 0.9375rem;
                --space-6: 16px;
                --space-8: 20px;
            }
            
            body {
                padding: 12px;
            }
            
            .card {
                padding: 16px;
                margin-bottom: 16px;
                border-radius: var(--radius-lg);
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .header {
                padding: var(--space-4);
                border-radius: var(--radius-lg);
            }
            
            .nav-button {
                padding: 10px 16px !important;
                font-size: 0.8rem !important;
            }
            
            .chart-container {
                padding: var(--space-4);
                height: 300px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-card {
                padding: var(--space-4);
            }
            
            .search-box {
                flex-direction: column;
                gap: var(--space-3);
            }
            
            .search-box input, .search-box button {
                width: 100%;
            }
            
            table {
                font-size: var(--font-size-xs);
            }
            
            thead th, tbody td {
                padding: var(--space-2) var(--space-3);
            }
            
            h1 {
                font-size: var(--font-size-2xl);
            }
            
            h2 {
                font-size: var(--font-size-xl);
            }
            
            h3 {
                font-size: var(--font-size-lg);
            }
        }
        
        /* Mobile (640px and down) */
        @media (max-width: 640px) {
            :root {
                --font-size-base: 0.875rem;
                --space-4: 12px;
                --space-6: 14px;
                --space-8: 16px;
            }
            
            body {
                padding: 8px;
                overflow-x: hidden;
            }
            
            .container {
                padding: 0;
                margin-left: 0 !important;
                width: 100%;
                max-width: 100%;
            }
            
            .main-content {
                margin-left: 0 !important;
                padding: 10px;
                width: 100%;
            }
            
            .card {
                padding: 16px;
                border-radius: var(--radius-md);
                margin-bottom: 16px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            /* Typography scale for mobile */
            h1 {
                font-size: 1.75rem !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
            }
            
            h3 {
                font-size: 1.25rem !important;
            }
            
            .header {
                padding: var(--space-3);
                flex-direction: column;
                gap: var(--space-3);
            }
            
            .nav-button {
                padding: 10px 16px !important;
                font-size: 0.9rem !important;
                gap: var(--space-1);
                min-height: 44px;
            }
            
            .btn-primary, .btn-secondary {
                padding: 12px 20px !important;
                font-size: 16px !important;
                min-height: 44px;
            }
            
            .icon-btn {
                width: 48px;
                height: 48px;
                min-width: 48px;
                min-height: 48px;
                font-size: 1.2rem;
            }
            
            .metric-card {
                flex-direction: column;
                text-align: center;
                padding: var(--space-4);
                min-height: 48px;
            }
            
            /* Ensure all toggle buttons have proper touch targets */
            .toggle-btn {
                min-height: 48px;
                min-width: 48px;
                padding: 12px 16px;
            }
            
            /* Nav items touch targets */
            .nav-item {
                min-height: 44px;
                padding: 12px 16px;
            }
            
            .metric-icon {
                width: 48px;
                height: 48px;
                font-size: 1.5rem;
            }
            
            .metric-value {
                font-size: var(--font-size-xl);
            }
            
            .chart-container {
                height: 200px !important;
                padding: var(--space-3);
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            canvas {
                touch-action: pan-x pan-y pinch-zoom;
            }
            
            .toast {
                left: var(--space-3);
                right: var(--space-3);
                bottom: var(--space-3);
                min-width: auto;
            }
            
            h1 {
                font-size: var(--font-size-xl);
            }
            
            h2 {
                font-size: var(--font-size-lg);
            }
            
            h3 {
                font-size: var(--font-size-base);
            }
            
            /* Tables - horizontal scroll with better UX */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                font-size: var(--font-size-xs);
            }
            
            table thead th,
            table tbody td {
                padding: 8px 12px;
                white-space: nowrap;
            }
            
            /* Hide less important columns on mobile */
            table .mobile-hide {
                display: none;
            }
            
            /* Prevent horizontal scroll on body */
            html, body {
                max-width: 100vw;
                overflow-x: hidden;
            }
        }
        
        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            button, .btn, .nav-button, .icon-btn, a, .link {
                min-height: 44px;
                min-width: 44px;
            }
            
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .card:hover {
                transform: none;
            }
            
            button:hover, .btn:hover {
                transform: none;
            }
        }

        /* ============================================
           GLASS CARD SYSTEM
           ============================================ */
        
        .card {
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--space-8);
            margin-bottom: var(--space-8);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--glass-border-strong);
        }
        
        .card-glow {
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }
        
        .card-glow:hover {
            box-shadow: var(--shadow-xl), var(--shadow-glow);
        }

        .card h2 {
            color: var(--text-primary);
            margin-bottom: var(--space-6);
            font-size: var(--font-size-2xl);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--glass-border);
            position: relative;
        }
        
        .card h2::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 80px;
            height: 2px;
            background: var(--gradient-primary);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .stock-title h3 {
            font-size: 2.2em;
            color: var(--text-primary);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stock-title p {
            color: var(--text-secondary);
            margin-top: 5px;
            font-size: 1em;
        }

        .price-info {
            text-align: right;
        }

        .price {
            font-size: 3em;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -1px;
        }

        .price-change {
            font-size: 1.2em;
            margin-top: 5px;
        }

        .price-change.positive {
            color: #10b981;
        }

        .price-change.negative {
            color: #ef4444;
        }

        /* ============================================
           CHARTS & METRICS
           ============================================ */
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: var(--space-8);
            padding: var(--space-6);
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .chart-container:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--glass-border-strong);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }
        
        .metric-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--glass-border-strong);
        }
        
        .metric-card:hover::before {
            opacity: 1;
        }
        
        .metric-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            background: var(--gradient-primary);
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }
        
        .gradient-icon {
            background: var(--gradient-primary);
            color: white;
        }
        
        .metric-content {
            flex: 1;
        }
        
        .metric-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: var(--space-1);
        }
        
        .metric-value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .metric-change {
            font-size: var(--font-size-sm);
            font-weight: 600;
            font-family: var(--font-mono);
            margin-top: var(--space-1);
        }
        
        .metric-change.positive {
            color: #10b981;
        }
        
        .metric-change.negative {
            color: #ef4444;
        }
        
        /* Data Tables */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            box-shadow: var(--shadow-sm);
        }
        
        thead {
            background: var(--gradient-surface);
        }
        
        thead th {
            padding: var(--space-4) var(--space-6);
            text-align: left;
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--text-primary);
            border-bottom: 2px solid var(--glass-border);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        tbody tr {
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--glass-border);
        }
        
        tbody tr:hover {
            background: var(--gradient-surface);
        }
        
        tbody tr:last-child {
            border-bottom: none;
        }
        
        tbody td {
            padding: var(--space-4) var(--space-6);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }
        
        .data-table {
            margin: var(--space-6) 0;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
        }

        .metric-item {
            padding: 20px;
            background: var(--metric-bg);
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            cursor: default;
        }

        .metric-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left-width: 5px;
        }

        .metric-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .company-info {
            margin-top: 20px;
        }

        .company-info p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .indicator-toggle {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        /* Toggle & Timeframe Buttons */
        .toggle-btn, .timeframe-btn {
            padding: 10px 18px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        
        .toggle-btn::before, .timeframe-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .toggle-btn.active, .timeframe-btn.active {
            color: white;
            border-color: transparent;
            box-shadow: var(--shadow-md), 0 0 20px rgba(102, 126, 234, 0.3);
        }
        
        .toggle-btn.active::before, .timeframe-btn.active::before {
            opacity: 1;
        }

        .toggle-btn:hover, .timeframe-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-500);
        }

        .toggle-btn.active:hover, .timeframe-btn.active:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg), 0 0 25px rgba(102, 126, 234, 0.4);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            position: relative;
        }

        .loading::before {
            content: '';
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Skeleton Loader Styles */
        @keyframes skeleton-loading {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        /* ============================================
           LOADING STATES
           ============================================ */
        
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--glass-bg) 0%,
                rgba(255, 255, 255, 0.4) 50%,
                var(--glass-bg) 100%
            );
            background-size: 1000px 100%;
            animation: shimmer 2s ease-in-out infinite;
            border-radius: var(--radius-md);
        }

        .skeleton-text {
            height: 1em;
            margin: var(--space-2) 0;
        }
        
        .skeleton-title {
            height: 2em;
            width: 60%;
            margin-bottom: var(--space-4);
        }
        
        .skeleton-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            margin-bottom: var(--space-6);
        }
        
        .skeleton-news-item {
            height: 80px;
            margin-bottom: var(--space-4);
            border-radius: var(--radius-lg);
        }
        
        .loader, .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--glass-border);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loader-sm, .spinner-sm {
            width: 24px;
            height: 24px;
            border-width: 3px;
        }
        
        .loader-lg, .spinner-lg {
            width: 64px;
            height: 64px;
            border-width: 5px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: var(--space-4);
            z-index: 100;
            animation: fadeIn 0.3s ease;
        }
        
        .button-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: var(--space-2);
        }

        .skeleton-title {
            height: 1.5em;
            width: 60%;
            margin-bottom: 1em;
        }

        .skeleton-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .skeleton-metric {
            height: 3em;
            width: 100%;
            margin-bottom: 1em;
        }

        .skeleton-chart {
            height: 300px;
            width: 100%;
            margin: 20px 0;
        }

        .skeleton-table-row {
            height: 50px;
            margin-bottom: 10px;
        }

        .skeleton-news-item {
            height: 100px;
            margin-bottom: 15px;
        }

        /* Button Loading Spinner */
        .button-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        button.loading {
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Button Click Feedback - Ripple Effect */
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* ============================================
           MICRO-INTERACTIONS
           ============================================ */
        
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }
        
        .ripple-effect .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }

        /* Button Scale Animation */
        button:not(.copy-btn):not(.favorite-btn):not(.remove-recent-btn):not(.loading) {
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), 
                        box-shadow 0.3s ease, 
                        background-color 0.3s ease;
        }
        
        button:not(.copy-btn):not(.favorite-btn):not(.remove-recent-btn):active {
            transform: scale(0.98);
        }
        
        /* Hover Glow Effects */
        .glow-on-hover {
            transition: all 0.3s ease;
        }
        
        .glow-on-hover:hover {
            box-shadow: var(--shadow-lg), 0 0 30px rgba(102, 126, 234, 0.3);
        }
        
        /* Smooth Transitions */
        a, .link {
            color: var(--primary-500);
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
        }
        
        a:hover, .link:hover {
            color: var(--primary-600);
        }
        
        a::after, .link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
        }
        
        a:hover::after, .link:hover::after {
            width: 100%;
        }
        
        /* Focus States */
        *:focus-visible {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }
        
        /* Selection */
        ::selection {
            background: var(--primary-500);
            color: white;
        }
        
        ::-moz-selection {
            background: var(--primary-500);
            color: white;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--glass-bg);
            border-radius: var(--radius-sm);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--glass-border-strong);
            border-radius: var(--radius-sm);
            border: 2px solid transparent;
            background-clip: padding-box;
            transition: background 0.3s ease;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-500);
            background-clip: padding-box;
        }
        
        /* Badge */
        .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--gradient-danger);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-sm);
            min-width: 18px;
            text-align: center;
            line-height: 1;
        }

        button:not(.copy-btn):not(.favorite-btn):not(.remove-recent-btn):not(.loading):active {
            transform: scale(0.97);
        }

        button:not(.copy-btn):not(.favorite-btn):not(.remove-recent-btn):not(.loading):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Enhanced Hover States */
        .card:hover {
            box-shadow: 0 8px 24px var(--shadow);
            transform: translateY(-2px);
        }

        .metric-item:hover {
            background: var(--bg-card-hover);
            transform: translateY(-2px);
        }

        .news-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(5px);
        }

        /* Success Indicator */
        @keyframes checkmark {
            0% {
                transform: scale(0) rotate(45deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(45deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(45deg);
                opacity: 1;
            }
        }

        .success-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #10b981;
            font-weight: 600;
            animation: fadeInUp 0.3s ease-out;
        }

        .success-checkmark {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981;
            position: relative;
            animation: checkmark 0.5s ease-out;
        }

        .success-checkmark::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* Toast Notification Styles */
        /* ============================================
           TOAST NOTIFICATIONS
           ============================================ */
        
        .toast {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur-strong);
            -webkit-backdrop-filter: var(--glass-blur-strong);
            color: var(--text-primary);
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--glass-border);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: var(--space-3);
            min-width: 280px;
            max-width: 420px;
            animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transition: all 0.3s ease;
        }
        
        .toast::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        }

        .toast.success::before {
            background: linear-gradient(180deg, #10b981 0%, #059669 100%);
        }

        .toast.error::before {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        }

        .toast.info::before {
            background: var(--gradient-primary);
        }
        
        .toast.warning::before {
            background: var(--gradient-warning);
        }
        
        .toast-icon {
            font-size: 1.5rem;
            line-height: 1;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-1);
        }
        
        .toast-message {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 1.5em;
        }

        /* Data Freshness Indicator */
        .data-freshness-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .data-freshness-indicator.fresh {
            color: #10b981;
        }

        .data-freshness-indicator.stale {
            color: #f59e0b;
        }

        .data-freshness-indicator.very-stale {
            color: #ef4444;
        }

        /* Daily History Table Styles */
        .daily-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .daily-history-table thead {
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .daily-history-table th {
            padding: 10px;
            text-align: left;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        .daily-history-table th:not(:first-child) {
            text-align: right;
        }

        .daily-history-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .daily-history-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .daily-history-table td {
            padding: 8px;
            color: var(--text-primary);
        }

        .daily-history-table td:not(:first-child) {
            text-align: right;
        }

        .history-filter-btn {
            transition: all 0.2s ease;
        }

        .history-filter-btn:hover {
            background: rgba(102, 126, 234, 0.1) !important;
            border-color: #667eea !important;
            transform: translateY(-1px);
        }

        .history-filter-btn.active {
            background: rgba(102, 126, 234, 0.2) !important;
            border-color: #667eea !important;
            color: #667eea !important;
        }

        .refresh-data-btn {
            padding: 4px 12px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid #667eea;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-actions-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .quick-action-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            color: var(--text-primary);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .quick-action-btn:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .quick-action-btn:active {
            transform: translateY(0);
        }

        .refresh-data-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        .refresh-data-btn:active {
            transform: scale(0.97);
        }

        .refresh-data-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .refresh-data-btn.stale {
            animation: pulse 2s infinite;
        }

        /* Enhanced Error Messages */
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-left: 4px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: var(--text-primary);
        }

        .error-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #ef4444;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .error-tips {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(239, 68, 68, 0.2);
        }

        .error-tips-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-tips-list {
            list-style: none;
            padding-left: 0;
        }

        .error-tips-list li {
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
            color: var(--text-secondary);
        }

        .error-tips-list li::before {
            content: 'â€¢';
            position: absolute;
            left: 10px;
            color: #ef4444;
            font-weight: bold;
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin-bottom: 20px;
            line-height: 1.6;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            color: #ef4444;
            padding: 20px 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #ef4444;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .error::before {
            content: 'âš ï¸';
            font-size: 1.5em;
        }

        .success-message {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            color: #10b981;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #10b981;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .hidden {
            display: none !important;
        }
        
        #settingsSection:not(.hidden) {
            display: block !important;
            min-height: 200px;
        }
        
        #settingsSection:not(.hidden) .card {
            min-height: 200px;
        }

        .earnings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .earnings-table th,
        .earnings-table td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .earnings-table th {
            background: var(--table-header-bg);
            font-weight: 700;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        .earnings-table tr {
            transition: all 0.2s ease;
        }

        .earnings-table tr:hover {
            background: var(--table-row-hover);
            transform: scale(1.01);
        }

        .qoq-positive {
            color: #10b981;
            font-weight: 600;
        }

        .qoq-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .surprise-positive {
            color: #10b981;
            font-weight: 600;
        }

        .surprise-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .earnings-calendar-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .earnings-filter-btn,
        .alerts-filter-btn,
        .portfolio-tab-btn {
            padding: 10px 20px;
            background: var(--metric-bg);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .earnings-filter-btn:hover,
        .alerts-filter-btn:hover,
        .portfolio-tab-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .earnings-filter-btn.active,
        .alerts-filter-btn.active,
        .portfolio-tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .education-tab-content {
            margin-top: 20px;
        }

        .education-tab-content.hidden {
            display: none;
        }

        .portfolio-tab-content {
            margin-top: 25px;
        }

        .earnings-container {
            overflow-x: auto;
        }

        .news-item {
            padding: 25px;
            margin-bottom: 20px;
            background: var(--news-bg);
            border-radius: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
            border: 1px solid var(--border-light);
        }

        .news-item:hover {
            transform: translateY(-5px) translateX(5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border-left-width: 6px;
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .news-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            flex: 1;
        }

        .news-title a {
            color: #667eea;
            text-decoration: none;
        }

        .news-title a:hover {
            text-decoration: underline;
        }

        .sentiment-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
            white-space: nowrap;
        }

        .sentiment-positive {
            background: #d1fae5;
            color: #065f46;
        }

        .sentiment-negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .sentiment-neutral {
            background: #e5e7eb;
            color: #374151;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
            font-size: 0.9em;
            color: var(--text-secondary);
            flex-wrap: wrap;
            gap: 10px;
        }

        .news-date {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--metric-bg) 0%, rgba(99, 102, 241, 0.15) 100%);
            border-radius: 10px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s ease;
            border: 1px solid rgba(99, 102, 241, 0.3);
            font-size: 0.95em;
            min-width: 150px;
            justify-content: center;
        }

        .news-date:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            background: linear-gradient(135deg, var(--metric-bg) 0%, rgba(99, 102, 241, 0.25) 100%);
        }

        .news-date-icon {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .news-date span:last-child {
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .news-publisher {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--metric-bg) 0%, rgba(16, 185, 129, 0.1) 100%);
            border-radius: 10px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s ease;
            border: 1px solid var(--border-light);
        }

        .news-publisher:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .news-item-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .news-item-text {
            flex: 1;
            min-width: 0;
        }

        .news-thumbnail-container {
            flex-shrink: 0;
            width: 120px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .news-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .news-thumbnail:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .news-thumbnail-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 80px;
            border-radius: 8px;
            font-size: 2em;
        }

        .ticker-color-badge {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .impact-score-stars {
            margin-left: 10px;
            font-size: 0.9em;
            color: #fbbf24;
            letter-spacing: 2px;
            vertical-align: middle;
            display: inline-block;
        }

        .news-summary {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-top: 10px;
        }

        .sentiment-score {
            font-size: 0.85em;
            color: var(--text-tertiary);
            margin-left: 10px;
        }

        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .portfolio-stat {
            background: var(--portfolio-stat-bg);
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
            border: 1px solid var(--border-light);
        }

        .portfolio-stat:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-left-width: 6px;
        }

        .portfolio-stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .portfolio-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .portfolio-stat-value.positive {
            color: #10b981;
        }

        .portfolio-stat-value.negative {
            color: #ef4444;
        }

        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .portfolio-table th,
        .portfolio-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .portfolio-table th {
            background: var(--table-header-bg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .portfolio-table tr:hover {
            background: var(--table-row-hover);
        }

        .pl-positive {
            color: #10b981;
            font-weight: 600;
        }

        .pl-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .watchlist-ticker-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--metric-bg);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .watchlist-ticker-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .watchlist-ticker-badge .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .watchlist-ticker-badge .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .live-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
            animation: pulse 2s infinite;
            border: 2px solid white;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }
        }

        .news-item.unread {
            border-left-width: 5px;
            background: var(--bg-card);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .news-item.unread::before {
            content: 'â—';
            position: absolute;
            left: -12px;
            top: 20px;
            color: #667eea;
            font-size: 12px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .watchlist-news-group {
            margin-bottom: 40px;
        }

        .watchlist-news-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .watchlist-news-group-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .watchlist-sentiment-summary {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .sentiment-summary-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .sentiment-summary-positive {
            background: #d1fae5;
            color: #065f46;
        }

        .dark-mode .sentiment-summary-positive {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .sentiment-summary-negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .dark-mode .sentiment-summary-negative {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .sentiment-summary-neutral {
            background: #e5e7eb;
            color: #374151;
        }

        .dark-mode .sentiment-summary-neutral {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        /* ============================================
           WATCHLIST SIDEBAR
           ============================================ */
        
        .watchlist-sidebar {
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            padding: 0;
            margin-bottom: var(--space-8);
            position: sticky;
            top: var(--space-6);
            max-height: calc(100vh - 48px);
            overflow: hidden;
            align-self: start;
            transition: all 0.3s ease;
            z-index: 5;
        }
        
        .watchlist-sidebar:hover {
            box-shadow: var(--shadow-2xl);
            border-color: var(--glass-border-strong);
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-bottom: 1px solid var(--glass-border);
            background: var(--gradient-surface);
        }

        .watchlist-header h3 {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--text-primary);
            font-weight: 700;
            margin: 0;
        }

        .watchlist-group {
            margin-bottom: 20px;
        }

        .watchlist-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .watchlist-group-header:hover {
            background: rgba(102, 126, 234, 0.15);
        }

        .watchlist-group-title {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .watchlist-group-actions {
            display: flex;
            gap: 5px;
        }

        .watchlist-group-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            margin: 0;
            background: transparent;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .watchlist-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .watchlist-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
            background: var(--glass-bg);
        }

        .watchlist-item.drag-over {
            background: var(--gradient-surface);
        }
        
        .watchlist-item.drag-over::before {
            opacity: 1;
        }

        .watchlist-item:hover {
            background: var(--gradient-surface);
        }
        
        .watchlist-item:hover::before {
            opacity: 1;
        }

        .watchlist-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .watchlist-item-drag-handle {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.2em;
            cursor: grab;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .watchlist-item:hover .watchlist-item-drag-handle {
            opacity: 1;
        }

        .watchlist-item-drag-handle:active {
            cursor: grabbing;
        }

        .watchlist-item-info {
            flex: 1;
        }

        .watchlist-item-ticker {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .watchlist-item-price {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .watchlist-item-change {
            font-weight: 600;
            font-size: 0.95em;
        }

        .watchlist-item-change.positive {
            color: #10b981;
        }

        .watchlist-item-change.negative {
            color: #ef4444;
        }

        .watchlist-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .watchlist-remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            opacity: 0;
        }

        .watchlist-item:hover .watchlist-remove-btn {
            opacity: 1;
        }

        .watchlist-remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .watchlist-add-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-light);
        }

        .watchlist-add-input {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .watchlist-add-input input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .watchlist-add-input button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watchlist-add-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .watchlist-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }

        .watchlist-empty-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .timeframe-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--metric-bg);
            border-radius: 12px;
            border: 1px solid var(--border-light);
        }

        .timeframe-btn {
            padding: 8px 16px;
            background: var(--toggle-btn-bg);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .timeframe-btn.active {
            background: var(--toggle-btn-active);
            color: white;
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .timeframe-btn:hover {
            background: var(--bg-card-hover);
            transform: translateY(-2px);
        }

        .timeframe-btn.active:hover {
            background: #5568d3;
        }

        .price-alerts-section {
            margin-top: 30px;
            padding: 20px;
            background: var(--metric-bg);
            border-radius: 12px;
            border: 1px solid var(--border-light);
        }

        .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: var(--bg-card);
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .alert-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .alert-info {
            flex: 1;
        }

        .alert-ticker {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .alert-details {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .alert-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* Global Search Styles */
        .global-search-container {
            position: relative;
            max-width: 400px;
            width: 100%;
        }

        #globalSearchInput {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid var(--input-border, rgba(255,255,255,0.3));
            border-radius: 8px;
            background: var(--input-bg, rgba(255,255,255,0.1));
            color: var(--text-primary, white);
            font-size: 1em;
            backdrop-filter: blur(10px);
        }
        
        /* Mobile optimizations for search */
        @media (max-width: 768px) {
            #globalSearchInput {
                font-size: 16px !important; /* Prevents iOS zoom */
                padding: 14px 40px 14px 16px !important;
                min-height: 48px;
            }
        }

        #globalSearchInput:focus {
            outline: none;
            border-color: var(--accent-color, #667eea);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
        }

        .search-dropdown-section {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-dropdown-section:last-child {
            border-bottom: none;
        }

        .search-dropdown-header {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85em;
            padding: 8px 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-dropdown-item {
            padding: 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-dropdown-item:hover {
            background: var(--table-row-hover, rgba(102, 126, 234, 0.1));
        }

        .search-dropdown-item .ticker-info {
            flex: 1;
        }

        .search-dropdown-item .ticker-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .search-dropdown-item .ticker-exchange {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .favorite-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 4px 8px;
            transition: transform 0.2s;
        }

        .favorite-btn:hover {
            transform: scale(1.2);
        }

        .remove-recent-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9em;
            padding: 4px;
            opacity: 0.6;
        }

        .remove-recent-btn:hover {
            opacity: 1;
        }

        .alert-status.active {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .alert-status.triggered {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .alert-actions {
            display: flex;
            gap: 8px;
        }

        .alert-delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .alert-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .add-alert-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .add-alert-form input {
            flex: 1;
            min-width: 120px;
            padding: 10px 14px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .add-alert-form select {
            padding: 10px 14px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
        }

        .add-alert-form button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-alert-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Sidebar Navigation Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-primary);
        }

        .sidebar-toggle {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--bg-card);
        }

        .breadcrumbs {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
            background: var(--bg-primary);
        }

        .breadcrumb-link {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .breadcrumb-link:hover {
            color: var(--primary-500);
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: var(--text-tertiary);
        }

        .breadcrumb-current {
            color: var(--text-primary);
            font-weight: 600;
        }

        .sidebar-nav {
            flex: 1;
            padding: 10px 0;
            overflow-y: auto;
        }

        .nav-group {
            margin-bottom: 5px;
        }

        .nav-group-header {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
            color: var(--text-primary);
        }

        .nav-group-header:hover {
            background: var(--bg-card);
        }

        .nav-group-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        .nav-group-title {
            flex: 1;
            font-weight: 600;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .nav-group-chevron {
            font-size: 0.8em;
            transition: transform 0.3s ease;
            color: var(--text-tertiary);
        }

        .nav-group.collapsed .nav-group-chevron {
            transform: rotate(-90deg);
        }

        .nav-group-items {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .nav-group.collapsed .nav-group-items {
            max-height: 0;
            opacity: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px 10px 52px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
            font-size: 0.95em;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: transparent;
            transition: background 0.2s ease;
        }

        .nav-item:hover {
            background: var(--bg-card);
            color: var(--primary-500);
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-500);
            font-weight: 600;
        }

        .nav-item.active::before {
            background: var(--primary-500);
        }

        .nav-item-single {
            padding-left: 20px;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 999;
            transition: opacity 0.3s ease;
        }

        /* Main content padding for sidebar */
        .container {
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }

        /* Header adjustments for sidebar */
        .header {
            position: relative;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                touch-action: pan-y;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
                opacity: 1;
            }

            .container {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 260px;
            }
            
            .container {
                margin-left: 0 !important;
                padding: 10px;
            }
            
            .main-content {
                margin-left: 0 !important;
                padding: 10px;
            }
            
            .financials-header-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Tables - make scrollable on mobile */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
            }
            
            /* Card layout for tables on mobile */
            .table-mobile-card {
                display: block;
            }
            
            .table-mobile-card thead {
                display: none;
            }
            
            .table-mobile-card tbody {
                display: block;
            }
            
            .table-mobile-card tbody tr {
                display: block;
                margin-bottom: 16px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 12px;
                background: var(--bg-card);
            }
            
            .table-mobile-card tbody td {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border: none;
                text-align: left;
            }
            
            .table-mobile-card tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                margin-right: 12px;
                color: var(--text-secondary);
            }
            
            /* Cards - better spacing on mobile */
            .card {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            /* Single column grids on mobile */
            .metrics-grid,
            div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }
            
            /* Inputs and buttons - bigger for touch */
            input[type="text"],
            input[type="number"],
            input[type="search"],
            select,
            textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding: 14px 16px !important;
                min-height: 48px;
                border-radius: 8px;
            }
            
            /* Touch targets - minimum 44x44px for all clickable elements */
            button,
            .btn-primary,
            .btn-secondary,
            .nav-item,
            .icon-btn,
            .nav-button,
            a.btn,
            .link {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 20px !important;
                font-size: 16px !important;
            }
            
            /* Larger touch targets for small elements */
            .toggle-btn,
            .metric-card,
            .icon-btn {
                min-height: 48px;
                min-width: 48px;
                padding: 12px;
            }
            
            /* Charts - responsive height */
            .chart-container {
                max-width: 100%;
                height: 200px !important;
                min-height: 200px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            canvas {
                max-width: 100%;
                touch-action: pan-x pan-y pinch-zoom;
            }
            
            /* Grid layouts - single column on mobile */
            div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Hide some elements on mobile */
            .desktop-only {
                display: none !important;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .main-content {
                padding: 5px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            h1 {
                font-size: 1.5rem !important;
            }
            
            h2 {
                font-size: 1.25rem !important;
            }
            
            h3 {
                font-size: 1.1rem !important;
            }
            
            /* Sidebar narrower on very small screens */
            .sidebar {
                width: 100%;
                max-width: 280px;
            }
            
            /* Search box full width */
            .global-search-container {
                max-width: 100% !important;
                width: 100% !important;
            }
            
            /* Header buttons stack */
            .header > div {
                flex-direction: column !important;
                width: 100%;
            }
        }

        /* Mobile hamburger button */
        .mobile-menu-button,
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            padding: 0;
            cursor: pointer;
            font-size: 1.8rem;
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .mobile-menu-button:hover,
        .mobile-menu-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        
        .mobile-menu-button:active,
        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }

        @media (max-width: 1024px) {
            .mobile-menu-button,
            .mobile-menu-toggle {
                display: flex;
            }
        }

        /* Financials Tabs Styling */
        .financials-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .financials-tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            position: relative;
            top: 2px;
        }

        .financials-tab-btn:hover {
            color: var(--text-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .financials-tab-btn.active {
            color: var(--primary-500);
            border-bottom-color: var(--primary-500);
        }

        .financials-tab-content {
            display: none;
        }

        .financials-tab-content.active {
            display: block;
        }

        /* Detailed Financials Table Styling */
        .detailed-financials-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--glass-bg);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .detailed-financials-table th {
            background: var(--gradient-primary);
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .detailed-financials-table th:first-child {
            min-width: 250px;
            position: sticky;
            left: 0;
            z-index: 11;
            background: var(--gradient-primary);
        }

        .detailed-financials-table td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .detailed-financials-table td:first-child {
            font-weight: 500;
            position: sticky;
            left: 0;
            background: var(--glass-bg);
            z-index: 5;
        }

        .detailed-financials-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .detailed-financials-table tr:hover td:first-child {
            background: rgba(102, 126, 234, 0.05);
        }

        .detailed-financials-table .metric-value {
            text-align: right;
            font-family: var(--font-mono);
            white-space: nowrap;
        }

        .detailed-financials-table .metric-value.negative {
            color: #ef4444;
        }

        .detailed-financials-table .metric-value.positive {
            color: #10b981;
        }

        /* Scrollable container for table */
        .detailed-financials-scroll {
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
            max-width: 100%;
        }

        @media (max-width: 768px) {
            .financials-tabs {
                flex-wrap: wrap;
            }

            .financials-tab-btn {
                padding: 10px 16px;
                font-size: 0.9em;
            }

            .detailed-financials-table {
                font-size: 0.85em;
            }

            .detailed-financials-table th,
            .detailed-financials-table td {
                padding: 8px 12px;
            }

            .detailed-financials-table th:first-child,
            .detailed-financials-table td:first-child {
                min-width: 180px;
            }
        }
    </style>
</head>
    <body>
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleMobileSidebar()" aria-label="Toggle menu">â˜°</button>
        <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>
    <!-- Sidebar Navigation -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2 style="margin: 0; font-size: 1.2em; color: var(--text-primary);">ðŸ“ˆ Stock Analysis</h2>
            <button id="sidebarToggle" class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">
                <span id="sidebarToggleIcon">â˜°</span>
            </button>
        </div>
        
        <!-- Breadcrumbs -->
        <div id="breadcrumbs" class="breadcrumbs">
            <a href="#" onclick="if(typeof window.showWelcome === 'function') { window.showWelcome(); } else { console.error('showWelcome not available'); } return false;" class="breadcrumb-link">Home</a>
            <span class="breadcrumb-separator">â€º</span>
            <span id="breadcrumbCurrent" class="breadcrumb-current">Welcome</span>
        </div>
        
        <!-- Navigation Groups -->
        <nav class="sidebar-nav">
            <!-- Analysis Group -->
            <div class="nav-group">
                <div class="nav-group-header" onclick="if(typeof window.toggleNavGroup === 'function') { window.toggleNavGroup('analysis'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                    <span class="nav-group-icon">ðŸ“Š</span>
                    <span class="nav-group-title">Analysis</span>
                    <span class="nav-group-chevron" id="chevron-analysis">â–¼</span>
                </div>
                <div class="nav-group-items" id="nav-group-analysis">
                    <a href="#" class="nav-item" data-section="stockAnalysisSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('stockAnalysisSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ“ˆ Stock Analysis</span>
                    </a>
                    <a href="#" class="nav-item" data-section="financialsSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('financialsSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ’° Financials</span>
                    </a>
                    <a href="#" class="nav-item" data-section="aiRecommendationsSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('aiRecommendationsSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ¤– AI Recommendations</span>
                    </a>
                    <a href="#" class="nav-item" data-section="factorAnalysisSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('factorAnalysisSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ“Š Factor Analysis</span>
                    </a>
                    <a href="#" class="nav-item" data-section="backtestSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('backtestSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ“Š Backtest</span>
                    </a>
                    <a href="#" class="nav-item" data-section="screenerSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('screenerSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ” Stock Screener</span>
                    </a>
                </div>
            </div>
            
            <!-- Market Data Group -->
            <div class="nav-group">
                <div class="nav-group-header" onclick="if(typeof window.toggleNavGroup === 'function') { window.toggleNavGroup('marketData'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                    <span class="nav-group-icon">ðŸ“°</span>
                    <span class="nav-group-title">Market Data</span>
                    <span class="nav-group-chevron" id="chevron-marketData">â–¼</span>
                </div>
                <div class="nav-group-items" id="nav-group-marketData">
                    <a href="#" class="nav-item" data-section="newsSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('newsSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ“° News</span>
                    </a>
                    <a href="#" class="nav-item" data-section="earningsCalendarSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('earningsCalendarSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ“… Earnings Calendar</span>
                    </a>
                    <a href="#" class="nav-item" data-section="economicCalendarSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('economicCalendarSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ“Š Economic Data</span>
                    </a>
                </div>
            </div>
            
            <!-- Portfolio & Tracking Group -->
            <div class="nav-group">
                <div class="nav-group-header" onclick="if(typeof window.toggleNavGroup === 'function') { window.toggleNavGroup('portfolio'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                    <span class="nav-group-icon">ðŸ’¼</span>
                    <span class="nav-group-title">Portfolio & Tracking</span>
                    <span class="nav-group-chevron" id="chevron-portfolio">â–¼</span>
                </div>
                <div class="nav-group-items" id="nav-group-portfolio">
                    <a href="#" class="nav-item" data-section="portfolioSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('portfolioSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ’¼ Portfolio</span>
                    </a>
                    <a href="#" class="nav-item" data-section="alertsDashboardSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('alertsDashboardSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ”” Alerts Dashboard</span>
                    </a>
                    <a href="#" class="nav-item" data-section="watchlistSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('watchlistSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>â­ Watchlist</span>
                    </a>
                </div>
            </div>
            
            <!-- Research Group -->
            <div class="nav-group">
                <div class="nav-group-header" onclick="if(typeof window.toggleNavGroup === 'function') { window.toggleNavGroup('research'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                    <span class="nav-group-icon">ðŸ”</span>
                    <span class="nav-group-title">Research</span>
                    <span class="nav-group-chevron" id="chevron-research">â–¼</span>
                </div>
                <div class="nav-group-items" id="nav-group-research">
                    <a href="#" class="nav-item" data-section="analystInsiderSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('analystInsiderSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ‘” Analyst & Insider</span>
                    </a>
                    <a href="#" class="nav-item" data-section="socialSentimentSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('socialSentimentSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ’¬ Social Sentiment</span>
                    </a>
                </div>
            </div>
            
            <!-- Learn Group -->
            <div class="nav-group">
                <div class="nav-group-header" onclick="if(typeof window.toggleNavGroup === 'function') { window.toggleNavGroup('learn'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                    <span class="nav-group-icon">ðŸŽ“</span>
                    <span class="nav-group-title">Learn</span>
                    <span class="nav-group-chevron" id="chevron-learn">â–¼</span>
                </div>
                <div class="nav-group-items" id="nav-group-learn">
                    <a href="#" class="nav-item" data-section="educationSection" onclick="if(typeof window.navigateToSection === 'function') { window.navigateToSection('educationSection'); } else { console.error('navigateToSection not available'); alert('Please wait, page is still loading...'); } return false;">
                        <span>ðŸ“š Educational Content</span>
                    </a>
                </div>
            </div>
            
            <!-- Settings (no group) -->
            <div class="nav-group">
                <a href="#" class="nav-item nav-item-single" data-section="settingsSection" onclick="if(typeof navigateToSection === 'function') { navigateToSection('settingsSection'); } else { showSettings(); } return false;">
                    <span class="nav-group-icon">âš™ï¸</span>
                    <span>Settings</span>
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-button" onclick="toggleSidebar()" title="Toggle Menu">
        â˜°
    </button>
    
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 15px; justify-content: flex-end; margin-bottom: 20px; flex-wrap: wrap;">
                <div class="global-search-container" style="position: relative; max-width: 400px; width: 100%; min-width: 250px; flex: 1;">
                    <input type="search" id="globalSearchInput" 
                           placeholder="ðŸ” Search ticker..." 
                           inputmode="search"
                           autocomplete="off"
                           style="width: 100%; padding: 12px 40px 12px 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 1em; backdrop-filter: blur(10px); box-sizing: border-box;"
                           oninput="handleGlobalSearch(event)"
                           onfocus="showSearchDropdown()"
                           onkeydown="handleSearchKeydown(event)" />
                    <button id="clearSearchBtn" onclick="clearGlobalSearch()" style="display: none; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: white; cursor: pointer; font-size: 1.2em; padding: 5px; z-index: 10;">Ã—</button>
                    <div id="globalSearchDropdown" class="search-dropdown hidden" style="position: absolute; top: 100%; left: 0; right: 0; margin-top: 5px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); max-height: 500px; overflow-y: auto; z-index: 1001; min-width: 100%;">
                        <!-- Recent Searches -->
                        <div id="recentSearchesSection" class="search-dropdown-section" style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                            <div class="search-dropdown-header" style="font-weight: 600; color: var(--text-secondary); font-size: 0.85em; padding: 8px 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                Recent Searches
                                <button onclick="clearRecentSearches()" style="float: right; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.8em;">Clear</button>
                            </div>
                            <div id="recentSearchesList"></div>
                        </div>
                        <!-- Favorites -->
                        <div id="favoritesSection" class="search-dropdown-section" style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                            <div class="search-dropdown-header" style="font-weight: 600; color: var(--text-secondary); font-size: 0.85em; padding: 8px 12px; text-transform: uppercase; letter-spacing: 0.5px;">â­ Favorites</div>
                            <div id="favoritesList"></div>
                        </div>
                        <!-- Search Results -->
                        <div id="searchResultsSection" class="search-dropdown-section hidden" style="padding: 10px;">
                            <div class="search-dropdown-header" style="font-weight: 600; color: var(--text-secondary); font-size: 0.85em; padding: 8px 12px; text-transform: uppercase; letter-spacing: 0.5px;">Search Results</div>
                            <div id="searchResultsList"></div>
                        </div>
                    </div>
                </div>
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                    <span id="darkModeIcon">ðŸŒ™</span>
                </button>
                <button class="dark-mode-toggle" onclick="if(typeof window.showSettings === 'function') { window.showSettings(); } else { console.error('showSettings not found'); }" title="Settings" style="margin-left: 10px;">
                    <span>âš™ï¸</span>
                </button>
            </div>
            <h1>ðŸ“ˆ Stock Analysis Tool</h1>
            <p>Your comprehensive platform for stock analysis and market insights</p>
        </div>

        <!-- Welcome Section -->
        <div id="welcomeSection" class="welcome-section hidden">
            <div class="welcome-header">
                <h2>Welcome to Stock Analysis Tool! ðŸ‘‹</h2>
                <p>Get started with professional stock analysis in just a few clicks. Perfect for beginners and experienced investors alike.</p>
            </div>
            
            <div class="quick-start-grid">
                <div class="quick-start-card" onclick="showStockAnalysis(); document.getElementById('tickerInput').focus();">
                    <div style="position: relative;">
                        <div class="quick-start-card-icon">ðŸ“ˆ</div>
                        <div style="position: absolute; top: -10px; right: -10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 12px; border-radius: 20px; font-size: 0.7em; font-weight: 700; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">POPULAR</div>
                    </div>
                    <h3>Stock Analysis</h3>
                    <p>Enter a stock ticker (like AAPL or MSFT) to see detailed charts, technical indicators, financial metrics, earnings data, and AI-powered news sentiment analysis.</p>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(102, 126, 234, 0.2); display: flex; align-items: center; gap: 8px; color: #667eea; font-weight: 600; font-size: 0.9em;">
                        <span>Get Started â†’</span>
                    </div>
                </div>
                
                <div class="quick-start-card" onclick="if(typeof window.showNews === 'function') { window.showNews(); setTimeout(function() { const input = document.getElementById('newsTickerInput'); if(input) input.focus(); }, 300); } else { console.error('showNews not available'); alert('Loading... Please wait a moment and try again.'); }">
                    <div style="position: relative;">
                        <div class="quick-start-card-icon">ðŸ“°</div>
                        <div style="position: absolute; top: -10px; right: -10px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 8px 12px; border-radius: 20px; font-size: 0.7em; font-weight: 700; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">NEW</div>
                    </div>
                    <h3>News</h3>
                    <p>Get the latest news for any stock with AI sentiment analysis. Enter a ticker to see news articles with sentiment indicators and impact scores.</p>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(102, 126, 234, 0.2); display: flex; align-items: center; gap: 8px; color: #667eea; font-weight: 600; font-size: 0.9em;">
                        <span>Try It Now â†’</span>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">6+</div>
                    <div class="stat-label">Analysis Tools</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">AI</div>
                    <div class="stat-label">Sentiment Analysis</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">24/7</div>
                    <div class="stat-label">Real-time Data</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">100%</div>
                    <div class="stat-label">Free to Use</div>
                </div>
            </div>

            <div class="features-showcase">
                <div class="feature-item">
                    <div class="feature-icon">ðŸ“Š</div>
                    <div class="feature-content">
                        <h4>Technical Analysis</h4>
                        <p>Advanced charts with RSI, MACD, Bollinger Bands, and moving averages</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ðŸ’°</div>
                    <div class="feature-content">
                        <h4>Financial Metrics</h4>
                        <p>Comprehensive financial health analysis with company stage detection</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ðŸ“°</div>
                    <div class="feature-content">
                        <h4>AI News Analysis</h4>
                        <p>Real-time news with AI-powered sentiment analysis from StockTitan</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ðŸ‘”</div>
                    <div class="feature-content">
                        <h4>Insider Trading</h4>
                        <p>Track insider purchases and sales from official SEC filings</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ðŸŽ¯</div>
                    <div class="feature-content">
                        <h4>Analyst Ratings</h4>
                        <p>See individual analyst recommendations and price targets</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ðŸ””</div>
                    <div class="feature-content">
                        <h4>Price Alerts</h4>
                        <p>Set target prices and get browser notifications when reached</p>
                    </div>
                </div>
            </div>

            <div class="help-text" style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); border-radius: 20px; border: 2px solid rgba(102, 126, 234, 0.15); position: relative; z-index: 1;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <span style="font-size: 2em;">ðŸ’¡</span>
                    <strong style="font-size: 1.3em; color: var(--text-primary);">Quick Tips</strong>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="color: #667eea; font-weight: bold; font-size: 1.2em;">â†’</span>
                        <span style="color: var(--text-secondary); line-height: 1.7;">Stock tickers are 1-5 letter codes (e.g., <strong>AAPL</strong> for Apple)</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="color: #667eea; font-weight: bold; font-size: 1.2em;">â†’</span>
                        <span style="color: var(--text-secondary); line-height: 1.7;">Use dark mode toggle (ðŸŒ™) to switch themes</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="color: #667eea; font-weight: bold; font-size: 1.2em;">â†’</span>
                        <span style="color: var(--text-secondary); line-height: 1.7;">Hover over metrics for detailed explanations</span>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="color: #667eea; font-weight: bold; font-size: 1.2em;">â†’</span>
                        <span style="color: var(--text-secondary); line-height: 1.7;">Click news articles to read full stories</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Watchlist Section -->
        <div id="newsSection" class="hidden">
            <div class="card">
                <h2>ðŸ“° News</h2>
                <div class="section-description">
                    Get the latest news for any stock with AI sentiment analysis. Enter a ticker symbol to see news articles with sentiment indicators, impact scores, and thumbnails.
                </div>
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="newsTickerInput" placeholder="Enter ticker (e.g., AAPL, MSFT, TSLA)" inputmode="text" autocomplete="off" style="flex: 1; min-width: 200px; max-width: 400px; padding: 12px; border: 2px solid var(--input-border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text-primary);" onkeypress="if(event.key === 'Enter') loadNewsForTicker()" />
                        <button onclick="loadNewsForTicker()" id="loadNewsBtn" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">ðŸ“° Load News</button>
                        <button onclick="addNewsTickerToNewsAlerts()" id="addNewsTickerToAlertsBtn" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); transition: all 0.3s ease; display: none;">ðŸ“° Add to News Alerts</button>
                        <button onclick="generateNewsAISummary()" id="newsAISummaryBtn" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; display: none;">ðŸ¤– AI Summary</button>
                    </div>
                </div>
                <div id="newsContent"></div>
            </div>
        </div>

        <!-- Earnings Calendar Section -->
        <div id="earningsCalendarSection" class="hidden">
            <div class="card">
                <h2>ðŸ“… Earnings Calendar</h2>
                <div class="section-description">
                    View upcoming earnings reports for popular stocks. Click on any stock to see its detailed analysis. Earnings dates are updated regularly.
                </div>
                
                <div class="earnings-calendar-filters">
                    <button class="earnings-filter-btn active" onclick="filterEarnings('all')">All</button>
                    <button class="earnings-filter-btn" onclick="filterEarnings('this-week')">This Week</button>
                    <button class="earnings-filter-btn" onclick="filterEarnings('this-month')">This Month</button>
                    <button class="earnings-filter-btn" onclick="filterEarnings('next-month')">Next Month</button>
                </div>

                <div id="earningsCalendarContent">
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text" style="width: 80%;"></div>
                        <div style="margin-top: 20px;">
                            <div class="skeleton skeleton-table-row"></div>
                            <div class="skeleton skeleton-table-row"></div>
                            <div class="skeleton skeleton-table-row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Economic Calendar Section -->
        <div id="economicCalendarSection" class="hidden">
            <div class="card">
                <h2>ðŸ“Š Economic Data</h2>
                <div class="section-description">
                    Track important economic events and indicators that can impact the markets. View upcoming releases for GDP, employment, inflation, and other key economic data.
                </div>
                
                <div class="economic-calendar-filters" style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap;">
                    <button class="economic-filter-btn active" onclick="filterEconomicCalendar('all')" style="padding: 10px 20px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); cursor: pointer; transition: all 0.3s; font-weight: 600;">All</button>
                    <button class="economic-filter-btn" onclick="filterEconomicCalendar('today')" style="padding: 10px 20px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); cursor: pointer; transition: all 0.3s; font-weight: 600;">Today</button>
                    <button class="economic-filter-btn" onclick="filterEconomicCalendar('tomorrow')" style="padding: 10px 20px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); cursor: pointer; transition: all 0.3s; font-weight: 600;">Tomorrow</button>
                    <button class="economic-filter-btn" onclick="filterEconomicCalendar('this-week')" style="padding: 10px 20px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); cursor: pointer; transition: all 0.3s; font-weight: 600;">This Week</button>
                    <button class="economic-filter-btn" onclick="filterEconomicCalendar('next-week')" style="padding: 10px 20px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); cursor: pointer; transition: all 0.3s; font-weight: 600;">Next Week</button>
                </div>

                <div id="economicCalendarContent">
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text" style="width: 80%;"></div>
                        <div style="margin-top: 20px;">
                            <div class="skeleton skeleton-table-row"></div>
                            <div class="skeleton skeleton-table-row"></div>
                            <div class="skeleton skeleton-table-row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Section -->
        <div id="portfolioSection" class="hidden">
            <div class="card">
                <h2>ðŸ’¼ Portfolio Tracker</h2>
                <div class="section-description">
                    Track your stock portfolio performance. Add positions manually or import from CSV. Monitor P&L, percentage gains/losses, and sector allocation.
                </div>
                
                <!-- Portfolio Tabs -->
                <div style="display: flex; gap: 10px; margin: 25px 0; border-bottom: 2px solid var(--border-color); flex-wrap: wrap;">
                    <button class="portfolio-tab-btn active" onclick="switchPortfolioTab('add')" style="padding: 12px 24px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s;">âž• Add Position</button>
                    <button class="portfolio-tab-btn" onclick="switchPortfolioTab('import')" style="padding: 12px 24px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ“¥ Import CSV</button>
                    <button class="portfolio-tab-btn" onclick="switchPortfolioTab('view')" style="padding: 12px 24px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ“Š Portfolio View</button>
                    <button class="portfolio-tab-btn" onclick="switchPortfolioTab('performance')" style="padding: 12px 24px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ“ˆ Performance</button>
                </div>

                <!-- Add Position Tab -->
                <div id="portfolioAddTab" class="portfolio-tab-content">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary);">Add New Position</h3>
                        <form id="addPositionForm" onsubmit="event.preventDefault(); addPosition();">
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Ticker Symbol *</label>
                                    <input type="text" id="portfolioTickerInput" placeholder="e.g., AAPL, MSFT" required inputmode="text" autocomplete="off" style="width: 100%; padding: 12px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); font-size: 1em;" />
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Number of Shares *</label>
                                    <input type="number" id="portfolioSharesInput" placeholder="e.g., 10" required min="0.0001" step="0.0001" inputmode="decimal" style="width: 100%; padding: 12px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); font-size: 1em;" />
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Purchase Price *</label>
                                    <input type="number" id="portfolioPriceInput" placeholder="e.g., 150.50" required min="0.01" step="0.01" inputmode="decimal" style="width: 100%; padding: 12px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); font-size: 1em;" />
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 600;">Purchase Date</label>
                                    <input type="date" id="portfolioDateInput" style="width: 100%; padding: 12px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); font-size: 1em;" />
                                </div>
                                <button type="submit" style="padding: 14px 28px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">Add Position</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Import CSV Tab -->
                <div id="portfolioImportTab" class="portfolio-tab-content hidden">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary);">Import Positions from CSV</h3>
                        <div style="padding: 30px; border: 2px dashed var(--border-color); border-radius: 12px; text-align: center; background: var(--metric-bg);">
                            <div style="font-size: 3em; margin-bottom: 15px;">ðŸ“¥</div>
                            <p style="margin-bottom: 20px; color: var(--text-secondary);">Upload a CSV file with your positions</p>
                            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)" />
                            <button onclick="document.getElementById('csvFileInput').click()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Choose CSV File</button>
                            <div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; text-align: left;">
                                <p style="font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">CSV Format:</p>
                                <code style="display: block; padding: 10px; background: var(--bg-card); border-radius: 6px; color: var(--text-primary); font-size: 0.9em;">
                                    ticker,shares,purchase_price,purchase_date<br/>
                                    AAPL,10,150.50,2024-01-15<br/>
                                    MSFT,5,380.25,2024-02-20
                                </code>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio View Tab -->
                <div id="portfolioViewTab" class="portfolio-tab-content hidden">
                    <div id="portfolioTableContainer">
                        <div class="skeleton-card">
                            <div class="skeleton skeleton-title"></div>
                            <div class="skeleton skeleton-table-row"></div>
                            <div class="skeleton skeleton-table-row"></div>
                            <div class="skeleton skeleton-table-row"></div>
                        </div>
                    </div>
                </div>

                <!-- Performance Tab -->
                <div id="portfolioPerformanceTab" class="portfolio-tab-content hidden">
                    <div id="portfolioPerformanceContainer">
                        <div class="skeleton-card">
                            <div class="skeleton skeleton-title"></div>
                            <div class="skeleton skeleton-chart"></div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                                <div class="skeleton skeleton-metric" style="height: 2em;"></div>
                                <div class="skeleton skeleton-metric" style="height: 2em;"></div>
                                <div class="skeleton skeleton-metric" style="height: 2em;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Economic Event Explanation Modal -->
        <div id="economicEventModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; overflow-y: auto;">
            <div style="position: relative; max-width: 700px; margin: 50px auto; background: var(--bg-primary); border-radius: 16px; padding: 30px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                <button onclick="closeEconomicEventModal()" style="position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 2em; color: var(--text-secondary); cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s;" onmouseover="this.style.background='rgba(102, 126, 234, 0.1)'; this.style.color='#667eea'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'">Ã—</button>
                
                <div id="economicEventModalContent">
                    <div style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 20px; color: var(--text-secondary);">Loading explanation...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Watchlist Section -->
        <div id="watchlistSection" class="hidden">
            <div class="card">
                <h2>â­ Watchlist</h2>
                <div class="section-description">
                    Manage your stock watchlist. Add stocks to track, organize them into groups, and quickly access your favorite tickers.
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="watchlistTickerInput" placeholder="Enter ticker symbol (e.g., AAPL)" inputmode="text" autocomplete="off" onkeypress="if(event.key==='Enter') addToWatchlistFromInput()" style="flex: 1; min-width: 200px; max-width: 300px; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg-primary); color: var(--text-primary); font-size: 1em;" />
                        <button onclick="addToWatchlistFromInput()" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">+ Add to Watchlist</button>
                        <button onclick="showWatchlistGroupManager(event)" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;">ðŸ“ Manage Groups</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="watchlistSearchInputMain" placeholder="ðŸ” Search watchlist..." oninput="filterWatchlistMain()" style="width: 100%; max-width: 500px; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg-primary); color: var(--text-primary); font-size: 1em;" />
                    </div>
                    
                    <div id="watchlistMainContent">
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 3em; margin-bottom: 20px;">â­</div>
                            <p>Your watchlist is empty. Add stocks to track them here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Factor Analysis Section -->
        <div id="factorAnalysisSection" class="hidden">
            <div class="card">
                <h2>ðŸ“Š Factor Analysis</h2>
                <div class="section-description">
                    Analyze stocks based on investment factors: Value, Growth, Momentum, and Quality. Each factor is scored 0-100 based on relevant financial and technical metrics.
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <input type="text" id="factorAnalysisTicker" placeholder="Enter ticker symbol (e.g., AAPL)" onkeypress="if(event.key==='Enter') loadFactorAnalysis()" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg-primary); color: var(--text-primary); font-size: 1em;" />
                        <button onclick="loadFactorAnalysis()" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">ðŸ” Analyze Factors</button>
                    </div>
                    
                    <div id="factorAnalysisContent">
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <p>Enter a ticker symbol and click "Analyze Factors" to see factor scores.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financials Section -->
        <div id="aiRecommendationsSection" class="hidden">
            <div class="card">
                <h2>ðŸ¤– AI Recommendations</h2>
                <div class="section-description">
                    Get AI-powered stock recommendations based on technical analysis, price momentum, and news sentiment. This analysis combines multiple indicators to provide actionable insights.
                    <br><br>
                    <div style="padding: 15px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 10px; border-left: 4px solid #667eea; margin: 15px 0;">
                        <strong style="color: #667eea;">ðŸš€ UnikÃ¡tnÃ­ ML/AI Funkce:</strong>
                        <p style="margin: 8px 0 0 0; line-height: 1.6;">Tato aplikace nabÃ­zÃ­ <strong>ML price predictions a AI recommendations zdarma</strong> - funkce, kterÃ© vÄ›tÅ¡ina konkurenÄnÃ­ch platforem buÄ nemÃ¡ vÅ¯bec, nebo jsou placenÃ©. Kombinace ML predikcÃ­, trend classification, a technickÃ© analÃ½zy poskytuje komplexnÃ­ pohled na investiÄnÃ­ pÅ™Ã­leÅ¾itost.</p>
                    </div>
                    <strong>How it works:</strong> AI analyzuje 50+ features (technickÃ© indikÃ¡tory, fundamentÃ¡lnÃ­ metriky, sentiment, market context) pomocÃ­ 3 ML modelÅ¯:
                    <ul style="margin-top: 10px; padding-left: 25px; line-height: 1.8; text-align: left;">
                        <li><strong>Price Prediction Model:</strong> PÅ™edpovÃ­dÃ¡ cenu za 1, 3, 6, 12 mÄ›sÃ­cÅ¯ s confidence intervals a hybridnÃ­m pÅ™Ã­stupem (ML + momentum blending)</li>
                        <li><strong>Trend Classification Model:</strong> Klasifikuje trend do 5 kategoriÃ­ (Strong Uptrend â†’ Strong Downtrend) s probabilities</li>
                        <li><strong>Risk Scoring Model:</strong> PoÄÃ­tÃ¡ risk score (0-100) na zÃ¡kladÄ› volatility, beta, financial health, liquidity a dalÅ¡Ã­ch faktorÅ¯</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">KliknÄ›te na "â„¹ï¸ What is this?" u kaÅ¾dÃ© sekce pro detailnÃ­ vysvÄ›tlenÃ­.</p>
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <input type="text" id="aiRecommendationsTicker" placeholder="Enter ticker symbol (e.g., AAPL)" onkeypress="if(event.key==='Enter') loadAIRecommendations()" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg-primary); color: var(--text-primary); font-size: 1em;" />
                        <button onclick="loadAIRecommendations()" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">ðŸ” Get Recommendations</button>
                    </div>
                    
                    <div id="aiRecommendationsContent">
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <p>Enter a ticker symbol and click "Get Recommendations" to see AI-powered analysis.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Social Sentiment Section -->
        <div id="socialSentimentSection" class="hidden">
            <div class="card">
                <h2>ðŸ’¬ Social Sentiment</h2>
                <div class="section-description">
                    Analyze social media sentiment from Reddit, Twitter/X, and StockTwits. Track what the crowd is saying about stocks in your watchlist.
                    <br><br>
                    <strong>How it works:</strong> Aggregates sentiment from multiple social platforms, identifies key topics, and provides AI-powered insights about market sentiment trends.
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="socialSentimentTicker" placeholder="Enter ticker symbol (e.g., AAPL)" onkeypress="if(event.key==='Enter') loadSocialSentiment()" style="flex: 1; min-width: 200px; max-width: 300px; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg-primary); color: var(--text-primary); font-size: 1em;" />
                        <button onclick="loadSocialSentiment()" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">ðŸ” Analyze Sentiment</button>
                        <button onclick="loadWatchlistSocialSentiment()" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;">â­ Watchlist Overview</button>
                        <select id="socialSentimentTimeRange" onchange="if(document.getElementById('socialSentimentTicker').value) loadSocialSentiment()" style="padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg-primary); color: var(--text-primary); font-size: 1em; cursor: pointer;">
                            <option value="7">Last 7 Days</option>
                            <option value="3">Last 3 Days</option>
                            <option value="1">Last Day</option>
                            <option value="30">Last 30 Days</option>
                        </select>
                        <button onclick="exportSocialSentiment()" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); transition: all 0.3s ease;">ðŸ“¥ Export</button>
                    </div>
                    
                    <div id="socialSentimentContent">
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 3em; margin-bottom: 20px;">ðŸ’¬</div>
                            <p>Enter a ticker symbol or click "Watchlist Overview" to see social sentiment analysis.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="financialsSection" class="hidden">
            <div class="card">
                <h2>ðŸ’° Financials</h2>
                <div class="section-description">
                    Jak si firma skuteÄnÄ› vede â€“ bez Å¡umu trhu. KomplexnÃ­ analÃ½za fundamentÃ¡lnÃ­ch ukazatelÅ¯.<br>
                    <span style="font-size: 0.85em; opacity: 0.8;">ðŸ“Š Data pochÃ¡zejÃ­ z oficiÃ¡lnÃ­ch SEC reportÅ¯ (10-K, 10-Q) pÅ™es Yahoo Finance</span>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div class="search-box" style="max-width: 500px; margin: 0 auto; position: relative;">
                        <div style="flex: 1; min-width: 200px; position: relative; z-index: 10001;">
                            <input type="text" id="financialsTickerInput" placeholder="Enter stock ticker or company name (e.g., AAPL, Apple, MSFT)" style="width: 100%;" />
                            <div id="financialsAutocomplete" class="autocomplete-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 10000;"></div>
                        </div>
                        <button onclick="loadFinancials(); addRippleEffect(event)" class="ripple-effect">ðŸ” Load Financials</button>
                    </div>
                </div>

                <div id="financialsContent">
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 3em; margin-bottom: 20px;">ðŸ’°</div>
                        <h3>Enter a stock ticker to view financials</h3>
                        <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.7;">Get comprehensive financial analysis including revenue, earnings, cash flow, margins, and more.</p>
                    </div>
                </div>
                
                <!-- Financials Tabs (always visible, hidden content until data is loaded) -->
                <div id="financialsTabsContainer" style="margin-top: 20px; display: none;">
                    <div class="financials-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color);">
                        <button class="financials-tab-btn active" data-tab="overview" onclick="if(typeof switchFinancialsTab === 'function') { switchFinancialsTab('overview'); } else { console.error('switchFinancialsTab not available'); } return false;" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid var(--primary-500); color: var(--primary-500); cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.3s ease; position: relative; top: 2px;">Overview</button>
                        <button class="financials-tab-btn" data-tab="detailed" onclick="if(typeof switchFinancialsTab === 'function') { switchFinancialsTab('detailed'); } else { console.error('switchFinancialsTab not available'); } return false;" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.3s ease; position: relative; top: 2px;">Detailed Financials</button>
                    </div>
                    <div id="financialsOverviewTab" class="financials-tab-content active" style="display: block;">
                        <!-- Current overview content will be moved here -->
                        <div style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading overview data...</div>
                    </div>
                    <div id="financialsDetailedTab" class="financials-tab-content" style="display: none;">
                        <!-- Detailed financials table will be rendered here -->
                        <div id="detailedFinancialsContent" style="padding: 20px; text-align: center; color: var(--text-secondary);">
                            <p>Click "Load Financials" first, then switch to this tab to see detailed data.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analyst & Insider Section -->
        <div id="analystInsiderSection" class="hidden">
            <div class="card">
                <h2>ðŸ“Š Analyst Ratings & Insider Trading</h2>
                <div class="section-description">
                    View analyst recommendations, price targets, and insider trading activity. Analyst ratings show what Wall Street thinks, while insider trading can indicate management confidence.
                </div>
                
                <div style="margin-top: 30px;">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" id="analystInsiderTickerInput" placeholder="Enter stock ticker (e.g., AAPL)" />
                            <button onclick="loadAnalystInsider(); addRippleEffect(event)" class="ripple-effect">ðŸ” Load Data</button>
                        </div>
                    </div>
                </div>
                
                <div id="analystInsiderContent" style="margin-top: 30px;"></div>
            </div>
        </div>

        <!-- Alerts Dashboard Section -->
        <div id="alertsDashboardSection" class="hidden">
            <div class="card">
                <h2>ðŸ”” Alerts Dashboard</h2>
                <div class="section-description">
                    Central hub for all your stock alerts. View price alerts, upcoming earnings, and important news from your watchlist in one place.
                </div>
                
                <div style="margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <button onclick="loadAlertsDashboard()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">ðŸ”„ Refresh Alerts</button>
                    <button onclick="showAlertsHistory()" id="alertsHistoryBtn" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;">ðŸ“œ Alert History</button>
                    <button onclick="clearAlertsHistory()" style="padding: 12px 24px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); transition: all 0.3s ease;">ðŸ—‘ï¸ Clear History</button>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="alerts-filter-btn active" onclick="filterAlerts('all')" data-filter="all">All Alerts</button>
                        <button class="alerts-filter-btn" onclick="filterAlerts('price')" data-filter="price">ðŸ’° Price</button>
                        <button class="alerts-filter-btn" onclick="filterAlerts('earnings')" data-filter="earnings">ðŸ“… Earnings</button>
                        <button class="alerts-filter-btn" onclick="filterAlerts('news')" data-filter="news">ðŸ“° News</button>
                    </div>
                </div>

                <div id="alertsDashboardContent">
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-news-item"></div>
                        <div class="skeleton skeleton-news-item"></div>
                        <div class="skeleton skeleton-news-item"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Latest Updates Section -->
        <div id="latestUpdatesSection" style="margin-bottom: 30px;">
            <div class="card" style="background: var(--gradient-primary); padding: 0; overflow: hidden; position: relative;">
                <div style="padding: 30px; position: relative; z-index: 2;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h2 style="margin: 0; color: white; font-size: 1.8em; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                                <span>ðŸ“¢</span> Latest Updates
                            </h2>
                            <p style="margin: 8px 0 0 0; color: rgba(255, 255, 255, 0.9); font-size: 0.95em;" id="appVersion">
                                Version <span id="versionNumber">-</span>
                            </p>
                        </div>
                        <button onclick="toggleUpdatesSection()" style="padding: 10px 20px; background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; color: white; cursor: pointer; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            <span id="updatesToggleText">â–¼ Collapse</span>
                        </button>
                    </div>
                    
                    <div id="updatesContent" style="color: white;">
                        <div style="text-align: center; padding: 40px;">
                            <div class="spinner" style="border-top-color: white; border-color: rgba(255, 255, 255, 0.3);"></div>
                            <p style="margin-top: 20px; color: rgba(255, 255, 255, 0.9);">Loading updates...</p>
                        </div>
                    </div>
                </div>
                <div style="position: absolute; top: 0; right: 0; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); border-radius: 50%; transform: translate(30%, -30%); pointer-events: none;"></div>
            </div>
        </div>

        <!-- Stock Analysis Section -->
        <div id="stockAnalysisSection" class="hidden">
        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 30px; margin-bottom: 30px;">
            <div class="search-container" style="margin-bottom: 0; position: relative;">
                <div class="search-box" style="display: flex; gap: 5px; flex-wrap: wrap; position: relative;">
                    <div style="flex: 1; min-width: 200px; position: relative; z-index: 10001;">
                        <input type="text" id="tickerInput" placeholder="Enter stock ticker or company name (e.g., AAPL, Apple, MSFT)" style="width: 100%;" oninput="handleTickerInputDirect(event)" onfocus="showAutocompleteDirect()" />
                        <div id="tickerAutocomplete" class="autocomplete-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 10000; width: 100%;"></div>
                    </div>
                    <button onclick="searchStock(event)" class="ripple-effect">ðŸ” Analyze</button>
                    <button onclick="addCurrentTickerToNewsAlerts()" id="addToNewsAlertsBtn" class="ripple-effect" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); display: none;" title="Add to News Alerts">ðŸ“° Add to News Alerts</button>
                </div>
                <div class="help-text" style="margin-top: 30px;">
                    <strong>ðŸ“Œ What is a stock ticker?</strong> A ticker symbol is a unique code used to identify a publicly traded company's stock. Examples: AAPL (Apple), MSFT (Microsoft), TSLA (Tesla), GOOGL (Google).
                </div>
            </div>

            <!-- Watchlist Sidebar - Always Visible -->
            <div class="watchlist-sidebar">
                <div class="watchlist-header">
                    <h3>â­ My Watchlist</h3>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="event.stopPropagation(); showWatchlistGroupManager(event); return false;" class="ripple-effect" style="padding: 6px 10px; background: rgba(102, 126, 234, 0.1); color: #667eea; border: 1px solid #667eea; border-radius: 6px; font-size: 0.8em; font-weight: 600; cursor: pointer; transition: all 0.3s;" title="Manage groups">ðŸ“</button>
                        <button onclick="event.stopPropagation(); addCurrentToWatchlist(event); return false;" class="ripple-effect" style="padding: 6px 12px; background: rgba(102, 126, 234, 0.1); color: #667eea; border: 1px solid #667eea; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.3s;" title="Add current stock to watchlist">+ Add</button>
                    </div>
                </div>
                <div style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                    <input type="text" id="watchlistSearchInput" placeholder="ðŸ” Search watchlist..." oninput="filterWatchlist()" style="width: 100%; padding: 8px 12px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 0.9em; background: var(--input-bg); color: var(--text-primary);" />
                </div>
                <div id="watchlistSidebarContent">
                    <div class="watchlist-empty">
                        <div class="watchlist-empty-icon">â­</div>
                        <p>Your watchlist is empty</p>
                        <p style="font-size: 0.85em; margin-top: 10px; opacity: 0.7;">Add stocks to track them here</p>
                    </div>
                </div>
                <div class="watchlist-add-section">
                    <div class="watchlist-add-input">
                        <input type="text" id="watchlistQuickAdd" placeholder="Add ticker..." onkeypress="if(event.key==='Enter') { event.preventDefault(); addToWatchlistQuick(event); }" />
                        <button onclick="addToWatchlistQuick(event); return false;" class="ripple-effect">+</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="results" class="hidden">
            <div class="content" style="grid-template-columns: 2fr 1fr;">
                <div>
                <div class="card">
                    <div class="stock-header">
                        <div class="stock-title">
                            <h3 id="stockName">-</h3>
                            <p id="stockSector">-</p>
                            <div id="dataFreshnessIndicator" class="data-freshness-indicator" style="display: none;">
                                <span id="dataLastUpdated">-</span>
                                <button id="refreshDataBtn" class="refresh-data-btn ripple-effect" onclick="refreshCurrentStock(event)" style="display: none;" title="Refresh data">
                                    ðŸ”„ Refresh
                                </button>
                            </div>
                        </div>
                        <div class="price-info">
                            <div class="price" id="currentPrice">-</div>
                            <div class="price-change" id="priceChange">-</div>
                        </div>
                    </div>

                    <!-- Quick Actions Toolbar -->
                    <div id="quickActionsToolbar" class="quick-actions-toolbar" style="display: none; margin-bottom: 20px; padding: 15px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <span style="font-weight: 600; color: var(--text-primary); margin-right: 5px;">Quick Actions:</span>
                            <button onclick="addCurrentStockToWatchlist()" class="quick-action-btn" title="Add to Watchlist">
                                â­ Add to Watchlist
                            </button>
                            <button onclick="setPriceAlert()" class="quick-action-btn" title="Set Price Alert">
                                ðŸ”” Set Alert
                            </button>
                            <button onclick="compareStocks()" class="quick-action-btn" title="Compare Stocks">
                                ðŸ“Š Compare
                            </button>
                            <button onclick="exportChart('png')" class="quick-action-btn" title="Export Chart as PNG">
                                ðŸ“¥ Export PNG
                            </button>
                            <button onclick="exportChart('svg')" class="quick-action-btn" title="Export Chart as SVG">
                                ðŸ“¥ Export SVG
                            </button>
                        </div>
                    </div>

                    <div class="timeframe-selector" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
                        <!-- Intraday timeframes - only visible for candlestick chart -->
                        <div id="intradayTimeframes" style="display: none; gap: 8px; flex-wrap: wrap;">
                            <button class="timeframe-btn" onclick="changeTimeframe('1m')" data-period="1m">1M</button>
                            <button class="timeframe-btn" onclick="changeTimeframe('5m')" data-period="5m">5M</button>
                            <button class="timeframe-btn" onclick="changeTimeframe('15m')" data-period="15m">15M</button>
                            <button class="timeframe-btn" onclick="changeTimeframe('1h')" data-period="1h">1H</button>
                            <button class="timeframe-btn" onclick="changeTimeframe('4h')" data-period="4h">4H</button>
                            <button class="timeframe-btn" onclick="changeTimeframe('1d')" data-period="1d">1D</button>
                            <button class="timeframe-btn" onclick="changeTimeframe('1w')" data-period="1w">1W</button>
                        </div>
                        <!-- Standard timeframes - always visible -->
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="timeframe-btn" onclick="changeTimeframe('5d')" data-period="5d">5D</button>
                            <button class="timeframe-btn" onclick="changeTimeframe('1mo')" data-period="1mo">1M</button>
                            <button class="timeframe-btn" onclick="changeTimeframe('3mo')" data-period="3mo">3M</button>
                            <button class="timeframe-btn" onclick="changeTimeframe('6mo')" data-period="6mo">6M</button>
                            <button class="timeframe-btn active" onclick="changeTimeframe('1y')" data-period="1y">1Y</button>
                            <button class="timeframe-btn" onclick="changeTimeframe('5y')" data-period="5y">5Y</button>
                        </div>
                    </div>

                    <div class="indicator-toggle">
                        <button class="toggle-btn active tooltip" onclick="toggleIndicator('sma')">SMA (20/50)<span class="tooltiptext">Simple Moving Average - Average price over 20/50 days. Helps identify trends.</span></button>
                        <button class="toggle-btn active tooltip" onclick="toggleIndicator('ema')">EMA (12/26)<span class="tooltiptext">Exponential Moving Average - Gives more weight to recent prices. More responsive than SMA.</span></button>
                        <button class="toggle-btn tooltip" onclick="toggleIndicator('bb')">Bollinger Bands<span class="tooltiptext">Shows price volatility. When price touches bands, it may indicate overbought/oversold conditions.</span></button>
                        <button class="toggle-btn tooltip" onclick="toggleIndicator('volume')">Volume<span class="tooltiptext">Number of shares traded. High volume confirms price movements.</span></button>
                    </div>

                    <div class="chart-container" style="position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button id="chartTypeLine" onclick="switchChartType('line')" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">Line</button>
                            <button id="chartTypeCandlestick" onclick="switchChartType('candlestick')" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: var(--text-primary); border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600;">Candlestick</button>
                            <button id="toggleVolume" onclick="window.toggleVolumeOverlay && window.toggleVolumeOverlay();" class="toggle-btn" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: var(--text-primary); border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600;">ðŸ“Š Volume</button>
                            <button id="toggleSupportResistance" onclick="window.toggleSupportResistance && window.toggleSupportResistance();" class="toggle-btn" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: var(--text-primary); border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600;">ðŸ“ S/R</button>
                            <button id="toggleAnnotations" onclick="window.toggleAnnotationMode && window.toggleAnnotationMode();" class="toggle-btn" style="padding: 6px 12px; background: rgba(255,255,255,0.1); color: var(--text-primary); border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600;">ðŸ“ Annotate</button>
                        </div>
                        <canvas id="priceChart"></canvas>
                        <div id="candlestickChart" style="display: none; width: 100%; height: 100%;"></div>
                    </div>

                    <div class="chart-container" style="height: 200px;">
                        <canvas id="rsiChart"></canvas>
                    </div>

                    <div class="chart-container" style="height: 200px;">
                        <canvas id="macdChart"></canvas>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <h2>Key Metrics <span class="info-badge tooltip">â„¹ï¸<span class="tooltiptext">Hover over each metric label for detailed explanations</span></span></h2>
                        <div class="metrics-grid" id="metricsGrid"></div>
                    </div>

                    <div class="card" style="margin-top: 30px;">
                        <h2>Quarterly Earnings (QoQ) <span class="info-badge tooltip">â„¹ï¸<span class="tooltiptext">Quarter-over-Quarter comparison shows how earnings, revenue, and EPS changed compared to the previous quarter. QoQ % shows the percentage change.</span></span></h2>
                        <div id="earningsQoq"></div>
                    </div>

                    <div class="card" style="margin-top: 30px;">
                        <h2>ðŸ¤– AI News Summary <span class="info-badge tooltip">â„¹ï¸<span class="tooltiptext">AI-powered summary of all news articles with key points and overall sentiment analysis.</span></span></h2>
                        <div id="newsSummaryContainer"></div>
                    </div>

                    <div class="card" style="margin-top: 30px;">
                        <h2>Latest News (AI Sentiment Analysis) <span class="info-badge tooltip">â„¹ï¸<span class="tooltiptext">News articles are analyzed using AI to determine if the sentiment is positive, negative, or neutral. Click on any article to read the full story.</span></span></h2>
                        <div id="newsContainer"></div>
                    </div>

                    <div class="card" style="margin-top: 30px;">
                        <h2>ðŸ“Š Volume Analysis <span class="info-badge tooltip">â„¹ï¸<span class="tooltiptext">Volume analysis compares current volume with historical averages to detect unusual trading activity. High volume ratios may indicate significant news or events.</span></span></h2>
                        <div id="volumeAnalysisContainer"></div>
                    </div>

                    <div class="card" style="margin-top: 30px;">
                        <h2>ðŸ“‰ Short Interest <span class="info-badge tooltip">â„¹ï¸<span class="tooltiptext">Short interest shows how many shares are being shorted. High short interest can indicate potential for a short squeeze if the stock price rises.</span></span></h2>
                        <div id="shortInterestContainer"></div>
                    </div>

                    <div class="card" style="margin-top: 30px;">
                        <h2>Company Information</h2>
                        <div class="company-info" id="companyInfo"></div>
                    </div>

                    <div class="card" style="margin-top: 30px;">
                        <h2>ðŸ”” Price Alerts</h2>
                        <div class="price-alerts-section">
                            <div id="alertsList"></div>
                            <div class="add-alert-form">
                                <input type="number" id="alertPrice" placeholder="Target price ($)" step="0.01" />
                                <select id="alertCondition">
                                    <option value="above">Price goes above</option>
                                    <option value="below">Price goes below</option>
                                </select>
                                <button onclick="addPriceAlert(event)" class="ripple-effect">Add Alert</button>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Education Section -->
        <div id="educationSection" class="hidden">
            <div class="card">
                <h2>ðŸŽ“ Educational Content</h2>
                <div class="section-description">
                    Learn the fundamentals of investing, understand financial metrics, and master key investment concepts. Perfect for beginners!
                </div>
                
                <!-- Education Tabs -->
                <div style="display: flex; gap: 10px; margin: 25px 0; border-bottom: 2px solid var(--border-color); flex-wrap: wrap;">
                    <button class="education-tab-btn active" onclick="switchEducationTab('metrics')" style="padding: 12px 24px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ“Š Metric Explanations</button>
                    <button class="education-tab-btn" onclick="switchEducationTab('basics')" style="padding: 12px 24px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ“š Investing Basics</button>
                    <button class="education-tab-btn" onclick="switchEducationTab('glossary')" style="padding: 12px 24px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ“– Glossary</button>
                    <button class="education-tab-btn" onclick="switchEducationTab('why')" style="padding: 12px 24px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ’¡ Why This Matters</button>
                </div>

                <!-- Metric Explanations Tab -->
                <div id="educationMetricsTab" class="education-tab-content">
                    <div id="metricsContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>

                <!-- Investing Basics Tab -->
                <div id="educationBasicsTab" class="education-tab-content hidden">
                    <div id="basicsContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>

                <!-- Glossary Tab -->
                <div id="educationGlossaryTab" class="education-tab-content hidden">
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="glossarySearch" placeholder="ðŸ” Search glossary terms..." style="width: 100%; max-width: 500px; padding: 12px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-primary); font-size: 1em;" />
                    </div>
                    <div id="glossaryContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>

                <!-- Why This Matters Tab -->
                <div id="educationWhyTab" class="education-tab-content hidden">
                    <div id="whyContent">
                        <!-- Content will be loaded here -->
                </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="hidden">
            <div class="card">
                <h2>âš™ï¸ Settings</h2>
                <div class="section-description">
                    Manage your application preferences, notifications, and data.
                </div>
                
                <div id="settingsContent">
                    <!-- Settings will be loaded here -->
            </div>
        </div>
        </div>

        <!-- Backtest Section -->
        <div id="backtestSection" class="hidden">
            <div class="card">
                <h2>ðŸ“Š Backtest ML Predictions</h2>
                <div class="section-description">
                    Testujte pÅ™esnost ML predikcÃ­ na historickÃ½ch datech. Backtest porovnÃ¡vÃ¡ pÅ™edpovÄ›zenÃ© ceny se skuteÄnÃ½mi cenami a vypoÄÃ­tÃ¡vÃ¡ metriky jako accuracy, profit/loss a direction accuracy.
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <input type="text" id="backtestTicker" placeholder="Enter ticker symbol (e.g., ONDS)" onkeypress="if(event.key==='Enter') loadBacktest()" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg-primary); color: var(--text-primary); font-size: 1em;" />
                        <button onclick="loadBacktest()" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">ðŸ” Run Backtest</button>
                    </div>
                    
                    <div id="backtestContent"></div>
                </div>
            </div>
        </div>

        <div id="screenerSection" class="hidden">
            <div class="card">
                <h2>ðŸ” Stock Screener</h2>
                <div class="section-description">
                    NajdÄ›te akcie podle vaÅ¡ich kritÃ©riÃ­. PouÅ¾ijte filtry pro market cap, P/E ratio, rÅ¯st, ziskovost a dalÅ¡Ã­ metriky.
                </div>
                
                <div style="margin-top: 30px;">
                    <!-- Filter Form -->
                    <div class="card" style="margin-bottom: 30px; background: var(--bg-card);">
                        <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>âš™ï¸ Filters</span>
                            <span style="font-size: 0.7em; font-weight: normal; color: var(--text-secondary);">(Leave empty to ignore)</span>
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <!-- Market Cap -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Market Cap</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_market_cap_min" placeholder="Min (B)" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_market_cap_max" placeholder="Max (B)" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- P/E Ratio -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">P/E Ratio</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_pe_min" placeholder="Min" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_pe_max" placeholder="Max" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- P/B Ratio -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">P/B Ratio</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_pb_min" placeholder="Min" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_pb_max" placeholder="Max" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- P/S Ratio -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">P/S Ratio</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_ps_min" placeholder="Min" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_ps_max" placeholder="Max" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- Dividend Yield -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Dividend Yield (%)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_dividend_yield_min" placeholder="Min %" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_dividend_yield_max" placeholder="Max %" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- Revenue Growth -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Revenue Growth (%)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_revenue_growth_min" placeholder="Min %" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_revenue_growth_max" placeholder="Max %" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- EPS Growth -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">EPS Growth (%)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_eps_growth_min" placeholder="Min %" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_eps_growth_max" placeholder="Max %" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- ROE -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">ROE (%)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_roe_min" placeholder="Min %" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_roe_max" placeholder="Max %" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- Debt/Equity -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Debt/Equity</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_debt_equity_min" placeholder="Min" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_debt_equity_max" placeholder="Max" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- Beta -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Beta</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_beta_min" placeholder="Min" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_beta_max" placeholder="Max" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- RSI -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">RSI</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_rsi_min" placeholder="Min" step="0.1" min="0" max="100" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_rsi_max" placeholder="Max" step="0.1" min="0" max="100" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- Short Float -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Short Float (%)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_short_float_min" placeholder="Min %" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_short_float_max" placeholder="Max %" step="0.1" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- Volume -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Avg Volume</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_volume_min" placeholder="Min" step="1000" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_volume_max" placeholder="Max" step="1000" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- Price -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Price</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="filter_price_min" placeholder="Min $" step="0.01" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                    <input type="number" id="filter_price_max" placeholder="Max $" step="0.01" style="flex: 1; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                                </div>
                            </div>
                            
                            <!-- Sector -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Sector</label>
                                <input type="text" id="filter_sector" placeholder="e.g., Technology" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                            </div>
                            
                            <!-- Industry -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Industry</label>
                                <input type="text" id="filter_industry" placeholder="e.g., Software" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);" />
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; align-items: center; margin-top: 20px; flex-wrap: wrap;">
                            <button onclick="runScreener()" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">
                                ðŸ” Run Screener
                            </button>
                            <button onclick="clearScreenerFilters()" class="ripple-effect" style="padding: 12px 24px; background: var(--bg-card); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                ðŸ—‘ï¸ Clear Filters
                            </button>
                            <button onclick="saveScreenerPreset()" class="ripple-effect" style="padding: 12px 24px; background: var(--bg-card); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                ðŸ’¾ Save Preset
                            </button>
                            <select id="screenerPresetSelect" onchange="loadScreenerPreset()" style="padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--input-bg); color: var(--text-primary); font-weight: 600; cursor: pointer;">
                                <option value="">Load Preset...</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Results -->
                    <div id="screenerResults" style="display: none;">
                        <div class="card" style="background: var(--bg-card);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                                <h3 id="screenerResultsCount" style="margin: 0;">Results: 0 stocks</h3>
                                <button onclick="exportScreenerResults()" class="ripple-effect" style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    ðŸ“¥ Export CSV
                                </button>
                            </div>
                            <div style="overflow-x: auto;">
                                <table id="screenerResultsTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: var(--table-header-bg); border-bottom: 2px solid var(--border-color);">
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); cursor: pointer;" onclick="sortScreenerResults('ticker')">Ticker â†•ï¸</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">Name</th>
                                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary); cursor: pointer;" onclick="sortScreenerResults('price')">Price â†•ï¸</th>
                                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary); cursor: pointer;" onclick="sortScreenerResults('market_cap')">Market Cap â†•ï¸</th>
                                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary); cursor: pointer;" onclick="sortScreenerResults('pe_ratio')">P/E â†•ï¸</th>
                                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary); cursor: pointer;" onclick="sortScreenerResults('revenue_growth')">Rev Growth â†•ï¸</th>
                                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary); cursor: pointer;" onclick="sortScreenerResults('roe')">ROE â†•ï¸</th>
                                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary); cursor: pointer;" onclick="sortScreenerResults('rsi')">RSI â†•ï¸</th>
                                            <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="screenerResultsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="screenerLoading" class="hidden" style="text-align: center; padding: 40px;">
                        <div style="font-size: 1.2em; color: var(--text-secondary); margin-bottom: 10px;">ðŸ” Screening stocks...</div>
                        <div style="color: var(--text-tertiary);">This may take a minute</div>
                </div>
            </div>
        </div>
        </div>

        <div id="loading" class="hidden">
            <div class="skeleton-card">
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-chart"></div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div class="skeleton skeleton-metric"></div>
                    <div class="skeleton skeleton-metric"></div>
                    <div class="skeleton skeleton-metric"></div>
                    <div class="skeleton skeleton-metric"></div>
                </div>
            </div>
        </div>
        <div id="error" class="error hidden"></div>
    </div>

    <script>
        // Debug: Check if script is loading
        console.log('ðŸš€ Script started loading...');
        
        // Make basic functions available immediately
        window.debugCheck = function() {
            console.log('âœ… Script is loaded and functions are accessible');
            return true;
        };
        
        // Cached fetch function with simple in-memory cache
        const fetchCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
        
        // Define cachedFetch immediately and make it globally available
        window.cachedFetch = async function cachedFetch(url, options = {}) {
            const cacheKey = `${url}_${JSON.stringify(options)}`;
            const now = Date.now();
            
            // Check cache
            if (fetchCache.has(cacheKey)) {
                const cached = fetchCache.get(cacheKey);
                if (now - cached.timestamp < CACHE_DURATION) {
                    // Return cached response as a Response-like object
                    const cachedData = cached.data;
                    const cachedResponse = {
                        ok: cached.ok !== false,
                        status: cached.status || 200,
                        statusText: cached.statusText || 'OK',
                        headers: new Headers(cached.headers || { 'Content-Type': 'application/json' }),
                        json: async function() {
                            return cachedData;
                        },
                        text: async function() {
                            return JSON.stringify(cachedData);
                        },
                        clone: function() {
                            return window.cachedFetch(url, options);
                        }
                    };
                    return cachedResponse;
                } else {
                    // Cache expired, remove it
                    fetchCache.delete(cacheKey);
                }
            }
            
            // Fetch from network
            try {
                const response = await fetch(url, options);
                const responseClone = response.clone();
                
                // Cache the response data
                try {
                    const data = await responseClone.json();
                    fetchCache.set(cacheKey, {
                        data: data,
                        timestamp: now,
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                } catch (e) {
                    // If JSON parsing fails, don't cache
                    console.warn('Failed to cache response (not JSON):', url);
                }
                
                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        };
        
        // Also create a local reference for use within this script
        const cachedFetch = window.cachedFetch;
        
        // Latest Updates Functions
        async function loadLatestUpdates() {
            try {
                const response = await fetch('/api/updates?limit=5');
                const data = await response.json();
                
                if (!data.success || !data.updates) {
                    console.error('Failed to load updates:', data.error);
                    document.getElementById('updatesContent').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: rgba(255, 255, 255, 0.8);">
                            <p>Unable to load updates at this time.</p>
                        </div>
                    `;
                    return;
                }
                
                // Update version
                if (data.version) {
                    document.getElementById('versionNumber').textContent = data.version;
                }
                
                // Render updates
                const updatesHtml = data.updates.map(update => {
                    const typeColors = {
                        'feature': 'rgba(16, 185, 129, 0.2)',
                        'fix': 'rgba(239, 68, 68, 0.2)',
                        'improvement': 'rgba(59, 130, 246, 0.2)'
                    };
                    const typeColor = typeColors[update.type] || 'rgba(255, 255, 255, 0.1)';
                    
                    const detailsHtml = update.details ? `
                        <ul style="margin: 12px 0 0 0; padding-left: 20px; list-style: none;">
                            ${update.details.map(detail => `
                                <li style="margin: 6px 0; padding-left: 20px; position: relative;">
                                    <span style="position: absolute; left: 0;">â€¢</span>
                                    ${detail}
                                </li>
                            `).join('')}
                        </ul>
                    ` : '';
                    
                    return `
                        <div style="background: ${typeColor}; border-left: 4px solid white; border-radius: 8px; padding: 20px; margin-bottom: 15px; transition: transform 0.2s;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5em;">${update.icon || 'ðŸ“¦'}</span>
                                        <h3 style="margin: 0; font-size: 1.2em; font-weight: 700; color: white;">${update.title}</h3>
                                        <span style="background: rgba(255, 255, 255, 0.2); padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">v${update.version}</span>
                                    </div>
                                    <p style="margin: 0; color: rgba(255, 255, 255, 0.9); line-height: 1.6;">${update.description}</p>
                                </div>
                                <span style="color: rgba(255, 255, 255, 0.7); font-size: 0.9em; white-space: nowrap;">${update.date}</span>
                            </div>
                            ${detailsHtml}
                        </div>
                    `;
                }).join('');
                
                document.getElementById('updatesContent').innerHTML = updatesHtml || `
                    <div style="text-align: center; padding: 20px; color: rgba(255, 255, 255, 0.8);">
                        <p>No updates available.</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading updates:', error);
                document.getElementById('updatesContent').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: rgba(255, 255, 255, 0.8);">
                        <p>Error loading updates. Please try again later.</p>
                    </div>
                `;
            }
        }
        
        let updatesSectionExpanded = true;
        function toggleUpdatesSection() {
            updatesSectionExpanded = !updatesSectionExpanded;
            const content = document.getElementById('updatesContent');
            const toggleText = document.getElementById('updatesToggleText');
            
            if (updatesSectionExpanded) {
                content.style.display = 'block';
                toggleText.textContent = 'â–¼ Collapse';
            } else {
                content.style.display = 'none';
                toggleText.textContent = 'â–¶ Expand';
            }
        }
        window.toggleUpdatesSection = toggleUpdatesSection;
        
        // Load updates on page load
        window.addEventListener('load', function() {
            setTimeout(loadLatestUpdates, 500);
        });

        // Sidebar Navigation Functions
        let currentSection = 'welcomeSection';
        const sectionNames = {
            'welcomeSection': 'Welcome',
            'stockAnalysisSection': 'Stock Analysis',
            'financialsSection': 'Financials',
            'newsSection': 'News',
            'earningsCalendarSection': 'Earnings Calendar',
            'economicCalendarSection': 'Economic Data',
            'portfolioSection': 'Portfolio',
            'alertsDashboardSection': 'Alerts Dashboard',
            'analystInsiderSection': 'Analyst & Insider',
            'aiRecommendationsSection': 'AI Recommendations',
            'backtestSection': 'Backtest',
            'screenerSection': 'Stock Screener',
            'socialSentimentSection': 'Social Sentiment',
            'settingsSection': 'Settings',
            'watchlistSection': 'Watchlist',
            'educationSection': 'Learn'
        };

        // Initialize sidebar state from localStorage
        function initSidebarState() {
            const savedState = localStorage.getItem('sidebarGroupsState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    Object.keys(state).forEach(groupId => {
                        if (!state[groupId]) {
                            const group = document.querySelector(`#nav-group-${groupId}`).closest('.nav-group');
                            if (group) {
                                group.classList.add('collapsed');
                            }
                        }
                    });
                } catch (e) {
                    console.error('Error loading sidebar state:', e);
                }
            }
        }

        // Toggle sidebar (mobile)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar && overlay) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        }
        window.toggleSidebar = toggleSidebar;
        window.toggleMobileSidebar = toggleSidebar; // Alias for mobile
        
        // Swipe gesture support for mobile sidebar
        (function() {
            let touchStartX = 0;
            let touchEndX = 0;
            const minSwipeDistance = 50;
            
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
            
            function handleSwipe() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if (!sidebar || !overlay) return;
                
                const swipeDistance = touchEndX - touchStartX;
                const isOpen = sidebar.classList.contains('open');
                
                // Swipe right to open (from left edge)
                if (swipeDistance > minSwipeDistance && touchStartX < 50 && !isOpen) {
                    sidebar.classList.add('open');
                    overlay.classList.add('active');
                }
                // Swipe left to close (when sidebar is open)
                else if (swipeDistance < -minSwipeDistance && isOpen) {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('active');
                }
            }
        })();

        // Toggle nav group (collapsible)
        function toggleNavGroup(groupId) {
            const group = document.querySelector(`#nav-group-${groupId}`).closest('.nav-group');
            if (group) {
                group.classList.toggle('collapsed');
                
                // Save state to localStorage
                const savedState = localStorage.getItem('sidebarGroupsState');
                const state = savedState ? JSON.parse(savedState) : {};
                state[groupId] = !group.classList.contains('collapsed');
                localStorage.setItem('sidebarGroupsState', JSON.stringify(state));
            }
        }
        window.toggleNavGroup = toggleNavGroup;

        // Navigate to section
        function navigateToSection(sectionId) {
            console.log('Navigating to section:', sectionId);
            
            // Hide all sections
            const allSections = [
                'welcomeSection', 'stockAnalysisSection', 'financialsSection', 
                'newsSection', 'earningsCalendarSection', 'economicCalendarSection',
                'portfolioSection', 'alertsDashboardSection', 'analystInsiderSection',
                'aiRecommendationsSection', 'socialSentimentSection', 'settingsSection',
                'watchlistSection', 'educationSection'
            ];
            
            allSections.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('hidden');
                    el.style.setProperty('display', 'none', 'important'); // Force hide with inline style
                    console.log('Hiding section:', id, 'has hidden class:', el.classList.contains('hidden'), 'computed display:', window.getComputedStyle(el).display);
                }
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                
                targetSection.classList.remove('hidden');
                targetSection.style.removeProperty('display'); // Remove inline display to use CSS
                const computed = window.getComputedStyle(targetSection);
                
                console.log('Showing section:', sectionId, 'has hidden class:', targetSection.classList.contains('hidden'), 'computed display:', window.getComputedStyle(targetSection).display);
                
                // Double-check welcomeSection is hidden
                const welcomeSection = document.getElementById('welcomeSection');
                if (welcomeSection && sectionId !== 'welcomeSection') {
                    welcomeSection.style.setProperty('display', 'none', 'important');
                    welcomeSection.classList.add('hidden');
                    console.log('Double-check: welcomeSection hidden, computed display:', window.getComputedStyle(welcomeSection).display);
                }
                
                currentSection = sectionId;
                
                // Update active state
                setActiveSection(sectionId);
                
                // Update breadcrumbs with current ticker if available
                updateBreadcrumbs(sectionId, window.currentTicker || null);
                
                // Close mobile sidebar
                if (window.innerWidth <= 1024) {
                    toggleSidebar();
                }
                
                // Call specific section loaders
                if (sectionId === 'educationSection') {
                    setTimeout(() => {
                        console.log('Loading education section...');
                        loadEducationContent();
                        switchEducationTab('metrics');
                    }, 50);
                } else if (sectionId === 'settingsSection') {
                    setTimeout(() => {
                        console.log('Loading settings...');
                        if (typeof loadSettings === 'function') {
                            loadSettings();
                            console.log('Settings loaded');
                        } else {
                            console.error('loadSettings function not found');
                        }
                        // Verify settings section is visible
                        const settingsEl = document.getElementById('settingsSection');
                        const settingsContent = document.getElementById('settingsContent');
                        if (settingsEl) {                            const computed = window.getComputedStyle(settingsEl);
                            const card = settingsEl.querySelector('.card');
                            const cardComputed = card ? window.getComputedStyle(card) : null;
                            
                            console.log('Settings section visibility check:', {
                                hasHidden: settingsEl.classList.contains('hidden'),
                                computedDisplay: computed.display,
                                offsetHeight: settingsEl.offsetHeight,
                                scrollHeight: settingsEl.scrollHeight,
                                clientHeight: settingsEl.clientHeight,
                                settingsContentHeight: settingsContent ? settingsContent.offsetHeight : 0,
                                settingsContentInnerHTML: settingsContent ? settingsContent.innerHTML.substring(0, 200) : 'not found'
                            });
                            
                            // Force show if still has 0 height
                            if (settingsEl.offsetHeight === 0 || settingsEl.scrollHeight === 0) {
                                console.log('Settings section has 0 height, forcing display...');
                                settingsEl.style.removeProperty('display');
                                settingsEl.style.setProperty('display', 'block', 'important');
                                settingsEl.style.setProperty('min-height', '400px', 'important');
                                settingsEl.style.setProperty('visibility', 'visible', 'important');
                                const card = settingsEl.querySelector('.card');
                                if (card) {
                                    card.style.setProperty('min-height', '400px', 'important');
                                    card.style.setProperty('display', 'block', 'important');
                                }
                                // Force reflow
                                settingsEl.offsetHeight;
                                console.log('After force display - offsetHeight:', settingsEl.offsetHeight, 'scrollHeight:', settingsEl.scrollHeight);
                            }
                        }
                    }, 50);
                }
            } else {
                console.error('Section not found:', sectionId);
            }
        }
        
        // Make navigateToSection globally available
        window.navigateToSection = navigateToSection;

        // Set active section in sidebar
        function setActiveSection(sectionId) {
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to current section
            const activeItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                
                // Expand parent group if collapsed (only for items with nav-group-items)
                const parentGroup = activeItem.closest('.nav-group');
                if (parentGroup && parentGroup.classList.contains('collapsed')) {
                    const groupItems = parentGroup.querySelector('.nav-group-items');
                    if (groupItems && groupItems.id) {
                        const groupId = groupItems.id.replace('nav-group-', '');
                        toggleNavGroup(groupId);
                    }
                }
            }
        }

        // Update breadcrumbs
        function updateBreadcrumbs(sectionId) {
            const breadcrumbCurrent = document.getElementById('breadcrumbCurrent');
            if (breadcrumbCurrent) {
                const sectionName = sectionNames[sectionId] || 'Unknown';
                breadcrumbCurrent.textContent = sectionName;
            }
        }

        // Show welcome section
        function showWelcome() {
            navigateToSection('welcomeSection');
        }
        window.showWelcome = showWelcome;

        // Lazy loading for charts using IntersectionObserver
        function initLazyLoading() {
            const chartObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const chartContainer = entry.target;
                        // Add loading class if not already loaded
                        if (!chartContainer.dataset.loaded) {
                            chartContainer.classList.add('chart-loading');
                            // Mark as observed - actual chart loading happens when data is ready
                            chartContainer.dataset.observed = 'true';
                        }
                        chartObserver.unobserve(chartContainer);
                    }
                });
            }, {
                rootMargin: '50px' // Start loading 50px before chart enters viewport
            });
            
            // Observe all chart containers
            document.querySelectorAll('.chart-container').forEach(container => {
                chartObserver.observe(container);
            });
        }
        
        // Loading state styles
        const loadingStyles = document.createElement('style');
        loadingStyles.textContent = `
            .chart-loading {
                position: relative;
            }
            .chart-loading::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 40px;
                height: 40px;
                border: 4px solid var(--border-color);
                border-top-color: var(--primary-500);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                z-index: 10;
            }
            @keyframes spin {
                to { transform: translate(-50%, -50%) rotate(360deg); }
            }
        `;
        document.head.appendChild(loadingStyles);
        
        // Initialize sidebar on page load
        document.addEventListener('DOMContentLoaded', function() {
            initSidebarState();
            
            // Initialize lazy loading for charts
            initLazyLoading();
            
            // Show welcome section by default on page load (only if no navigation has occurred)
            if (currentSection === 'welcomeSection') {
                const welcomeSection = document.getElementById('welcomeSection');
                if (welcomeSection) {
                    welcomeSection.classList.remove('hidden');
                    welcomeSection.style.display = '';
                }
            }
            
            // Hide all other sections
            const allSections = [
                'stockAnalysisSection', 'financialsSection', 
                'newsSection', 'earningsCalendarSection', 'economicCalendarSection',
                'portfolioSection', 'alertsDashboardSection', 'analystInsiderSection',
                'aiRecommendationsSection', 'socialSentimentSection', 'settingsSection',
                'watchlistSection', 'educationSection'
            ];
            allSections.forEach(id => {
                const el = document.getElementById(id);
                if (el && id !== currentSection) {
                    el.classList.add('hidden');
                    el.style.display = 'none';
                }
            });
            
            // Show current section if not welcome
            if (currentSection !== 'welcomeSection') {
                const currentSectionEl = document.getElementById(currentSection);
                if (currentSectionEl) {
                    currentSectionEl.classList.remove('hidden');
                    currentSectionEl.style.display = '';
                }
            }
            
            setActiveSection(currentSection);
            updateBreadcrumbs(currentSection, currentTicker || null);
            
            // Load watchlist content if on watchlist section
            if (currentSection === 'watchlistSection') {
                setTimeout(() => {
                    updateWatchlistMainContent();
                }, 100);
            }
        });
        let priceChart, rsiChart, macdChart;
        let candlestickChart = null;
        let currentData = null;
        let currentNewsData = null;
        let currentTimeframe = '1y';
        let currentChartType = 'line'; // 'line' or 'candlestick'
        let indicatorVisibility = {
            sma: true,
            ema: true,
            bb: true,
            volume: true
        };
        let chartFeatures = {
            volumeOverlay: false,
            supportResistance: false,
            annotationMode: false
        };
        let chartAnnotations = [];
        let supportResistanceLevels = null;
        let priceAlerts = [];
        let alertCheckInterval = null;

        // Initialize dark mode on page load (after DOM is ready)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDarkMode);
        } else {
        initDarkMode();
        }
        
        // Load watchlist on page load if on watchlist tab
        const watchlistSection = document.getElementById('watchlistSection');
        if (watchlistSection && !watchlistSection.classList.contains('hidden')) {
            loadWatchlistFromStorage();
        }

        // Update watchlist sidebar when stock analysis section is shown
        const originalShowStockAnalysis = showStockAnalysis;
        showStockAnalysis = function() {
            navigateToSection('stockAnalysisSection');
            setTimeout(() => {
                updateWatchlistSidebar();
                if (typeof initAutocomplete === 'function') {
                    initAutocomplete();
                }
            }, 200);
        };

        // Load watchlist on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                updateWatchlistSidebar();
            }, 500);
            // Initialize real-time updates
            initRealTimeUpdates();
            
            // Initialize autocomplete immediately if input exists
            setTimeout(() => {
                const tickerInput = document.getElementById('tickerInput');
                if (tickerInput && tickerInput.dataset.autocompleteInitialized !== 'true') {
                    console.log('[AUTOCOMPLETE] Initializing on page load');
                    initAutocomplete();
                }
            }, 1000);
        });

        // Autocomplete state
        let autocompleteTimeout = null;
        let autocompleteSelectedIndex = -1;
        let autocompleteResults = [];
        let autocompleteVisible = false;

        // Search History Functions
        function getSearchHistory() {
            try {
                const stored = localStorage.getItem('searchHistory');
                if (!stored) return [];
                return JSON.parse(stored);
            } catch (error) {
                console.error('Error loading search history:', error);
                return [];
            }
        }

        function saveSearchHistory(history) {
            try {
                localStorage.setItem('searchHistory', JSON.stringify(history));
            } catch (error) {
                console.error('Error saving search history:', error);
            }
        }

        function addToSearchHistory(ticker, name) {
            const history = getSearchHistory();
            const existingIndex = history.findIndex(item => item.ticker === ticker);
            
            if (existingIndex >= 0) {
                history[existingIndex].count = (history[existingIndex].count || 1) + 1;
                history[existingIndex].timestamp = Date.now();
            } else {
                history.unshift({
                    ticker: ticker,
                    name: name || ticker,
                    timestamp: Date.now(),
                    count: 1
                });
            }
            
            // Keep only last 15 items
            const sorted = history.sort((a, b) => b.timestamp - a.timestamp);
            saveSearchHistory(sorted.slice(0, 15));
        }

        // Favorite Tickers Functions
        function getFavoriteTickers() {
            try {
                const stored = localStorage.getItem('favoriteTickers');
                if (!stored) return [];
                return JSON.parse(stored);
            } catch (error) {
                console.error('Error loading favorite tickers:', error);
                return [];
            }
        }

        function saveFavoriteTickers(favorites) {
            try {
                localStorage.setItem('favoriteTickers', JSON.stringify(favorites));
            } catch (error) {
                console.error('Error saving favorite tickers:', error);
            }
        }

        function toggleFavoriteTicker(ticker) {
            const favorites = getFavoriteTickers();
            const index = favorites.indexOf(ticker);
            
            if (index >= 0) {
                favorites.splice(index, 1);
            } else {
                favorites.push(ticker);
            }
            
            saveFavoriteTickers(favorites);
            return index < 0; // Returns true if added, false if removed
        }

        function isFavoriteTicker(ticker) {
            return getFavoriteTickers().includes(ticker);
        }

        // Autocomplete Functions
        async function fetchAutocompleteResults(query) {
            if (!query || query.length < 1) {
                return { results: [], favorites: getFavoriteTickers(), recent: getSearchHistory().slice(0, 5) };
            }

            try {
                console.log('[AUTOCOMPLETE] Fetching results for:', query);
                const response = await window.cachedFetch(`/api/search/${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }
                const data = await response.json();
                console.log('[AUTOCOMPLETE] Received data:', data);
                console.log('[AUTOCOMPLETE] Received results count:', data.results?.length || 0);
                if (data.results && data.results.length > 0) {
                    console.log('[AUTOCOMPLETE] First result:', data.results[0]);
                } else {
                }
                return {
                    results: data.results || [],
                    favorites: getFavoriteTickers(),
                    recent: getSearchHistory().slice(0, 5)
                };
            } catch (error) {
                console.error('[AUTOCOMPLETE] Error fetching autocomplete:', error);
                return { results: [], favorites: getFavoriteTickers(), recent: getSearchHistory().slice(0, 5), error: true };
            }
        }

        function renderAutocomplete(data, query, isLoading = false) {
            const dropdown = document.getElementById('tickerAutocomplete');
            if (!dropdown) {
                console.error('[AUTOCOMPLETE] Dropdown element not found!');
                console.error('[AUTOCOMPLETE] Trying to find element...');
                const test = document.querySelector('#tickerAutocomplete');
                console.error('[AUTOCOMPLETE] QuerySelector result:', test);
                return;
            }
            console.log('[AUTOCOMPLETE] Rendering:', { query, isLoading, resultsCount: data.results?.length || 0, dropdown: dropdown });

            // Show loading state
            if (isLoading && query) {
                dropdown.innerHTML = '<div class="autocomplete-loading">ðŸ” Searching...</div>';
                dropdown.style.display = 'block';
                autocompleteVisible = true;
                return;
            }

            // Show error state
            if (data.error) {
                dropdown.innerHTML = '<div class="autocomplete-empty">âš ï¸ Search error. Please try again.</div>';
                dropdown.style.display = 'block';
                autocompleteVisible = true;
                return;
            }

            const favorites = data.favorites || [];
            const recent = data.recent || [];
            const results = data.results || [];
            const queryLower = (query || '').toLowerCase();

            // Filter favorites and recent by query if provided
            const filteredFavorites = query ? favorites.filter(t => 
                typeof t === 'string' ? t.toLowerCase().includes(queryLower) : 
                (t.ticker && t.ticker.toLowerCase().includes(queryLower))
            ).slice(0, 3) : favorites.slice(0, 3);
            
            const filteredRecent = query ? recent.filter(item => 
                item.ticker && item.ticker.toLowerCase().includes(queryLower)
            ).slice(0, 3) : recent.slice(0, 3);

            let html = '';

            // Favorites section
            if (filteredFavorites.length > 0 && !query) {
                html += '<div class="autocomplete-section">';
                html += '<div class="autocomplete-section-title">â­ Favorites</div>';
                filteredFavorites.forEach(ticker => {
                    const tickerStr = typeof ticker === 'string' ? ticker : ticker.ticker;
                    const name = typeof ticker === 'string' ? ticker : (ticker.name || tickerStr);
                    html += `<div class="autocomplete-item" data-ticker="${tickerStr}" onclick="selectAutocompleteItem('${tickerStr}')">
                        <span class="autocomplete-item-icon">â­</span>
                        <div class="autocomplete-item-content">
                            <div class="autocomplete-item-ticker">${tickerStr}</div>
                            <div class="autocomplete-item-name">${name}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            // Recent searches section
            if (filteredRecent.length > 0 && !query) {
                html += '<div class="autocomplete-section">';
                html += '<div class="autocomplete-section-title">ðŸ“ˆ Recent Searches</div>';
                filteredRecent.forEach(item => {
                    html += `<div class="autocomplete-item" data-ticker="${item.ticker}" onclick="selectAutocompleteItem('${item.ticker}')" onmouseenter="autocompleteSelectedIndex = -1;">
                        <span class="autocomplete-item-icon">ðŸ“ˆ</span>
                        <div class="autocomplete-item-content">
                            <div class="autocomplete-item-ticker">${item.ticker}</div>
                            <div class="autocomplete-item-name">${item.name || item.ticker}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            // Search results section
            if (results.length > 0) {
                html += '<div class="autocomplete-section">';
                html += '<div class="autocomplete-section-title">ðŸ” Search Results</div>';
                results.forEach((item, index) => {
                    const isFavorite = isFavoriteTicker(item.ticker);
                    html += `<div class="autocomplete-item ${index === autocompleteSelectedIndex ? 'active' : ''}" 
                        data-ticker="${item.ticker}" 
                        data-index="${index}"
                        onclick="selectAutocompleteItem('${item.ticker}')"
                        onmouseenter="setAutocompleteSelected(${index})">
                        <span class="autocomplete-item-icon">ðŸ“Š</span>
                        <div class="autocomplete-item-content">
                            <div class="autocomplete-item-ticker">${item.ticker}</div>
                            <div class="autocomplete-item-name">${item.name || item.ticker}</div>
                            <div class="autocomplete-item-meta">
                                <span>${item.exchange || 'N/A'}</span>
                                ${item.sector ? `<span>â€¢ ${item.sector}</span>` : ''}
                            </div>
                        </div>
                        <span class="autocomplete-item-favorite ${isFavorite ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleFavoriteFromAutocomplete('${item.ticker}')" 
                            title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                            ${isFavorite ? 'â­' : 'â˜†'}
                        </span>
                    </div>`;
                });
                html += '</div>';
            }

            // Empty state
            if (html === '' && query) {
                html = '<div class="autocomplete-empty">No results found</div>';
            }

            dropdown.innerHTML = html;
            autocompleteResults = results;
            autocompleteVisible = html !== '';
            dropdown.style.display = autocompleteVisible ? 'block' : 'none';
            console.log('[AUTOCOMPLETE] Dropdown display:', dropdown.style.display, 'HTML length:', html.length);
        }

        function setAutocompleteSelected(index) {
            autocompleteSelectedIndex = index;
            document.querySelectorAll('.autocomplete-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function selectAutocompleteItem(ticker) {
            const input = document.getElementById('tickerInput');
            if (input) {
                input.value = ticker;
            }
            hideAutocomplete();
            // Small delay to ensure value is set
            setTimeout(() => {
                searchStock();
            }, 100);
        }

        function toggleFavoriteFromAutocomplete(ticker) {
            const added = toggleFavoriteTicker(ticker);
            showToast(`${ticker} ${added ? 'added to' : 'removed from'} favorites`, added ? 'success' : 'info');
            
            // Re-render autocomplete to update favorite icons
            const query = document.getElementById('tickerInput').value;
            if (query) {
                handleTickerInput({ target: { value: query } });
            }
        }

        function hideAutocomplete() {
            const dropdown = document.getElementById('tickerAutocomplete');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
            autocompleteVisible = false;
            autocompleteSelectedIndex = -1;
        }

        // Direct handler for inline oninput (must be in global scope)
        async function handleTickerInputDirect(event) {
            const query = event.target.value.trim();
            console.log('[AUTOCOMPLETE] Direct input handler:', query);
            
            const dropdown = document.getElementById('tickerAutocomplete');
            if (!dropdown) {
                console.error('[AUTOCOMPLETE] Dropdown not found!');
                return;
            }
            
            // Clear previous timeout
            if (autocompleteTimeout) {
                clearTimeout(autocompleteTimeout);
            }

            // Hide autocomplete if query is empty
            if (!query) {
                dropdown.style.display = 'none';
                return;
            }

            // Show loading state immediately
            dropdown.innerHTML = '<div class="autocomplete-loading">ðŸ” Searching...</div>';
            dropdown.style.display = 'block';
            console.log('[AUTOCOMPLETE] Showing loading, dropdown display:', dropdown.style.display);

            // Debounce API call
            autocompleteTimeout = setTimeout(async () => {
                console.log('[AUTOCOMPLETE] Fetching results for:', query);
                const data = await fetchAutocompleteResults(query);
                console.log('[AUTOCOMPLETE] Received data:', data);
                
                let html = '';
                console.log('[AUTOCOMPLETE] Processing results:', data.results);
                if (data.results && data.results.length > 0) {
                    console.log('[AUTOCOMPLETE] Found results, rendering...');
                    html += '<div class="autocomplete-section"><div class="autocomplete-section-title">ðŸ” Search Results</div>';
                    data.results.forEach((item, index) => {
                        console.log('[AUTOCOMPLETE] Rendering item:', item);
                        const isFavorite = isFavoriteTicker(item.ticker);
                        // Escape HTML to prevent XSS
                        const ticker = String(item.ticker || '').replace(/"/g, '&quot;');
                        const name = String(item.name || item.ticker || '').replace(/"/g, '&quot;');
                        const exchange = String(item.exchange || 'N/A').replace(/"/g, '&quot;');
                        const sector = item.sector ? String(item.sector).replace(/"/g, '&quot;') : '';
                        html += `<div class="autocomplete-item" data-ticker="${ticker}" data-index="${index}" onclick="const input = document.getElementById('tickerInput'); if(input) { input.value='${ticker}'; } const dropdown = document.getElementById('tickerAutocomplete'); if(dropdown) { dropdown.style.display='none'; } setTimeout(() => searchStock(), 100);">
                            <span class="autocomplete-item-icon">ðŸ“Š</span>
                            <div class="autocomplete-item-content">
                                <div class="autocomplete-item-ticker">${ticker}</div>
                                <div class="autocomplete-item-name">${name}</div>
                                <div class="autocomplete-item-meta">
                                    <span>${exchange}</span>
                                    ${sector ? `<span>â€¢ ${sector}</span>` : ''}
                                </div>
                            </div>
                            <span class="autocomplete-item-favorite ${isFavorite ? 'active' : ''}" 
                                onclick="event.stopPropagation(); toggleFavoriteFromAutocomplete('${ticker}')" 
                                title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                                ${isFavorite ? 'â­' : 'â˜†'}
                            </span>
                        </div>`;
                    });
                    html += '</div>';
                } else {
                    html = '<div class="autocomplete-empty">No results found</div>';
                }
                
                if (dropdown) {
                    dropdown.innerHTML = html;
                    dropdown.style.display = html !== '' ? 'block' : 'none';
                    console.log('[AUTOCOMPLETE] Rendered dropdown:', { htmlLength: html.length, display: dropdown.style.display });
                } else {
                    console.error('[AUTOCOMPLETE] Dropdown element is null!');
                }
            }, 300);
        }
        
        // Direct handler for inline onfocus (must be in global scope)
        function showAutocompleteDirect() {
            const dropdown = document.getElementById('tickerAutocomplete');
            const input = document.getElementById('tickerInput');
            console.log('[AUTOCOMPLETE] Direct focus handler');
            
            if (!dropdown || !input) {
                console.error('[AUTOCOMPLETE] Dropdown or input not found');
                return;
            }
            
            if (input.value.trim() === '') {
                const favorites = getFavoriteTickers();
                const recent = getSearchHistory().slice(0, 5);
                if (favorites.length > 0 || recent.length > 0) {
                    let html = '';
                    if (favorites.length > 0) {
                        html += '<div class="autocomplete-section"><div class="autocomplete-section-title">â­ Favorites</div>';
                        favorites.slice(0, 3).forEach(ticker => {
                            const tickerStr = typeof ticker === 'string' ? ticker : ticker.ticker;
                            const name = typeof ticker === 'string' ? ticker : (ticker.name || tickerStr);
                            html += `<div class="autocomplete-item" data-ticker="${tickerStr}" onclick="document.getElementById('tickerInput').value='${tickerStr}'; document.getElementById('tickerAutocomplete').style.display='none'; searchStock();">
                                <span class="autocomplete-item-icon">â­</span>
                                <div class="autocomplete-item-content">
                                    <div class="autocomplete-item-ticker">${tickerStr}</div>
                                    <div class="autocomplete-item-name">${name}</div>
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    }
                    if (recent.length > 0) {
                        html += '<div class="autocomplete-section"><div class="autocomplete-section-title">ðŸ“ˆ Recent Searches</div>';
                        recent.slice(0, 3).forEach(item => {
                            html += `<div class="autocomplete-item" data-ticker="${item.ticker}" onclick="const input = document.getElementById('tickerInput'); if(input) { input.value='${item.ticker}'; } const dropdown = document.getElementById('tickerAutocomplete'); if(dropdown) { dropdown.style.display='none'; } setTimeout(() => searchStock(), 100);">
                                <span class="autocomplete-item-icon">ðŸ“ˆ</span>
                                <div class="autocomplete-item-content">
                                    <div class="autocomplete-item-ticker">${item.ticker}</div>
                                    <div class="autocomplete-item-name">${item.name || item.ticker}</div>
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    }
                    dropdown.innerHTML = html;
                    dropdown.style.display = 'block';
                    console.log('[AUTOCOMPLETE] Showing favorites/recent');
                }
            } else {
                // If there's a value, trigger input handler
                handleTickerInputDirect({ target: input });
            }
        }

        function showAutocomplete() {
            const dropdown = document.getElementById('tickerAutocomplete');
            const input = document.getElementById('tickerInput');
            if (dropdown && input && input.value.trim() === '') {
                // Show favorites and recent when input is empty
                const favorites = getFavoriteTickers();
                const recent = getSearchHistory().slice(0, 5);
                if (favorites.length > 0 || recent.length > 0) {
                    renderAutocomplete({ results: [], favorites: favorites, recent: recent }, '', false);
                } else {
                    hideAutocomplete();
                }
            }
        }

        async function handleTickerInput(event) {
            const query = event.target.value.trim();
            console.log('[AUTOCOMPLETE] Input changed:', query);
            
            // Clear previous timeout
            if (autocompleteTimeout) {
                clearTimeout(autocompleteTimeout);
            }

            // Hide autocomplete if query is empty (unless showing favorites/recent)
            if (!query) {
                showAutocomplete();
                return;
            }

            // Show loading state immediately
            renderAutocomplete({ results: [], favorites: [], recent: [] }, query, true);

            // Debounce API call
            autocompleteTimeout = setTimeout(async () => {
                const data = await fetchAutocompleteResults(query);
                renderAutocomplete(data, query, false);
            }, 300);
        }

        // Initialize autocomplete (called when Stock Analysis section is shown)
        let autocompleteInitialized = false;
        function initAutocomplete() {
            const tickerInput = document.getElementById('tickerInput');
            if (!tickerInput) {
                console.log('[AUTOCOMPLETE] tickerInput not found');
                return;
            }
            
            // Check if already initialized by checking for data attribute
            if (tickerInput.dataset.autocompleteInitialized === 'true') {
                console.log('[AUTOCOMPLETE] Already initialized');
                return;
            }
            
            console.log('[AUTOCOMPLETE] Initializing...', tickerInput);
            
            // Remove any existing listeners first (by cloning)
            const newInput = tickerInput.cloneNode(true);
            tickerInput.parentNode.replaceChild(newInput, tickerInput);
            
            // Add event listeners to the new input
            newInput.addEventListener('input', function(e) {
                console.log('[AUTOCOMPLETE] Input event triggered:', e.target.value);
                handleTickerInput(e);
            });
            newInput.addEventListener('focus', function() {
                console.log('[AUTOCOMPLETE] Focus event triggered');
                const dropdown = document.getElementById('tickerAutocomplete');
                console.log('[AUTOCOMPLETE] Focus - dropdown exists:', !!dropdown);
                if (dropdown) {
                    console.log('[AUTOCOMPLETE] Focus - dropdown display:', dropdown.style.display);
                }
                showAutocomplete();
            });
            tickerInput.addEventListener('keydown', function(e) {
                const dropdown = document.getElementById('tickerAutocomplete');
                const isVisible = dropdown && dropdown.style.display === 'block';
                
                if (!isVisible) {
            if (e.key === 'Enter') {
                searchStock();
                    }
                    return;
                }

                const items = dropdown.querySelectorAll('.autocomplete-item[data-index]');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    autocompleteSelectedIndex = Math.min(autocompleteSelectedIndex + 1, items.length - 1);
                    setAutocompleteSelected(autocompleteSelectedIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    autocompleteSelectedIndex = Math.max(autocompleteSelectedIndex - 1, -1);
                    if (autocompleteSelectedIndex >= 0) {
                        setAutocompleteSelected(autocompleteSelectedIndex);
                    }
                } else if (e.key === 'Enter' && autocompleteSelectedIndex >= 0) {
                    e.preventDefault();
                    const selectedItem = items[autocompleteSelectedIndex];
                    if (selectedItem) {
                        const ticker = selectedItem.getAttribute('data-ticker');
                        selectAutocompleteItem(ticker);
                    }
                } else if (e.key === 'Enter') {
                    // If Enter pressed but no item selected, just search
                    searchStock();
                } else if (e.key === 'Escape') {
                    hideAutocomplete();
                }
            });

            // Mark as initialized
            tickerInput.dataset.autocompleteInitialized = 'true';
            autocompleteInitialized = true;
            console.log('[AUTOCOMPLETE] Initialized successfully', tickerInput);
            
            // Test: Try to show autocomplete immediately
            setTimeout(() => {
                const dropdown = document.getElementById('tickerAutocomplete');
                console.log('[AUTOCOMPLETE] Test - dropdown exists:', !!dropdown);
                if (dropdown) {
                    console.log('[AUTOCOMPLETE] Test - dropdown computed styles:', {
                        display: window.getComputedStyle(dropdown).display,
                        position: window.getComputedStyle(dropdown).position,
                        zIndex: window.getComputedStyle(dropdown).zIndex,
                        visibility: window.getComputedStyle(dropdown).visibility
                    });
                }
            }, 500);
        }

        // Initialize on page load if section is visible
        window.addEventListener('load', function() {
            setTimeout(() => {
                const stockSection = document.getElementById('stockAnalysisSection');
                if (stockSection && !stockSection.classList.contains('hidden')) {
                    initAutocomplete();
                }
            }, 500);
        });

        // Hide autocomplete when clicking outside (global listener)
        if (!document.autocompleteClickHandler) {
            document.autocompleteClickHandler = function(e) {
                const dropdown = document.getElementById('tickerAutocomplete');
                const input = document.getElementById('tickerInput');
                if (dropdown && input && !dropdown.contains(e.target) && !input.contains(e.target)) {
                    hideAutocomplete();
                }
            };
            document.addEventListener('click', document.autocompleteClickHandler);
        }

        function changeTimeframe(period) {
            currentTimeframe = period;
            
            // Update active button
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-period') === period) {
                    btn.classList.add('active');
                }
            });
            
            // Reload stock data if we have a ticker
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (ticker) {
                searchStock();
            }
        }

        async function searchStock() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (!ticker) {
                showError('Please enter a stock ticker');
                return;
            }

            // Hide autocomplete
            hideAutocomplete();

            // Add to search history (will get name from API response)
            // We'll update it after we get the stock data

            const button = document.querySelector('button[onclick*="searchStock"]');
            if (button && !button.classList.contains('loading')) {
                button.classList.add('loading');
                const originalText = button.innerHTML;
                button.innerHTML = 'ðŸ” Analyzing <span class="button-spinner"></span>';
                button.dataset.originalText = originalText;
            }

            showLoading();
            hideError();
            document.getElementById('results').classList.add('hidden');

            try {
                const response = await fetch(`/api/stock/${ticker}?period=${currentTimeframe}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch stock data');
                }

                // Ensure news is an array
                if (!data.news || !Array.isArray(data.news)) {
                    data.news = [];
                }

                // Add timestamp to data
                data.lastUpdated = new Date().toISOString();
                currentData = data;
                
                // Load annotations for this ticker and timeframe
                loadAnnotationsFromStorage();
                
                // Detect support/resistance levels if enabled
                if (chartFeatures.supportResistance) {
                    supportResistanceLevels = detectSupportResistanceLevels(data);
                }
                
                // Add to search history
                const stockName = data.info?.longName || data.info?.shortName || data.ticker || ticker;
                addToSearchHistory(ticker, stockName);
                
                // Make sure results section is visible first
                const resultsSection = document.getElementById('results');
                if (resultsSection) {
                    resultsSection.classList.remove('hidden');
                }
                
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                displayStockData(data);
                updateNewsAlertsButton(); // Update News Alerts button
                }, 50);
                
                hideLoading();
            } catch (error) {
                hideLoading();
                showError(error.message);
            } finally {
                const button = document.querySelector('button[onclick*="searchStock"]');
                if (button && button.classList.contains('loading')) {
                    button.classList.remove('loading');
                    button.innerHTML = button.dataset.originalText || 'ðŸ” Analyze';
                }
                
                // Re-enable refresh button
                const refreshBtn = document.getElementById('refreshDataBtn');
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = 'ðŸ”„ Refresh';
                }
            }
        }

        function displayStockData(data) {
            // Add to recent searches
            const ticker = data.ticker || document.getElementById('tickerInput').value.trim().toUpperCase();
            const companyName = data.company_info.name || ticker;
            addToRecentSearches(ticker, companyName);
            
            // Update header
            const stockNameEl = document.getElementById('stockName');
            stockNameEl.innerHTML = `${data.company_info.name || data.ticker} ${isFavorite(ticker) ? '<span style="font-size: 0.8em; margin-left: 8px;">â­</span>' : ''}`;
            document.getElementById('stockSector').textContent = 
                `${data.company_info.sector || 'N/A'} â€¢ ${data.company_info.industry || 'N/A'}`;
            
            // Add favorite button if not exists
            let favoriteBtn = document.getElementById('favoriteBtn');
            if (!favoriteBtn) {
                const headerDiv = document.querySelector('.stock-header');
                if (headerDiv) {
                    favoriteBtn = document.createElement('button');
                    favoriteBtn.id = 'favoriteBtn';
                    favoriteBtn.className = 'nav-button';
                    favoriteBtn.style.cssText = 'padding: 8px 16px; margin-top: 10px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; color: white; cursor: pointer; font-size: 0.9em;';
                    favoriteBtn.onclick = () => toggleFavorite(ticker);
                    headerDiv.appendChild(favoriteBtn);
                }
            }
            if (favoriteBtn) {
                favoriteBtn.innerHTML = isFavorite(ticker) ? 'â­ Remove from Favorites' : 'â˜† Add to Favorites';
            }
            
            // Update price
            const price = data.metrics.current_price;
            const change = data.metrics.price_change;
            const changePct = data.metrics.price_change_pct;
            
            document.getElementById('currentPrice').textContent = `$${price.toFixed(2)}`;
            const changeEl = document.getElementById('priceChange');
            changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%)`;
            changeEl.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
            
            // Update data freshness indicator
            if (data.lastUpdated) {
                updateDataFreshnessIndicator(data.lastUpdated);
            }

            // Update metrics
            displayMetrics(data.metrics);

            // Update company info
            document.getElementById('companyInfo').innerHTML = 
                `<p>${data.company_info.description || 'No description available.'}</p>`;

            // Display earnings QoQ
            if (data.earnings_qoq) {
            displayEarningsQoq(data.earnings_qoq);
            }

            // Display AI news summary
            displayNewsSummary(data.news_summary);
            
            // Show quick actions toolbar
            const quickActionsToolbar = document.getElementById('quickActionsToolbar');
            if (quickActionsToolbar) {
                quickActionsToolbar.style.display = 'block';
            }
            
            // Display volume analysis
            displayVolumeAnalysis(data.volume_analysis);
            
            // Display short interest
            displayShortInterest(data.short_interest);
            
            // Display news
            const newsContainer = document.getElementById('newsContainer');
            if (!newsContainer) {
                // Try to find it after a delay
                setTimeout(() => {
                    const retryContainer = document.getElementById('newsContainer');
                    if (retryContainer && data.news && Array.isArray(data.news) && data.news.length > 0) {
                displayNews(data.news);
                    }
                }, 200);
            } else {
                if (data.news && Array.isArray(data.news) && data.news.length > 0) {
                    displayNews(data.news);
                } else {
                    newsContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 3em; margin-bottom: 20px;">ðŸ“°</div>
                            <h3>No News Available</h3>
                            <p>No news articles found for this stock at this time.</p>
                        </div>
                    `;
                }
            }

            // Show/hide intraday timeframes based on chart type
            const intradayTimeframes = document.getElementById('intradayTimeframes');
            if (intradayTimeframes) {
                if (currentChartType === 'candlestick') {
                    intradayTimeframes.style.display = 'flex';
                } else {
                    intradayTimeframes.style.display = 'none';
                }
            }
            
            // Create charts based on current chart type
            if (currentChartType === 'line') {
                createPriceChart(data);
            } else {
                createCandlestickChart(data);
            }
            createRSIChart(data);
            createMACDChart(data);

            // Update watchlist sidebar
            updateWatchlistSidebar(data.ticker);

            // Update price alerts with current stock price
            updatePriceAlertsForTicker(data.ticker, data.metrics.current_price);
            displayPriceAlerts();
        }

        function updatePriceAlertsForTicker(ticker, currentPrice) {
            loadPriceAlerts();
            priceAlerts.forEach(alert => {
                if (alert.ticker === ticker && !alert.triggered) {
                    alert.currentPrice = currentPrice;
                }
            });
            savePriceAlerts();
        }

        function displayEarningsQoq(earningsData) {
            const container = document.getElementById('earningsQoq');
            console.log('[DEBUG] displayEarningsQoq called with data:', {
                hasData: !!earningsData,
                quarters: earningsData?.quarters,
                eps: earningsData?.eps,
                epsLength: earningsData?.eps?.length
            });
            
            if (!earningsData || !earningsData.quarters || earningsData.quarters.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Earnings data not available for this stock.</p>';
                return;
            }

            let tableHTML = '<div class="earnings-container"><table class="earnings-table"><thead><tr>';
            tableHTML += '<th>Quarter</th>';
            tableHTML += '<th>Revenue (B)</th><th>Rev QoQ</th><th>Rev QoQ %</th>';
            tableHTML += '<th>EPS</th><th>EPS QoQ</th><th>EPS QoQ %</th>';
            tableHTML += '<th>EPS Est.</th><th>EPS Act.</th><th>Surprise %</th>';
            tableHTML += '<th>Earnings (B)</th><th>Earn QoQ</th><th>Earn QoQ %</th>';
            tableHTML += '</tr></thead><tbody>';
            
            for (let i = 0; i < earningsData.quarters.length; i++) {
                const quarter = earningsData.quarters[i];
                const revenue = earningsData.revenue ? earningsData.revenue[i] : null;
                const revenueQoq = earningsData.revenue_qoq_change ? earningsData.revenue_qoq_change[i] : null;
                const revenueQoqPct = earningsData.revenue_qoq_change_pct ? earningsData.revenue_qoq_change_pct[i] : null;
                const eps = earningsData.eps ? earningsData.eps[i] : null;
                const epsQoq = earningsData.eps_qoq_change ? earningsData.eps_qoq_change[i] : null;
                const epsQoqPct = earningsData.eps_qoq_change_pct ? earningsData.eps_qoq_change_pct[i] : null;
                
                if (i < 4) {  // Log first 4 quarters
                    console.log(`[DEBUG] displayEarningsQoq ${quarter}: revenue=${revenue}, revenueQoq=${revenueQoq}, revenueQoqPct=${revenueQoqPct}, eps=${eps}, epsQoq=${epsQoq}, epsQoqPct=${epsQoqPct}`);
                }
                
                const epsEst = earningsData.eps_estimate ? earningsData.eps_estimate[i] : null;
                const epsRep = earningsData.eps_reported ? earningsData.eps_reported[i] : null;
                const epsSurprise = earningsData.eps_surprise_pct ? earningsData.eps_surprise_pct[i] : null;
                const earnings = earningsData.earnings && earningsData.earnings[i] !== undefined ? earningsData.earnings[i] : null;
                const earningsQoq = earningsData.earnings_qoq_change ? earningsData.earnings_qoq_change[i] : null;
                const earningsQoqPct = earningsData.earnings_qoq_change_pct ? earningsData.earnings_qoq_change_pct[i] : null;
                
                tableHTML += '<tr>';
                
                // Quarter
                tableHTML += `<td><strong>${quarter}</strong></td>`;
                
                // Helper function to safely format numbers
                const safeToFixed = (value, decimals = 2) => {
                    if (value === null || value === undefined || isNaN(value) || typeof value !== 'number') {
                        return null;
                    }
                    return value.toFixed(decimals);
                };
                
                // Revenue
                const revenueFormatted = safeToFixed(revenue);
                tableHTML += `<td>${revenueFormatted !== null ? '$' + revenueFormatted : 'N/A'}</td>`;
                const revenueQoqFormatted = safeToFixed(revenueQoq);
                if (revenueQoqFormatted !== null) {
                    const changeClass = revenueQoq >= 0 ? 'qoq-positive' : 'qoq-negative';
                    const changeSign = revenueQoq >= 0 ? '+' : '';
                    tableHTML += `<td class="${changeClass}">${changeSign}$${revenueQoqFormatted}B</td>`;
                } else {
                    tableHTML += '<td>-</td>';
                }
                const revenueQoqPctFormatted = safeToFixed(revenueQoqPct);
                if (revenueQoqPctFormatted !== null) {
                    const pctClass = revenueQoqPct >= 0 ? 'qoq-positive' : 'qoq-negative';
                    const pctSign = revenueQoqPct >= 0 ? '+' : '';
                    tableHTML += `<td class="${pctClass}">${pctSign}${revenueQoqPctFormatted}%</td>`;
                } else {
                    tableHTML += '<td>-</td>';
                }
                
                // EPS
                const epsFormatted = safeToFixed(eps);
                tableHTML += `<td>${epsFormatted !== null ? epsFormatted : 'N/A'}</td>`;
                const epsQoqFormatted = safeToFixed(epsQoq);
                if (epsQoqFormatted !== null) {
                    const changeClass = epsQoq >= 0 ? 'qoq-positive' : 'qoq-negative';
                    const changeSign = epsQoq >= 0 ? '+' : '';
                    tableHTML += `<td class="${changeClass}">${changeSign}${epsQoqFormatted}</td>`;
                } else {
                    tableHTML += '<td>-</td>';
                }
                const epsQoqPctFormatted = safeToFixed(epsQoqPct);
                if (epsQoqPctFormatted !== null) {
                    const pctClass = epsQoqPct >= 0 ? 'qoq-positive' : 'qoq-negative';
                    const pctSign = epsQoqPct >= 0 ? '+' : '';
                    tableHTML += `<td class="${pctClass}">${pctSign}${epsQoqPctFormatted}%</td>`;
                } else {
                    tableHTML += '<td>-</td>';
                }
                
                // EPS Estimates
                const epsEstFormatted = safeToFixed(epsEst);
                tableHTML += `<td>${epsEstFormatted !== null ? epsEstFormatted : '-'}</td>`;
                const epsRepFormatted = safeToFixed(epsRep);
                tableHTML += `<td>${epsRepFormatted !== null ? epsRepFormatted : '-'}</td>`;
                const epsSurpriseFormatted = safeToFixed(epsSurprise);
                if (epsSurpriseFormatted !== null) {
                    const surpriseClass = epsSurprise >= 0 ? 'surprise-positive' : 'surprise-negative';
                    const surpriseSign = epsSurprise >= 0 ? '+' : '';
                    tableHTML += `<td class="${surpriseClass}">${surpriseSign}${epsSurpriseFormatted}%</td>`;
                } else {
                    tableHTML += '<td>-</td>';
                }
                
                // Earnings
                const earningsFormatted = safeToFixed(earnings);
                tableHTML += `<td>${earningsFormatted !== null ? '$' + earningsFormatted : 'N/A'}</td>`;
                const earningsQoqFormatted = safeToFixed(earningsQoq);
                if (earningsQoqFormatted !== null) {
                    const changeClass = earningsQoq >= 0 ? 'qoq-positive' : 'qoq-negative';
                    const changeSign = earningsQoq >= 0 ? '+' : '';
                    tableHTML += `<td class="${changeClass}">${changeSign}$${earningsQoqFormatted}B</td>`;
                } else {
                    tableHTML += '<td>-</td>';
                }
                const earningsQoqPctFormatted = safeToFixed(earningsQoqPct);
                if (earningsQoqPctFormatted !== null) {
                    const pctClass = earningsQoqPct >= 0 ? 'qoq-positive' : 'qoq-negative';
                    const pctSign = earningsQoqPct >= 0 ? '+' : '';
                    tableHTML += `<td class="${pctClass}">${pctSign}${earningsQoqPctFormatted}%</td>`;
                } else {
                    tableHTML += '<td>-</td>';
                }
                
                tableHTML += '</tr>';
            }
            
            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        function formatRelativeTime(dateString) {
            if (!dateString || dateString === 'N/A') return 'N/A';
            
            try {
                // Try to parse different date formats
                let date;
                if (dateString.includes('T')) {
                    // ISO format
                    date = new Date(dateString);
                } else if (dateString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/)) {
                    // YYYY-MM-DD HH:MM format
                    date = new Date(dateString.replace(' ', 'T'));
                } else {
                    // Try standard parsing
                    date = new Date(dateString);
                }
                
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'PrÃ¡vÄ› teÄ';
                if (diffMins < 60) return `PÅ™ed ${diffMins} min`;
                if (diffHours < 24) return `PÅ™ed ${diffHours} ${diffHours === 1 ? 'hodinou' : 'hodinami'}`;
                if (diffDays < 7) return `PÅ™ed ${diffDays} ${diffDays === 1 ? 'dnem' : 'dny'}`;
                
                // Format as date
                const day = date.getDate();
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                
                if (diffDays < 365) {
                    return `${day}.${month}. ${hours}:${minutes}`;
                } else {
                    return `${day}.${month}.${year} ${hours}:${minutes}`;
                }
            } catch (e) {
                return dateString;
            }
        }

        function displayNewsSummary(summaryData) {
            const container = document.getElementById('newsSummaryContainer');
            
            if (!summaryData || !summaryData.summary) {
                container.innerHTML = '<p style="color: var(--text-secondary);">AI summary not available.</p>';
                return;
            }

            const sentimentClass = `sentiment-${summaryData.overall_sentiment}`;
            const sentimentLabel = summaryData.sentiment_label || summaryData.overall_sentiment;
            
            let html = `
                <div class="news-summary-card" style="background: var(--card-bg); border-radius: 15px; padding: 25px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">ðŸ“Š PÅ™ehled novinek</h3>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <span class="sentiment-badge ${sentimentClass}" style="font-size: 1em; padding: 8px 16px;">
                                ${sentimentLabel} (${summaryData.sentiment_score >= 0 ? '+' : ''}${summaryData.sentiment_score.toFixed(2)})
                            </span>
                            <span style="color: var(--text-secondary); font-size: 0.9em;">
                                ${summaryData.total_articles} ÄlÃ¡nkÅ¯
                            </span>
                        </div>
                    </div>
                    
                    <div style="background: rgba(102, 126, 234, 0.05); border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                        <pre style="white-space: pre-wrap; font-family: inherit; margin: 0; color: var(--text-primary); line-height: 1.6;">${summaryData.summary}</pre>
                    </div>
                    
                    ${summaryData.sentiment_breakdown ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1em;">ðŸ“ˆ RozdÄ›lenÃ­ sentimentu:</h4>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 120px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: 600; color: #10b981;">${summaryData.sentiment_breakdown.positive || 0}%</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">PozitivnÃ­</div>
                            </div>
                            <div style="flex: 1; min-width: 120px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: 600; color: #ef4444;">${summaryData.sentiment_breakdown.negative || 0}%</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">NegativnÃ­</div>
                            </div>
                            <div style="flex: 1; min-width: 120px; padding: 12px; background: rgba(156, 163, 175, 0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: 600; color: #9ca3af;">${summaryData.sentiment_breakdown.neutral || 0}%</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">NeutrÃ¡lnÃ­</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
            `;
            
            if (summaryData.key_points && summaryData.key_points.length > 0) {
                html += `
                    <div>
                        <h4 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1em;">ðŸ”‘ KlÃ­ÄovÃ© body:</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                `;
                
                for (const point of summaryData.key_points) {
                    const pointSentimentClass = `sentiment-${point.sentiment}`;
                    html += `
                        <div style="padding: 12px; background: var(--metric-bg); border-radius: 8px; border-left: 3px solid ${point.sentiment === 'positive' ? '#10b981' : point.sentiment === 'negative' ? '#ef4444' : '#9ca3af'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                                <div style="flex: 1; color: var(--text-primary);">${point.text}</div>
                                <span class="sentiment-badge ${pointSentimentClass}" style="font-size: 0.75em; padding: 4px 8px; white-space: nowrap;">
                                    ${point.sentiment === 'positive' ? 'ðŸ˜Š' : point.sentiment === 'negative' ? 'ðŸ˜Ÿ' : 'ðŸ˜'}
                                </span>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-tertiary); margin-top: 5px;">Zdroj: ${point.source}</div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            
            console.log('ðŸŽ¯ [DEBUG] displayFinancials: HTML generation complete, length:', html.length);
            console.log('ðŸŽ¯ [DEBUG] displayFinancials: About to show tabs container...');
            
            // ALWAYS show tabs container - make it visible immediately
            const tabsContainer = document.getElementById('financialsTabsContainer');
            console.log('ðŸ” [DEBUG] displayFinancials: tabsContainer found:', !!tabsContainer);
            console.log('ðŸ” [DEBUG] displayFinancials: tabsContainer element:', tabsContainer);
            console.log('ðŸ” [DEBUG] displayFinancials: Container element:', container);
            console.log('ðŸ” [DEBUG] displayFinancials: Container parent:', container?.parentElement);
            
            if (!tabsContainer) {
                console.error('âŒ [DEBUG] displayFinancials: tabsContainer NOT FOUND in DOM! Creating it...');
                // Create tabs container if it doesn't exist
                const financialsCard = container.closest('.card');
                if (financialsCard) {
                    const newTabsContainer = document.createElement('div');
                    newTabsContainer.id = 'financialsTabsContainer';
                    newTabsContainer.style.cssText = 'display: block !important; visibility: visible !important; margin-top: 20px;';
                    newTabsContainer.innerHTML = `
                        <div class="financials-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color);">
                            <button class="financials-tab-btn active" data-tab="overview" onclick="if(typeof switchFinancialsTab === 'function') { switchFinancialsTab('overview'); } return false;" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid var(--primary-500); color: var(--primary-500); cursor: pointer; font-weight: 600; font-size: 1em;">Overview</button>
                            <button class="financials-tab-btn" data-tab="detailed" onclick="if(typeof switchFinancialsTab === 'function') { switchFinancialsTab('detailed'); } return false;" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; font-size: 1em;">Detailed Financials</button>
                        </div>
                        <div id="financialsOverviewTab" class="financials-tab-content active" style="display: block;"></div>
                        <div id="financialsDetailedTab" class="financials-tab-content" style="display: none;">
                            <div id="detailedFinancialsContent"></div>
                        </div>
                    `;
                    financialsCard.appendChild(newTabsContainer);
                    console.log('âœ… [DEBUG] displayFinancials: Created tabs container dynamically');
                }
            }
            
            // Now get the tabs container (either existing or newly created)
            const finalTabsContainer = document.getElementById('financialsTabsContainer');
            if (finalTabsContainer) {
                // Force display block with !important via inline style
                finalTabsContainer.style.cssText = 'display: block !important; visibility: visible !important; margin-top: 20px;';
                console.log('âœ… [DEBUG] displayFinancials: tabsContainer displayed (forced)');
                console.log('âœ… [DEBUG] displayFinancials: tabsContainer computed display:', window.getComputedStyle(finalTabsContainer).display);
                
                // Set overview tab content
                const overviewTab = document.getElementById('financialsOverviewTab');
                if (overviewTab) {
                    overviewTab.innerHTML = html;
                    // Make sure overview tab is visible and active
                    overviewTab.style.display = 'block';
                    overviewTab.classList.add('active');
                    console.log('âœ… [DEBUG] displayFinancials: overviewTab content set, length:', html.length);
                } else {
                    console.error('âŒ [DEBUG] displayFinancials: financialsOverviewTab not found!');
                }
                
                // Set detailed tab as inactive initially
                const detailedTab = document.getElementById('financialsDetailedTab');
                if (detailedTab) {
                    detailedTab.style.display = 'none';
                    detailedTab.classList.remove('active');
                } else {
                    console.error('âŒ [DEBUG] displayFinancials: financialsDetailedTab not found!');
                }
                
                // Make sure Overview tab button is active
                const tabButtons = document.querySelectorAll('.financials-tab-btn');
                console.log('ðŸ”˜ [DEBUG] displayFinancials: Found', tabButtons.length, 'tab buttons');
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === 'overview') {
                        btn.classList.add('active');
                        btn.style.color = 'var(--primary-500)';
                        btn.style.borderBottomColor = 'var(--primary-500)';
                        console.log('âœ… [DEBUG] displayFinancials: Overview button activated');
                    } else {
                        btn.style.color = 'var(--text-secondary)';
                        btn.style.borderBottomColor = 'transparent';
                    }
                });
                
                // Render detailed financials to detailed tab
                const hasDetailedData = !!data.detailed_income_statement;
                const quarterlyLength = data.detailed_income_statement?.quarterly?.length || 0;
                const annualLength = data.detailed_income_statement?.annual?.length || 0;
                console.log('ðŸ“Š [DEBUG] displayFinancials: Data check for renderDetailedFinancials', {
                    hasDetailedIncomeStatement: hasDetailedData,
                    hasQuarterly: !!(data.detailed_income_statement && data.detailed_income_statement.quarterly),
                    quarterlyLength: quarterlyLength,
                    annualLength: annualLength,
                    allDataKeys: Object.keys(data || {}).slice(0, 15)
                });
                
                if (hasDetailedData && (quarterlyLength > 0 || annualLength > 0)) {
                    console.log('âœ… [DEBUG] displayFinancials: Calling renderDetailedFinancials...');
                    if (typeof renderDetailedFinancials === 'function') {
                        renderDetailedFinancials(data, ticker);
                    } else {
                        console.error('âŒ [DEBUG] displayFinancials: renderDetailedFinancials function not found!');
                    }
                } else {
                    console.warn('âš ï¸ [DEBUG] displayFinancials: No detailed data available - detailed_income_statement missing or empty');
                    const detailedContent = document.getElementById('detailedFinancialsContent');
                    if (detailedContent) {
                        detailedContent.innerHTML = `
                            <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                                <p style="font-size: 1.1em; margin-bottom: 15px;">âš ï¸ Detailed financial data not available from backend.</p>
                                <p style="font-size: 0.9em; margin-top: 10px;">Check browser console (F12) and server logs for details.</p>
                                <p style="font-size: 0.85em; margin-top: 10px; color: var(--text-tertiary);">
                                    Quarterly data: ${quarterlyLength} metrics<br>
                                    Annual data: ${annualLength} metrics
                                </p>
                            </div>
                        `;
                    } else {
                        console.error('âŒ [DEBUG] displayFinancials: detailedFinancialsContent container not found!');
                    }
                }
            } else {
                // Fallback if tabs still don't exist - render directly to container
                console.warn('âš ï¸ [DEBUG] displayFinancials: tabsContainer still not found after creation attempt, using fallback');
                container.innerHTML = html;
            }
        }

        // Switch between financials tabs
        function switchFinancialsTab(tabName) {
            console.log('ðŸ”„ [DEBUG] switchFinancialsTab: Called with tabName:', tabName);
            
            // Update tab buttons
            const buttons = document.querySelectorAll('.financials-tab-btn');
            console.log('ðŸ”„ [DEBUG] switchFinancialsTab: Found buttons:', buttons.length);
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                    btn.style.color = 'var(--primary-500)';
                    btn.style.borderBottomColor = 'var(--primary-500)';
                    console.log('âœ… [DEBUG] switchFinancialsTab: Activated button for', tabName);
                } else {
                    btn.style.color = 'var(--text-secondary)';
                    btn.style.borderBottomColor = 'transparent';
                }
            });
            
            // Update tab content
            document.querySelectorAll('.financials-tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            if (tabName === 'overview') {
                const overviewTab = document.getElementById('financialsOverviewTab');
                if (overviewTab) {
                    overviewTab.classList.add('active');
                    overviewTab.style.display = 'block';
                    console.log('âœ… [DEBUG] switchFinancialsTab: Overview tab shown');
                } else {
                    console.error('âŒ [DEBUG] switchFinancialsTab: Overview tab not found!');
                }
            } else if (tabName === 'detailed') {
                const detailedTab = document.getElementById('financialsDetailedTab');
                if (detailedTab) {
                    detailedTab.classList.add('active');
                    detailedTab.style.display = 'block';
                    console.log('âœ… [DEBUG] switchFinancialsTab: Detailed tab shown');
                    
                    // Check if content exists
                    const detailedContent = document.getElementById('detailedFinancialsContent');
                    if (detailedContent) {
                        console.log('âœ… [DEBUG] switchFinancialsTab: detailedFinancialsContent found, innerHTML length:', detailedContent.innerHTML.length);
                        if (!detailedContent.innerHTML || detailedContent.innerHTML.trim() === '' || detailedContent.innerHTML.includes('âš ï¸')) {
                            console.warn('âš ï¸ [DEBUG] switchFinancialsTab: detailedFinancialsContent is empty or has error, trying to re-render...');
                            
                            // Try to re-render if we have currentFinancialsData
                            if (typeof currentFinancialsData !== 'undefined' && currentFinancialsData) {
                                console.log('ðŸ”„ [DEBUG] switchFinancialsTab: Re-rendering with currentFinancialsData');
                                const ticker = document.getElementById('financialsTickerInput')?.value.trim().toUpperCase() || 'UNKNOWN';
                                renderDetailedFinancials(currentFinancialsData, ticker);
                            } else {
                                console.warn('âš ï¸ [DEBUG] switchFinancialsTab: currentFinancialsData not available');
                                detailedContent.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);"><p>âš ï¸ No detailed financial data available.</p><p style="font-size: 0.9em; margin-top: 10px;">Please load financials first, then check the console (F12) for details.</p></div>';
                            }
                        }
                    } else {
                        console.error('âŒ [DEBUG] switchFinancialsTab: detailedFinancialsContent container not found!');
                    }
                } else {
                    console.error('âŒ [DEBUG] switchFinancialsTab: Detailed tab not found!');
                }
            }
        }
        window.switchFinancialsTab = switchFinancialsTab;

        // Format number for display (millions/billions with commas)
        function formatDetailedNumber(value) {
            if (value === null || value === undefined || isNaN(value)) {
                return '-';
            }
            
            const absValue = Math.abs(value);
            let formatted;
            
            if (absValue >= 1e9) {
                formatted = (value / 1e9).toFixed(2) + 'B';
            } else if (absValue >= 1e6) {
                formatted = (value / 1e6).toFixed(2) + 'M';
            } else if (absValue >= 1e3) {
                formatted = (value / 1e3).toFixed(2) + 'K';
            } else {
                formatted = value.toFixed(2);
            }
            
            // Add commas for thousands
            const parts = formatted.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            formatted = parts.join('.');
            
            return formatted;
        }

        // Render detailed financials table
        function renderDetailedFinancials(data, ticker) {
            console.log('ðŸ“‹ [DEBUG] renderDetailedFinancials: Called for ticker:', ticker);
            console.log('ðŸ“‹ [DEBUG] renderDetailedFinancials: Data check:', {
                hasData: !!data,
                hasDetailedIncomeStatement: !!data?.detailed_income_statement,
                hasQuarterly: !!(data?.detailed_income_statement?.quarterly),
                quarterlyLength: data?.detailed_income_statement?.quarterly?.length || 0,
                allKeys: data ? Object.keys(data).slice(0, 20) : []
            });
            
            const container = document.getElementById('detailedFinancialsContent');
            if (!container) {
                console.error('âŒ [DEBUG] renderDetailedFinancials: detailedFinancialsContent container not found!');
                return;
            }
            console.log('âœ… [DEBUG] renderDetailedFinancials: Container found');
            
            if (!data || !data.detailed_income_statement) {
                console.warn('âš ï¸ [DEBUG] renderDetailedFinancials: No detailed_income_statement in data');
                container.innerHTML = '<p style="color: var(--text-secondary); padding: 20px;">âš ï¸ Detailed financial data not available. Backend may not have returned detailed_income_statement. Check server logs.</p>';
                return;
            }
            
            console.log('âœ… [DEBUG] renderDetailedFinancials: detailed_income_statement found, processing...');
            
            let quarterlyData = data.detailed_income_statement.quarterly || [];
            let annualData = data.detailed_income_statement.annual || [];
            
            // If no quarterly data, try to use annual data as fallback
            if (quarterlyData.length === 0 && annualData.length > 0) {
                console.log('âš ï¸ [DEBUG] renderDetailedFinancials: No quarterly data, using annual data as fallback');
                quarterlyData = annualData;
            }
            
            if (quarterlyData.length === 0) {
                console.warn('âš ï¸ [DEBUG] renderDetailedFinancials: No financial data available (neither quarterly nor annual)');
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);"><p>âš ï¸ No quarterly or annual financial data available for this ticker.</p><p style="font-size: 0.9em; margin-top: 10px;">This may be because:</p><ul style="text-align: left; display: inline-block; margin-top: 10px;"><li>The ticker is too new or delisted</li><li>Yahoo Finance does not have financial data for this company</li><li>There was an error fetching the data</li></ul><p style="font-size: 0.9em; margin-top: 15px;">Check the browser console (F12) and server logs for more details.</p></div>';
                return;
            }
            
            console.log('âœ… [DEBUG] renderDetailedFinancials: Processing', quarterlyData.length, 'metrics');
            
            // Get all unique quarter dates from all metrics
            const allDates = new Set();
            dataToUse.forEach(metric => {
                if (metric.values && typeof metric.values === 'object') {
                    Object.keys(metric.values).forEach(date => allDates.add(date));
                }
            });
            
            console.log('ðŸ“… [DEBUG] renderDetailedFinancials: Found', allDates.size, 'unique dates');
            
            // Sort dates (most recent first)
            const sortedDates = Array.from(allDates).sort((a, b) => {
                try {
                    const dateA = new Date(a);
                    const dateB = new Date(b);
                    return dateB - dateA; // Descending order
                } catch (e) {
                    return 0;
                }
            });
            
            // Take first 4 quarters/years for display
            const displayDates = sortedDates.slice(0, 4);
            console.log('ðŸ“… [DEBUG] renderDetailedFinancials: Display dates:', displayDates);
            
            let html = `
                <div class="detailed-financials-scroll">
                    <table class="detailed-financials-table">
                        <thead>
                            <tr>
                                <th>Breakdown</th>
                                <th>TTM</th>
                                ${displayDates.map(date => {
                                    try {
                                        const d = new Date(date);
                                        const month = d.toLocaleString('en-US', { month: 'short' });
                                        const day = d.getDate();
                                        const year = d.getFullYear();
                                        return `<th>${month} ${day}, ${year}</th>`;
                                    } catch (e) {
                                        return `<th>${date}</th>`;
                                    }
                                }).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Render each metric as a row
            console.log('ðŸ”„ [DEBUG] renderDetailedFinancials: Rendering', dataToUse.length, 'rows');
            dataToUse.forEach((metric, index) => {
                const metricName = metric.metric || 'Unknown';
                const ttm = metric.ttm;
                const values = metric.values || {};
                
                if (index < 3) {
                    console.log(`ðŸ“Š [DEBUG] renderDetailedFinancials: Row ${index}: ${metricName}, TTM: ${ttm}, has ${Object.keys(values).length} values`);
                }
                
                html += '<tr>';
                html += `<td style="font-weight: 500;">${metricName}</td>`;
                html += `<td class="metric-value ${ttm !== null && ttm !== undefined && ttm < 0 ? 'negative' : ''}">${ttm !== null && ttm !== undefined ? formatDetailedNumber(ttm) : '-'}</td>`;
                
                // Add values for each quarter/year
                displayDates.forEach(date => {
                    const value = values[date];
                    const cellClass = value !== null && value !== undefined && value < 0 ? 'negative' : '';
                    html += `<td class="metric-value ${cellClass}">${value !== null && value !== undefined ? formatDetailedNumber(value) : '-'}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        window.renderDetailedFinancials = renderDetailedFinancials;

        // Store current news data globally for impact analysis (used in stock analysis section)
        let currentStockNewsData = [];

        function displayVolumeAnalysis(volumeData) {
            const container = document.getElementById('volumeAnalysisContainer');
            if (!container) return;
            
            if (!volumeData) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Volume analysis data not available for this stock.</p>';
                return;
            }
            
            const currentVolume = volumeData.current_volume;
            const avg20d = volumeData.avg_volume_20d;
            const avg50d = volumeData.avg_volume_50d;
            const avg90d = volumeData.avg_volume_90d;
            const ratio20d = volumeData.volume_ratio_20d;
            const unusualActivity = volumeData.unusual_activity;
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">';
            
            // Current Volume
            html += `
                <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid var(--border-color);">
                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Current Volume</div>
                    <div style="font-size: 2em; font-weight: 700; color: var(--text-primary);">${formatVolume(currentVolume)}</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">Today's volume</div>
                </div>
            `;
            
            // Average Volume 20d
            if (avg20d) {
                const ratioColor = ratio20d > 2 ? '#ef4444' : ratio20d > 1.5 ? '#f59e0b' : '#10b981';
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid ${ratioColor};">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Avg Volume (20d)</div>
                        <div style="font-size: 2em; font-weight: 700; color: ${ratioColor};">${formatVolume(avg20d)}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">Ratio: ${ratio20d ? ratio20d.toFixed(2) + 'x' : 'N/A'}</div>
                    </div>
                `;
            }
            
            // Average Volume 50d
            if (avg50d) {
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid var(--border-color);">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Avg Volume (50d)</div>
                        <div style="font-size: 2em; font-weight: 700; color: var(--text-primary);">${formatVolume(avg50d)}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">50-day average</div>
                    </div>
                `;
            }
            
            // Average Volume 90d
            if (avg90d) {
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid var(--border-color);">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Avg Volume (90d)</div>
                        <div style="font-size: 2em; font-weight: 700; color: var(--text-primary);">${formatVolume(avg90d)}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">90-day average</div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Unusual Activity Alert
            if (unusualActivity) {
                html += `
                    <div style="padding: 15px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; border-radius: 8px; margin-top: 15px;">
                        <strong>âš ï¸ Unusual Activity Detected:</strong> Current volume is more than 2x the 20-day average. This may indicate significant news or events.
                    </div>
                `;
            }
            
            // Volume History Chart
            if (volumeData.volume_history && volumeData.volume_history.length > 0) {
                html += `
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ“ˆ Volume Trend (Last 60 Days)</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="volumeAnalysisChart"></canvas>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Create volume chart if data available
            if (volumeData.volume_history && volumeData.volume_history.length > 0) {
                setTimeout(() => {
                    const ctx = document.getElementById('volumeAnalysisChart');
                    if (ctx) {
                        const history = volumeData.volume_history;
                        const dates = history.map(d => d.date);
                        const volumes = history.map(d => d.volume);
                        const ma20 = history.map(d => d.ma20);
                        const ma50 = history.map(d => d.ma50);
                        const ma90 = history.map(d => d.ma90);
                        
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: dates,
                                datasets: [
                                    {
                                        label: 'Volume',
                                        data: volumes,
                                        borderColor: '#667eea',
                                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                        yAxisID: 'y',
                                        tension: 0.3,
                                        fill: true
                                    },
                                    {
                                        label: 'MA 20',
                                        data: ma20,
                                        borderColor: '#f59e0b',
                                        backgroundColor: 'transparent',
                                        yAxisID: 'y',
                                        tension: 0.3,
                                        borderDash: [5, 5]
                                    },
                                    {
                                        label: 'MA 50',
                                        data: ma50,
                                        borderColor: '#10b981',
                                        backgroundColor: 'transparent',
                                        yAxisID: 'y',
                                        tension: 0.3,
                                        borderDash: [5, 5],
                                        hidden: ma50.every(v => v === null)
                                    },
                                    {
                                        label: 'MA 90',
                                        data: ma90,
                                        borderColor: '#8b5cf6',
                                        backgroundColor: 'transparent',
                                        yAxisID: 'y',
                                        tension: 0.3,
                                        borderDash: [5, 5],
                                        hidden: ma90.every(v => v === null)
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false,
                                },
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                const value = context.parsed.y;
                                                label += formatVolume(value);
                                                return label;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Date'
                                        },
                                        ticks: {
                                            maxRotation: 45,
                                            minRotation: 45
                                        }
                                    },
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        title: {
                                            display: true,
                                            text: 'Volume'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return formatVolume(value);
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }, 100);
            }
        }
        
        function formatVolume(volume) {
            if (!volume || volume === 0) return '0';
            if (volume >= 1_000_000_000) {
                return (volume / 1_000_000_000).toFixed(2) + 'B';
            } else if (volume >= 1_000_000) {
                return (volume / 1_000_000).toFixed(2) + 'M';
            } else if (volume >= 1_000) {
                return (volume / 1_000).toFixed(2) + 'K';
            }
            return volume.toLocaleString();
        }

        function displayShortInterest(shortInterestData) {
            const container = document.getElementById('shortInterestContainer');
            if (!container) return;
            
            if (!shortInterestData) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Short interest data not available for this stock.</p>';
                return;
            }
            
            const shortFloatPct = shortInterestData.short_float_pct;
            const shortRatio = shortInterestData.short_ratio;
            const shortInterest = shortInterestData.short_interest;
            const squeezeScore = shortInterestData.squeeze_score || 0;
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">';
            
            // Short Float %
            if (shortFloatPct !== undefined && shortFloatPct !== null) {
                const floatColor = shortFloatPct > 20 ? '#ef4444' : shortFloatPct > 10 ? '#f59e0b' : '#10b981';
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid ${floatColor};">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Short Float</div>
                        <div style="font-size: 2em; font-weight: 700; color: ${floatColor};">${shortFloatPct.toFixed(2)}%</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">of float shorted</div>
                    </div>
                `;
            }
            
            // Short Ratio
            if (shortRatio !== undefined && shortRatio !== null) {
                const ratioColor = shortRatio > 5 ? '#ef4444' : shortRatio > 3 ? '#f59e0b' : '#10b981';
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid ${ratioColor};">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Short Ratio</div>
                        <div style="font-size: 2em; font-weight: 700; color: ${ratioColor};">${shortRatio.toFixed(2)}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">days to cover</div>
                    </div>
                `;
            }
            
            // Short Interest (absolute)
            if (shortInterest !== undefined && shortInterest !== null) {
                const shortInterestFormatted = shortInterest >= 1_000_000_000 
                    ? (shortInterest / 1_000_000_000).toFixed(2) + 'B'
                    : (shortInterest / 1_000_000).toFixed(2) + 'M';
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid var(--border-color);">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Short Interest</div>
                        <div style="font-size: 2em; font-weight: 700; color: var(--text-primary);">${shortInterestFormatted}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">shares shorted</div>
                    </div>
                `;
            }
            
            // Short Squeeze Score
            const squeezeColor = squeezeScore > 60 ? '#ef4444' : squeezeScore > 40 ? '#f59e0b' : '#10b981';
            html += `
                <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid ${squeezeColor};">
                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Squeeze Score</div>
                    <div style="font-size: 2em; font-weight: 700; color: ${squeezeColor};">${squeezeScore}/100</div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">squeeze potential</div>
                </div>
            `;
            
            html += '</div>';
            
            // Interpretation
            let interpretation = '';
            if (squeezeScore > 60) {
                interpretation = '<div style="padding: 15px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; border-radius: 8px; margin-top: 15px;"><strong>âš ï¸ High Squeeze Potential:</strong> This stock has high short interest, which could lead to a short squeeze if the price rises significantly.</div>';
            } else if (squeezeScore > 40) {
                interpretation = '<div style="padding: 15px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; border-radius: 8px; margin-top: 15px;"><strong>âš¡ Moderate Squeeze Potential:</strong> This stock has moderate short interest. Monitor price movements for potential squeeze opportunities.</div>';
            } else {
                interpretation = '<div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; border-radius: 8px; margin-top: 15px;"><strong>âœ“ Low Squeeze Potential:</strong> This stock has low short interest. Short squeeze is unlikely.</div>';
            }
            
            html += interpretation;
            
            // Add history chart if available
            if (shortInterestData.history && shortInterestData.history.length > 0) {
                html += `
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ“ˆ Short Interest History (Reported Every 15 Days)</h3>
                        <div style="position: relative; height: 400px;">
                            <canvas id="shortInterestHistoryChart"></canvas>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Create history chart if data available
            if (shortInterestData.history && shortInterestData.history.length > 0) {
                setTimeout(() => {
                    const ctx = document.getElementById('shortInterestHistoryChart');
                    if (ctx) {
                        const history = shortInterestData.history;
                        const dates = history.map(d => d.date);
                        const shortInterestValues = history.map(d => d.short_interest || 0);
                        const shortRatioValues = history.map(d => d.short_ratio || null);
                        
                        // Filter out null values for short ratio
                        const hasShortRatio = shortRatioValues.some(v => v !== null && v !== undefined);
                        
                        // Create chart with two y-axes
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: dates,
                                datasets: [
                                    {
                                        label: 'Short Interest (shares)',
                                        data: shortInterestValues,
                                        borderColor: '#ef4444',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        yAxisID: 'y',
                                        tension: 0.3,
                                        fill: true,
                                        pointRadius: 4,
                                        pointHoverRadius: 6
                                    },
                                    {
                                        label: 'Short Ratio (days to cover)',
                                        data: shortRatioValues,
                                        borderColor: '#f59e0b',
                                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                        yAxisID: 'y1',
                                        tension: 0.3,
                                        fill: false,
                                        pointRadius: 4,
                                        pointHoverRadius: 6,
                                        hidden: !hasShortRatio
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false,
                                },
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.datasetIndex === 0) {
                                                    // Short Interest in millions/billions
                                                    const value = context.parsed.y;
                                                    if (value >= 1_000_000_000) {
                                                        label += (value / 1_000_000_000).toFixed(2) + 'B shares';
                                                    } else if (value >= 1_000_000) {
                                                        label += (value / 1_000_000).toFixed(2) + 'M shares';
                                                    } else if (value >= 1_000) {
                                                        label += (value / 1_000).toFixed(2) + 'K shares';
                                                    } else {
                                                        label += value.toLocaleString() + ' shares';
                                                    }
                                                } else {
                                                    // Short Ratio
                                                    label += context.parsed.y.toFixed(2) + ' days';
                                                }
                                                return label;
                                            },
                                            afterBody: function(context) {
                                                const index = context[0].dataIndex;
                                                const floatPct = history[index].short_float_pct;
                                                if (floatPct !== null && floatPct !== undefined && floatPct > 0) {
                                                    return `Short Float: ${floatPct.toFixed(2)}%`;
                                                }
                                                return '';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Date (Reported Every 15 Days)'
                                        },
                                        ticks: {
                                            maxRotation: 45,
                                            minRotation: 45
                                        }
                                    },
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        title: {
                                            display: true,
                                            text: 'Short Interest (shares)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                if (value >= 1_000_000_000) {
                                                    return (value / 1_000_000_000).toFixed(1) + 'B';
                                                } else if (value >= 1_000_000) {
                                                    return (value / 1_000_000).toFixed(1) + 'M';
                                                } else if (value >= 1_000) {
                                                    return (value / 1_000).toFixed(1) + 'K';
                                                }
                                                return value;
                                            }
                                        }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        title: {
                                            display: true,
                                            text: 'Short Ratio (days)'
                                        },
                                        grid: {
                                            drawOnChartArea: false,
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value.toFixed(1);
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }, 100);
            }
        }

        function displayNews(newsData) {
            try {
                // Use newsContainer for Stock Analysis section
            const container = document.getElementById('newsContainer');
                if (!container) {
                    return;
                }
            
            // Handle both array and object with news property
            let newsArray = null;
            if (Array.isArray(newsData)) {
                newsArray = newsData;
            } else if (newsData && newsData.news && Array.isArray(newsData.news)) {
                newsArray = newsData.news;
                // Store the full object if it has ticker and company_name
                if (newsData.ticker) {
                    currentNewsData = newsData;
                }
            }
            
            if (!newsArray || newsArray.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No news available for this stock.</p>';
                if (!currentNewsData || !currentNewsData.ticker) {
                    currentNewsData = null;
                }
                return;
            }
            
            console.log('Rendering', newsArray.length, 'news articles');

            // Sort by date (newest first)
            const sortedNews = [...newsArray].sort((a, b) => {
                try {
                    const dateA = new Date(a.published || 0);
                    const dateB = new Date(b.published || 0);
                    return dateB - dateA;
                } catch {
                    return 0;
                }
            });

            // Store sorted news globally
            // If currentNewsData is already an object with ticker, update its news array
            // Otherwise, store as array (for Stock Analysis) or create object if we have ticker info
            if (currentNewsData && currentNewsData.ticker) {
                currentNewsData.news = sortedNews;
            } else if (currentData && currentData.ticker) {
                // Create object with ticker info for Stock Analysis
                currentNewsData = {
                    ticker: currentData.ticker,
                    news: sortedNews,
                    company_name: currentData.company_info?.name || currentData.ticker
                };
            } else {
                // Fallback: store as array
            currentNewsData = sortedNews;
            }
            
            let newsHTML = '';
            
            try {
            sortedNews.forEach((news, index) => {
                const sentimentClass = `sentiment-${news.sentiment}`;
                const sentimentLabel = news.sentiment_label || news.sentiment;
                const sentimentScore = news.sentiment_score !== undefined ? news.sentiment_score : null;
                const relativeTime = formatRelativeTime(news.published);
                const ticker = currentData ? currentData.ticker : '';
                
                newsHTML += '<div class="news-item">';
                newsHTML += '<div class="news-header">';
                
                // Title with link
                if (news.link) {
                    newsHTML += `<h3 class="news-title"><a href="${news.link}" target="_blank" rel="noopener noreferrer">${news.title || 'No title'}</a></h3>`;
                } else {
                    newsHTML += `<h3 class="news-title">${news.title || 'No title'}</h3>`;
                }
                
                // Sentiment badge
                newsHTML += `<span class="sentiment-badge ${sentimentClass}">${sentimentLabel}`;
                if (sentimentScore !== null) {
                    const scoreSign = sentimentScore >= 0 ? '+' : '';
                    newsHTML += `<span class="sentiment-score">${scoreSign}${sentimentScore.toFixed(2)}</span>`;
                }
                newsHTML += '</span>';
                
                newsHTML += '</div>';
                
                // Summary
                if (news.summary && news.summary !== 'No summary available') {
                    newsHTML += `<p class="news-summary">${news.summary}</p>`;
                }
                
                // Meta info with better formatting
                newsHTML += '<div class="news-meta">';
                if (news.publisher && news.publisher !== 'Unknown') {
                    newsHTML += `<div class="news-publisher">ðŸ“° ${news.publisher}</div>`;
                }
                // Always show date - formatRelativeTime handles N/A and other cases
                const dateDisplay = formatRelativeTime(news.published);
                newsHTML += `<div class="news-date"><span class="news-date-icon">ðŸ“…</span><span>${dateDisplay}</span></div>`;
                newsHTML += '</div>';
                
                // AI Impact Analysis button
                newsHTML += `
                    <button onclick="analyzeNewsImpact(${index}, '${ticker}', event)" 
                            class="ripple-effect" 
                            style="margin-top: 12px; padding: 8px 16px; background: rgba(102, 126, 234, 0.1); color: #667eea; border: 1px solid #667eea; border-radius: 6px; font-size: 0.85em; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        ðŸ¤– Analyze Impact
                    </button>
                `;
                
                // Impact analysis container
                newsHTML += `<div id="newsImpact_${index}" style="display: none; margin-top: 15px;"></div>`;
                
                newsHTML += '</div>';
            });
            } catch (forEachError) {
                throw forEachError;
            }
            
                if (newsHTML) {
            container.innerHTML = newsHTML;
                    
                    // Ensure both stockAnalysisSection and results section are visible
                    const resultsSection = document.getElementById('results');
                    const stockAnalysisSection = document.getElementById('stockAnalysisSection');
                    if (stockAnalysisSection && stockAnalysisSection.classList.contains('hidden')) {
                        stockAnalysisSection.classList.remove('hidden');
                    }
                    if (resultsSection && resultsSection.classList.contains('hidden')) {
                        resultsSection.classList.remove('hidden');
                    }
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary);">Error rendering news.</p>';
                }
            } catch (error) {
                console.error('Error in displayNews:', error);
                const container = document.getElementById('newsContainer');
                if (container) {
                    container.innerHTML = `<p style="color: var(--text-secondary);">Error displaying news: ${error.message}</p>`;
                }
            }
        }

        async function analyzeNewsImpact(newsIndex, ticker, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addRippleEffect(event);
            }
            
            // Get news data from stored array or DOM
            let newsTitle = '';
            let newsSummary = '';
            
            // Handle both array and object formats
            let newsArray = null;
            if (Array.isArray(currentNewsData)) {
                newsArray = currentNewsData;
            } else if (currentNewsData && currentNewsData.news && Array.isArray(currentNewsData.news)) {
                newsArray = currentNewsData.news;
            }
            
            if (newsArray && newsArray[newsIndex]) {
                // Use stored news data (preferred)
                const news = newsArray[newsIndex];
                newsTitle = news.title || '';
                newsSummary = news.summary || '';
            } else {
                // Fallback to DOM
                const newsContainer = document.getElementById('newsContainer');
                if (!newsContainer) return;
                
                const newsItems = newsContainer.querySelectorAll('.news-item');
                if (!newsItems || newsItems.length <= newsIndex) return;
                
                const newsItem = newsItems[newsIndex];
                newsTitle = newsItem.querySelector('.news-title')?.textContent?.trim() || '';
                newsSummary = newsItem.querySelector('.news-summary')?.textContent?.trim() || '';
            }
            
            if (!newsTitle && !newsSummary) {
                showToast('News data not available', 'error');
                return;
            }
            
            // Find impact container and button
            const impactContainer = document.getElementById(`newsImpact_${newsIndex}`);
            if (!impactContainer) {
                showToast('Impact container not found', 'error');
                return;
            }
            
            // Find button - try to find it in the news item
            const newsContainer = document.getElementById('newsContainer');
            let analyzeButton = null;
            if (newsContainer) {
                const newsItems = newsContainer.querySelectorAll('.news-item');
                if (newsItems && newsItems[newsIndex]) {
                    analyzeButton = newsItems[newsIndex].querySelector('button[onclick*="analyzeNewsImpact"]');
                }
            }
            
            if (!analyzeButton && event) {
                analyzeButton = event.target;
            }
            
            if (!analyzeButton) {
                showToast('Analyze button not found', 'error');
                return;
            }
            
            // Show loading state
            analyzeButton.disabled = true;
            const originalButtonText = analyzeButton.innerHTML;
            analyzeButton.innerHTML = 'â³ Analyzing...';
            impactContainer.style.display = 'block';
            impactContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; background: var(--metric-bg); border-radius: 10px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9em;">Analyzing news impact...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/analyze-news-impact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: newsTitle,
                        summary: newsSummary,
                        content: '',
                        ticker: ticker
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to analyze news impact');
                }
                
                // Display results
                displayNewsImpactAnalysis(data, impactContainer);
                
            } catch (error) {
                console.error('Error analyzing news impact:', error);
                impactContainer.innerHTML = `
                    <div style="padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
                        <div style="color: #ef4444; font-weight: 600; margin-bottom: 5px;">âŒ Error</div>
                        <div style="color: var(--text-secondary); font-size: 0.9em;">${error.message}</div>
                        <button onclick="analyzeNewsImpact(${newsIndex}, '${ticker}', event)" 
                                style="margin-top: 10px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                            Retry
                        </button>
                    </div>
                `;
            } finally {
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = originalButtonText;
            }
        }

        function displayNewsImpactAnalysis(data, container) {
            if (!container) return;
            
            const impact = data.impact_assessment || 'neutral';
            const level = data.impact_level || 'medium';
            const factors = data.key_factors || [];
            const explanation = data.explanation || '';
            const priceEstimate = data.price_impact_estimate || '';
            
            // Color coding
            const impactColors = {
                'positive': { bg: 'rgba(16, 185, 129, 0.1)', border: '#10b981', emoji: 'ðŸŸ¢' },
                'negative': { bg: 'rgba(239, 68, 68, 0.1)', border: '#ef4444', emoji: 'ðŸ”´' },
                'neutral': { bg: 'rgba(245, 158, 11, 0.1)', border: '#f59e0b', emoji: 'ðŸŸ¡' }
            };
            
            const levelLabels = {
                'high': 'VysokÃ½',
                'medium': 'StÅ™ednÃ­',
                'low': 'NÃ­zkÃ½'
            };
            
            const impactLabels = {
                'positive': 'PozitivnÃ­',
                'negative': 'NegativnÃ­',
                'neutral': 'NeutrÃ¡lnÃ­'
            };
            
            const colors = impactColors[impact] || impactColors['neutral'];
            
            // Helper function to escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            let html = `
                <div style="padding: 20px; background: ${colors.bg}; border-radius: 10px; border-left: 4px solid ${colors.border};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h5 style="margin: 0; color: var(--text-primary); font-size: 1.1em;">
                            ${colors.emoji} Impact Assessment: ${impactLabels[impact]}
                        </h5>
                        <span style="font-size: 0.85em; color: var(--text-secondary); padding: 4px 12px; background: ${colors.border}20; border-radius: 6px;">
                            ${levelLabels[level]} dopad
                        </span>
                    </div>
                    
                    ${factors.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <h6 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1em; font-weight: 600;">KlÃ­ÄovÃ© faktory:</h6>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${factors.map(factor => `
                                    <li style="padding: 8px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                        <span style="position: absolute; left: 0; color: ${colors.border};">â€¢</span>${escapeHtml(factor)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${explanation ? `
                        <div style="margin-bottom: 15px;">
                            <h6 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1em; font-weight: 600;">VysvÄ›tlenÃ­:</h6>
                            <p style="color: var(--text-primary); line-height: 1.6; margin: 0;">${escapeHtml(explanation)}</p>
                        </div>
                    ` : ''}
                    
                    ${priceEstimate ? `
                        <div style="margin-top: 15px; padding: 12px; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                            <h6 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 0.95em; font-weight: 600;">ðŸ’° Odhad dopadu na cenu:</h6>
                            <p style="color: var(--text-secondary); font-size: 0.9em; margin: 0; line-height: 1.5;">${escapeHtml(priceEstimate)}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Simple/Advanced tooltip mode
        let tooltipMode = localStorage.getItem('tooltipMode') || 'simple';
        
        function toggleTooltipMode() {
            tooltipMode = tooltipMode === 'simple' ? 'advanced' : 'simple';
            localStorage.setItem('tooltipMode', tooltipMode);
            showToast(`Tooltips: ${tooltipMode === 'simple' ? 'JednoduchÃ©' : 'PokroÄilÃ©'}`, 'info');
        }
        
        const metricTooltipsSimple = {
            'Market Cap': 'CelkovÃ¡ trÅ¾nÃ­ hodnota vÅ¡ech akciÃ­',
            'P/E Ratio': 'PomÄ›r ceny k zisku. NiÅ¾Å¡Ã­ = levnÄ›jÅ¡Ã­',
            'Forward P/E': 'P/E pomÄ›r zaloÅ¾enÃ½ na oÄekÃ¡vanÃ©m zisku',
            'Dividend Yield': 'RoÄnÃ­ dividenda jako % z ceny akcie',
            'Beta': 'Volatilita oproti trhu. >1 = vÃ­ce volatilnÃ­',
            'EPS': 'Zisk na akcii. VyÅ¡Å¡Ã­ = lepÅ¡Ã­',
            'Price to Book': 'PomÄ›r ceny k ÃºÄetnÃ­ hodnotÄ›',
            'Profit Margin': '% z trÅ¾eb, kterÃ© jsou zisk',
            '52 Week High': 'NejvyÅ¡Å¡Ã­ cena za poslednÃ­ rok',
            '52 Week Low': 'NejniÅ¾Å¡Ã­ cena za poslednÃ­ rok',
            'Volatility (30d)': 'KolÃ­sÃ¡nÃ­ ceny za 30 dnÃ­',
            'Volume': 'PoÄet obchodovanÃ½ch akciÃ­ dnes'
        };
        
        const metricTooltipsAdvanced = {
            'Market Cap': 'Total market value of all outstanding shares. Calculated as share price Ã— number of shares.',
            'P/E Ratio': 'Price-to-Earnings ratio. Shows how much investors pay per dollar of earnings. Lower is generally better.',
            'Forward P/E': 'Forward Price-to-Earnings ratio based on projected earnings. Helps assess future valuation.',
            'Dividend Yield': 'Annual dividend payment as a percentage of stock price. Higher yield = more income for investors.',
            'Beta': 'Measures stock volatility compared to the market. Beta > 1 = more volatile, < 1 = less volatile.',
            'EPS': 'Earnings Per Share - Company profit divided by number of shares. Higher is better.',
            'Price to Book': 'Compares stock price to company book value. Lower may indicate undervaluation.',
            'Profit Margin': 'Percentage of revenue that becomes profit. Higher = more efficient company.',
            '52 Week High': 'Highest price the stock reached in the past 52 weeks.',
            '52 Week Low': 'Lowest price the stock reached in the past 52 weeks.',
            'Volatility (30d)': 'Measure of price fluctuations over 30 days. Higher volatility = more price swings (riskier).',
            'Volume': 'Number of shares traded today. Higher volume = more interest and liquidity.'
        };
        
        const metricTooltips = tooltipMode === 'simple' ? metricTooltipsSimple : metricTooltipsAdvanced;

        function displayMetrics(metrics) {
            const grid = document.getElementById('metricsGrid');
            const metricItems = [
                { label: 'Market Cap', value: formatMarketCap(metrics.market_cap) },
                { label: 'P/E Ratio', value: metrics.pe_ratio ? metrics.pe_ratio.toFixed(2) : 'N/A' },
                { label: 'Forward P/E', value: metrics.forward_pe ? metrics.forward_pe.toFixed(2) : 'N/A' },
                { label: 'Dividend Yield', value: metrics.dividend_yield ? (metrics.dividend_yield * 100).toFixed(2) + '%' : 'N/A' },
                { label: 'Beta', value: metrics.beta ? metrics.beta.toFixed(2) : 'N/A' },
                { label: 'EPS', value: metrics.eps ? metrics.eps.toFixed(2) : 'N/A' },
                { label: 'Price to Book', value: metrics.price_to_book ? metrics.price_to_book.toFixed(2) : 'N/A' },
                { label: 'Profit Margin', value: metrics.profit_margin ? (metrics.profit_margin * 100).toFixed(2) + '%' : 'N/A' },
                { label: '52 Week High', value: `$${metrics.year_high.toFixed(2)}` },
                { label: '52 Week Low', value: `$${metrics.year_low.toFixed(2)}` },
                { label: 'Volatility (30d)', value: metrics.volatility ? metrics.volatility.toFixed(2) + '%' : 'N/A' },
                { label: 'Volume', value: formatNumber(metrics.volume) },
            ];

            const currentTooltips = tooltipMode === 'simple' ? metricTooltipsSimple : metricTooltipsAdvanced;
            grid.innerHTML = metricItems.map(item => {
                const tooltip = currentTooltips[item.label] || '';
                return `
                    <div class="metric-item">
                        <div class="metric-label">
                            ${item.label}
                            ${tooltip ? `<span class="tooltip" style="margin-left: 6px; cursor: help;">â„¹ï¸<span class="tooltiptext">${tooltip}</span></span>` : ''}
                        </div>
                        <div class="metric-value">${item.value}</div>
                    </div>
                `;
            }).join('');
        }

        function switchChartType(type) {
            currentChartType = type;
            
            // Update button styles
            const lineBtn = document.getElementById('chartTypeLine');
            const candlestickBtn = document.getElementById('chartTypeCandlestick');
            const intradayTimeframes = document.getElementById('intradayTimeframes');
            
            if (type === 'line') {
                lineBtn.style.background = '#667eea';
                lineBtn.style.color = 'white';
                lineBtn.style.border = 'none';
                candlestickBtn.style.background = 'rgba(255,255,255,0.1)';
                candlestickBtn.style.color = 'var(--text-primary)';
                candlestickBtn.style.border = '2px solid rgba(255,255,255,0.3)';
                
                // Hide intraday timeframes for line chart
                if (intradayTimeframes) {
                    intradayTimeframes.style.display = 'none';
                }
                
                // If current timeframe is intraday, switch to 1y
                const intradayTimeframes_list = ['1m', '5m', '15m', '1h', '4h', '1d', '1w'];
                if (intradayTimeframes_list.includes(currentTimeframe)) {
                    changeTimeframe('1y');
                }
                
                document.getElementById('priceChart').style.display = 'block';
                const candlestickContainer = document.getElementById('candlestickChart');
                candlestickContainer.style.display = 'none';
                // Destroy candlestick chart when switching away
                if (candlestickChart) {
                    candlestickChart.remove();
                    candlestickChart = null;
                }
            } else {
                lineBtn.style.background = 'rgba(255,255,255,0.1)';
                lineBtn.style.color = 'var(--text-primary)';
                lineBtn.style.border = '2px solid rgba(255,255,255,0.3)';
                candlestickBtn.style.background = '#667eea';
                candlestickBtn.style.color = 'white';
                candlestickBtn.style.border = 'none';
                
                // Show intraday timeframes for candlestick chart
                if (intradayTimeframes) {
                    intradayTimeframes.style.display = 'flex';
                }
                
                document.getElementById('priceChart').style.display = 'none';
                const candlestickContainer = document.getElementById('candlestickChart');
                candlestickContainer.style.display = 'block';
                
                // Small delay to ensure container is visible before creating chart
                setTimeout(() => {
                    if (currentData) {
                        createCandlestickChart(currentData);
                    }
                }, 50);
                return; // Don't create line chart
            }
            
            // Recreate chart with new type
            if (currentData && type === 'line') {
                createPriceChart(currentData);
            }
        }

        function createPriceChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            // Show line chart, hide candlestick
            document.getElementById('priceChart').style.display = 'block';
            document.getElementById('candlestickChart').style.display = 'none';

            const datasets = [{
                label: 'ðŸ’° Close Price',
                data: data.chart_data.close,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.1,
                pointRadius: 0,
                pointHoverRadius: 5
            }];

            if (indicatorVisibility.sma && data.indicators.sma_20) {
                datasets.push({
                    label: 'SMA 20',
                    data: data.indicators.sma_20,
                    borderColor: '#f59e0b',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0
                });
                datasets.push({
                    label: 'SMA 50',
                    data: data.indicators.sma_50,
                    borderColor: '#ef4444',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0
                });
            }

            if (indicatorVisibility.ema && data.indicators.ema_12) {
                datasets.push({
                    label: 'EMA 12',
                    data: data.indicators.ema_12,
                    borderColor: '#10b981',
                    borderWidth: 1,
                    pointRadius: 0
                });
                datasets.push({
                    label: 'EMA 26',
                    data: data.indicators.ema_26,
                    borderColor: '#3b82f6',
                    borderWidth: 1,
                    pointRadius: 0
                });
            }

            if (indicatorVisibility.bb && data.indicators.bb_high) {
                datasets.push({
                    label: 'BB Upper',
                    data: data.indicators.bb_high,
                    borderColor: '#8b5cf6',
                    borderWidth: 1,
                    borderDash: [3, 3],
                    pointRadius: 0
                });
                datasets.push({
                    label: 'BB Lower',
                    data: data.indicators.bb_low,
                    borderColor: '#8b5cf6',
                    borderWidth: 1,
                    borderDash: [3, 3],
                    pointRadius: 0
                });
            }

            // Add volume overlay if enabled
            if (chartFeatures.volumeOverlay && data.chart_data.volume) {
                const volumes = data.chart_data.volume;
                const closes = data.chart_data.close;
                const volumeColors = volumes.map((vol, i) => {
                    if (i === 0) return 'rgba(102, 126, 234, 0.3)';
                    return closes[i] >= closes[i-1] ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)';
                });
                
                datasets.push({
                    label: 'Volume',
                    data: volumes,
                    type: 'bar',
                    yAxisID: 'y1',
                    backgroundColor: volumeColors,
                    borderColor: volumeColors,
                    borderWidth: 0,
                    order: 0
                });
            }


            const isDark = document.body.classList.contains('dark-mode');
            const chartTextColor = isDark ? '#f5f5f5' : '#333';
            const chartGridColor = isDark ? '#3a3a3a' : '#e0e0e0';
            const chartBgColor = isDark ? '#1e1e1e' : '#ffffff';

            const scalesConfig = {
                y: {
                    beginAtZero: false,
                    position: 'left',
                    ticks: {
                        color: chartTextColor
                    },
                    grid: {
                        color: chartGridColor
                    }
                },
                x: {
                    ticks: {
                        maxTicksLimit: 10,
                        color: chartTextColor
                    },
                    grid: {
                        color: chartGridColor
                    }
                }
            };

            // Add secondary Y-axis for volume if volume overlay is enabled
            if (chartFeatures.volumeOverlay && data.chart_data.volume) {
                scalesConfig.y1 = {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    ticks: {
                        color: chartTextColor,
                        callback: function(value) {
                            if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B';
                            if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
                            if (value >= 1e3) return (value / 1e3).toFixed(1) + 'K';
                            return value;
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                };
            }

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chart_data.dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'start',
                            fullSize: true,
                            labels: {
                                color: chartTextColor,
                                usePointStyle: true,
                                pointStyle: 'line',
                                padding: 20,
                                font: {
                                    size: 13,
                                    weight: '600',
                                    family: 'Inter, sans-serif'
                                },
                                boxWidth: 40,
                                boxHeight: 2,
                                generateLabels: function(chart) {
                                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                    const labels = original.call(this, chart);
                                    const isDark = document.body.classList.contains('dark-mode');
                                    const textColor = isDark ? '#f5f5f5' : '#333';
                                    
                                    // Force light color in dark mode for all labels
                                    labels.forEach(label => {
                                        label.fontColor = textColor;
                                        label.fillStyle = textColor;
                                        label.textFillStyle = textColor;
                                        if (label.text.includes('ðŸ“Š') || label.text.includes('S&P 500') || label.text.includes('NASDAQ')) {
                                            label.fontStyle = 'bold';
                                            label.fontSize = 15;
                                            label.fontWeight = '800';
                                            label.fontColor = textColor;
                                            label.textFillStyle = textColor;
                                        }
                                        if (label.text.includes('ðŸ’°') || label.text.includes('Close Price')) {
                                            label.fontSize = 14;
                                            label.fontWeight = '700';
                                            label.fontColor = textColor;
                                            label.textFillStyle = textColor;
                                        }
                                    });
                                    return labels;
                                }
                            },
                            title: {
                                display: true,
                                text: 'Legend - Click to toggle visibility',
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '400',
                                    style: 'italic'
                                },
                                padding: {
                                    bottom: 10
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isDark ? 'rgba(30, 30, 30, 0.98)' : 'rgba(255, 255, 255, 0.98)',
                            titleColor: isDark ? '#f5f5f5' : '#333',
                            bodyColor: isDark ? '#f5f5f5' : '#333',
                            borderColor: isDark ? '#555' : '#ddd',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: {
                                size: 13,
                                weight: '600',
                                color: isDark ? '#f5f5f5' : '#333'
                            },
                            bodyFont: {
                                size: 12,
                                color: isDark ? '#f5f5f5' : '#333'
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: scalesConfig,
                    onClick: chartFeatures.annotationMode ? function(event, elements) {
                        if (elements.length > 0) {
                            const element = elements[0];
                            const index = element.index;
                            const date = data.chart_data.dates[index];
                            const price = data.chart_data.close[index];
                            addChartAnnotation(date, price, index);
                        }
                    } : undefined
                }
            });

            // Add support/resistance levels if enabled
            if (chartFeatures.supportResistance && supportResistanceLevels) {
                addSupportResistanceToChart(priceChart, supportResistanceLevels, data.chart_data);
            }

            // Add annotations to chart if any exist
            if (chartAnnotations.length > 0) {
                addAnnotationsToChart(priceChart, data.chart_data);
            }
        }

        // Toggle functions for chart features
        window.toggleVolumeOverlay = function() {
            console.log('toggleVolumeOverlay called');
            chartFeatures.volumeOverlay = !chartFeatures.volumeOverlay;
            const btn = document.getElementById('toggleVolume');
            if (!btn) {
                console.error('toggleVolume button not found');
                return;
            }
            if (chartFeatures.volumeOverlay) {
                btn.style.background = '#667eea';
                btn.style.color = 'white';
            } else {
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.color = 'var(--text-primary)';
            }
            if (currentData) {
                if (currentChartType === 'line') {
                    createPriceChart(currentData);
                } else {
                    createCandlestickChart(currentData);
                }
            }
        };


        window.toggleSupportResistance = async function() {
            console.log('toggleSupportResistance called');
            chartFeatures.supportResistance = !chartFeatures.supportResistance;
            const btn = document.getElementById('toggleSupportResistance');
            
            if (!btn) {
                console.error('toggleSupportResistance button not found');
                return;
            }
            
            if (chartFeatures.supportResistance) {
                btn.style.background = '#667eea';
                btn.style.color = 'white';
                // Detect support/resistance levels
                if (!supportResistanceLevels && currentData) {
                    supportResistanceLevels = detectSupportResistanceLevels(currentData);
                }
            } else {
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.color = 'var(--text-primary)';
            }
            
            if (currentData) {
                if (currentChartType === 'line') {
                    createPriceChart(currentData);
                } else {
                    createCandlestickChart(currentData);
                }
            }
        };

        window.toggleAnnotationMode = function() {
            console.log('toggleAnnotationMode called');
            chartFeatures.annotationMode = !chartFeatures.annotationMode;
            const btn = document.getElementById('toggleAnnotations');
            
            if (!btn) {
                console.error('toggleAnnotations button not found');
                return;
            }
            
            if (chartFeatures.annotationMode) {
                btn.style.background = '#667eea';
                btn.style.color = 'white';
                document.body.style.cursor = 'crosshair';
            } else {
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.color = 'var(--text-primary)';
                document.body.style.cursor = 'default';
            }
        };

        // Use event delegation for toggle buttons (works even if buttons are added dynamically)
        document.addEventListener('click', function(e) {
            const target = e.target.closest('#toggleVolume, #toggleSupportResistance, #toggleAnnotations');
            if (!target) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const buttonId = target.id;
            console.log('Toggle button clicked:', buttonId);
            
            if (buttonId === 'toggleVolume') {
                if (window.toggleVolumeOverlay) {
                    window.toggleVolumeOverlay();
                } else {
                    console.error('toggleVolumeOverlay function not found');
                }
            } else if (buttonId === 'toggleSupportResistance') {
                if (window.toggleSupportResistance) {
                    window.toggleSupportResistance();
                } else {
                    console.error('toggleSupportResistance function not found');
                }
            } else if (buttonId === 'toggleAnnotations') {
                if (window.toggleAnnotationMode) {
                    window.toggleAnnotationMode();
                } else {
                    console.error('toggleAnnotationMode function not found');
                }
            }
        });


        // Quick Actions Functions
        function addCurrentStockToWatchlist() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (!ticker) {
                showToast('Please enter a stock ticker first', 'error');
                return;
            }
            
            if (typeof addToWatchlistQuick === 'function') {
                const event = { preventDefault: () => {}, stopPropagation: () => {} };
                addToWatchlistQuick(event);
                showToast(`Added ${ticker} to watchlist`, 'success');
            } else {
                // Fallback: use toggleFavoriteTicker
                if (typeof toggleFavoriteTicker === 'function') {
                    toggleFavoriteTicker(ticker);
                    showToast(`Added ${ticker} to watchlist`, 'success');
                } else {
                    showToast('Watchlist function not available', 'error');
                }
            }
        }

        function setPriceAlert() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (!ticker) {
                showToast('Please enter a stock ticker first', 'error');
                return;
            }
            
            const currentPriceEl = document.getElementById('currentPrice');
            if (!currentPriceEl || currentPriceEl.textContent === '-') {
                showToast('Please load stock data first', 'error');
                return;
            }
            
            const currentPrice = parseFloat(currentPriceEl.textContent.replace('$', '').replace(/,/g, ''));
            if (isNaN(currentPrice)) {
                showToast('Please load stock data first', 'error');
                return;
            }
            
            const alertType = prompt(`Set price alert for ${ticker}\n\nCurrent price: $${currentPrice.toFixed(2)}\n\nEnter:\n- "above X" for price above X\n- "below X" for price below X\n- "X" for exact price\n\nExample: "above 150" or "below 100"`);
            
            if (!alertType) return;
            
            // Parse alert
            const aboveMatch = alertType.match(/above\s+(\d+\.?\d*)/i);
            const belowMatch = alertType.match(/below\s+(\d+\.?\d*)/i);
            const exactMatch = alertType.match(/^(\d+\.?\d*)$/);
            
            let alertPrice = null;
            let condition = null;
            
            if (aboveMatch) {
                alertPrice = parseFloat(aboveMatch[1]);
                condition = 'above';
            } else if (belowMatch) {
                alertPrice = parseFloat(belowMatch[1]);
                condition = 'below';
            } else if (exactMatch) {
                alertPrice = parseFloat(exactMatch[1]);
                condition = 'exact';
            }
            
            if (alertPrice && condition) {
                // Store alert in localStorage
                const alerts = JSON.parse(localStorage.getItem('priceAlerts') || '[]');
                alerts.push({
                    ticker: ticker,
                    price: alertPrice,
                    condition: condition,
                    createdAt: new Date().toISOString(),
                    active: true
                });
                localStorage.setItem('priceAlerts', JSON.stringify(alerts));
                showToast(`Alert set: ${ticker} ${condition} $${alertPrice.toFixed(2)}`, 'success');
            } else {
                showToast('Invalid alert format', 'error');
            }
        }

        let comparisonData = null;
        
        async function compareStocks() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (!ticker) {
                showToast('Please enter a stock ticker first', 'error');
                return;
            }
            
            if (!currentData) {
                showToast('Please load stock data first', 'error');
                return;
            }
            
            const compareTicker = prompt(`Compare ${ticker} with another stock:\n\nEnter ticker symbol to compare:`, '');
            if (!compareTicker) return;
            
            const compareTickerUpper = compareTicker.trim().toUpperCase();
            if (compareTickerUpper === ticker) {
                showToast('Cannot compare stock with itself', 'error');
                return;
            }
            
            showToast(`Loading ${compareTickerUpper}...`, 'info');
            
            try {
                const response = await fetch(`/api/stock/${compareTickerUpper}?period=${currentTimeframe}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(`Error loading ${compareTickerUpper}: ${data.error}`, 'error');
                    return;
                }
                
                comparisonData = data;
                displayComparison(ticker, compareTickerUpper, currentData, data);
                showToast(`Comparison: ${ticker} vs ${compareTickerUpper}`, 'success');
            } catch (error) {
                console.error('Error loading comparison stock:', error);
                showToast(`Error loading ${compareTickerUpper}: ${error.message}`, 'error');
            }
        }
        
        function displayComparison(ticker1, ticker2, data1, data2) {
            // Create or show comparison container
            let comparisonContainer = document.getElementById('comparisonContainer');
            if (!comparisonContainer) {
                // Insert comparison container after results section
                const resultsSection = document.getElementById('results');
                comparisonContainer = document.createElement('div');
                comparisonContainer.id = 'comparisonContainer';
                comparisonContainer.className = 'card';
                comparisonContainer.style.marginTop = '30px';
                resultsSection.appendChild(comparisonContainer);
            }
            
            comparisonContainer.style.display = 'block';
            
            const price1 = data1.chart_data.close[data1.chart_data.close.length - 1];
            const price2 = data2.chart_data.close[data2.chart_data.close.length - 1];
            const change1 = data1.metrics.price_change || 0;
            const change2 = data2.metrics.price_change || 0;
            const changePct1 = data1.metrics.price_change_percent || 0;
            const changePct2 = data2.metrics.price_change_percent || 0;
            
            comparisonContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ðŸ“Š Stock Comparison: ${ticker1} vs ${ticker2}</h2>
                    <button onclick="closeComparison()" style="padding: 8px 16px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; cursor: pointer; font-weight: 600;">âœ• Close</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- Stock 1 -->
                    <div style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.3);">
                        <h3 style="margin: 0 0 10px 0; color: var(--text-primary);">${ticker1}</h3>
                        <p style="margin: 0 0 15px 0; color: var(--text-secondary); font-size: 0.9em;">${data1.company_info.name || ticker1}</p>
                        <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">$${price1.toFixed(2)}</div>
                        <div style="color: ${change1 >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                            ${change1 >= 0 ? '+' : ''}${change1.toFixed(2)} (${changePct1 >= 0 ? '+' : ''}${changePct1.toFixed(2)}%)
                        </div>
                    </div>
                    
                    <!-- Stock 2 -->
                    <div style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid rgba(118, 75, 162, 0.3);">
                        <h3 style="margin: 0 0 10px 0; color: var(--text-primary);">${ticker2}</h3>
                        <p style="margin: 0 0 15px 0; color: var(--text-secondary); font-size: 0.9em;">${data2.company_info.name || ticker2}</p>
                        <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">$${price2.toFixed(2)}</div>
                        <div style="color: ${change2 >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                            ${change2 >= 0 ? '+' : ''}${change2.toFixed(2)} (${changePct2 >= 0 ? '+' : ''}${changePct2.toFixed(2)}%)
                        </div>
                    </div>
                </div>
                
                <!-- Comparison Metrics Table -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: var(--bg-card); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 12px; text-align: left; color: var(--text-primary); font-weight: 600;">Metric</th>
                                <th style="padding: 12px; text-align: right; color: var(--text-primary); font-weight: 600;">${ticker1}</th>
                                <th style="padding: 12px; text-align: right; color: var(--text-primary); font-weight: 600;">${ticker2}</th>
                                <th style="padding: 12px; text-align: right; color: var(--text-primary); font-weight: 600;">Difference</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 10px; color: var(--text-primary); font-weight: 600;">Market Cap</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">${formatNumber(data1.metrics.market_cap || 0)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">${formatNumber(data2.metrics.market_cap || 0)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-secondary);">
                                    ${(() => {
                                        const diff = (data1.metrics.market_cap || 0) - (data2.metrics.market_cap || 0);
                                        const sign = diff >= 0 ? '+' : '-';
                                        return sign + formatNumber(Math.abs(diff)) + (diff >= 0 ? ' â†‘' : ' â†“');
                                    })()}
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 10px; color: var(--text-primary); font-weight: 600;">P/E Ratio</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">${(data1.metrics.pe_ratio || 0).toFixed(2)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">${(data2.metrics.pe_ratio || 0).toFixed(2)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-secondary);">
                                    ${(() => {
                                        const diff = (data1.metrics.pe_ratio || 0) - (data2.metrics.pe_ratio || 0);
                                        const sign = diff >= 0 ? '+' : '';
                                        return sign + diff.toFixed(2) + (diff >= 0 ? ' â†‘' : ' â†“');
                                    })()}
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 10px; color: var(--text-primary); font-weight: 600;">52W High</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">$${(data1.metrics.year_high || 0).toFixed(2)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">$${(data2.metrics.year_high || 0).toFixed(2)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-secondary);">
                                    ${(() => {
                                        const diff = (data1.metrics.year_high || 0) - (data2.metrics.year_high || 0);
                                        const sign = diff >= 0 ? '+' : '';
                                        return '$' + sign + Math.abs(diff).toFixed(2) + (diff >= 0 ? ' â†‘' : ' â†“');
                                    })()}
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 10px; color: var(--text-primary); font-weight: 600;">52W Low</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">$${(data1.metrics.year_low || 0).toFixed(2)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">$${(data2.metrics.year_low || 0).toFixed(2)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-secondary);">
                                    ${(() => {
                                        const diff = (data1.metrics.year_low || 0) - (data2.metrics.year_low || 0);
                                        const sign = diff >= 0 ? '+' : '';
                                        return '$' + sign + Math.abs(diff).toFixed(2) + (diff >= 0 ? ' â†‘' : ' â†“');
                                    })()}
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 10px; color: var(--text-primary); font-weight: 600;">Volume</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">${formatNumber(data1.metrics.volume || 0)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">${formatNumber(data2.metrics.volume || 0)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-secondary);">
                                    ${(() => {
                                        const diff = (data1.metrics.volume || 0) - (data2.metrics.volume || 0);
                                        const sign = diff >= 0 ? '+' : '-';
                                        return sign + formatNumber(Math.abs(diff)) + (diff >= 0 ? ' â†‘' : ' â†“');
                                    })()}
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; color: var(--text-primary); font-weight: 600;">Sector</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">${data1.company_info.sector || 'N/A'}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-primary);">${data2.company_info.sector || 'N/A'}</td>
                                <td style="padding: 10px; text-align: right; color: var(--text-secondary);">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Side-by-side charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                    <div>
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">${ticker1} Chart</h3>
                        <canvas id="comparisonChart1" style="max-height: 300px;"></canvas>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">${ticker2} Chart</h3>
                        <canvas id="comparisonChart2" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            `;
            
            // Create comparison charts
            setTimeout(() => {
                createComparisonChart('comparisonChart1', data1, ticker1);
                createComparisonChart('comparisonChart2', data2, ticker2);
            }, 100);
        }
        
        function createComparisonChart(canvasId, data, ticker) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            const isDark = document.body.classList.contains('dark-mode');
            const chartTextColor = isDark ? '#f5f5f5' : '#333';
            const chartGridColor = isDark ? '#3a3a3a' : '#e0e0e0';
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chart_data.dates,
                    datasets: [{
                        label: `${ticker} Price`,
                        data: data.chart_data.close,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: chartTextColor
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isDark ? 'rgba(30, 30, 30, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                            titleColor: chartTextColor,
                            bodyColor: chartTextColor,
                            borderColor: '#667eea',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor }
                        },
                        y: {
                            ticks: {
                                color: chartTextColor,
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            },
                            grid: { color: chartGridColor }
                        }
                    }
                }
            });
        }
        
        function closeComparison() {
            const comparisonContainer = document.getElementById('comparisonContainer');
            if (comparisonContainer) {
                comparisonContainer.style.display = 'none';
                comparisonContainer.innerHTML = '';
            }
            comparisonData = null;
        }
        
        window.closeComparison = closeComparison;

        function exportChart(format) {
            if (!currentData || !currentData.ticker) {
                showToast('Please load stock data first', 'error');
                return;
            }
            
            const ticker = currentData.ticker;
            let canvas = null;
            let chartName = 'Price Chart';
            
            // Get the active chart
            if (currentChartType === 'line') {
                canvas = document.getElementById('priceChart');
                chartName = 'Price Chart';
            } else {
                // For candlestick chart, we need to use a different approach
                showToast('Candlestick chart export coming soon', 'info');
                return;
            }
            
            if (!canvas) {
                showToast('Chart not found', 'error');
                return;
            }
            
            try {
                if (format === 'png') {
                    // Export as PNG
                    const url = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = `${ticker}_${chartName}_${new Date().toISOString().split('T')[0]}.png`;
                    link.href = url;
                    link.click();
                    showToast('Chart exported as PNG', 'success');
                } else if (format === 'svg') {
                    // Export as SVG - for Chart.js, we need to convert canvas to SVG
                    const svg = canvasToSVG(canvas);
                    const blob = new Blob([svg], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `${ticker}_${chartName}_${new Date().toISOString().split('T')[0]}.svg`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    showToast('Chart exported as SVG', 'success');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('Export failed: ' + error.message, 'error');
            }
        }

        function canvasToSVG(canvas) {
            // Convert canvas to SVG
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', canvas.width);
            svg.setAttribute('height', canvas.height);
            svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            
            const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            img.setAttribute('href', canvas.toDataURL('image/png'));
            img.setAttribute('width', canvas.width);
            img.setAttribute('height', canvas.height);
            svg.appendChild(img);
            
            return new XMLSerializer().serializeToString(svg);
        }

        // Make functions globally available
        window.addCurrentStockToWatchlist = addCurrentStockToWatchlist;
        window.setPriceAlert = setPriceAlert;
        window.compareStocks = compareStocks;
        window.exportChart = exportChart;

        // Support/Resistance detection
        function detectSupportResistanceLevels(data) {
            const prices = data.chart_data.close;
            const dates = data.chart_data.dates;
            const windowSize = 20;
            const tolerance = 0.02; // 2% tolerance
            
            const localMinima = [];
            const localMaxima = [];
            
            // Find local minima and maxima
            for (let i = windowSize; i < prices.length - windowSize; i++) {
                let isMin = true;
                let isMax = true;
                
                for (let j = i - windowSize; j <= i + windowSize; j++) {
                    if (j !== i) {
                        if (prices[j] < prices[i]) isMin = false;
                        if (prices[j] > prices[i]) isMax = false;
                    }
                }
                
                if (isMin) {
                    localMinima.push({ price: prices[i], date: dates[i], index: i });
                }
                if (isMax) {
                    localMaxima.push({ price: prices[i], date: dates[i], index: i });
                }
            }
            
            // Group similar levels
            const groupLevels = (levels) => {
                const groups = [];
                for (const level of levels) {
                    let found = false;
                    for (const group of groups) {
                        const avgPrice = group.reduce((sum, l) => sum + l.price, 0) / group.length;
                        if (Math.abs(level.price - avgPrice) / avgPrice <= tolerance) {
                            group.push(level);
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        groups.push([level]);
                    }
                }
                return groups.map(group => ({
                    price: group.reduce((sum, l) => sum + l.price, 0) / group.length,
                    touches: group.length,
                    dates: group.map(l => l.date)
                }));
            };
            
            const supportLevels = groupLevels(localMinima)
                .sort((a, b) => b.touches - a.touches)
                .slice(0, 3);
            const resistanceLevels = groupLevels(localMaxima)
                .sort((a, b) => b.touches - a.touches)
                .slice(0, 3);
            
            return { support: supportLevels, resistance: resistanceLevels };
        }

        function addSupportResistanceToChart(chart, levels, chartData) {
            if (!chart || !levels) return;
            
            // Add support levels as horizontal lines
            levels.support.forEach((level, idx) => {
                chart.data.datasets.push({
                    label: `Support ${idx + 1} (${level.touches} touches)`,
                    data: chartData.dates.map(() => level.price),
                    borderColor: '#10b981',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                });
            });
            
            // Add resistance levels as horizontal lines
            levels.resistance.forEach((level, idx) => {
                chart.data.datasets.push({
                    label: `Resistance ${idx + 1} (${level.touches} touches)`,
                    data: chartData.dates.map(() => level.price),
                    borderColor: '#ef4444',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                });
            });
            
            chart.update();
        }


        // Chart annotations
        function addChartAnnotation(date, price, index) {
            const note = prompt('Enter annotation note:');
            if (!note) return;
            
            const annotation = {
                date: date,
                price: price,
                index: index,
                note: note,
                id: Date.now()
            };
            
            chartAnnotations.push(annotation);
            saveAnnotationsToStorage();
            
            // Re-render chart with annotation
            if (currentData) {
                if (currentChartType === 'line') {
                    createPriceChart(currentData);
                } else {
                    createCandlestickChart(currentData);
                }
            }
        }

        function addAnnotationsToChart(chart, chartData) {
            if (!chart || chartAnnotations.length === 0) return;
            
            chartAnnotations.forEach(annotation => {
                const index = chartData.dates.indexOf(annotation.date);
                if (index !== -1) {
                    // Add annotation as a point with label
                    chart.data.datasets.push({
                        label: `Annotation: ${annotation.note}`,
                        data: chartData.dates.map((d, i) => i === index ? annotation.price : null),
                        borderColor: '#f59e0b',
                        backgroundColor: '#f59e0b',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        showLine: false
                    });
                }
            });
            
            chart.update();
        }

        function saveAnnotationsToStorage() {
            if (currentData && currentData.ticker) {
                const key = `annotations_${currentData.ticker}_${currentTimeframe}`;
                localStorage.setItem(key, JSON.stringify(chartAnnotations));
            }
        }

        function loadAnnotationsFromStorage() {
            if (currentData && currentData.ticker) {
                const key = `annotations_${currentData.ticker}_${currentTimeframe}`;
                const stored = localStorage.getItem(key);
                if (stored) {
                    chartAnnotations = JSON.parse(stored);
                }
            }
        }

        function createCandlestickChart(data) {
            // Destroy existing candlestick chart
            if (candlestickChart) {
                candlestickChart.remove();
                candlestickChart = null;
            }
            
            // Remove existing tooltip if present
            const existingTooltip = document.getElementById('candlestick-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }
            
            // Hide line chart, show candlestick
            document.getElementById('priceChart').style.display = 'none';
            const candlestickContainer = document.getElementById('candlestickChart');
            candlestickContainer.style.display = 'block';
            
            // Check if we have OHLC data
            const chartData = data.chart_data;
            if (!chartData.open || !chartData.high || !chartData.low || !chartData.close) {
                // Fallback: use close price for all OHLC
                console.warn('OHLC data not available, using close price');
                const closePrices = chartData.close || [];
                chartData.open = closePrices;
                chartData.high = closePrices;
                chartData.low = closePrices;
            }
            
            // Prepare data for lightweight-charts
            const candlestickData = chartData.dates.map((date, index) => {
                // Convert date string to timestamp (seconds)
                // Handle both formats: "YYYY-MM-DD" and "YYYY-MM-DD HH:MM:SS"
                let timestamp;
                try {
                    let dateObj;
                    if (date.includes(' ')) {
                        // Has time component: "YYYY-MM-DD HH:MM:SS"
                        const [datePart, timePart] = date.split(' ');
                        const [year, month, day] = datePart.split('-').map(Number);
                        const [hour, minute, second] = timePart.split(':').map(Number);
                        dateObj = new Date(year, month - 1, day, hour, minute, second || 0);
                    } else {
                        // Just date: "YYYY-MM-DD"
                        const [year, month, day] = date.split('-').map(Number);
                        dateObj = new Date(year, month - 1, day);
                    }
                    
                    if (isNaN(dateObj.getTime())) {
                        throw new Error('Invalid date');
                    }
                    timestamp = Math.floor(dateObj.getTime() / 1000);
                } catch (e) {
                    console.error('Error parsing date:', date, e);
                    // Fallback: use current time + index offset
                    timestamp = Math.floor(Date.now() / 1000) + index * 60; // 1 minute increments as fallback
                }
                
                const open = parseFloat(chartData.open[index]);
                const high = parseFloat(chartData.high[index]);
                const low = parseFloat(chartData.low[index]);
                const close = parseFloat(chartData.close[index]);
                
                // Validate data
                if (isNaN(open) || isNaN(high) || isNaN(low) || isNaN(close)) {
                    return null;
                }
                if (open <= 0 || high <= 0 || low <= 0 || close <= 0) {
                    return null;
                }
                if (high < low || high < open || high < close || low > open || low > close) {
                    console.warn('Invalid OHLC data at index', index, {open, high, low, close});
                    return null;
                }
                
                return {
                    time: timestamp,
                    open: open,
                    high: high,
                    low: low,
                    close: close
                };
            }).filter(item => item !== null && item.time > 0);
            
            // Ensure container is visible and has dimensions
            if (candlestickContainer.clientWidth === 0 || candlestickContainer.clientHeight === 0) {
                console.warn('Candlestick container has no dimensions, waiting...');
                setTimeout(() => createCandlestickChart(data), 100);
                return;
            }
            
            const isDark = document.body.classList.contains('dark-mode');
            
            // Get container dimensions
            const width = candlestickContainer.clientWidth || 800;
            const height = candlestickContainer.clientHeight || 400;
            
            const chartOptions = {
                layout: {
                    background: { color: isDark ? '#1a1a1a' : '#ffffff' },
                    textColor: isDark ? '#e0e0e0' : '#333333'
                },
                grid: {
                    vertLines: { color: isDark ? '#404040' : '#e0e0e0' },
                    horzLines: { color: isDark ? '#404040' : '#e0e0e0' }
                },
                width: width,
                height: height,
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false
                }
            };
            
            console.log('Creating candlestick chart with', candlestickData.length, 'data points');
            console.log('Container dimensions:', width, 'x', height);
            
            try {
                // Check if LightweightCharts is available
                if (typeof LightweightCharts === 'undefined') {
                    throw new Error('LightweightCharts library not loaded');
                }
                
                candlestickChart = LightweightCharts.createChart(candlestickContainer, chartOptions);
                
                if (!candlestickChart || typeof candlestickChart.addCandlestickSeries !== 'function') {
                    throw new Error('Failed to create chart or addCandlestickSeries method not available');
                }
                
                const candlestickSeries = candlestickChart.addCandlestickSeries({
                    upColor: '#10b981',
                    downColor: '#ef4444',
                    borderVisible: false,
                    wickUpColor: '#10b981',
                    wickDownColor: '#ef4444'
                });
                
                if (!candlestickSeries || typeof candlestickSeries.setData !== 'function') {
                    throw new Error('Failed to create candlestick series');
                }
                
                candlestickSeries.setData(candlestickData);
                
                // Create tooltip element for percentage display
                const tooltip = document.createElement('div');
                tooltip.id = 'candlestick-tooltip';
                tooltip.style.cssText = `
                    position: absolute;
                    display: none;
                    background: ${isDark ? 'rgba(26, 26, 26, 0.95)' : 'rgba(255, 255, 255, 0.95)'};
                    border: 1px solid ${isDark ? '#404040' : '#e0e0e0'};
                    border-radius: 4px;
                    padding: 8px 12px;
                    font-size: 12px;
                    font-weight: 600;
                    pointer-events: none;
                    z-index: 1000;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                    color: ${isDark ? '#e0e0e0' : '#333333'};
                `;
                candlestickContainer.style.position = 'relative';
                candlestickContainer.appendChild(tooltip);
                
                // Subscribe to crosshair move to show percentage change
                candlestickChart.subscribeCrosshairMove(param => {
                    if (param.point === undefined || !param.time || param.seriesData.size === 0) {
                        tooltip.style.display = 'none';
                        return;
                    }
                    
                    const data = param.seriesData.get(candlestickSeries);
                    if (!data) {
                        tooltip.style.display = 'none';
                        return;
                    }
                    
                    const { open, close, high, low } = data;
                    const change = close - open;
                    const changePercent = ((change / open) * 100).toFixed(2);
                    const isPositive = change >= 0;
                    const color = isPositive ? '#10b981' : '#ef4444';
                    const sign = isPositive ? '+' : '';
                    
                    // Calculate range (high - low) percentage
                    const range = high - low;
                    const rangePercent = ((range / open) * 100).toFixed(2);
                    
                    tooltip.innerHTML = `
                        <div style="color: ${color}; margin-bottom: 4px;">
                            ${sign}${changePercent}%
                        </div>
                        <div style="font-size: 10px; color: ${isDark ? '#999' : '#666'};">
                            Range: ${rangePercent}%<br>
                            O: ${open.toFixed(2)} | H: ${high.toFixed(2)}<br>
                            L: ${low.toFixed(2)} | C: ${close.toFixed(2)}
                        </div>
                    `;
                    
                    // Position tooltip near cursor
                    const rect = candlestickContainer.getBoundingClientRect();
                    const x = param.point.x;
                    const y = param.point.y;
                    
                    tooltip.style.left = (x + 20) + 'px';
                    tooltip.style.top = (y - 60) + 'px';
                    tooltip.style.display = 'block';
                });
                
                // Fit content to show all data
                setTimeout(() => {
                    if (candlestickChart && candlestickChart.timeScale) {
                        candlestickChart.timeScale().fitContent();
                    }
                }, 100);
                
                console.log('Candlestick chart created successfully');
                
                // Add volume overlay if enabled
                if (chartFeatures.volumeOverlay && chartData.volume) {
                    const volumeData = chartData.dates.map((date, index) => {
                        let timestamp;
                        try {
                            const dateObj = new Date(date);
                            if (isNaN(dateObj.getTime())) {
                                const [year, month, day] = date.split('-').map(Number);
                                timestamp = Math.floor(new Date(year, month - 1, day).getTime() / 1000);
                            } else {
                                timestamp = Math.floor(dateObj.getTime() / 1000);
                            }
                        } catch (e) {
                            timestamp = Math.floor(Date.now() / 1000) + index * 86400;
                        }
                        const volume = chartData.volume[index] || 0;
                        const close = chartData.close[index];
                        const prevClose = index > 0 ? chartData.close[index - 1] : close;
                        return {
                            time: timestamp,
                            value: volume,
                            color: close >= prevClose ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)'
                        };
                    }).filter(item => item.time > 0 && !isNaN(item.value) && item.value > 0);
                    
                    if (volumeData.length > 0) {
                        const volumeSeries = candlestickChart.addHistogramSeries({
                            color: '#667eea',
                            priceFormat: {
                                type: 'volume',
                            },
                            priceScaleId: 'volume',
                            scaleMargins: {
                                top: 0.8,
                                bottom: 0,
                            },
                        });
                        volumeSeries.setData(volumeData.map(item => ({
                            time: item.time,
                            value: item.value,
                            color: item.color
                        })));
                    }
                }


                // Add support/resistance levels if enabled
                if (chartFeatures.supportResistance && supportResistanceLevels) {
                    // Add support levels
                    supportResistanceLevels.support.forEach((level, idx) => {
                        const supportData = chartData.dates.map((date) => {
                            let timestamp;
                            try {
                                const dateObj = new Date(date);
                                if (isNaN(dateObj.getTime())) {
                                    const [year, month, day] = date.split('-').map(Number);
                                    timestamp = Math.floor(new Date(year, month - 1, day).getTime() / 1000);
                                } else {
                                    timestamp = Math.floor(dateObj.getTime() / 1000);
                                }
                            } catch (e) {
                                timestamp = Math.floor(Date.now() / 1000);
                            }
                            return {
                                time: timestamp,
                                value: level.price
                            };
                        });
                        
                        const supportSeries = candlestickChart.addLineSeries({
                            color: '#10b981',
                            lineWidth: 2,
                            lineStyle: 2, // Dashed
                            title: `Support ${idx + 1} (${level.touches} touches)`
                        });
                        supportSeries.setData(supportData);
                    });
                    
                    // Add resistance levels
                    supportResistanceLevels.resistance.forEach((level, idx) => {
                        const resistanceData = chartData.dates.map((date) => {
                            let timestamp;
                            try {
                                const dateObj = new Date(date);
                                if (isNaN(dateObj.getTime())) {
                                    const [year, month, day] = date.split('-').map(Number);
                                    timestamp = Math.floor(new Date(year, month - 1, day).getTime() / 1000);
                                } else {
                                    timestamp = Math.floor(dateObj.getTime() / 1000);
                                }
                            } catch (e) {
                                timestamp = Math.floor(Date.now() / 1000);
                            }
                            return {
                                time: timestamp,
                                value: level.price
                            };
                        });
                        
                        const resistanceSeries = candlestickChart.addLineSeries({
                            color: '#ef4444',
                            lineWidth: 2,
                            lineStyle: 2, // Dashed
                            title: `Resistance ${idx + 1} (${level.touches} touches)`
                        });
                        resistanceSeries.setData(resistanceData);
                    });
                }

                // Add annotations if any exist
                if (chartAnnotations.length > 0) {
                    chartAnnotations.forEach(annotation => {
                        const index = chartData.dates.indexOf(annotation.date);
                        if (index !== -1) {
                            let timestamp;
                            try {
                                const dateObj = new Date(annotation.date);
                                if (isNaN(dateObj.getTime())) {
                                    const [year, month, day] = annotation.date.split('-').map(Number);
                                    timestamp = Math.floor(new Date(year, month - 1, day).getTime() / 1000);
                                } else {
                                    timestamp = Math.floor(dateObj.getTime() / 1000);
                                }
                            } catch (e) {
                                timestamp = Math.floor(Date.now() / 1000);
                            }
                            
                            candlestickChart.createPriceLine({
                                price: annotation.price,
                                color: '#f59e0b',
                                lineWidth: 2,
                                lineStyle: 0, // Solid
                                axisLabelVisible: true,
                                title: annotation.note
                            });
                        }
                    });
                }
                
                // Add indicators if available (only if chart was created successfully)
                try {
                if (indicatorVisibility.sma && data.indicators.sma_20) {
                    const sma20Data = chartData.dates.map((date, index) => {
                        let timestamp;
                        try {
                            const dateObj = new Date(date);
                            if (isNaN(dateObj.getTime())) {
                                const [year, month, day] = date.split('-').map(Number);
                                timestamp = Math.floor(new Date(year, month - 1, day).getTime() / 1000);
                            } else {
                                timestamp = Math.floor(dateObj.getTime() / 1000);
                            }
                        } catch (e) {
                            timestamp = Math.floor(Date.now() / 1000) + index * 86400;
                        }
                        return {
                            time: timestamp,
                            value: parseFloat(data.indicators.sma_20[index])
                        };
                    }).filter(item => item.time > 0 && !isNaN(item.value) && item.value > 0);
                    
                    if (sma20Data.length > 0) {
                        const sma20Series = candlestickChart.addLineSeries({
                            color: '#f59e0b',
                            lineWidth: 1,
                            lineStyle: 2 // Dashed
                        });
                        sma20Series.setData(sma20Data);
                    }
                }
                
                if (indicatorVisibility.sma && data.indicators.sma_50) {
                    const sma50Data = chartData.dates.map((date, index) => {
                        let timestamp;
                        try {
                            const dateObj = new Date(date);
                            if (isNaN(dateObj.getTime())) {
                                const [year, month, day] = date.split('-').map(Number);
                                timestamp = Math.floor(new Date(year, month - 1, day).getTime() / 1000);
                            } else {
                                timestamp = Math.floor(dateObj.getTime() / 1000);
                            }
                        } catch (e) {
                            timestamp = Math.floor(Date.now() / 1000) + index * 86400;
                        }
                        return {
                            time: timestamp,
                            value: parseFloat(data.indicators.sma_50[index])
                        };
                    }).filter(item => item.time > 0 && !isNaN(item.value) && item.value > 0);
                    
                    if (sma50Data.length > 0) {
                        const sma50Series = candlestickChart.addLineSeries({
                            color: '#ef4444',
                            lineWidth: 1,
                            lineStyle: 2 // Dashed
                        });
                        sma50Series.setData(sma50Data);
                    }
                }
                
                if (indicatorVisibility.ema && data.indicators.ema_12) {
                    const ema12Data = chartData.dates.map((date, index) => {
                        let timestamp;
                        try {
                            const dateObj = new Date(date);
                            if (isNaN(dateObj.getTime())) {
                                const [year, month, day] = date.split('-').map(Number);
                                timestamp = Math.floor(new Date(year, month - 1, day).getTime() / 1000);
                            } else {
                                timestamp = Math.floor(dateObj.getTime() / 1000);
                            }
                        } catch (e) {
                            timestamp = Math.floor(Date.now() / 1000) + index * 86400;
                        }
                        return {
                            time: timestamp,
                            value: parseFloat(data.indicators.ema_12[index])
                        };
                    }).filter(item => item.time > 0 && !isNaN(item.value) && item.value > 0);
                    
                    if (ema12Data.length > 0) {
                        const ema12Series = candlestickChart.addLineSeries({
                            color: '#10b981',
                            lineWidth: 1
                        });
                        ema12Series.setData(ema12Data);
                    }
                }
                
                if (indicatorVisibility.ema && data.indicators.ema_26) {
                    const ema26Data = chartData.dates.map((date, index) => {
                        let timestamp;
                        try {
                            const dateObj = new Date(date);
                            if (isNaN(dateObj.getTime())) {
                                const [year, month, day] = date.split('-').map(Number);
                                timestamp = Math.floor(new Date(year, month - 1, day).getTime() / 1000);
                            } else {
                                timestamp = Math.floor(dateObj.getTime() / 1000);
                            }
                        } catch (e) {
                            timestamp = Math.floor(Date.now() / 1000) + index * 86400;
                        }
                        return {
                            time: timestamp,
                            value: parseFloat(data.indicators.ema_26[index])
                        };
                    }).filter(item => item.time > 0 && !isNaN(item.value) && item.value > 0);
                    
                    if (ema26Data.length > 0) {
                        const ema26Series = candlestickChart.addLineSeries({
                            color: '#3b82f6',
                            lineWidth: 1
                        });
                        ema26Series.setData(ema26Data);
                    }
                }
                } catch (error) {
                    console.error('Error adding indicators to candlestick chart:', error);
                }
                
                // Handle resize
                const resizeObserver = new ResizeObserver(entries => {
                    if (candlestickChart && entries.length > 0) {
                        const { width, height } = entries[0].contentRect;
                        candlestickChart.applyOptions({ width, height });
                    }
                });
                resizeObserver.observe(candlestickContainer);
            } catch (error) {
                console.error('Error creating candlestick chart:', error);
                candlestickContainer.innerHTML = `<div style="padding: 20px; color: var(--text-primary); text-align: center;">Error creating chart: ${error.message}<br><small>Check console for details</small></div>`;
            }
        }

        function createRSIChart(data) {
            const ctx = document.getElementById('rsiChart').getContext('2d');
            
            if (rsiChart) {
                rsiChart.destroy();
            }

            const isDark = document.body.classList.contains('dark-mode');
            const chartTextColor = isDark ? '#f5f5f5' : '#333';
            const chartGridColor = isDark ? '#3a3a3a' : '#e0e0e0';
            const chartBgColor = isDark ? '#1e1e1e' : '#ffffff';

            rsiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chart_data.dates,
                    datasets: [{
                        label: 'RSI (14)',
                        data: data.indicators.rsi,
                        borderColor: '#667eea',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: chartTextColor
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                color: chartTextColor
                            },
                            grid: {
                                color: chartGridColor
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10,
                                color: chartTextColor
                            },
                            grid: {
                                color: chartGridColor
                            }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                overbought: {
                                    type: 'line',
                                    yMin: 70,
                                    yMax: 70,
                                    borderColor: '#ef4444',
                                    borderDash: [5, 5]
                                },
                                oversold: {
                                    type: 'line',
                                    yMin: 30,
                                    yMax: 30,
                                    borderColor: '#10b981',
                                    borderDash: [5, 5]
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMACDChart(data) {
            const ctx = document.getElementById('macdChart').getContext('2d');
            
            if (macdChart) {
                macdChart.destroy();
            }

            const isDark = document.body.classList.contains('dark-mode');
            const chartTextColor = isDark ? '#e0e0e0' : '#333';
            const chartGridColor = isDark ? '#404040' : '#e0e0e0';

            macdChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chart_data.dates,
                    datasets: [
                        {
                            label: 'MACD',
                            data: data.indicators.macd,
                            borderColor: '#667eea',
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Signal',
                            data: data.indicators.macd_signal,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Histogram',
                            data: data.indicators.macd_diff,
                            borderColor: '#10b981',
                            borderWidth: 1,
                            type: 'bar',
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: chartTextColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 10,
                                color: chartTextColor
                            },
                            grid: {
                                color: chartGridColor
                            }
                        },
                        y: {
                            ticks: {
                                color: chartTextColor
                            },
                            grid: {
                                color: chartGridColor
                            }
                        }
                    }
                }
            });
        }

        function toggleIndicator(indicator) {
            indicatorVisibility[indicator] = !indicatorVisibility[indicator];
            const btn = event.target;
            btn.classList.toggle('active');
            
            if (currentData) {
                if (currentChartType === 'line') {
                    createPriceChart(currentData);
                } else {
                    createCandlestickChart(currentData);
                }
            }
        }

        function formatMarketCap(value) {
            if (!value) return 'N/A';
            if (value >= 1e12) return `$${(value / 1e12).toFixed(2)}T`;
            if (value >= 1e9) return `$${(value / 1e9).toFixed(2)}B`;
            if (value >= 1e6) return `$${(value / 1e6).toFixed(2)}M`;
            return `$${value.toFixed(0)}`;
        }

        function formatNumber(value) {
            if (!value) return 'N/A';
            if (value >= 1e9) return `${(value / 1e9).toFixed(2)}B`;
            if (value >= 1e6) return `${(value / 1e6).toFixed(2)}M`;
            if (value >= 1e3) return `${(value / 1e3).toFixed(2)}K`;
            return value.toString();
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // Universal fetch helper with error handling and retry
        async function safeFetch(url, options = {}, retries = 3) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                },
                ...options
            };
            
            let lastError = null;
            
            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(url, defaultOptions);
                    
                    // For non-ok responses, try to parse error message
                    if (!response.ok) {
                        let errorMessage = `Request failed with status ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.error || errorMessage;
                        } catch (e) {
                            // If response is not JSON, use status text
                            errorMessage = response.statusText || errorMessage;
                        }
                        
                        lastError = new Error(errorMessage);
                        
                        // Retry on 5xx errors (server errors) and 429 (rate limit)
                        const shouldRetry = (response.status >= 500 || response.status === 429) && attempt < retries;
                        
                        if (shouldRetry) {
                            // Exponential backoff: 1s, 2s, 4s with jitter
                            const baseDelay = Math.pow(2, attempt) * 1000;
                            const jitter = Math.random() * 1000;
                            const delay = baseDelay + jitter;
                            console.log(`Retrying request (attempt ${attempt + 1}/${retries + 1}) after ${Math.round(delay)}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        
                        throw lastError;
                    }
                    
                    // Success - store timestamp for data freshness tracking
                    if (window.dataTimestamps) {
                        window.dataTimestamps[url] = Date.now();
                    }
                    
                    return response;
                } catch (error) {
                    lastError = error;
                    
                    // Network errors, timeout, or connection errors - retry
                    const isNetworkError = error.name === 'TypeError' && 
                                         (error.message.includes('fetch') || 
                                          error.message.includes('network') ||
                                          error.message.includes('Failed to fetch'));
                    
                    if (isNetworkError && attempt < retries) {
                        // Exponential backoff: 1s, 2s, 4s with jitter
                        const baseDelay = Math.pow(2, attempt) * 1000;
                        const jitter = Math.random() * 1000;
                        const delay = baseDelay + jitter;
                        console.log(`Network error, retrying (attempt ${attempt + 1}/${retries + 1}) after ${Math.round(delay)}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    
                    // Last attempt failed or non-retryable error
                    if (attempt === retries) {
                        throw lastError;
                    }
                }
            }
            
            // Should never reach here, but just in case
            throw lastError || new Error('Request failed after all retries');
        }
        
        // Helper to fetch JSON with automatic error handling and retry mechanism
        async function fetchJSON(url, options = {}, containerElement = null) {
            try {
                const response = await safeFetch(url, options);
                const data = await response.json();
                
                // Store timestamp for data freshness tracking
                if (window.dataTimestamps) {
                    window.dataTimestamps[url] = Date.now();
                } else {
                    window.dataTimestamps = {};
                    window.dataTimestamps[url] = Date.now();
                }
                
                return { success: true, data, timestamp: Date.now() };
            } catch (error) {
                console.error(`Error fetching ${url}:`, error);
                
                // Show user-friendly error if container is provided
                if (containerElement) {
                    const errorMessage = error.message || 'An unexpected error occurred';
                    const isNetworkError = error.message && (
                        error.message.includes('fetch') || 
                        error.message.includes('network') ||
                        error.message.includes('Failed to fetch')
                    );
                    
                    const errorDetails = isNetworkError 
                        ? 'Network connection error. Please check your internet connection and try again.'
                        : errorMessage;
                    
                    containerElement.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ef4444;">
                            <div style="font-size: 3em; margin-bottom: 15px;">âŒ</div>
                            <p style="font-size: 1.2em; margin-bottom: 10px; font-weight: 600;">Error Loading Data</p>
                            <p style="margin-bottom: 20px; color: var(--text-secondary); max-width: 500px; margin-left: auto; margin-right: auto;">${errorDetails}</p>
                            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">ðŸ”„ Reload Page</button>
                                <button onclick="window.location.reload()" style="padding: 10px 20px; background: var(--input-bg); color: var(--text-primary); border: 2px solid var(--input-border); border-radius: 8px; cursor: pointer; font-weight: 600;">Retry Request</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Use global error handler
                    showError(error.message || 'An unexpected error occurred');
                }
                
                return { success: false, error: error.message };
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            let errorMessage = '';
            let tips = [];
            
            // Add helpful suggestions based on error type
            if (message.includes('not found') || message.includes('404') || message.includes('unavailable')) {
                tips = [
                    'Check if the ticker symbol is correct (e.g., AAPL, not APPLE)',
                    'Some stocks may be delisted or not available',
                    'Try searching for a different stock like AAPL, MSFT, or TSLA'
                ];
            } else if (message.includes('network') || message.includes('fetch') || message.includes('Failed to fetch')) {
                tips = [
                    'Check your internet connection',
                    'Try again in a few moments',
                    'The service may be temporarily unavailable'
                ];
            } else if (message.includes('timeout') || message.includes('time out')) {
                tips = [
                    'The request took too long to complete',
                    'Try again in a few moments',
                    'Check your internet connection speed'
                ];
            } else {
                tips = [
                    'Please try again',
                    'If the problem persists, refresh the page',
                    'Check your internet connection'
                ];
            }
            
            errorMessage = `
                <div class="error-title">
                    <span>âŒ Error</span>
                </div>
                <div style="margin-bottom: ${tips.length > 0 ? '15px' : '0'};">
                    ${message}
                </div>
                ${tips.length > 0 ? `
                    <div class="error-tips">
                        <div class="error-tips-title">
                            <span>ðŸ’¡ Tips:</span>
                        </div>
                        <ul class="error-tips-list">
                            ${tips.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
            
            errorEl.innerHTML = errorMessage;
            errorEl.classList.remove('hidden');
        }

        // Toast Notification System
        function showToast(message, type = 'success') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span>${message}</span>
            `;

            document.body.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(100px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Ripple Effect for Buttons
        function addRippleEffect(event) {
            const button = event.currentTarget;
            if (!button) return;
            
            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.style.position = 'absolute';
            ripple.style.borderRadius = '50%';
            ripple.style.background = 'rgba(255, 255, 255, 0.6)';
            ripple.style.transform = 'scale(0)';
            ripple.style.animation = 'ripple 0.6s ease-out';
            ripple.style.pointerEvents = 'none';
            
            button.style.position = 'relative';
            button.style.overflow = 'hidden';
            button.appendChild(ripple);
            
            setTimeout(() => ripple.remove(), 600);
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }
        
        // Universal loading component function
        function createLoadingIndicator(message = 'Loading...', includeProgress = false) {
            const progressHtml = includeProgress ? `
                <div style="margin-top: 15px; width: 100%; max-width: 300px; margin-left: auto; margin-right: auto;">
                    <div style="background: rgba(102, 126, 234, 0.1); border-radius: 8px; height: 8px; overflow: hidden;">
                        <div class="loading-progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease; animation: loading-pulse 1.5s ease-in-out infinite;"></div>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.85em; color: var(--text-tertiary);">This may take a moment...</p>
                </div>
            ` : '';
            
            return `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner" style="margin: 0 auto;"></div>
                    <p style="margin-top: 20px; color: var(--text-secondary); font-size: 1.05em;">${message}</p>
                    ${progressHtml}
                </div>
            `;
        }
        
        // Loading state for ML training (long operations)
        function createMLTrainingIndicator(ticker) {
            return `
                <div style="text-align: center; padding: 60px 40px;">
                    <div class="spinner spinner-lg" style="margin: 0 auto;"></div>
                    <p style="margin-top: 30px; color: var(--text-primary); font-size: 1.2em; font-weight: 600;">Training ML Model for ${ticker}</p>
                    <p style="margin-top: 15px; color: var(--text-secondary);">This may take 30-60 seconds...</p>
                    <div style="margin-top: 25px; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto;">
                        <div style="background: rgba(102, 126, 234, 0.1); border-radius: 10px; height: 10px; overflow: hidden;">
                            <div class="loading-progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.5s ease; animation: loading-pulse 2s ease-in-out infinite;"></div>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.9em; color: var(--text-tertiary);">
                            <p>ðŸ“Š Downloading historical data...</p>
                            <p style="margin-top: 5px;">ðŸ¤– Training model...</p>
                            <p style="margin-top: 5px;">âœ… Calculating predictions...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Dark Mode Functions
        function toggleDarkMode() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            const icon = document.getElementById('darkModeIcon');
            
            // Update icon
            if (icon) {
            icon.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            }
            
            // Save preference
            localStorage.setItem('darkMode', isDark);
            
            // Update charts if they exist
            if (typeof updateChartsTheme === 'function') {
            updateChartsTheme(isDark);
        }
        }
        window.toggleDarkMode = toggleDarkMode;
        
        function setThemeMode(mode) {
            const isDark = mode === 'dark';
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('darkMode', isDark.toString());
            
            // Update dark mode icon
            const darkModeIcon = document.getElementById('darkModeIcon');
            if (darkModeIcon) {
                darkModeIcon.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            }
            
            // Update charts if they exist
            if (typeof updateChartsTheme === 'function') {
                updateChartsTheme(isDark);
            }
        }
        window.setThemeMode = setThemeMode;

        function initDarkMode() {
            // Check localStorage first
            const savedPreference = localStorage.getItem('darkMode');
            let isDark = false;
            
            if (savedPreference !== null) {
                isDark = savedPreference === 'true';
            } else {
                // Check system preference
                isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            
            if (isDark) {
                document.body.classList.add('dark-mode');
                const icon = document.getElementById('darkModeIcon');
                if (icon) {
                    icon.textContent = 'â˜€ï¸';
                }
            } else {
                document.body.classList.remove('dark-mode');
                const icon = document.getElementById('darkModeIcon');
                if (icon) {
                    icon.textContent = 'ðŸŒ™';
                }
            }
        }

        function updateChartsTheme(isDark) {
            const chartColors = {
                light: {
                    grid: '#e0e0e0',
                    text: '#333'
                },
                dark: {
                    grid: '#404040',
                    text: '#e0e0e0'
                }
            };
            
            const colors = isDark ? chartColors.dark : chartColors.light;
            
            // Update existing charts if they exist
            if (priceChart) {
                priceChart.options.scales.x.ticks.color = colors.text;
                priceChart.options.scales.y.ticks.color = colors.text;
                priceChart.options.scales.x.grid.color = colors.grid;
                priceChart.options.scales.y.grid.color = colors.grid;
                priceChart.update();
            }
            
            if (rsiChart) {
                rsiChart.options.scales.x.ticks.color = colors.text;
                rsiChart.options.scales.y.ticks.color = colors.text;
                rsiChart.options.scales.x.grid.color = colors.grid;
                rsiChart.options.scales.y.grid.color = colors.grid;
                rsiChart.update();
            }
            
            if (macdChart) {
                macdChart.options.scales.x.ticks.color = colors.text;
                macdChart.options.scales.y.ticks.color = colors.text;
                macdChart.options.scales.x.grid.color = colors.grid;
                macdChart.options.scales.y.grid.color = colors.grid;
                macdChart.update();
            }
        }

        function showStockAnalysis() {
            navigateToSection('stockAnalysisSection');
            // Initialize autocomplete when section becomes visible
            setTimeout(() => {
                initAutocomplete();
            }, 200);
        }
        window.showStockAnalysis = showStockAnalysis;

        function showFinancials() {
            navigateToSection('financialsSection');
            
            // Initialize autocomplete for Financials section
            setTimeout(() => {
                const financialsInput = document.getElementById('financialsTickerInput');
                const financialsDropdown = document.getElementById('financialsAutocomplete');
                if (financialsInput && financialsDropdown && financialsInput.dataset.autocompleteInitialized !== 'true') {
                    console.log('[AUTOCOMPLETE] Initializing financialsTickerInput');
                    let autocompleteTimeout = null;
                    financialsInput.addEventListener('input', async function(e) {
                        const query = e.target.value.trim();
                        console.log('[AUTOCOMPLETE] Financials input changed:', query);
                        if (!query) {
                            financialsDropdown.style.display = 'none';
                            return;
                        }
                        
                        // Clear previous timeout
                        if (autocompleteTimeout) {
                            clearTimeout(autocompleteTimeout);
                        }
                        
                        // Show loading state immediately
                        financialsDropdown.innerHTML = '<div class="autocomplete-loading">ðŸ” Searching...</div>';
                        financialsDropdown.style.display = 'block';
                        
                        // Debounce API call
                        autocompleteTimeout = setTimeout(async () => {
                            console.log('[AUTOCOMPLETE] Fetching results for:', query);
                            try {
                                const data = await fetchAutocompleteResults(query);
                                console.log('[AUTOCOMPLETE] Received data:', data);
                                let html = '';
                                if (data.results && data.results.length > 0) {
                                    html += '<div class="autocomplete-section"><div class="autocomplete-section-title">ðŸ” Search Results</div>';
                                    data.results.forEach(item => {
                                        html += `<div class="autocomplete-item" data-ticker="${item.ticker}" onclick="document.getElementById('financialsTickerInput').value='${item.ticker}'; document.getElementById('financialsAutocomplete').style.display='none';">
                                            <span class="autocomplete-item-icon">ðŸ“Š</span>
                                            <div class="autocomplete-item-content">
                                                <div class="autocomplete-item-ticker">${item.ticker}</div>
                                                <div class="autocomplete-item-name">${item.name || item.ticker}</div>
                                            </div>
                                        </div>`;
                                    });
                                    html += '</div>';
                                } else {
                                    html = '<div class="autocomplete-empty">No results found</div>';
                                }
                                financialsDropdown.innerHTML = html;
                                financialsDropdown.style.display = html !== '' ? 'block' : 'none';
                                console.log('[AUTOCOMPLETE] Rendered dropdown:', { htmlLength: html.length, display: financialsDropdown.style.display });
                            } catch (error) {
                                console.error('[AUTOCOMPLETE] Error:', error);
                                financialsDropdown.innerHTML = '<div class="autocomplete-empty">âš ï¸ Search error. Please try again.</div>';
                                financialsDropdown.style.display = 'block';
                            }
                        }, 300);
                    });
                    financialsInput.dataset.autocompleteInitialized = 'true';
                } else {
                    console.log('[AUTOCOMPLETE] Financials input or dropdown not found, or already initialized');
                }
            }, 200);
        }

        function showNews() {
            navigateToSection('newsSection');
        }

        function showEarningsCalendar() {
            navigateToSection('earningsCalendarSection');
            // Always load earnings calendar when section is shown
            loadEarningsCalendar();
        }

        function showPortfolio() {
            navigateToSection('portfolioSection');
            loadPortfolio();
        }

        function showEconomicCalendar() {
            navigateToSection('economicCalendarSection');
            // Always load economic calendar when section is shown
            loadEconomicCalendar();
        }

        function showAlertsDashboard() {
            navigateToSection('alertsDashboardSection');
            showingAlertsHistory = false;
            loadAlertsDashboard();
        }
        window.showAlertsDashboard = showAlertsDashboard;

        function showSettings() {
            navigateToSection('settingsSection');
            // Load settings content
            loadSettings();
        }
        window.showSettings = showSettings;

        function showAnalystInsider() {
            navigateToSection('analystInsiderSection');
        }

        function showAIRecommendations() {
            navigateToSection('aiRecommendationsSection');
        }

        function showSocialSentiment() {
            navigateToSection('socialSentimentSection');
        }
        window.showSocialSentiment = showSocialSentiment;

        async function loadSocialSentiment() {
            const tickerInput = document.getElementById('socialSentimentTicker');
            const ticker = tickerInput.value.trim().toUpperCase();
            
            if (!ticker) {
                showToast('Please enter a ticker symbol', 'error');
                return;
            }
            
            const container = document.getElementById('socialSentimentContent');
            const timeRange = document.getElementById('socialSentimentTimeRange').value;
            
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 20px; color: var(--text-secondary);">Analyzing social sentiment for ${ticker}...</p>
                </div>
            `;
            
            const result = await fetchJSON(`/api/social-sentiment/${ticker}?days=${timeRange}`, {}, container);
                
            if (!result.success) {
                // Add retry button to error message
                const errorContainer = container;
                if (errorContainer && errorContainer.innerHTML.includes('âŒ Error')) {
                    const retryButton = document.createElement('button');
                    retryButton.textContent = 'Retry';
                    retryButton.onclick = () => loadSocialSentiment();
                    retryButton.style.cssText = 'margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;';
                    errorContainer.appendChild(retryButton);
                }
                return; // Error already displayed by fetchJSON
            }
            
            displaySocialSentiment(result.data, ticker);
        }

        async function loadWatchlistSocialSentiment() {
            const container = document.getElementById('socialSentimentContent');
            const timeRange = document.getElementById('socialSentimentTimeRange').value;
            
            // Show loading state
            container.innerHTML = createLoadingIndicator('Analyzing watchlist sentiment...', true);
            
            // Get watchlist from localStorage
            const watchlistData = localStorage.getItem('watchlist');
            let tickers = [];
            
            if (watchlistData) {
                try {
                    const parsed = JSON.parse(watchlistData);
                    if (Array.isArray(parsed)) {
                        tickers = parsed;
                    } else if (parsed.groups) {
                        // New format with groups
                        for (const group of Object.values(parsed.groups)) {
                            if (Array.isArray(group)) {
                                tickers.push(...group);
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error parsing watchlist:', e);
                }
            }
            
            if (tickers.length === 0) {
                showToast('Your watchlist is empty. Add stocks first.', 'info');
                return;
            }
            
            // Loading state already shown above (line 9954), update message
            container.innerHTML = createLoadingIndicator(`Analyzing sentiment for ${tickers.length} stocks...`, true);
            
            try {
                const response = await fetch(`/api/social-sentiment/watchlist?days=${timeRange}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tickers: tickers })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch watchlist sentiment');
                }
                
                displayWatchlistSocialSentiment(data);
            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <p style="font-size: 1.2em; margin-bottom: 10px;">âŒ Error</p>
                        <p>${error.message}</p>
                        <button onclick="loadWatchlistSocialSentiment()" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        }

        function displaySocialSentiment(data, ticker) {
            const container = document.getElementById('socialSentimentContent');
            
            const sentimentScore = data.sentiment_score || 50.0;
            const overallSentiment = data.overall_sentiment || 'neutral';
            const platformBreakdown = data.platform_breakdown || {};
            const rawData = data.raw_data || {};
            const aiAnalysis = data.ai_analysis || {};
            
            // Color coding
            let sentimentColor = '#f59e0b'; // neutral
            let sentimentEmoji = 'ðŸŸ¡';
            if (overallSentiment === 'positive') {
                sentimentColor = '#10b981';
                sentimentEmoji = 'ðŸŸ¢';
            } else if (overallSentiment === 'negative') {
                sentimentColor = '#ef4444';
                sentimentEmoji = 'ðŸ”´';
            }
            
            let html = `
                <div style="margin-top: 20px;">
                    <!-- Sentiment Overview Card -->
                    <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, ${sentimentColor}15 0%, ${sentimentColor}05 100%); border-radius: 16px; border: 3px solid ${sentimentColor}; margin-bottom: 30px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">${sentimentEmoji}</div>
                        <h2 style="color: ${sentimentColor}; margin-bottom: 10px; font-size: 2em;">${overallSentiment.toUpperCase()} Sentiment</h2>
                        <div style="display: inline-block; padding: 8px 20px; background: ${sentimentColor}; color: white; border-radius: 20px; font-weight: 600; font-size: 1.1em;">
                            Score: ${sentimentScore.toFixed(1)}/100
                        </div>
                    </div>
                    
                    <!-- Platform Breakdown -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        ${platformBreakdown.reddit ? `
                            <div style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                                <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">ðŸ“± Reddit</h4>
                                <div style="font-size: 2em; font-weight: 600; color: #ff4500; margin-bottom: 10px;">${platformBreakdown.reddit.sentiment_score.toFixed(1)}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9em;">Mentions: ${platformBreakdown.reddit.mention_count}</div>
                                ${platformBreakdown.reddit.trending ? '<div style="color: #10b981; font-size: 0.85em; margin-top: 5px;">ðŸ”¥ Trending</div>' : ''}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Key Topics -->
                    ${data.key_topics && data.key_topics.length > 0 ? `
                        <div style="margin-bottom: 30px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                            <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">ðŸ”‘ Key Topics</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                ${data.key_topics.map(topic => `
                                    <span style="padding: 8px 16px; background: rgba(102, 126, 234, 0.1); color: #667eea; border-radius: 20px; font-size: 0.9em; font-weight: 600;">
                                        ${topic.topic} (${topic.mentions})
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- AI Analysis -->
                    ${aiAnalysis.success && (aiAnalysis.key_topics || aiAnalysis.themes || aiAnalysis.warnings) ? `
                        <div style="margin-bottom: 30px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                            <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">ðŸ¤– AI Insights</h4>
                            ${aiAnalysis.themes && aiAnalysis.themes.length > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <h5 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1em;">Themes</h5>
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        ${aiAnalysis.themes.map(theme => `
                                            <li style="padding: 8px 0; padding-left: 25px; position: relative; color: var(--text-primary);">
                                                <span style="position: absolute; left: 0; color: #667eea;">â€¢</span>${theme}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${aiAnalysis.warnings && aiAnalysis.warnings.length > 0 ? `
                                <div style="margin-top: 15px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
                                    <h5 style="margin: 0 0 10px 0; color: #ef4444; font-size: 1em;">âš ï¸ Warnings</h5>
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        ${aiAnalysis.warnings.map(warning => `
                                            <li style="padding: 8px 0; padding-left: 25px; position: relative; color: var(--text-primary);">
                                                <span style="position: absolute; left: 0; color: #ef4444;">âš </span>${warning}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Sentiment Timeline Chart -->
                    <div style="margin-top: 30px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                        <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">ðŸ“ˆ Reddit Sentiment Timeline</h4>
                        <canvas id="sentimentTimelineChart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <!-- Reddit Posts -->
                    <div style="margin-top: 30px;">
                        <h4 style="margin: 0 0 20px 0; color: var(--text-primary);">ðŸ“± Reddit Posts</h4>
                        <div id="reddit-posts-content">
                            ${rawData.reddit && rawData.reddit.posts && rawData.reddit.posts.length > 0 ? `
                                <div style="display: grid; gap: 15px;">
                                    ${rawData.reddit.posts.slice(0, 10).map(post => `
                                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px; border-left: 4px solid #ff4500;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                                <h5 style="margin: 0; color: var(--text-primary);"><a href="${post.url}" target="_blank" style="color: inherit; text-decoration: none;">${post.title}</a></h5>
                                                <span style="font-size: 0.85em; color: var(--text-secondary);">r/${post.subreddit}</span>
                                            </div>
                                            ${post.text ? `<p style="color: var(--text-secondary); font-size: 0.9em; margin: 10px 0;">${post.text.substring(0, 200)}...</p>` : ''}
                                            <div style="display: flex; gap: 15px; font-size: 0.85em; color: var(--text-secondary);">
                                                <span>ðŸ‘ ${post.upvotes}</span>
                                                <span>ðŸ’¬ ${post.comments}</span>
                                                <span style="color: ${post.sentiment >= 0 ? '#10b981' : '#ef4444'};">Sentiment: ${(post.sentiment * 100).toFixed(0)}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: var(--text-secondary);">No Reddit posts found.</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Store data for tab switching
            window.currentSocialSentimentData = data;
            
            // Create sentiment timeline chart
            setTimeout(() => {
                displaySocialSentimentChart(data);
            }, 100);
        }

        function displaySocialSentimentChart(data) {
            const canvas = document.getElementById('sentimentTimelineChart');
            if (!canvas) return;
            
            // Generate sample timeline data (in production, this would come from backend)
            const days = 7;
            const labels = [];
            const redditData = [];
            
            const platformBreakdown = data.platform_breakdown || {};
            const redditScore = platformBreakdown.reddit?.sentiment_score || 50;
            const overallScore = data.sentiment_score || 50;
            
            // Generate labels for last 7 days
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                // Simulate data with some variation (in production, use real historical data)
                redditData.push(redditScore + (Math.random() * 20 - 10));
            }
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.sentimentChartInstance) {
                window.sentimentChartInstance.destroy();
            }
            
            window.sentimentChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Reddit Sentiment',
                            data: redditData,
                            borderColor: '#ff4500',
                            backgroundColor: 'rgba(255, 69, 0, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'var(--text-primary)',
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 100,
                            ticks: {
                                color: 'var(--text-secondary)',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'var(--border-color)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'var(--text-secondary)'
                            },
                            grid: {
                                color: 'var(--border-color)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }


        function displayWatchlistSocialSentiment(data) {
            const container = document.getElementById('socialSentimentContent');
            
            if (!data.tickers || data.tickers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No sentiment data available for watchlist.</p>';
                return;
            }
            
            let html = `
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">Watchlist Sentiment Overview</h3>
                    <div style="display: grid; gap: 15px;">
                        ${data.tickers.map(item => {
                            const score = item.sentiment_score || 50.0;
                            const sentiment = item.overall_sentiment || 'neutral';
                            const color = sentiment === 'positive' ? '#10b981' : sentiment === 'negative' ? '#ef4444' : '#f59e0b';
                            const emoji = sentiment === 'positive' ? 'ðŸŸ¢' : sentiment === 'negative' ? 'ðŸ”´' : 'ðŸŸ¡';
                            
                            return `
                                <div style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: var(--text-primary);">${item.ticker}</h4>
                                        <div style="color: var(--text-secondary); font-size: 0.9em;">Mentions: ${item.mention_count}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 1.5em; font-weight: 600; color: ${color}; margin-bottom: 5px;">${emoji} ${score.toFixed(1)}</div>
                                        <div style="font-size: 0.85em; color: var(--text-secondary);">${sentiment.toUpperCase()}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function loadAIRecommendations() {
            const tickerInput = document.getElementById('aiRecommendationsTicker');
            const ticker = tickerInput.value.trim().toUpperCase();
            
            if (!ticker) {
                showError('Please enter a ticker symbol');
                return;
            }
            
            const container = document.getElementById('aiRecommendationsContent');
            // Show ML training indicator for long operations
            container.innerHTML = createMLTrainingIndicator(ticker);
            
            const result = await fetchJSON(`/api/ai-recommendations/${ticker}`, {}, container);
                
            if (!result.success) {
                return; // Error already displayed by fetchJSON
                }
                
            displayAIRecommendations(result.data, ticker);
        }

        async function loadPredictionHistory(ticker = null) {
            try {
                // Get ticker from parameter or from current input
                if (!ticker || ticker === 'undefined') {
                    ticker = document.getElementById('tickerInput')?.value?.trim().toUpperCase() || 
                             document.querySelector('[data-ticker]')?.getAttribute('data-ticker') ||
                             window.currentTicker;
                }
                
                if (!ticker || ticker === 'undefined') {
                    console.error('[PREDICTION HISTORY] No ticker available');
                    document.getElementById('predictionHistoryTable').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Error: No ticker specified.</p>';
                    document.getElementById('predictionHistoryContainer').style.display = 'block';
                    return;
                }
                
                const container = document.getElementById('predictionHistoryTable');
                const containerWrapper = document.getElementById('predictionHistoryContainer');
                
                // Show loading state
                if (container) {
                    container.innerHTML = createLoadingIndicator('Loading prediction history...');
                }
                if (containerWrapper) {
                    containerWrapper.style.display = 'block';
                }
                
                const days = document.getElementById('historyPeriodSelect')?.value || 30;
                const result = await fetchJSON(`/api/ml-prediction-history/${ticker}?days=${days}`, {}, container);
                
                if (!result.success) {
                    return; // Error already displayed by fetchJSON
                }
                
                const data = result.data;
                if (!data.history || data.history.length === 0) {
                    document.getElementById('predictionHistoryTable').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No prediction history available yet. Predictions will be saved automatically when you analyze this stock.</p>';
                    document.getElementById('predictionHistoryContainer').style.display = 'block';
                    return;
                }
                
                
                // Build table
                let tableHtml = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead>
                            <tr style="background: rgba(102, 126, 234, 0.1); border-bottom: 2px solid rgba(102, 126, 234, 0.3);">
                                <th style="padding: 8px; text-align: left; color: var(--text-primary); font-weight: 600;">Date</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-primary); font-weight: 600;">Price</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-primary); font-weight: 600;">Score</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-primary); font-weight: 600;">1M</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-primary); font-weight: 600;">3M</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-primary); font-weight: 600;">6M</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-primary); font-weight: 600;">12M</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.history.forEach(entry => {
                    const date = entry.date;
                    const price = entry.current_price || 0;
                    const score = entry.score || 0;
                    const pred1m = entry.predictions?.['1m'] || 0;
                    const pred3m = entry.predictions?.['3m'] || 0;
                    const pred6m = entry.predictions?.['6m'] || 0;
                    const pred12m = entry.predictions?.['12m'] || 0;
                    
                    const ret1m = entry.expected_returns?.['1m'] || 0;
                    const ret3m = entry.expected_returns?.['3m'] || 0;
                    const ret6m = entry.expected_returns?.['6m'] || 0;
                    const ret12m = entry.expected_returns?.['12m'] || 0;
                    
                    const formatPrice = (p) => p > 0 ? '$' + p.toFixed(2) : '-';
                    const formatReturn = (r) => {
                        if (r === null || r === undefined || !isFinite(r)) return '-';
                        if (r < 10) return r.toFixed(1) + '%';
                        if (r < 100) return r.toFixed(1) + '%';
                        return r.toFixed(0) + '%';
                    };
                    const formatScore = (s) => {
                        if (s === null || s === undefined || !isFinite(s)) return '-';
                        return s.toFixed(1) + '%';
                    };
                    
                    tableHtml += `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 8px; color: var(--text-primary);">${date}</td>
                            <td style="padding: 8px; text-align: right; color: var(--text-primary); font-weight: 500;">${formatPrice(price)}</td>
                            <td style="padding: 8px; text-align: right; color: ${score >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                ${formatScore(score)}
                            </td>
                            <td style="padding: 8px; text-align: right; color: ${ret1m >= 0 ? '#10b981' : '#ef4444'};">
                                ${formatPrice(pred1m)}<br>
                                <span style="font-size: 0.85em; opacity: 0.8;">${formatReturn(ret1m)}</span>
                            </td>
                            <td style="padding: 8px; text-align: right; color: ${ret3m >= 0 ? '#10b981' : '#ef4444'};">
                                ${formatPrice(pred3m)}<br>
                                <span style="font-size: 0.85em; opacity: 0.8;">${formatReturn(ret3m)}</span>
                            </td>
                            <td style="padding: 8px; text-align: right; color: ${ret6m >= 0 ? '#10b981' : '#ef4444'};">
                                ${formatPrice(pred6m)}<br>
                                <span style="font-size: 0.85em; opacity: 0.8;">${formatReturn(ret6m)}</span>
                            </td>
                            <td style="padding: 8px; text-align: right; color: ${ret12m >= 0 ? '#10b981' : '#ef4444'};">
                                ${formatPrice(pred12m)}<br>
                                <span style="font-size: 0.85em; opacity: 0.8;">${formatReturn(ret12m)}</span>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('predictionHistoryTable').innerHTML = tableHtml;
                document.getElementById('predictionHistoryContainer').style.display = 'block';
            } catch (error) {
                console.error('[PREDICTION HISTORY] Error loading history:', error);
                document.getElementById('predictionHistoryTable').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Error loading prediction history.</p>';
                document.getElementById('predictionHistoryContainer').style.display = 'block';
            }
        }

        async function loadScoreHistory(ticker = null) {
            try {
                // Get ticker from parameter or from current input
                if (!ticker || ticker === 'undefined') {
                    ticker = document.getElementById('tickerInput')?.value?.trim().toUpperCase() || 
                             document.querySelector('[data-ticker]')?.getAttribute('data-ticker') ||
                             window.currentTicker;
                }
                
                if (!ticker || ticker === 'undefined') {
                    console.error('[SCORE HISTORY] No ticker available');
                    document.getElementById('scoreHistoryTable').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Error: No ticker specified.</p>';
                    document.getElementById('scoreHistoryContainer').style.display = 'block';
                    return;
                }
                
                const container = document.getElementById('scoreHistoryTable');
                const containerWrapper = document.getElementById('scoreHistoryContainer');
                
                // Show loading state
                if (container) {
                    container.innerHTML = createLoadingIndicator('Loading score history...');
                }
                if (containerWrapper) {
                    containerWrapper.style.display = 'block';
                }
                
                const days = document.getElementById('scoreHistoryPeriodSelect')?.value || 30;
                const result = await fetchJSON(`/api/ml-score-history/${ticker}?days=${days}`, {}, container);
                
                if (!result.success) {
                    return; // Error already displayed by fetchJSON
                }
                
                const data = result.data;
                if (!data.score_history || data.score_history.length === 0) {
                    document.getElementById('scoreHistoryTable').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No score history available yet. Scores will be saved automatically when you analyze this stock.</p>';
                    document.getElementById('scoreHistoryContainer').style.display = 'block';
                    return;
                }
                
                // Build table
                let tableHtml = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead>
                            <tr style="background: rgba(102, 126, 234, 0.1); border-bottom: 2px solid rgba(102, 126, 234, 0.3);">
                                <th style="padding: 8px; text-align: left; color: var(--text-primary); font-weight: 600;">Date</th>
                                <th style="padding: 8px; text-align: right; color: var(--text-primary); font-weight: 600;">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.score_history.forEach(entry => {
                    const date = entry.date;
                    const score = entry.score || 0;
                    
                    const formatScore = (s) => {
                        if (s === null || s === undefined || !isFinite(s)) return '-';
                        return Math.round(s) + '/100';
                    };
                    
                    tableHtml += `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 8px; color: var(--text-primary);">${date}</td>
                            <td style="padding: 8px; text-align: right; color: ${score >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600; font-size: 1.1em;">
                                ${formatScore(score)}
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('scoreHistoryTable').innerHTML = tableHtml;
                document.getElementById('scoreHistoryContainer').style.display = 'block';
            } catch (error) {
                console.error('[SCORE HISTORY] Error loading score history:', error);
                document.getElementById('scoreHistoryTable').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Error loading score history.</p>';
                document.getElementById('scoreHistoryContainer').style.display = 'block';
            }
        }

        function toggleExplanation(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Store chart data globally for history table updates
        let currentChartData = null;

        function updateHistoryTable(ticker, days) {
            if (!currentChartData || !currentChartData.chart_data) {
                console.error('Chart data not available');
                return;
            }

            const dates = currentChartData.chart_data.dates || [];
            const opens = currentChartData.chart_data.open || [];
            const highs = currentChartData.chart_data.high || [];
            const lows = currentChartData.chart_data.low || [];
            const closes = currentChartData.chart_data.close || [];
            const volumes = currentChartData.chart_data.volume || [];

            // Calculate start index
            const startIdx = days > 0 ? Math.max(0, dates.length - days) : 0;
            const rows = [];

            for (let i = dates.length - 1; i >= startIdx; i--) {
                const date = dates[i] || '';
                const open = opens[i] || 0;
                const high = highs[i] || 0;
                const low = lows[i] || 0;
                const close = closes[i] || 0;
                const volume = volumes[i] || 0;

                // Calculate change from previous day
                const prevClose = i > 0 ? (closes[i - 1] || close) : close;
                const change = close - prevClose;
                const changePct = prevClose > 0 ? ((change / prevClose) * 100) : 0;

                const changeColor = change >= 0 ? '#10b981' : '#ef4444';
                const changeSign = change >= 0 ? '+' : '';

                // Format volume (with K, M, B suffixes)
                const formatVolume = (vol) => {
                    if (vol >= 1000000000) {
                        return (vol / 1000000000).toFixed(2) + 'B';
                    } else if (vol >= 1000000) {
                        return (vol / 1000000).toFixed(2) + 'M';
                    } else if (vol >= 1000) {
                        return (vol / 1000).toFixed(2) + 'K';
                    }
                    return vol.toLocaleString();
                };

                rows.push(`
                    <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='rgba(102, 126, 234, 0.05)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 8px; color: var(--text-primary);">${date}</td>
                        <td style="padding: 8px; text-align: right; color: var(--text-primary);">$${open.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: right; color: var(--text-primary);">$${high.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: right; color: var(--text-primary);">$${low.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: right; color: var(--text-primary); font-weight: 600;">$${close.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: right; color: ${changeColor}; font-weight: 600;">${changeSign}$${Math.abs(change).toFixed(2)}</td>
                        <td style="padding: 8px; text-align: right; color: ${changeColor}; font-weight: 600;">${changeSign}${changePct.toFixed(2)}%</td>
                        <td style="padding: 8px; text-align: right; color: var(--text-secondary);">${formatVolume(volume)}</td>
                    </tr>
                `);
            }

            // Update table
            const container = document.getElementById('historyTableContainer');
            if (container) {
                container.innerHTML = `
                    <table class="daily-history-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Open</th>
                                <th>High</th>
                                <th>Low</th>
                                <th>Close</th>
                                <th>Change</th>
                                <th>Change %</th>
                                <th>Volume</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.join('')}
                        </tbody>
                    </table>
                `;
            }

            // Update button states
            document.querySelectorAll('.history-filter-btn').forEach(btn => {
                if (parseInt(btn.getAttribute('data-days')) === days) {
                    btn.style.background = 'rgba(102, 126, 234, 0.2)';
                    btn.style.border = '1px solid #667eea';
                    btn.style.color = '#667eea';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'var(--metric-bg)';
                    btn.style.border = '1px solid var(--border-color)';
                    btn.style.color = 'var(--text-primary)';
                    btn.classList.remove('active');
                }
            });
        }

        function displayAIRecommendations(data, ticker) {
            // Store ticker globally for history loading
            window.currentTicker = ticker || data.ticker || document.getElementById('tickerInput')?.value?.trim().toUpperCase();
            
            const container = document.getElementById('aiRecommendationsContent');
            
            // Debug: Log chart_data availability
            console.log('[AI RECOMMENDATIONS] Data received:', {
                hasChartData: !!data.chart_data,
                chartDataType: typeof data.chart_data,
                chartDataKeys: data.chart_data ? Object.keys(data.chart_data) : null,
                hasDates: data.chart_data && Array.isArray(data.chart_data.dates),
                datesLength: data.chart_data && data.chart_data.dates ? data.chart_data.dates.length : 0
            });
            
            // Store chart data globally for history table updates
            currentChartData = data;            if (data.ml_models && data.ml_models.price_prediction) {
                const pp = data.ml_models.price_prediction;
                try {
                    const pred12m = pp.predictions?.['12m'];
                    const ret12m = pp.expected_returns?.['12m'];
                    const ci12m = pp.confidence_intervals?.['12m'];
                } catch (e) {
                    // Silently ignore debug log errors
                }
            }            const reasonsHtml = data.reasons && data.reasons.length > 0 
                ? `<div style="margin-top: 20px;">
                    <h4 style="color: #10b981; margin-bottom: 10px;">âœ… Positive Factors</h4>
                    <ul style="list-style: none; padding: 0;">
                        ${data.reasons.map(reason => `<li style="padding: 8px 0; padding-left: 25px; position: relative; color: var(--text-primary);">
                            <span style="position: absolute; left: 0; color: #10b981;">âœ“</span>${reason}
                        </li>`).join('')}
                    </ul>
                </div>`
                : '';
            
            const warningsHtml = data.warnings && data.warnings.length > 0
                ? `<div style="margin-top: 20px;">
                    <h4 style="color: #ef4444; margin-bottom: 10px;">âš ï¸ Concerns</h4>
                    <ul style="list-style: none; padding: 0;">
                        ${data.warnings.map(warning => `<li style="padding: 8px 0; padding-left: 25px; position: relative; color: var(--text-primary);">
                            <span style="position: absolute; left: 0; color: #ef4444;">âš </span>${warning}
                        </li>`).join('')}
                    </ul>
                </div>`
                : '';
            
            const technicalIndicators = data.technical_indicators || {};
            let indicatorsHtml = '';
            const hasIndicators = (technicalIndicators.rsi !== null && technicalIndicators.rsi !== undefined) ||
                                  (technicalIndicators.macd_bullish !== null && technicalIndicators.macd_bullish !== undefined) ||
                                  (technicalIndicators.price_vs_sma20 !== null && technicalIndicators.price_vs_sma20 !== undefined) ||
                                  (technicalIndicators.price_vs_sma50 !== null && technicalIndicators.price_vs_sma50 !== undefined);
            
            if (hasIndicators) {
                indicatorsHtml = `
                    <div style="margin-top: 20px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                        <h4 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ“Š Technical Indicators</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${technicalIndicators.rsi !== null && technicalIndicators.rsi !== undefined 
                                ? `<div style="padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">RSI</div>
                                    <div style="font-size: 1.2em; font-weight: 600; color: var(--text-primary);">${technicalIndicators.rsi.toFixed(2)}</div>
                                </div>`
                                : ''}
                            ${technicalIndicators.macd_bullish !== null && technicalIndicators.macd_bullish !== undefined
                                ? `<div style="padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">MACD</div>
                                    <div style="font-size: 1.2em; font-weight: 600; color: ${technicalIndicators.macd_bullish ? '#10b981' : '#ef4444'};">
                                        ${technicalIndicators.macd_bullish ? 'ðŸŸ¢ Bullish' : 'ðŸ”´ Bearish'}
                                    </div>
                                </div>`
                                : ''}
                            ${technicalIndicators.price_vs_sma20 !== null && technicalIndicators.price_vs_sma20 !== undefined
                                ? `<div style="padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Price vs SMA 20</div>
                                    <div style="font-size: 1.2em; font-weight: 600; color: ${technicalIndicators.price_vs_sma20 ? '#10b981' : '#ef4444'};">
                                        ${technicalIndicators.price_vs_sma20 ? 'ðŸŸ¢ Above' : 'ðŸ”´ Below'}
                                    </div>
                                </div>`
                                : ''}
                            ${technicalIndicators.price_vs_sma50 !== null && technicalIndicators.price_vs_sma50 !== undefined
                                ? `<div style="padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Price vs SMA 50</div>
                                    <div style="font-size: 1.2em; font-weight: 600; color: ${technicalIndicators.price_vs_sma50 ? '#10b981' : '#ef4444'};">
                                        ${technicalIndicators.price_vs_sma50 ? 'ðŸŸ¢ Above' : 'ðŸ”´ Below'}
                                    </div>
                                </div>`
                                : ''}
                        </div>
                    </div>`;
            }
            
            // Store trading strategy data globally for chart creation
            if (data.trading_strategy) {
                window.currentTradingStrategy = data.trading_strategy;
                window.currentChartData = data.chart_data;
                window.currentTickerForStrategy = ticker || data.ticker;
            }
            
            container.innerHTML = `
                <div style="margin-top: 20px;">
                    <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, ${data.color}15 0%, ${data.color}05 100%); border-radius: 16px; border: 3px solid ${data.color}; margin-bottom: 30px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">ðŸ¤–</div>
                        <h2 style="color: ${data.color}; margin-bottom: 10px; font-size: 2em;">${data.recommendation}</h2>
                        <p style="color: var(--text-secondary); font-size: 1.1em; margin-bottom: 15px;">Confidence: <strong style="color: ${data.color};">${data.confidence}</strong><span style="margin-left: 15px; font-size: 0.85em; opacity: 0.7; cursor: help;" title="Confidence ukazuje, jak jistÃ½ je AI model ve svÃ©m doporuÄenÃ­. High = vysokÃ¡ jistota, Medium = stÅ™ednÃ­ jistota.">â„¹ï¸</span></p>
                        <div style="display: inline-block; padding: 8px 20px; background: ${data.color}; color: white; border-radius: 20px; font-weight: 600; font-size: 1.1em;">
                            Score: ${data.score}/100<span style="margin-left: 8px; font-size: 0.85em; opacity: 0.9; cursor: help;" title="Score (0-100) kombinuje technickou analÃ½zu, ML predikce, trend klasifikaci a risk analÃ½zu. ÄŒÃ­m vyÅ¡Å¡Ã­, tÃ­m lepÅ¡Ã­ doporuÄenÃ­.">â„¹ï¸</span>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color); margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: var(--text-primary);">ðŸ“ Summary</h4>
                            <button onclick="toggleExplanation('summaryExplanation')" style="background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea; color: #667eea; padding: 4px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">â„¹ï¸ What is this?</button>
                        </div>
                        <div id="summaryExplanation" style="display: none; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #667eea;">
                            <p style="margin: 0; color: var(--text-primary); line-height: 1.6; font-size: 0.9em;">
                                <strong>Summary:</strong> ShrnutÃ­ hlavnÃ­ch pozitivnÃ­ch faktorÅ¯ a obav, kterÃ© ovlivnily finÃ¡lnÃ­ doporuÄenÃ­. Kombinuje technickou analÃ½zu (RSI, MACD, moving averages), ML predikce (price prediction, trend classification) a risk analÃ½zu.
                            </p>
                        </div>
                        <p style="color: var(--text-primary); line-height: 1.6;">${data.summary}</p>
                    </div>
                    
                    ${data.why_explanation ? `
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.3); margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: var(--text-primary);">ðŸ’¡ Why ${data.recommendation}?</h4>
                            <button onclick="toggleExplanation('whyExplanationInfo')" style="background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea; color: #667eea; padding: 4px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">â„¹ï¸ What is this?</button>
                        </div>
                        <div id="whyExplanationInfo" style="display: none; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #667eea;">
                            <p style="margin: 0; color: var(--text-primary); line-height: 1.6; font-size: 0.9em;">
                                <strong>Why explanation:</strong> DetailnÃ­ vysvÄ›tlenÃ­, proÄ bylo doporuÄeno ${data.recommendation}. Tato analÃ½za kombinuje ML price predictions, trend classification, technical indicators, news sentiment a risk assessment pro komplexnÃ­ pohled na investiÄnÃ­ pÅ™Ã­leÅ¾itost.
                            </p>
                        </div>
                        <p style="color: var(--text-primary); line-height: 1.8; font-size: 1em;">${data.why_explanation}</p>
                    </div>
                    ` : ''}
                    
                    ${reasonsHtml}
                    ${warningsHtml}
                    ${indicatorsHtml}
                    
                    ${data.ml_models ? `
                        <!-- Price Prediction Section -->
                        ${data.ml_models.price_prediction && data.ml_models.price_prediction.predictions ? `
                            <div style="margin-top: 20px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: var(--text-primary);">ðŸ“ˆ Price Prediction (ML Model)</h4>
                                    <button onclick="toggleExplanation('pricePredictionExplanation')" style="background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea; color: #667eea; padding: 4px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">â„¹ï¸ What is this?</button>
                                </div>
                                <div id="pricePredictionExplanation" style="display: none; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #667eea;">
                                    <p style="margin: 0; color: var(--text-primary); line-height: 1.6; font-size: 0.9em;">
                                        <strong>Price Prediction:</strong> ML model pÅ™edpovÃ­dÃ¡, jakÃ¡ bude cena akcie za 1, 3, 6 a 12 mÄ›sÃ­cÅ¯ na zÃ¡kladÄ› technickÃ½ch indikÃ¡torÅ¯, fundamentÃ¡lnÃ­ch metrik a sentimentu. <strong>Expected Return</strong> ukazuje oÄekÃ¡vanÃ½ procentuÃ¡lnÃ­ zisk/ztrÃ¡tu. <strong>Range</strong> zobrazuje confidence interval - rozsah, ve kterÃ©m se cena s vysokou pravdÄ›podobnostÃ­ bude pohybovat (ÄÃ­m Å¡irÅ¡Ã­ range, tÃ­m vyÅ¡Å¡Ã­ nejistota).
                                    </p>
                                </div>
                                ${data.ml_models.price_prediction.model_quality && data.ml_models.price_prediction.model_quality.cv_r2_score !== null ? `
                                <div style="padding: 12px; background: ${data.ml_models.price_prediction.model_quality.cv_r2_score < 0 ? 'rgba(239, 68, 68, 0.1)' : data.ml_models.price_prediction.model_quality.cv_r2_score < 0.5 ? 'rgba(251, 191, 36, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; border-radius: 8px; border-left: 3px solid ${data.ml_models.price_prediction.model_quality.cv_r2_score < 0 ? '#ef4444' : data.ml_models.price_prediction.model_quality.cv_r2_score < 0.5 ? '#fbbf24' : '#10b981'}; margin-bottom: 15px;">
                                    <p style="margin: 0; color: var(--text-primary); line-height: 1.5; font-size: 0.85em;">
                                        <strong>Model Quality (CV RÂ²):</strong> ${data.ml_models.price_prediction.model_quality.cv_r2_score.toFixed(3)}
                                        ${data.ml_models.price_prediction.model_quality.cv_r2_score < 0 ? ' âš ï¸ NegativnÃ­ RÂ² = model je horÅ¡Ã­ neÅ¾ jednoduchÃ½ baseline (prÅ¯mÄ›r). Predikce nejsou spolehlivÃ©.' : data.ml_models.price_prediction.model_quality.cv_r2_score < 0.5 ? ' âš ï¸ NÃ­zkÃ¡ pÅ™esnost modelu. Predikce jsou experimentÃ¡lnÃ­.' : ' âœ… Model mÃ¡ rozumnou pÅ™esnost.'}
                                    </p>
                                </div>
                                ` : ''}
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    ${['1m', '3m', '6m', '12m'].map(period => {
                                        // Safely extract prediction value
                                        let pred = null;
                                        let ret = null;
                                        let ci = null;
                                        
                                        try {
                                            const predictions = data.ml_models?.price_prediction?.predictions;
                                            const expectedReturns = data.ml_models?.price_prediction?.expected_returns;
                                            const confidenceIntervals = data.ml_models?.price_prediction?.confidence_intervals;
                                            
                                            // Extract prediction price - handle both {price: X} and direct number formats
                                            if (predictions && typeof predictions === 'object' && predictions[period] !== null && predictions[period] !== undefined) {
                                                const predObj = predictions[period];
                                                try {
                                                    // Check if predObj is an object with 'price' property
                                                    if (predObj !== null && typeof predObj === 'object' && !Array.isArray(predObj)) {
                                                        // Safely check for 'price' property
                                                        if (Object.prototype.hasOwnProperty.call(predObj, 'price') || 'price' in predObj) {
                                                            const priceValue = predObj.price;
                                                            if (priceValue !== null && priceValue !== undefined && typeof priceValue === 'number' && isFinite(priceValue)) {
                                                                pred = priceValue;
                                                            }
                                                        }
                                                    } 
                                                    // Check if predObj is a direct number
                                                    else if (typeof predObj === 'number' && isFinite(predObj)) {
                                                        pred = predObj;
                                                    }
                                                } catch (priceError) {
                                                    console.error(`Error accessing price for ${period}:`, priceError, {predObj, predictions});
                                                    pred = null;
                                                }
                                            }
                                            
                                            // Extract expected return
                                            ret = expectedReturns?.[period];
                                            if (ret !== null && ret !== undefined && typeof ret === 'number' && isFinite(ret)) {
                                                // Keep ret as is
                                            } else {
                                                ret = null;
                                            }
                                            
                                            // Extract confidence interval
                                            ci = confidenceIntervals?.[period];
                                            if (ci !== null && ci !== undefined && typeof ci === 'object' && !Array.isArray(ci)) {
                                                // Keep ci as is
                                            } else {
                                                ci = null;
                                            }
                                        } catch (e) {
                                            console.error(`Error extracting data for ${period}:`, e);
                                            pred = null;
                                            ret = null;
                                            ci = null;
                                        }
                                        
                                        // Validate and fix Infinity/NaN values
                                        // Ensure pred, ret, ci are numbers (handle null/undefined)
                                        if (pred === null || pred === undefined || typeof pred !== 'number') {
                                            pred = 0;
                                        }
                                        if (ret === null || ret === undefined || typeof ret !== 'number') {
                                            ret = 0;
                                        }
                                        if (!ci || typeof ci !== 'object') {
                                            ci = {lower: 0, upper: 0};
                                        }
                                        if (ci.lower === null || ci.lower === undefined || typeof ci.lower !== 'number') {
                                            ci.lower = 0;
                                        }
                                        if (ci.upper === null || ci.upper === undefined || typeof ci.upper !== 'number') {
                                            ci.upper = 0;
                                        }
                                        
                                        // Calculate currentPrice safely - avoid division by zero when ret = -100
                                        let currentPrice = data.metrics?.current_price || data.current_price;
                                        if (!currentPrice || !isFinite(currentPrice) || currentPrice <= 0) {
                                            // If ret is -100%, we can't calculate backwards, so use pred as fallback
                                            if (ret === -100 || ret <= -99) {
                                                currentPrice = Math.max(pred * 2, 100); // Assume current price is at least 2x predicted
                                            } else if (pred > 0 && ret !== 0 && isFinite(ret) && ret > -99) {
                                                // Only calculate backwards if ret is not -100%
                                                const denominator = 1 + ret / 100;
                                                if (Math.abs(denominator) > 0.01) { // Avoid division by zero
                                                    currentPrice = pred / denominator;
                                                } else {
                                                    currentPrice = Math.max(pred * 2, 100);
                                                }
                                            } else {
                                                currentPrice = Math.max(Math.abs(pred) || 100, 100);
                                            }
                                        }
                                        // Ensure currentPrice is finite and positive
                                        if (!isFinite(currentPrice) || currentPrice <= 0) {
                                            currentPrice = 100;
                                        }
                                        const minPrice = Math.max(currentPrice * 0.20, 0.01); // Minimum 20% of current price
                                        const maxPrice = currentPrice * 5.0; // Maximum 5x current price
                                        
                                        // Fix Infinity/NaN predictions
                                        if (!isFinite(pred) || pred <= 0 || pred > maxPrice) {
                                            pred = Math.max(minPrice, currentPrice * 0.20);
                                        }
                                        if (pred < minPrice) {
                                            pred = minPrice;
                                        }
                                        
                                        // Fix Infinity/NaN returns - always recalculate from pred and currentPrice for accuracy
                                        if (!isFinite(ret) || ret === null || ret === undefined || currentPrice <= 0) {
                                            ret = ((pred - currentPrice) / currentPrice) * 100;
                                        }
                                        // Only cap negative returns, allow positive returns to be displayed accurately
                                        ret = Math.max(-80, ret);  // Cap only negative side at -80%
                                        
                                        // Fix Infinity/NaN confidence intervals
                                        if (!ci || !isFinite(ci.lower) || ci.lower <= 0) {
                                            ci = {...ci, lower: Math.max(minPrice, pred * 0.82)};
                                        }
                                        if (!ci || !isFinite(ci.upper) || ci.upper <= ci.lower) {
                                            ci = {...ci, upper: Math.min(maxPrice, pred * 1.18)};
                                        }
                                        if (ci.lower < minPrice) {
                                            ci = {...ci, lower: minPrice};
                                        }
                                        if (ci.upper > maxPrice) {
                                            ci = {...ci, upper: maxPrice};
                                        }
                                        
                                        // Final safety check - ensure all values are finite before display
                                        if (!isFinite(pred)) {
                                            pred = minPrice;
                                        }
                                        if (!isFinite(ci.lower)) {
                                            ci.lower = minPrice;
                                        }
                                        if (!isFinite(ci.upper)) {
                                            ci.upper = Math.min(maxPrice, pred * 1.18);
                                        }
                                        if (!isFinite(ret) || ret === null || ret === undefined || currentPrice <= 0) {
                                            ret = ((pred - currentPrice) / currentPrice) * 100;
                                            ret = Math.max(-80, ret);  // Cap only negative side
                                        }
                                        
                                        // Format values safely - add extra validation
                                        const formatPrice = (val) => {
                                            // Convert to number if string
                                            if (typeof val === 'string') {
                                                val = parseFloat(val);
                                            }
                                            // Check for Infinity, NaN, null, undefined
                                            if (val === null || val === undefined || !isFinite(val) || val <= 0 || val === Infinity || val === -Infinity || isNaN(val)) {
                                                return minPrice.toFixed(2);
                                            }
                                            // Ensure value is within bounds
                                            const bounded = Math.max(minPrice, Math.min(maxPrice, val));
                                            if (!isFinite(bounded) || bounded <= 0 || bounded === Infinity || bounded === -Infinity) {
                                                return minPrice.toFixed(2);
                                            }
                                            return bounded.toFixed(2);
                                        };
                                        
                                        const formatReturn = (val) => {
                                            // Convert to number if string
                                            if (typeof val === 'string') {
                                                val = parseFloat(val);
                                            }
                                            // Check for Infinity, NaN, null, undefined
                                            if (val === null || val === undefined || !isFinite(val) || val === Infinity || val === -Infinity || isNaN(val)) {
                                                return '0.0';
                                            }
                                            // Cap at -80% to +200%
                                            const capped = Math.max(-80, Math.min(200, val));
                                            if (!isFinite(capped) || capped === Infinity || capped === -Infinity) {
                                                return '0.0';
                                            }
                                            // Smart rounding: 1 decimal for smaller values, 0 decimals for larger
                                            if (Math.abs(capped) < 10) {
                                                return capped.toFixed(1);  // 1 decimal for values < 10%
                                            } else if (Math.abs(capped) < 100) {
                                                return capped.toFixed(1);  // 1 decimal for values 10-100%
                                            } else {
                                                return capped.toFixed(0);  // 0 decimals for values > 100%
                                            }
                                        };
                                        
                                        
                                        const retColor = ret >= 0 ? '#10b981' : '#ef4444';
                                        
                                        // Final check before rendering - ensure all values are safe
                                        const safePred = formatPrice(pred);
                                        const safeRet = formatReturn(ret);
                                        const safeCiLower = formatPrice(ci.lower);
                                        const safeCiUpper = formatPrice(ci.upper);
                                        
                                        return `
                                            <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px;">${period.toUpperCase()}</div>
                                                <div style="font-size: 1.3em; font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">$${safePred}</div>
                                                <div style="font-size: 0.9em; color: ${retColor}; font-weight: 600;">
                                                    ${ret >= 0 ? '+' : ''}${safeRet}%
                                                </div>
                                                <div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 5px;">
                                                    Range: $${safeCiLower} - $${safeCiUpper}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                <!-- Daily History Table -->
                                ${(() => {
                                    const hasData = data.chart_data && data.chart_data.dates && Array.isArray(data.chart_data.dates) && data.chart_data.dates.length > 0;
                                    console.log('[HISTORY TABLE] Condition check:', {
                                        hasChartData: !!data.chart_data,
                                        hasDates: !!(data.chart_data && data.chart_data.dates),
                                        isArray: data.chart_data && data.chart_data.dates ? Array.isArray(data.chart_data.dates) : false,
                                        length: data.chart_data && data.chart_data.dates ? data.chart_data.dates.length : 0,
                                        willShow: hasData
                                    });
                                    return hasData;
                                })() ? `
                                    <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid var(--border-color);">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                            <h5 style="margin: 0; color: var(--text-primary); font-size: 1em;">ðŸ“… Daily Price History</h5>
                                            <div style="display: flex; gap: 8px;">
                                                <button onclick="updateHistoryTable('${data.ticker}', 30)" class="history-filter-btn active" data-days="30" style="padding: 6px 12px; background: rgba(102, 126, 234, 0.2); border: 1px solid #667eea; color: #667eea; border-radius: 6px; font-size: 0.8em; cursor: pointer; font-weight: 600;">30d</button>
                                                <button onclick="updateHistoryTable('${data.ticker}', 60)" class="history-filter-btn" data-days="60" style="padding: 6px 12px; background: var(--metric-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; font-size: 0.8em; cursor: pointer; font-weight: 600;">60d</button>
                                                <button onclick="updateHistoryTable('${data.ticker}', 90)" class="history-filter-btn" data-days="90" style="padding: 6px 12px; background: var(--metric-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; font-size: 0.8em; cursor: pointer; font-weight: 600;">90d</button>
                                                <button onclick="updateHistoryTable('${data.ticker}', 0)" class="history-filter-btn" data-days="0" style="padding: 6px 12px; background: var(--metric-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; font-size: 0.8em; cursor: pointer; font-weight: 600;">All</button>
                                            </div>
                                        </div>
                                        <div id="historyTableContainer" style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                                            ${(() => {
                                                const dates = data.chart_data.dates || [];
                                                const opens = data.chart_data.open || [];
                                                const highs = data.chart_data.high || [];
                                                const lows = data.chart_data.low || [];
                                                const closes = data.chart_data.close || [];
                                                const volumes = data.chart_data.volume || [];
                                                
                                                // Show last 30 days by default
                                                const daysToShow = 30;
                                                const startIdx = Math.max(0, dates.length - daysToShow);
                                                const rows = [];
                                                
                                                for (let i = dates.length - 1; i >= startIdx; i--) {
                                                    const date = dates[i] || '';
                                                    const open = opens[i] || 0;
                                                    const high = highs[i] || 0;
                                                    const low = lows[i] || 0;
                                                    const close = closes[i] || 0;
                                                    const volume = volumes[i] || 0;
                                                    
                                                    // Calculate change from previous day
                                                    const prevClose = i > 0 ? (closes[i - 1] || close) : close;
                                                    const change = close - prevClose;
                                                    const changePct = prevClose > 0 ? ((change / prevClose) * 100) : 0;
                                                    
                                                    const changeColor = change >= 0 ? '#10b981' : '#ef4444';
                                                    const changeSign = change >= 0 ? '+' : '';
                                                    
                                                    // Format volume (with K, M, B suffixes)
                                                    const formatVolume = (vol) => {
                                                        if (vol >= 1000000000) {
                                                            return (vol / 1000000000).toFixed(2) + 'B';
                                                        } else if (vol >= 1000000) {
                                                            return (vol / 1000000).toFixed(2) + 'M';
                                                        } else if (vol >= 1000) {
                                                            return (vol / 1000).toFixed(2) + 'K';
                                                        }
                                                        return vol.toLocaleString();
                                                    };
                                                    
                                                    rows.push(`
                                                        <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='rgba(102, 126, 234, 0.05)'" onmouseout="this.style.background='transparent'">
                                                            <td style="padding: 8px; color: var(--text-primary);">${date}</td>
                                                            <td style="padding: 8px; text-align: right; color: var(--text-primary);">$${open.toFixed(2)}</td>
                                                            <td style="padding: 8px; text-align: right; color: var(--text-primary);">$${high.toFixed(2)}</td>
                                                            <td style="padding: 8px; text-align: right; color: var(--text-primary);">$${low.toFixed(2)}</td>
                                                            <td style="padding: 8px; text-align: right; color: var(--text-primary); font-weight: 600;">$${close.toFixed(2)}</td>
                                                            <td style="padding: 8px; text-align: right; color: ${changeColor}; font-weight: 600;">${changeSign}$${Math.abs(change).toFixed(2)}</td>
                                                            <td style="padding: 8px; text-align: right; color: ${changeColor}; font-weight: 600;">${changeSign}${changePct.toFixed(2)}%</td>
                                                            <td style="padding: 8px; text-align: right; color: var(--text-secondary);">${formatVolume(volume)}</td>
                                                        </tr>
                                                    `);
                                                }
                                                
                                                return `
                                                    <table class="daily-history-table" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                                        <thead>
                                                            <tr>
                                                                <th>Date</th>
                                                                <th>Open</th>
                                                                <th>High</th>
                                                                <th>Low</th>
                                                                <th>Close</th>
                                                                <th>Change</th>
                                                                <th>Change %</th>
                                                                <th>Volume</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            ${rows.join('')}
                                                        </tbody>
                                                    </table>
                                                `;
                                            })()}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Prediction History Section -->
                                <div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.2);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                        <h5 style="margin: 0; color: var(--text-primary); font-size: 0.95em;">ðŸ“… Historical Predictions</h5>
                                        <button id="loadHistoryBtn" onclick="loadPredictionHistory()" style="background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea; color: #667eea; padding: 4px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">Load History</button>
                                    </div>
                                    <div id="predictionHistoryContainer" style="display: none;">
                                        <div style="margin-bottom: 10px;">
                                            <select id="historyPeriodSelect" onchange="loadPredictionHistory()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); font-size: 0.85em;">
                                                <option value="7">Last 7 days</option>
                                                <option value="14">Last 14 days</option>
                                                <option value="30" selected>Last 30 days</option>
                                                <option value="60">Last 60 days</option>
                                                <option value="90">Last 90 days</option>
                                            </select>
                                        </div>
                                        <div id="predictionHistoryTable" style="max-height: 400px; overflow-y: auto;">
                                            <!-- History table will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Score History Section -->
                                <div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.2);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                        <h5 style="margin: 0; color: var(--text-primary); font-size: 0.95em;">ðŸ“Š Daily Score History</h5>
                                        <button id="loadScoreHistoryBtn" onclick="loadScoreHistory()" style="background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea; color: #667eea; padding: 4px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">Load Score</button>
                                    </div>
                                    <div id="scoreHistoryContainer" style="display: none;">
                                        <div style="margin-bottom: 10px;">
                                            <select id="scoreHistoryPeriodSelect" onchange="loadScoreHistory()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); font-size: 0.85em;">
                                                <option value="7">Last 7 days</option>
                                                <option value="14">Last 14 days</option>
                                                <option value="30" selected>Last 30 days</option>
                                                <option value="60">Last 60 days</option>
                                                <option value="90">Last 90 days</option>
                                            </select>
                                        </div>
                                        <div id="scoreHistoryTable" style="max-height: 300px; overflow-y: auto;">
                                            <!-- Score history table will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Trend Classification Section -->
                        ${data.ml_models?.trend_classification ? `
                            <div style="margin-top: 20px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: var(--text-primary);">ðŸ“Š Trend Classification (ML Model)</h4>
                                    <button onclick="toggleExplanation('trendClassificationExplanation')" style="background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea; color: #667eea; padding: 4px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">â„¹ï¸ What is this?</button>
                                </div>
                                <div id="trendClassificationExplanation" style="display: none; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #667eea;">
                                    <p style="margin: 0; color: var(--text-primary); line-height: 1.6; font-size: 0.9em;">
                                        <strong>Trend Classification:</strong> ML model analyzuje momentum, technickÃ© indikÃ¡tory a volume patterns a klasifikuje trend akcie do 5 kategoriÃ­. <strong>Strong Uptrend</strong> = silnÃ½ rÅ¯stovÃ½ trend, <strong>Moderate Uptrend</strong> = mÃ­rnÃ½ rÅ¯st, <strong>Sideways</strong> = konsolidace bez jasnÃ©ho smÄ›ru, <strong>Moderate Downtrend</strong> = mÃ­rnÃ½ pokles, <strong>Strong Downtrend</strong> = silnÃ½ poklesovÃ½ trend. ÄŒÃ­sla ukazujÃ­ pravdÄ›podobnost (%) kaÅ¾dÃ© kategorie. <strong>Confidence</strong> ukazuje, jak jistÃ½ je model ve svÃ© klasifikaci.
                                    </p>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <span style="font-size: 1.2em; font-weight: 600; color: var(--text-primary);">${data.ml_models?.trend_classification?.trend_class || 'N/A'}</span>
                                        <span style="font-size: 0.9em; color: var(--text-secondary);">(Confidence: ${data.ml_models?.trend_classification?.confidence ? (data.ml_models.trend_classification.confidence * 100).toFixed(0) : '0'}%)</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                                    ${(data.ml_models?.trend_classification?.probabilities && typeof data.ml_models.trend_classification.probabilities === 'object') ? Object.entries(data.ml_models.trend_classification.probabilities).map(([trend, prob]) => {
                                        const probPct = (prob * 100).toFixed(0);
                                        const isActive = trend === (data.ml_models?.trend_classification?.trend_class || '');
                                        const trendColors = {
                                            'Strong Uptrend': '#10b981',
                                            'Moderate Uptrend': '#34d399',
                                            'Sideways': '#fbbf24',
                                            'Moderate Downtrend': '#f87171',
                                            'Strong Downtrend': '#ef4444'
                                        };
                                        return `
                                            <div style="padding: 10px; background: ${isActive ? trendColors[trend] + '20' : 'rgba(102, 126, 234, 0.1)'}; border-radius: 8px; border: ${isActive ? '2px solid ' + trendColors[trend] : '1px solid var(--border-color)'}; text-align: center;">
                                                <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 5px;">${trend.replace(' ', '<br>')}</div>
                                                <div style="font-size: 1.1em; font-weight: 600; color: ${trendColors[trend]};">${probPct}%</div>
                                            </div>
                                        `;
                                    }).join('') : '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-secondary);">Probabilities not available</div>'}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Risk Analysis Section -->
                        ${data.ml_models?.risk_analysis ? `
                            <div style="margin-top: 20px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: var(--text-primary);">âš ï¸ Risk Analysis (ML Model)</h4>
                                    <button onclick="toggleExplanation('riskAnalysisExplanation')" style="background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea; color: #667eea; padding: 4px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">â„¹ï¸ What is this?</button>
                                </div>
                                <div id="riskAnalysisExplanation" style="display: none; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #667eea;">
                                    <p style="margin: 0; color: var(--text-primary); line-height: 1.6; font-size: 0.9em; margin-bottom: 10px;">
                                        <strong>Risk Score (0-100):</strong> CelkovÃ© hodnocenÃ­ rizika akcie. ÄŒÃ­m niÅ¾Å¡Ã­ ÄÃ­slo, tÃ­m niÅ¾Å¡Ã­ riziko. <strong>Risk Category:</strong> Low (0-25) = nÃ­zkÃ© riziko, Medium (25-50) = stÅ™ednÃ­ riziko, High (50-75) = vysokÃ© riziko, Very High (75-100) = velmi vysokÃ© riziko.
                                    </p>
                                    <p style="margin: 0; color: var(--text-primary); line-height: 1.6; font-size: 0.9em;">
                                        <strong>Risk Factors:</strong> <strong>Volatility</strong> = kolÃ­savost ceny (ÄÃ­m vyÅ¡Å¡Ã­, tÃ­m riskantnÄ›jÅ¡Ã­), <strong>Market Correlation (Beta)</strong> = korelace s trhem (beta > 1 = vÃ­ce volatilnÃ­ neÅ¾ trh), <strong>Financial Health</strong> = finanÄnÃ­ zdravÃ­ (dluh, cash flow, ziskovost), <strong>Liquidity</strong> = likvidita (schopnost rychle prodat), <strong>Sector Risk</strong> = riziko sektoru, <strong>Concentration Risk</strong> = riziko koncentrace.
                                    </p>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">Risk Score</div>
                                            <div style="font-size: 2em; font-weight: 600; color: ${(data.ml_models?.risk_analysis?.risk_score || 50) < 25 ? '#10b981' : (data.ml_models?.risk_analysis?.risk_score || 50) < 50 ? '#fbbf24' : (data.ml_models?.risk_analysis?.risk_score || 50) < 75 ? '#f87171' : '#ef4444'};">
                                                ${data.ml_models?.risk_analysis?.risk_score || 0}/100
                                            </div>
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">Risk Category</div>
                                            <div style="font-size: 1.5em; font-weight: 600; color: var(--text-primary);">
                                                ${data.ml_models?.risk_analysis?.risk_category || 'N/A'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                ${data.ml_models?.risk_analysis?.key_risk_factors && data.ml_models.risk_analysis.key_risk_factors.length > 0 ? `
                                    <div style="margin-top: 15px;">
                                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px;">Key Risk Factors:</div>
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            ${data.ml_models.risk_analysis.key_risk_factors.map(risk => {
                                                const factorNames = {
                                                    'volatility': 'Volatility',
                                                    'market_correlation': 'Market Correlation (Beta)',
                                                    'financial_health': 'Financial Health',
                                                    'liquidity': 'Liquidity',
                                                    'sector_risk': 'Sector Risk',
                                                    'concentration': 'Concentration Risk'
                                                };
                                                return `
                                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                                                        <span style="color: var(--text-primary);">${factorNames[risk.factor] || risk.factor}</span>
                                                        <span style="color: #ef4444; font-weight: 600;">${risk.score}/100</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    ` : ''}
                    
                    <!-- Trading Strategy Section (Entry, TP, DCA) -->
                    ${data.trading_strategy ? `
                        <div style="margin-top: 30px;">
                            <h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                                ðŸ“Š Trading Strategy
                            </h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                <!-- Entry Point Widget -->
                                <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(102, 126, 234, 0.05) 100%); border: 2px solid #667eea; padding: 20px;">
                                    <h4 style="margin: 0 0 15px 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        ðŸŽ¯ Entry Point
                                    </h4>
                                    <div style="text-align: center; margin-bottom: 15px;">
                                        <div style="font-size: 2.5em; font-weight: 800; color: #667eea; margin-bottom: 5px;">
                                            $${(data.trading_strategy?.entry?.price && typeof data.trading_strategy.entry.price === 'number') ? data.trading_strategy.entry.price.toFixed(2) : 'N/A'}
                                        </div>
                                        <div style="display: inline-block; padding: 4px 12px; background: ${(data.trading_strategy?.entry?.confidence || 'low') === 'high' ? 'rgba(16, 185, 129, 0.2)' : (data.trading_strategy?.entry?.confidence || 'low') === 'medium' ? 'rgba(245, 158, 11, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; border-radius: 12px; font-size: 0.85em; font-weight: 600; color: ${(data.trading_strategy?.entry?.confidence || 'low') === 'high' ? '#10b981' : (data.trading_strategy?.entry?.confidence || 'low') === 'medium' ? '#f59e0b' : '#ef4444'};">
                                            ${(data.trading_strategy?.entry?.confidence || 'low').toUpperCase()} Confidence
                                        </div>
                                    </div>
                                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; text-align: center;">
                                        ${data.trading_strategy?.entry?.reason || 'N/A'}
                                    </div>
                                    ${data.trading_strategy?.entry?.conditions && Array.isArray(data.trading_strategy.entry.conditions) && data.trading_strategy.entry.conditions.some(c => c && (c.includes('ML:') || c.includes('AI:'))) ? `
                                        <div style="margin-top: 10px; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; font-size: 0.8em; color: var(--text-primary);">
                                            <div style="font-weight: 600; margin-bottom: 4px; color: #667eea;">ðŸ¤– ML/AI Enhanced</div>
                                            <div style="color: var(--text-secondary); font-size: 0.85em;">
                                                Entry optimized using ML features and AI analysis
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${data.trading_strategy?.entry?.conditions && Array.isArray(data.trading_strategy.entry.conditions) && data.trading_strategy.entry.conditions.length > 0 ? `
                                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Conditions Met:</div>
                                            <ul style="list-style: none; padding: 0; margin: 0;">
                                                ${data.trading_strategy.entry.conditions.map(condition => condition || '').filter(c => c).map(condition => `
                                                    <li style="padding: 5px 0; padding-left: 20px; position: relative; color: var(--text-primary); font-size: 0.85em;">
                                                        <span style="position: absolute; left: 0; color: #10b981;">âœ“</span>${condition}
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Take Profit Widget -->
                                <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%); border: 2px solid #10b981; padding: 20px;">
                                    <h4 style="margin: 0 0 15px 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        ðŸŽ¯ Take Profit Levels
                                    </h4>
                                    <div style="display: flex; flex-direction: column; gap: 12px;">
                                        ${['tp1', 'tp2', 'tp3'].map(tpKey => {
                                            const tp = data.trading_strategy?.take_profit?.[tpKey];
                                            if (!tp || !tp.price || typeof tp.price !== 'number') return '';
                                            const gainColor = (tp.gain_pct || 0) >= 0 ? '#10b981' : '#ef4444';
                                            return `
                                                <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                                        <span style="font-weight: 600; color: var(--text-primary);">${tpKey.toUpperCase()}</span>
                                                        <span style="font-size: 1.2em; font-weight: 700; color: ${gainColor};">
                                                            $${tp.price.toFixed(2)}
                                                        </span>
                                                    </div>
                                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85em;">
                                                        <span style="color: var(--text-secondary);">${tp.timeframe || 'N/A'}</span>
                                                        <span style="color: ${gainColor}; font-weight: 600;">
                                                            ${(tp.gain_pct || 0) >= 0 ? '+' : ''}${tp.gain_pct || 0}%
                                                        </span>
                                                    </div>
                                                    ${tp.ml_confidence !== undefined && tp.ml_confidence !== null ? `
                                                        <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 3px; text-align: right;">
                                                            ML confidence: ${tp.ml_confidence}%
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    ${data.trading_strategy?.risk_reward_ratio && typeof data.trading_strategy.risk_reward_ratio === 'number' ? `
                                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: center;">
                                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Risk/Reward Ratio</div>
                                            <div style="font-size: 1.5em; font-weight: 700; color: ${data.trading_strategy.risk_reward_ratio >= 2 ? '#10b981' : data.trading_strategy.risk_reward_ratio >= 1 ? '#f59e0b' : '#ef4444'};">
                                                1:${data.trading_strategy.risk_reward_ratio.toFixed(2)}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${data.trading_strategy?.ml_enhancements ? `
                                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); padding: 12px; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                                            <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">ðŸ¤– ML/AI Adjustments</div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 0.75em;">
                                                <div>
                                                    <span style="color: var(--text-secondary);">Volatility:</span>
                                                    <span style="color: var(--text-primary); font-weight: 600; margin-left: 5px;">${data.trading_strategy.ml_enhancements?.volatility_pct || 'N/A'}%</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Adaptive Factor:</span>
                                                    <span style="color: var(--text-primary); font-weight: 600; margin-left: 5px;">${data.trading_strategy.ml_enhancements?.adaptive_factor || 'N/A'}x</span>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- DCA Levels Widget -->
                                <div class="card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%); border: 2px solid #f59e0b; padding: 20px;">
                                    <h4 style="margin: 0 0 15px 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        ðŸ’° DCA Levels
                                    </h4>
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 12px;">
                                        Dollar Cost Averaging - dokupovÃ¡nÃ­ pÅ™i poklesu
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        ${(data.trading_strategy?.dca_levels && Array.isArray(data.trading_strategy.dca_levels) ? data.trading_strategy.dca_levels : []).map((level, idx) => {
                                            if (!level || !level.price || typeof level.price !== 'number') return '';
                                            const confidenceColor = (level.confidence || 'low') === 'high' ? '#10b981' : (level.confidence || 'low') === 'medium' ? '#f59e0b' : '#ef4444';
                                            return `
                                                <div style="padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; border-left: 3px solid ${confidenceColor};">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                                                        <span style="font-weight: 600; color: var(--text-primary);">Level ${idx + 1}</span>
                                                        <span style="font-size: 1.1em; font-weight: 700; color: var(--text-primary);">
                                                            $${level.price.toFixed(2)}
                                                        </span>
                                                    </div>
                                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8em;">
                                                        <span style="color: var(--text-secondary);">${level.reason || 'N/A'}</span>
                                                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 2px;">
                                                            <span style="color: ${confidenceColor}; font-weight: 600; font-size: 0.75em;">
                                                                ${(level.confidence || 'low').toUpperCase()}
                                                            </span>
                                                            ${level.ml_probability !== undefined && level.ml_probability !== null ? `
                                                                <span style="color: var(--text-tertiary); font-size: 0.7em;">
                                                                    ML: ${level.ml_probability}% prob.
                                                                </span>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Visual Chart with Entry/TP/DCA Levels -->
                            ${data.chart_data && data.chart_data.dates && data.chart_data.dates.length > 0 ? `
                                <div class="card" style="margin-top: 20px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                                    <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">ðŸ“ˆ Price Chart with Strategy Levels</h4>
                                    <div style="position: relative; height: 400px;">
                                        <canvas id="tradingStrategyChart-${ticker || data.ticker || 'default'}"></canvas>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Position Sizing Calculator -->
                    ${data.position_sizing ? `
                        <div style="margin-top: 30px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                                    ðŸ’¼ Position Sizing Calculator
                                </h3>
                                <button onclick="toggleExplanation('positionSizingExplanation')" style="background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea; color: #667eea; padding: 4px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">â„¹ï¸ What is this?</button>
                            </div>
                            <div id="positionSizingExplanation" style="display: none; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #667eea;">
                                <p style="margin: 0; color: var(--text-primary); line-height: 1.6; font-size: 0.9em;">
                                    <strong>Position Sizing:</strong> DynamickÃ½ vÃ½poÄet optimÃ¡lnÃ­ velikosti pozice na zÃ¡kladÄ› risk score (vyÅ¡Å¡Ã­ riziko = menÅ¡Ã­ pozice), ML confidence (vyÅ¡Å¡Ã­ confidence = vÄ›tÅ¡Ã­ pozice), volatility (ATR-based) a risk/reward ratio. DoporuÄenÃ¡ pozice je vyjÃ¡dÅ™ena jako % portfolia s konzervativnÃ­m a agresivnÃ­m rozsahem.
                                </p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                <!-- Recommended Position -->
                                <div class="card" style="background: linear-gradient(135deg, ${(data.position_sizing?.size_color || '#667eea')}15 0%, ${(data.position_sizing?.size_color || '#667eea')}05 100%); border: 2px solid ${data.position_sizing?.size_color || '#667eea'}; padding: 20px; text-align: center;">
                                    <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">ðŸ“Š Recommended Position</h4>
                                    <div style="font-size: 3em; font-weight: 800; color: ${data.position_sizing?.size_color || '#667eea'}; margin-bottom: 10px;">
                                        ${(data.position_sizing?.recommended_pct !== undefined && data.position_sizing?.recommended_pct !== null) ? data.position_sizing.recommended_pct : 'N/A'}%
                                    </div>
                                    <div style="font-size: 1.2em; font-weight: 600; color: ${data.position_sizing?.size_color || '#667eea'}; margin-bottom: 5px;">
                                        ${data.position_sizing?.size_category || 'N/A'}
                                    </div>
                                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 10px;">
                                        of portfolio
                                    </div>
                                </div>
                                
                                <!-- Position Range -->
                                <div class="card" style="background: var(--bg-card); border: 2px solid var(--border-color); padding: 20px;">
                                    <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">ðŸ“ˆ Position Range</h4>
                                    <div style="display: flex; flex-direction: column; gap: 12px;">
                                        <div style="padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Conservative</div>
                                            <div style="font-size: 1.5em; font-weight: 700; color: #ef4444;">
                                                ${(data.position_sizing?.range?.conservative !== undefined && data.position_sizing?.range?.conservative !== null) ? data.position_sizing.range.conservative : 'N/A'}%
                                            </div>
                                        </div>
                                        <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
                                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Aggressive</div>
                                            <div style="font-size: 1.5em; font-weight: 700; color: #10b981;">
                                                ${(data.position_sizing?.range?.aggressive !== undefined && data.position_sizing?.range?.aggressive !== null) ? data.position_sizing.range.aggressive : 'N/A'}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Factors -->
                                <div class="card" style="background: var(--bg-card); border: 2px solid var(--border-color); padding: 20px;">
                                    <h4 style="margin: 0 0 15px 0; color: var(--text-primary);">ðŸ” Key Factors</h4>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 6px;">
                                            <span style="color: var(--text-primary); font-size: 0.9em;">Risk Score</span>
                                            <span style="color: ${(data.position_sizing?.risk_score !== undefined && data.position_sizing?.risk_score !== null && data.position_sizing.risk_score < 30) ? '#10b981' : (data.position_sizing?.risk_score !== undefined && data.position_sizing?.risk_score !== null && data.position_sizing.risk_score < 50) ? '#fbbf24' : '#ef4444'}; font-weight: 600;">${(data.position_sizing?.risk_score !== undefined && data.position_sizing?.risk_score !== null) ? data.position_sizing.risk_score : 'N/A'}/100</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 6px;">
                                            <span style="color: var(--text-primary); font-size: 0.9em;">ML Confidence</span>
                                            <span style="color: ${(data.position_sizing?.ml_confidence !== undefined && data.position_sizing?.ml_confidence !== null && data.position_sizing.ml_confidence >= 70) ? '#10b981' : (data.position_sizing?.ml_confidence !== undefined && data.position_sizing?.ml_confidence !== null && data.position_sizing.ml_confidence >= 50) ? '#fbbf24' : '#ef4444'}; font-weight: 600;">${(data.position_sizing?.ml_confidence !== undefined && data.position_sizing?.ml_confidence !== null) ? data.position_sizing.ml_confidence : 'N/A'}%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 6px;">
                                            <span style="color: var(--text-primary); font-size: 0.9em;">Volatility (ATR)</span>
                                            <span style="color: var(--text-primary); font-weight: 600;">${(data.position_sizing?.volatility_pct !== undefined && data.position_sizing?.volatility_pct !== null) ? data.position_sizing.volatility_pct : 'N/A'}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Reasoning -->
                            <div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border-left: 3px solid #667eea;">
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">ðŸ’¡ Reasoning</div>
                                <p style="margin: 0; color: var(--text-primary); line-height: 1.6; font-size: 0.9em;">
                                    ${data.position_sizing?.reasoning || 'Position sizing based on risk analysis and ML confidence.'}
                                </p>
                            </div>
                            
                            ${data.position_sizing?.confidence_factors && data.position_sizing.confidence_factors.length > 0 ? `
                                <div style="margin-top: 15px; padding: 15px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border-left: 3px solid #10b981;">
                                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">âœ… Confidence Factors</div>
                                    <ul style="margin: 0; padding-left: 20px; color: var(--text-primary); line-height: 1.8; font-size: 0.9em;">
                                        ${data.position_sizing.confidence_factors.map(factor => `<li>${factor}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${data.position_sizing?.adjustments ? `
                                <div style="margin-top: 15px; padding: 12px; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                                    <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">âš™ï¸ Adjustment Factors</div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 0.85em;">
                                        <div>
                                            <span style="color: var(--text-secondary);">Risk:</span>
                                            <span style="color: var(--text-primary); font-weight: 600; margin-left: 5px;">${(data.position_sizing.adjustments?.risk !== undefined && data.position_sizing.adjustments?.risk !== null) ? data.position_sizing.adjustments.risk : 'N/A'}x</span>
                                        </div>
                                        <div>
                                            <span style="color: var(--text-secondary);">Confidence:</span>
                                            <span style="color: var(--text-primary); font-weight: 600; margin-left: 5px;">${(data.position_sizing.adjustments?.confidence !== undefined && data.position_sizing.adjustments?.confidence !== null) ? data.position_sizing.adjustments.confidence : 'N/A'}x</span>
                                        </div>
                                        <div>
                                            <span style="color: var(--text-secondary);">Volatility:</span>
                                            <span style="color: var(--text-primary); font-weight: 600; margin-left: 5px;">${(data.position_sizing.adjustments?.volatility !== undefined && data.position_sizing.adjustments?.volatility !== null) ? data.position_sizing.adjustments.volatility : 'N/A'}x</span>
                                        </div>
                                        <div>
                                            <span style="color: var(--text-secondary);">R/R Ratio:</span>
                                            <span style="color: var(--text-primary); font-weight: 600; margin-left: 5px;">${(data.position_sizing.adjustments?.risk_reward !== undefined && data.position_sizing.adjustments?.risk_reward !== null) ? data.position_sizing.adjustments.risk_reward : 'N/A'}x</span>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Investment Thesis Section -->
                    <div style="margin-top: 30px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: var(--text-primary);">ðŸ“‹ Investment Thesis</h4>
                            <button onclick="loadInvestmentThesis('${ticker}')" id="investmentThesisBtn" class="ripple-effect" style="padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9em;">
                                ðŸ¤– Generate Thesis
                            </button>
                        </div>
                        <div id="investmentThesisContent" style="display: none;"></div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; border-left: 4px solid #667eea;">
                        <p style="font-size: 0.9em; color: var(--text-secondary); margin: 0;">
                            <strong>â„¹ï¸ Disclaimer:</strong> This AI recommendation is based on technical analysis and ML models. Predictions are not guaranteed and should not be considered as financial advice. Always conduct your own research and consult with a financial advisor before making investment decisions.
                        </p>
                    </div>
                </div>
            `;
            
            // Create trading strategy chart after DOM is updated
            if (data.trading_strategy && data.chart_data && data.chart_data.dates && data.chart_data.dates.length > 0) {
                setTimeout(() => {
                    createTradingStrategyChart(data.trading_strategy, data.chart_data, ticker || data.ticker);
                }, 100);
            }
        }
        
        function createTradingStrategyChart(strategy, chartData, ticker) {
            try {
                const canvasId = 'tradingStrategyChart-' + (ticker || 'default');
                const ctx = document.getElementById(canvasId);
                if (!ctx || typeof Chart === 'undefined') return;
                
                // Get last 60 days for better visibility
                const daysToShow = 60;
                const startIdx = Math.max(0, chartData.dates.length - daysToShow);
                const labels = chartData.dates.slice(startIdx);
                const prices = chartData.close.slice(startIdx);
                
                const isDark = document.body.classList.contains('dark-mode');
                const chartTextColor = isDark ? '#f5f5f5' : '#333';
                
                // Create annotations for Entry, TP, DCA
                // chartjs-plugin-annotation v3.x uses object with keys, not array
                const annotations = {};
                let annotationId = 0;
                
                // Entry point line
                if (strategy.entry && strategy.entry.price) {
                    annotations['entryLine'] = {
                        type: 'line',
                        yMin: strategy.entry.price,
                        yMax: strategy.entry.price,
                        borderColor: '#667eea',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        label: {
                            display: true,
                            content: 'Entry: $' + strategy.entry.price.toFixed(2),
                            position: 'end',
                            backgroundColor: '#667eea',
                            color: '#fff',
                            font: { size: 11, weight: '600' }
                        }
                    };
                }
                
                // TP lines
                if (strategy.take_profit) {
                    const tpColors = { tp1: '#10b981', tp2: '#34d399', tp3: '#6ee7b7' };
                    const tpLabels = { tp1: 'TP1', tp2: 'TP2', tp3: 'TP3' };
                    
                    ['tp1', 'tp2', 'tp3'].forEach(tpKey => {
                        const tp = strategy.take_profit[tpKey];
                        if (tp && tp.price) {
                            annotations['tp' + tpKey] = {
                                type: 'line',
                                yMin: tp.price,
                                yMax: tp.price,
                                borderColor: tpColors[tpKey],
                                borderWidth: 2,
                                label: {
                                    display: true,
                                    content: tpLabels[tpKey] + ': $' + tp.price.toFixed(2) + ' (+' + tp.gain_pct.toFixed(1) + '%)',
                                    position: 'end',
                                    backgroundColor: tpColors[tpKey],
                                    color: '#fff',
                                    font: { size: 11, weight: '600' }
                                }
                            };
                        }
                    });
                }
                
                // DCA lines
                if (strategy.dca_levels && strategy.dca_levels.length > 0) {
                    strategy.dca_levels.forEach((level, idx) => {
                        annotations['dca' + idx] = {
                            type: 'line',
                            yMin: level.price,
                            yMax: level.price,
                            borderColor: '#f59e0b',
                            borderWidth: 1.5,
                            borderDash: [3, 3],
                            label: {
                                display: true,
                                content: 'DCA ' + (idx + 1) + ': $' + level.price.toFixed(2),
                                position: 'start',
                                backgroundColor: '#f59e0b',
                                color: '#fff',
                                font: { size: 10, weight: '500' }
                            }
                        };
                    });
                }
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Price',
                            data: prices,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            annotation: {
                                annotations: annotations
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                backgroundColor: isDark ? 'rgba(30, 30, 30, 0.98)' : 'rgba(255, 255, 255, 0.98)',
                                titleColor: chartTextColor,
                                bodyColor: chartTextColor
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    color: chartTextColor,
                                    callback: function(value) {
                                        return '$' + value.toFixed(2);
                                    }
                                },
                                grid: {
                                    color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: chartTextColor,
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {
                                    color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating trading strategy chart:', error);
                console.error('Error creating trading strategy chart:', error);
            }
        }

        async function loadInvestmentThesis(ticker) {
            const button = document.getElementById('investmentThesisBtn');
            const container = document.getElementById('investmentThesisContent');
            
            if (!ticker) {
                showToast('Ticker symbol required', 'error');
                return;
            }
            
            if (!container) {
                showToast('Investment thesis container not found', 'error');
                return;
            }
            
            // Show loading state
            if (button) {
                button.disabled = true;
                const originalText = button.innerHTML;
                button.innerHTML = 'â³ Generating...';
                
                container.style.display = 'block';
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: var(--metric-bg); border-radius: 12px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 20px; color: var(--text-secondary);">Generating investment thesis...</p>
                        <p style="font-size: 0.85em; color: var(--text-tertiary); margin-top: 10px;">This may take 60-90 seconds</p>
                    </div>
                `;
                
                try {
                    const result = await fetchJSON(`/api/ai-investment-thesis/${ticker}`, {}, container);
                    
                    if (!result.success) {
                        return; // Error already displayed by fetchJSON
                    }
                    
                    // Display results
                    displayInvestmentThesis(result.data);
                    showToast('Investment thesis generated successfully', 'success');
                } catch (error) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ef4444;">
                            <div style="color: #ef4444; font-weight: 600; margin-bottom: 10px;">âŒ Error</div>
                            <div style="color: var(--text-secondary);">${error.message}</div>
                            <button onclick="loadInvestmentThesis('${ticker}')" style="margin-top: 15px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
                        </div>
                    `;
                    showToast('Error generating investment thesis', 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }
        }

        function displayInvestmentThesis(data) {
            const container = document.getElementById('investmentThesisContent');
            if (!container) return;
            
            const structured = data.structured_data || {};
            
            // Helper function to escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Color coding for recommendation
            const recommendationColors = {
                'BUY': { bg: 'rgba(16, 185, 129, 0.1)', border: '#10b981', emoji: 'ðŸŸ¢' },
                'SELL': { bg: 'rgba(239, 68, 68, 0.1)', border: '#ef4444', emoji: 'ðŸ”´' },
                'HOLD': { bg: 'rgba(245, 158, 11, 0.1)', border: '#f59e0b', emoji: 'ðŸŸ¡' }
            };
            
            const recommendationLabels = {
                'BUY': 'Buy',
                'SELL': 'Sell',
                'HOLD': 'Hold'
            };
            
            const recommendation = structured.recommendation || 'HOLD';
            const colors = recommendationColors[recommendation] || recommendationColors['HOLD'];
            
            let html = `
                <div style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                    ${structured.executive_summary ? `
                        <div style="margin-bottom: 25px; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ“‹ Executive Summary</h5>
                            <p style="color: var(--text-primary); line-height: 1.7; margin: 0; white-space: pre-wrap;">${escapeHtml(structured.executive_summary)}</p>
                        </div>
                    ` : ''}
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        ${structured.bull_case && structured.bull_case.length > 0 ? `
                            <div style="padding: 20px; background: rgba(16, 185, 129, 0.05); border-radius: 10px; border-left: 4px solid #10b981;">
                                <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">ðŸŸ¢ Bull Case</h5>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${structured.bull_case.map(point => `
                                        <li style="padding: 10px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                            <span style="position: absolute; left: 0; color: #10b981;">âœ“</span>${escapeHtml(point)}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${structured.bear_case && structured.bear_case.length > 0 ? `
                            <div style="padding: 20px; background: rgba(239, 68, 68, 0.05); border-radius: 10px; border-left: 4px solid #ef4444;">
                                <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ”´ Bear Case</h5>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${structured.bear_case.map(point => `
                                        <li style="padding: 10px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                            <span style="position: absolute; left: 0; color: #ef4444;">âš </span>${escapeHtml(point)}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${structured.key_risks && structured.key_risks.length > 0 ? `
                        <div style="margin-bottom: 25px; padding: 20px; background: rgba(245, 158, 11, 0.05); border-radius: 10px; border-left: 4px solid #f59e0b;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">âš ï¸ Key Risks</h5>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${structured.key_risks.map(risk => `
                                    <li style="padding: 10px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                        <span style="position: absolute; left: 0; color: #f59e0b;">âš </span>${escapeHtml(risk)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${structured.recommendation ? `
                        <div style="margin-bottom: 25px; padding: 20px; background: ${colors.bg}; border-radius: 10px; border-left: 4px solid ${colors.border};">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1.1em;">
                                ${colors.emoji} Investment Recommendation: ${recommendationLabels[recommendation]}
                            </h5>
                            ${structured.recommendation_explanation ? `
                                <p style="color: var(--text-primary); margin: 0; line-height: 1.7; white-space: pre-wrap;">${escapeHtml(structured.recommendation_explanation)}</p>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${structured.thesis_summary ? `
                        <div style="margin-top: 25px; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ“ Investment Thesis Summary</h5>
                            <p style="color: var(--text-primary); line-height: 1.7; margin: 0; white-space: pre-wrap;">${escapeHtml(structured.thesis_summary)}</p>
                        </div>
                    ` : ''}
                    
                    ${data.thesis ? `
                        <div style="margin-top: 25px; padding: 20px; background: var(--metric-bg); border-radius: 10px;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ“„ Full Investment Thesis</h5>
                            <div style="color: var(--text-primary); line-height: 1.8; white-space: pre-wrap;">${escapeHtml(data.thesis)}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Initialize data timestamps tracking
        if (!window.dataTimestamps) {
            window.dataTimestamps = {};
        }
        
        // Universal function to track data timestamp for any URL/endpoint
        function trackDataTimestamp(url, timestamp = null) {
            if (!window.dataTimestamps) {
                window.dataTimestamps = {};
            }
            window.dataTimestamps[url] = timestamp || Date.now();
        }
        
        // Universal function to get data freshness for a URL
        function getDataFreshness(url) {
            if (!window.dataTimestamps || !window.dataTimestamps[url]) {
                return null;
            }
            const timestamp = window.dataTimestamps[url];
            const diffMs = Date.now() - timestamp;
            const diffMinutes = Math.floor(diffMs / 60000);
            return { timestamp, diffMinutes, isFresh: diffMinutes < 15 };
        }

        // Data Freshness Functions
        function updateDataFreshnessIndicator(timestamp, containerId = null) {
            // Use default indicator if no containerId provided (for Stock Analysis section)
            const indicator = containerId ? 
                document.getElementById(`${containerId}_freshnessIndicator`) : 
                document.getElementById('dataFreshnessIndicator');
            const lastUpdatedEl = containerId ? 
                document.getElementById(`${containerId}_lastUpdated`) : 
                document.getElementById('dataLastUpdated');
            const refreshBtn = containerId ? 
                indicator?.querySelector('button') : 
                document.getElementById('refreshDataBtn');
            
            if (!indicator || !lastUpdatedEl) {
                // If indicator doesn't exist and containerId is provided, create it
                if (containerId) {
                    const container = document.getElementById(containerId);
                    if (container) {
                        const freshnessHtml = `
                            <div id="${containerId}_freshnessIndicator" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding: 8px 12px; background: var(--metric-bg); border-radius: 8px; font-size: 0.85em; border-left: 3px solid #10b981;">
                                <span id="${containerId}_lastUpdated" style="color: var(--text-secondary);"></span>
                                <button onclick="refreshSectionData('${containerId}')" style="padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600;">ðŸ”„ Refresh</button>
                            </div>
                        `;
                        container.insertAdjacentHTML('afterbegin', freshnessHtml);
                        // Recursively call with newly created elements
                        return updateDataFreshnessIndicator(timestamp, containerId);
                    }
                }
                return;
            }
            
            if (!timestamp) {
                indicator.style.display = 'none';
                return;
            }
            
            indicator.style.display = 'flex';
            
            const now = new Date();
            const lastUpdated = typeof timestamp === 'string' ? new Date(timestamp) : new Date(timestamp);
            const diffMs = now - lastUpdated;
            const diffMinutes = Math.floor(diffMs / 60000);
            const diffSeconds = Math.floor((diffMs % 60000) / 1000);
            
            let timeText = '';
            let status = 'fresh';
            let statusColor = '#10b981'; // Green for fresh
            
            if (diffMinutes < 1) {
                timeText = `Updated ${diffSeconds} second${diffSeconds !== 1 ? 's' : ''} ago`;
                status = 'fresh';
                statusColor = '#10b981';
            } else if (diffMinutes < 5) {
                timeText = `Updated ${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''} ago`;
                status = 'fresh';
                statusColor = '#10b981';
            } else if (diffMinutes < 15) {
                timeText = `Updated ${diffMinutes} minutes ago`;
                status = 'stale';
                statusColor = '#f59e0b'; // Yellow for stale
            } else {
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 1) {
                    timeText = `Updated ${diffMinutes} minutes ago`;
                } else if (diffHours < 24) {
                    timeText = `Updated ${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                } else {
                    const diffDays = Math.floor(diffHours / 24);
                    timeText = `Updated ${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
                }
                status = 'very-stale';
                statusColor = '#ef4444'; // Red for very stale
            }
            
            lastUpdatedEl.textContent = timeText;
            lastUpdatedEl.style.color = statusColor;
            
            // Update indicator styling based on status
            if (containerId) {
                indicator.style.borderLeft = `3px solid ${statusColor}`;
            } else {
            indicator.className = `data-freshness-indicator ${status}`;
            }
            
            // Show refresh button if data is older than 15 minutes
            if (refreshBtn) {
                if (diffMinutes >= 15) {
                    refreshBtn.style.display = 'inline-block';
                    if (containerId) {
                        refreshBtn.style.display = 'inline-block';
                } else {
                        refreshBtn.style.display = 'inline-block';
                        refreshBtn.classList.add('stale');
                    }
                } else if (diffMinutes >= 5) {
                    refreshBtn.style.display = 'inline-block';
                    if (!containerId) {
                    refreshBtn.classList.remove('stale');
                }
            } else {
                refreshBtn.style.display = 'none';
                    if (!containerId) {
                refreshBtn.classList.remove('stale');
            }
                }
            }
            
            // Update every minute for default indicator (Stock Analysis)
            if (!containerId && diffMinutes < 60) {
                if (window.freshnessUpdateInterval) {
                    clearInterval(window.freshnessUpdateInterval);
                }
                window.freshnessUpdateInterval = setTimeout(() => {
                    if (currentData && currentData.lastUpdated) {
                        updateDataFreshnessIndicator(currentData.lastUpdated);
                    }
                }, 60000);
            }
        }
        
        // Helper function to refresh section data (can be overridden per section)
        function refreshSectionData(containerId) {
            // Map container IDs to their refresh functions
            const refreshFunctions = {
                'financialsContent': () => {
                    const ticker = document.getElementById('financialsTickerInput')?.value?.trim().toUpperCase();
                    if (ticker) {
                        loadFinancials();
                    }
                },
                'portfolioTableContainer': () => calculatePortfolio(false),
                'portfolioPerformanceContainer': () => calculatePortfolio(true),
                'aiRecommendationsContent': loadAIRecommendations,
                'backtestContent': loadBacktest,
                // Add more mappings as needed
            };
            
            const refreshFn = refreshFunctions[containerId];
            if (refreshFn && typeof refreshFn === 'function') {
                refreshFn();
            } else {
                // Default: reload page
                console.warn(`No refresh function found for container: ${containerId}`);
            }
        }

        function refreshCurrentStock(event) {
            if (event) {
                addRippleEffect(event);
            }
            
            if (!currentData || !currentData.ticker) {
                showError('No stock data available to refresh');
                return;
            }
            
            const ticker = currentData.ticker;
            const refreshBtn = document.getElementById('refreshDataBtn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = 'ðŸ”„ Refreshing...';
            }
            
            searchStock();
        }

        // Show welcome section on page load (only if no other section is active)
        window.addEventListener('load', function() {
            // Only show welcome section if no other section is currently active
            const activeSection = document.querySelector('.nav-item.active');
            if (!activeSection || activeSection.getAttribute('data-section') === 'welcomeSection') {
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.classList.remove('hidden');
                }
            }
            
            // Load price alerts
            loadPriceAlerts();
            displayPriceAlerts();
            
            // Start checking alerts every 30 seconds
            startAlertChecker();
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });

        // Watchlist Functions
        function getWatchlist() {
            const stored = localStorage.getItem('stockWatchlist');
            if (!stored) {
                // Return new format by default
                return { groups: { "Uncategorized": [] }, order: ["Uncategorized"] };
            }
            const parsed = JSON.parse(stored);
            // Migration: if it's an array (old format), convert to new format
            if (Array.isArray(parsed)) {
                return { groups: { "Uncategorized": parsed }, order: ["Uncategorized"] };
            }
            return parsed;
        }

        function saveWatchlist(watchlist) {
            localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
        }

        function getAllTickers() {
            const watchlist = getWatchlist();
            // If old format (array), return it
            if (Array.isArray(watchlist)) {
                return watchlist;
            }
            // New format: collect all tickers from all groups
            const allTickers = [];
            if (watchlist.groups) {
                for (const groupName in watchlist.groups) {
                    if (Array.isArray(watchlist.groups[groupName])) {
                        allTickers.push(...watchlist.groups[groupName]);
                    }
                }
            }
            return allTickers;
        }

        function getTickerGroup(ticker) {
            const watchlist = getWatchlist();
            if (Array.isArray(watchlist)) {
                // Old format - ticker is in "Uncategorized" if it exists
                return watchlist.includes(ticker) ? "Uncategorized" : null;
            }
            // New format - find which group contains the ticker
            if (watchlist.groups) {
                for (const groupName in watchlist.groups) {
                    if (Array.isArray(watchlist.groups[groupName]) && watchlist.groups[groupName].includes(ticker)) {
                        return groupName;
                    }
                }
            }
            return null;
        }

        function addToWatchlist(event, groupName = null) {
            if (event) {
                addRippleEffect(event);
            }
            
            const input = document.getElementById('watchlistTickerInput');
            const ticker = input.value.trim().toUpperCase();
            
            if (!ticker) {
                showError('Please enter a ticker symbol');
                return;
            }

            let watchlist = getWatchlist();
            const existingGroup = getTickerGroup(ticker);
            
            // Determine which group to add to
            if (!groupName) {
                groupName = "Uncategorized";
            }
            
            if (existingGroup) {
                // Ticker already exists in a group
                if (existingGroup === groupName) {
                    showToast(`${ticker} is already in ${groupName}`, 'info');
                    return;
                } else {
                    // Move ticker to new group
                    moveTickerToGroup(ticker, existingGroup, groupName);
                    input.value = '';
                    loadWatchlistFromStorage();
                    updateWatchlistSidebar();
                    showToast(`${ticker} moved from ${existingGroup} to ${groupName}`, 'success');
                    return;
                }
            }
            
            // Ticker doesn't exist - add it
            // Create group if it doesn't exist
            if (!watchlist.groups[groupName]) {
                watchlist.groups[groupName] = [];
                if (!watchlist.order.includes(groupName)) {
                    watchlist.order.push(groupName);
                }
            }
            
            watchlist.groups[groupName].push(ticker);
            saveWatchlist(watchlist);
            input.value = '';
            // Add to recent searches
            if (typeof addToRecentSearches === 'function') {
                addToRecentSearches(ticker, ticker);
            }
            loadWatchlistFromStorage();
            updateWatchlistSidebar();
            
            // Show success indicator
            showToast(`${ticker} added to watchlist${groupName !== "Uncategorized" ? ` (${groupName})` : ''}`, 'success');
        }

        function addToWatchlistQuick(event) {
            try {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    addRippleEffect(event);
                }
                
                const input = document.getElementById('watchlistQuickAdd');
                if (!input) {
                    console.error('watchlistQuickAdd input not found');
                    showToast('Input field not found', 'error');
                    return;
                }
                
                const ticker = input.value.trim().toUpperCase();
                
                if (!ticker) {
                    showToast('Please enter a ticker symbol', 'info');
                    return;
                }

                let watchlist = getWatchlist();
                const existingGroup = getTickerGroup(ticker);
                
                if (existingGroup) {
                    // Ticker already exists
                    showToast(`${ticker} is already in ${existingGroup}`, 'info');
                    return;
                }
                
                // Add to "Uncategorized" by default
                if (!watchlist.groups["Uncategorized"]) {
                    watchlist.groups["Uncategorized"] = [];
                    if (!watchlist.order.includes("Uncategorized")) {
                        watchlist.order.push("Uncategorized");
                    }
                }
                watchlist.groups["Uncategorized"].push(ticker);
                saveWatchlist(watchlist);
                input.value = '';
                // Add to recent searches
                if (typeof addToRecentSearches === 'function') {
                    addToRecentSearches(ticker, ticker);
                }
                updateWatchlistSidebar();
                // Load data for the new ticker (if function exists)
                if (typeof loadWatchlistItemData === 'function') {
                    loadWatchlistItemData(ticker);
                }
                
                // Show success indicator
                showToast(`${ticker} added to watchlist`, 'success');
            } catch (error) {
                console.error('Error in addToWatchlistQuick:', error);
                showToast('Error adding to watchlist: ' + error.message, 'error');
            }
        }

        // News Alerts Functions
        function getNewsAlerts() {
            try {
                const stored = localStorage.getItem('newsAlerts');
                if (!stored) {
                    return [];
                }
                return JSON.parse(stored);
            } catch (error) {
                console.error('Error loading news alerts:', error);
                return [];
            }
        }

        function saveNewsAlerts(alerts) {
            try {
                localStorage.setItem('newsAlerts', JSON.stringify(alerts));
            } catch (error) {
                console.error('Error saving news alerts:', error);
            }
        }

        function addTickerToNewsAlerts(ticker) {
            if (!ticker) {
                showToast('Please enter a ticker symbol', 'info');
                return false;
            }

            ticker = ticker.trim().toUpperCase();
            
            if (!ticker || ticker.length === 0) {
                showToast('Invalid ticker symbol', 'error');
                return false;
            }

            const alerts = getNewsAlerts();
            
            // Check if already exists
            if (alerts.includes(ticker)) {
                showToast(`${ticker} is already in News Alerts`, 'info');
                return false;
            }

            alerts.push(ticker);
            saveNewsAlerts(alerts);
            showToast(`${ticker} added to News Alerts`, 'success');
            return true;
        }

        function removeTickerFromNewsAlerts(ticker) {
            const alerts = getNewsAlerts();
            const index = alerts.indexOf(ticker);
            if (index > -1) {
                alerts.splice(index, 1);
                saveNewsAlerts(alerts);
                showToast(`${ticker} removed from News Alerts`, 'success');
                return true;
            }
            return false;
        }

        function isTickerInNewsAlerts(ticker) {
            const alerts = getNewsAlerts();
            return alerts.includes(ticker.toUpperCase());
        }

        function addCurrentTickerToNewsAlerts() {
            const tickerInput = document.getElementById('tickerInput');
            let ticker = null;
            
            if (currentData && currentData.ticker) {
                ticker = currentData.ticker;
            } else if (tickerInput && tickerInput.value.trim()) {
                ticker = tickerInput.value.trim().toUpperCase();
            } else {
                showToast('Please load a stock first or enter a ticker', 'info');
                return;
            }

            if (addTickerToNewsAlerts(ticker)) {
                updateNewsAlertsButton();
            }
        }

        function addNewsTickerToNewsAlerts() {
            const tickerInput = document.getElementById('newsTickerInput');
            let ticker = null;
            
            if (currentNewsData && currentNewsData.ticker) {
                ticker = currentNewsData.ticker;
            } else if (tickerInput && tickerInput.value.trim()) {
                ticker = tickerInput.value.trim().toUpperCase();
            } else {
                showToast('Please load news first or enter a ticker', 'info');
                return;
            }

            if (addTickerToNewsAlerts(ticker)) {
                updateNewsAlertsButton();
            }
        }

        function updateNewsAlertsButton() {
            // Update button in Stock Analysis section
            const stockBtn = document.getElementById('addToNewsAlertsBtn');
            if (stockBtn && currentData && currentData.ticker) {
                const ticker = currentData.ticker;
                const isInAlerts = isTickerInNewsAlerts(ticker);
                if (isInAlerts) {
                    stockBtn.textContent = 'âœ“ In News Alerts';
                    stockBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    stockBtn.onclick = () => {
                        if (removeTickerFromNewsAlerts(ticker)) {
                            updateNewsAlertsButton();
                        }
                    };
                } else {
                    stockBtn.textContent = 'ðŸ“° Add to News Alerts';
                    stockBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    stockBtn.onclick = addCurrentTickerToNewsAlerts;
                }
                stockBtn.style.display = 'inline-block';
            } else if (stockBtn) {
                stockBtn.style.display = 'none';
            }

            // Update button in News section
            const newsBtn = document.getElementById('addNewsTickerToAlertsBtn');
            if (newsBtn && currentNewsData && currentNewsData.ticker) {
                const ticker = currentNewsData.ticker;
                const isInAlerts = isTickerInNewsAlerts(ticker);
                if (isInAlerts) {
                    newsBtn.textContent = 'âœ“ In News Alerts';
                    newsBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    newsBtn.onclick = () => {
                        if (removeTickerFromNewsAlerts(ticker)) {
                            updateNewsAlertsButton();
                        }
                    };
                } else {
                    newsBtn.textContent = 'ðŸ“° Add to News Alerts';
                    newsBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    newsBtn.onclick = addNewsTickerToNewsAlerts;
                }
                newsBtn.style.display = 'inline-block';
            } else if (newsBtn) {
                newsBtn.style.display = 'none';
            }
        }

        function addCurrentToWatchlist(event) {
            try {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    addRippleEffect(event);
                }
                
                // Try to get ticker from current data or input field
                let ticker = null;
                
                if (currentData && currentData.ticker) {
                    ticker = currentData.ticker;
                } else {
                    // Try to get from ticker input field
                    const tickerInput = document.getElementById('tickerInput');
                    if (tickerInput && tickerInput.value.trim()) {
                        ticker = tickerInput.value.trim().toUpperCase();
                    } else {
                        // Focus on quick add input instead
                        const quickAddInput = document.getElementById('watchlistQuickAdd');
                        if (quickAddInput) {
                            quickAddInput.focus();
                            showToast('Enter a ticker symbol in the input field below', 'info');
                        } else {
                            showError('No stock data available. Please enter a ticker symbol first.');
                        }
                        return;
                    }
                }

                if (!ticker) {
                    showError('No ticker symbol available to add');
                    return;
                }

                let watchlist = getWatchlist();
                const existingGroup = getTickerGroup(ticker);
                
                if (existingGroup) {
                    // Ticker already exists
                    showToast(`${ticker} is already in ${existingGroup}`, 'info');
                    return;
                }
                
                // Add to "Uncategorized" by default
                if (!watchlist.groups["Uncategorized"]) {
                    watchlist.groups["Uncategorized"] = [];
                    if (!watchlist.order.includes("Uncategorized")) {
                        watchlist.order.push("Uncategorized");
                    }
                }
                watchlist.groups["Uncategorized"].push(ticker);
                saveWatchlist(watchlist);
                updateWatchlistSidebar(ticker);
                showToast(`${ticker} added to watchlist`, 'success');
            } catch (error) {
                console.error('Error in addCurrentToWatchlist:', error);
                showToast('Error adding to watchlist', 'error');
            }
        }

        function removeFromWatchlist(ticker, event) {
            if (event) {
                event.stopPropagation();
                addRippleEffect(event);
            }
            
            let watchlist = getWatchlist();
            // Find and remove ticker from its group
            for (const groupName in watchlist.groups) {
                const index = watchlist.groups[groupName].indexOf(ticker);
                if (index > -1) {
                    watchlist.groups[groupName].splice(index, 1);
                    // Remove empty groups (except Uncategorized)
                    if (watchlist.groups[groupName].length === 0 && groupName !== "Uncategorized") {
                        delete watchlist.groups[groupName];
                        watchlist.order = watchlist.order.filter(g => g !== groupName);
                    }
                    break;
                }
            }
            saveWatchlist(watchlist);
            loadWatchlistFromStorage();
            updateWatchlistSidebar();
            showToast(`${ticker} removed from watchlist`, 'info');
        }

        let watchlistSearchFilter = '';
        let watchlistCollapsedGroups = new Set();

        function filterWatchlist() {
            const searchInput = document.getElementById('watchlistSearchInput');
            if (searchInput) {
                watchlistSearchFilter = searchInput.value.trim().toLowerCase();
                updateWatchlistSidebar();
            }
        }

        async function updateWatchlistSidebar(activeTicker = null) {
            const container = document.getElementById('watchlistSidebarContent');
            if (!container) {
                console.warn('watchlistSidebarContent container not found');
                return; // Watchlist sidebar might not be visible
            }
            
            const watchlist = getWatchlist();
            console.log('updateWatchlistSidebar - watchlist:', JSON.stringify(watchlist));
            
            if (!activeTicker && currentData) {
                activeTicker = currentData.ticker;
            }

            const allTickers = getAllTickers();
            if (allTickers.length === 0) {
                container.innerHTML = `
                    <div class="watchlist-empty">
                        <div class="watchlist-empty-icon">â­</div>
                        <p>Your watchlist is empty</p>
                        <p style="font-size: 0.85em; margin-top: 10px; opacity: 0.7;">Add stocks to track them here</p>
                    </div>
                `;
                return;
            }

            // Ensure watchlist is in new format
            if (Array.isArray(watchlist)) {
                // Convert old format to new format
                watchlist = { groups: { "Uncategorized": watchlist }, order: ["Uncategorized"] };
                saveWatchlist(watchlist);
            }
            
            // Ensure groups and order exist
            if (!watchlist.groups) {
                watchlist.groups = { "Uncategorized": [] };
            }
            if (!watchlist.order) {
                watchlist.order = Object.keys(watchlist.groups);
                if (!watchlist.order.includes("Uncategorized")) {
                    watchlist.order.unshift("Uncategorized");
                }
            }

            // Filter tickers based on search
            const filteredGroups = {};
            for (const groupName in watchlist.groups) {
                if (!Array.isArray(watchlist.groups[groupName])) continue;
                const filteredTickers = watchlist.groups[groupName].filter(ticker => {
                    if (!watchlistSearchFilter) return true;
                    return ticker.toLowerCase().includes(watchlistSearchFilter);
                });
                // Always include group, even if empty (for empty groups)
                filteredGroups[groupName] = filteredTickers;
            }

            // Load data for all filtered tickers
            const allFilteredTickers = [];
            for (const groupName in filteredGroups) {
                allFilteredTickers.push(...filteredGroups[groupName]);
            }

            const watchlistDataMap = {};
            await Promise.all(
                allFilteredTickers.map(async (ticker) => {
                    try {
                        const response = await fetch(`/api/stock/${ticker}?period=${currentTimeframe || '1y'}`);
                        if (response.ok) {
                            const data = await response.json();
                            watchlistDataMap[ticker] = {
                                ticker: ticker,
                                price: data.metrics.current_price,
                                change: data.metrics.price_change,
                                changePct: data.metrics.price_change_pct,
                                name: data.company_info.name || ticker
                            };
                        }
                    } catch (error) {
                        console.error(`Error loading data for ${ticker}:`, error);
                    }
                    if (!watchlistDataMap[ticker]) {
                        watchlistDataMap[ticker] = {
                            ticker: ticker,
                            price: null,
                            change: null,
                            changePct: null,
                            name: ticker
                        };
                    }
                })
            );

            let html = '';
            // Render groups in order
            if (!watchlist.order || watchlist.order.length === 0) {
                // If no order, use all groups
                watchlist.order = Object.keys(watchlist.groups);
            }
            
            for (const groupName of watchlist.order) {
                // Skip if group doesn't exist in groups
                if (!watchlist.groups || !watchlist.groups[groupName]) {
                    continue;
                }
                
                // Show group even if empty (for empty groups)
                const groupTickers = filteredGroups[groupName] || [];
                const isCollapsed = watchlistCollapsedGroups.has(groupName);
                
                html += `
                    <div class="watchlist-group">
                        <div class="watchlist-group-header" onclick="toggleWatchlistGroup('${groupName}')">
                            <div class="watchlist-group-title">
                                <span>${isCollapsed ? 'â–¶' : 'â–¼'}</span>
                                <span>${groupName === "Uncategorized" ? "ðŸ“‹ Uncategorized" : `ðŸ“ ${groupName}`}</span>
                                <span style="font-size: 0.8em; opacity: 0.7; margin-left: 8px;">(${groupTickers.length})</span>
                            </div>
                            <div class="watchlist-group-actions" onclick="event.stopPropagation();">
                                ${groupName !== "Uncategorized" ? `
                                    <button onclick="editWatchlistGroup('${groupName}', event)" style="padding: 4px 8px; background: rgba(102, 126, 234, 0.1); color: #667eea; border: 1px solid #667eea; border-radius: 4px; font-size: 0.75em; cursor: pointer;" title="Edit group">âœï¸</button>
                                    <button onclick="deleteWatchlistGroup('${groupName}', event)" style="padding: 4px 8px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; border-radius: 4px; font-size: 0.75em; cursor: pointer;" title="Delete group">ðŸ—‘ï¸</button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="watchlist-group-items" 
                             style="display: ${isCollapsed ? 'none' : 'flex'}; min-height: 20px;"
                             ondragover="handleWatchlistGroupDragOver(event, '${groupName}')"
                             ondrop="handleWatchlistGroupDrop(event, '${groupName}')"
                             ondragleave="event.currentTarget.classList.remove('drag-over');">
                `;

                for (const ticker of groupTickers) {
                    const item = watchlistDataMap[ticker];
                    if (!item) continue;
                    
                    const isActive = item.ticker === activeTicker;
                    const changeClass = item.change !== null ? (item.change >= 0 ? 'positive' : 'negative') : '';
                    const changeSign = item.change !== null && item.change >= 0 ? '+' : '';
                    
                    const favoriteIcon = isFavorite(item.ticker) ? 'â­' : '';
                    html += `
                        <div class="watchlist-item ${isActive ? 'active' : ''}" 
                             draggable="true"
                             ondragstart="handleWatchlistDragStart(event, '${item.ticker}', '${groupName}')"
                             ondragover="handleWatchlistDragOver(event)"
                             ondrop="handleWatchlistDrop(event, '${item.ticker}', '${groupName}')"
                             ondragend="handleWatchlistDragEnd(event)"
                             ondragleave="event.currentTarget.classList.remove('drag-over');"
                             style="cursor: pointer;">
                            <span class="watchlist-item-drag-handle" style="cursor: grab;" draggable="false" onmousedown="event.stopPropagation();">â˜°</span>
                            <div class="watchlist-item-info" style="flex: 1; cursor: pointer; margin-left: 20px;" onclick="if(!event.target.closest('.watchlist-item-drag-handle')) loadWatchlistStock('${item.ticker}')">
                                <div class="watchlist-item-ticker">${item.ticker} ${favoriteIcon}</div>
                                <div class="watchlist-item-price">${item.name}</div>
                            </div>
                            <div class="watchlist-item-actions" onclick="event.stopPropagation();">
                                <button class="favorite-btn" onclick="toggleFavorite('${item.ticker}', event)" style="font-size: 1em; padding: 4px 8px;" title="${isFavorite(item.ticker) ? 'Remove from favorites' : 'Add to favorites'}">
                                    ${isFavorite(item.ticker) ? 'â­' : 'â˜†'}
                                </button>
                                ${item.price !== null ? `
                                    <div class="watchlist-item-change ${changeClass}">
                                        $${item.price.toFixed(2)}<br>
                                        <small>${changeSign}${item.changePct !== null ? item.changePct.toFixed(2) : '0.00'}%</small>
                                    </div>
                                ` : '<div class="watchlist-item-change">-</div>'}
                                <button class="watchlist-remove-btn ripple-effect" onclick="removeFromWatchlist('${item.ticker}', event)" title="Remove">Ã—</button>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            if (html === '') {
                html = `
                    <div class="watchlist-empty">
                        <div class="watchlist-empty-icon">ðŸ”</div>
                        <p>No tickers match your search</p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function toggleWatchlistGroup(groupName) {
            if (watchlistCollapsedGroups.has(groupName)) {
                watchlistCollapsedGroups.delete(groupName);
            } else {
                watchlistCollapsedGroups.add(groupName);
            }
            updateWatchlistSidebar();
        }

        // Drag & Drop handlers
        let draggedTicker = null;
        let draggedFromGroup = null;

        function handleWatchlistDragStart(event, ticker, groupName) {
            draggedTicker = ticker;
            draggedFromGroup = groupName;
            event.currentTarget.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', ticker); // Required for some browsers
        }

        function handleWatchlistDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.dataTransfer.dropEffect = 'move';
            const target = event.currentTarget;
            if (target) {
                target.classList.add('drag-over');
            }
        }

        function handleWatchlistDrop(event, targetTicker, targetGroup) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedTicker || draggedTicker === targetTicker) return;
            
            // Move ticker within same group (reorder)
            if (draggedFromGroup === targetGroup) {
                const watchlist = getWatchlist();
                const group = watchlist.groups[targetGroup];
                const fromIndex = group.indexOf(draggedTicker);
                const toIndex = group.indexOf(targetTicker);
                
                if (fromIndex !== -1 && toIndex !== -1) {
                    group.splice(fromIndex, 1);
                    group.splice(toIndex, 0, draggedTicker);
                    saveWatchlist(watchlist);
                    updateWatchlistSidebar();
                }
            } else {
                // Move ticker to different group
                moveTickerToGroup(draggedTicker, draggedFromGroup, targetGroup);
            }
        }

        function handleWatchlistDragEnd(event) {
            if (event.currentTarget) {
                event.currentTarget.classList.remove('dragging');
            }
            document.querySelectorAll('.watchlist-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            document.querySelectorAll('.watchlist-group-items').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedTicker = null;
            draggedFromGroup = null;
        }

        function handleWatchlistGroupDragOver(event, groupName) {
            event.preventDefault();
            event.stopPropagation();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function handleWatchlistGroupDrop(event, targetGroup) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedTicker || !draggedFromGroup) return;
            
            // Move ticker to this group
            if (draggedFromGroup !== targetGroup) {
                moveTickerToGroup(draggedTicker, draggedFromGroup, targetGroup);
            }
        }

        function moveTickerToGroup(ticker, fromGroup, toGroup) {
            const watchlist = getWatchlist();
            
            // Remove from old group
            const fromIndex = watchlist.groups[fromGroup].indexOf(ticker);
            if (fromIndex > -1) {
                watchlist.groups[fromGroup].splice(fromIndex, 1);
                // Remove empty groups (except Uncategorized)
                if (watchlist.groups[fromGroup].length === 0 && fromGroup !== "Uncategorized") {
                    delete watchlist.groups[fromGroup];
                    watchlist.order = watchlist.order.filter(g => g !== fromGroup);
                }
            }
            
            // Add to new group
            if (!watchlist.groups[toGroup]) {
                watchlist.groups[toGroup] = [];
                if (!watchlist.order.includes(toGroup)) {
                    watchlist.order.push(toGroup);
                }
            }
            watchlist.groups[toGroup].push(ticker);
            
            saveWatchlist(watchlist);
            updateWatchlistSidebar();
            showToast(`${ticker} moved to ${toGroup}`, 'success');
        }

        // Group management functions
        function showWatchlistGroupManager(event) {
            try {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    addRippleEffect(event);
                }
                
                const watchlist = getWatchlist();
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'watchlistGroupManagerModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeWatchlistGroupManager();
                }
            };
            
            let html = `
                <div style="background: var(--bg-card); border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3 style="margin: 0; color: var(--text-primary);">ðŸ“ Manage Groups</h3>
                        <button onclick="closeWatchlistGroupManager()" style="background: transparent; border: none; font-size: 1.5em; color: var(--text-secondary); cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">Ã—</button>
                    </div>
                    <div style="margin-bottom: 25px;">
                        <input type="text" id="newGroupName" placeholder="New group name..." onkeypress="if(event.key==='Enter') createWatchlistGroup()" style="width: 100%; padding: 12px; border: 2px solid var(--input-border); border-radius: 8px; margin-bottom: 10px; background: var(--input-bg); color: var(--text-primary); font-size: 1em;" />
                        <button onclick="createWatchlistGroup()" class="ripple-effect" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">Create Group</button>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 15px; color: var(--text-primary);">Existing Groups:</h4>
            `;
            
            const hasGroups = watchlist.order.some(g => g !== "Uncategorized");
            if (!hasGroups) {
                html += `<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No custom groups yet. Create one above!</p>`;
            } else {
                for (const groupName of watchlist.order) {
                    if (groupName === "Uncategorized") continue;
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--metric-bg); border-radius: 8px; margin-bottom: 8px;">
                            <span style="color: var(--text-primary);">ðŸ“ ${groupName} <span style="opacity: 0.7;">(${watchlist.groups[groupName].length} ticker${watchlist.groups[groupName].length !== 1 ? 's' : ''})</span></span>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="editWatchlistGroup('${groupName}', event)" class="ripple-effect" style="padding: 6px 12px; background: rgba(102, 126, 234, 0.1); color: #667eea; border: 1px solid #667eea; border-radius: 4px; cursor: pointer; font-size: 0.85em;" title="Edit group name">âœï¸ Edit</button>
                                <button onclick="deleteWatchlistGroup('${groupName}', event)" class="ripple-effect" style="padding: 6px 12px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; border-radius: 4px; cursor: pointer; font-size: 0.85em;" title="Delete group">ðŸ—‘ï¸ Delete</button>
                            </div>
                        </div>
                    `;
                }
            }
            
            html += `
                    </div>
                </div>
            `;
            
            modal.innerHTML = html;
            document.body.appendChild(modal);
            
                // Focus on input
                setTimeout(() => {
                    const input = document.getElementById('newGroupName');
                    if (input) input.focus();
                }, 100);
            } catch (error) {
                console.error('Error in showWatchlistGroupManager:', error);
                showToast('Error opening group manager', 'error');
            }
        }

        function closeWatchlistGroupManager() {
            const modal = document.getElementById('watchlistGroupManagerModal');
            if (modal) {
                modal.remove();
            }
        }

        function createWatchlistGroup(groupName = null) {
            if (!groupName) {
                const input = document.getElementById('newGroupName');
                if (input) {
                    groupName = input.value.trim();
                } else {
                    showToast('Please enter a group name', 'error');
                    return;
                }
            }
            
            if (!groupName || !groupName.trim()) {
                showToast('Group name cannot be empty', 'error');
                return;
            }
            
            const watchlist = getWatchlist();
            if (watchlist.groups[groupName]) {
                showToast('Group already exists', 'info');
                return;
            }
            
            // Ensure watchlist is in correct format
            if (Array.isArray(watchlist)) {
                watchlist = { groups: { "Uncategorized": watchlist }, order: ["Uncategorized"] };
            }
            if (!watchlist.groups) {
                watchlist.groups = { "Uncategorized": [] };
            }
            if (!watchlist.order) {
                watchlist.order = ["Uncategorized"];
            }
            
            watchlist.groups[groupName] = [];
            if (!watchlist.order.includes(groupName)) {
                watchlist.order.push(groupName);
            }
            saveWatchlist(watchlist);
            
            console.log('Created group:', groupName, 'watchlist:', watchlist);
            
            // Clear input
            const input = document.getElementById('newGroupName');
            if (input) input.value = '';
            
            // Refresh modal and sidebar
            updateWatchlistSidebar();
            showToast(`Group "${groupName}" created`, 'success');
            
            // Refresh modal to show new group
            closeWatchlistGroupManager();
            setTimeout(() => showWatchlistGroupManager(), 100);
        }

        function editWatchlistGroup(groupName, event) {
            if (event) {
                event.stopPropagation();
                addRippleEffect(event);
            }
            
            const newName = prompt(`Rename group "${groupName}":`, groupName);
            if (newName && newName.trim() && newName !== groupName) {
                const watchlist = getWatchlist();
                if (watchlist.groups[newName]) {
                    showToast('Group name already exists', 'error');
                    return;
                }
                
                watchlist.groups[newName] = watchlist.groups[groupName];
                delete watchlist.groups[groupName];
                watchlist.order = watchlist.order.map(g => g === groupName ? newName : g);
                saveWatchlist(watchlist);
                updateWatchlistSidebar();
                showToast(`Group renamed to "${newName}"`, 'success');
                
                // Refresh modal
                closeWatchlistGroupManager();
                setTimeout(() => showWatchlistGroupManager(), 100);
            }
        }

        function deleteWatchlistGroup(groupName, event) {
            if (event) {
                event.stopPropagation();
                addRippleEffect(event);
            }
            
            if (groupName === "Uncategorized") {
                showToast('Cannot delete Uncategorized group', 'error');
                return;
            }
            
            if (!confirm(`Delete group "${groupName}"? Tickers will be moved to Uncategorized.`)) {
                return;
            }
            
            const watchlist = getWatchlist();
            const tickers = watchlist.groups[groupName] || [];
            
            // Move tickers to Uncategorized
            if (!watchlist.groups["Uncategorized"]) {
                watchlist.groups["Uncategorized"] = [];
                if (!watchlist.order.includes("Uncategorized")) {
                    watchlist.order.push("Uncategorized");
                }
            }
            watchlist.groups["Uncategorized"].push(...tickers);
            
            delete watchlist.groups[groupName];
            watchlist.order = watchlist.order.filter(g => g !== groupName);
            saveWatchlist(watchlist);
            updateWatchlistSidebar();
            showToast(`Group "${groupName}" deleted. ${tickers.length} ticker(s) moved to Uncategorized.`, 'success');
            
            // Refresh modal
            closeWatchlistGroupManager();
            setTimeout(() => showWatchlistGroupManager(), 100);
        }

        async function loadWatchlistStock(ticker) {
            if (!ticker) return;
            
            // Switch to stock analysis section
            showStockAnalysis();
            
            // Set ticker and search
            document.getElementById('tickerInput').value = ticker;
            currentTimeframe = '1y'; // Reset to default
            
            // Update timeframe buttons
            const timeframeButtons = document.querySelectorAll('.timeframe-btn');
            if (timeframeButtons.length > 0) {
                timeframeButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-period') === '1y') {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Wait a bit for UI to update, then search
            setTimeout(async () => {
                await searchStock();
            }, 100);
        }

        async function loadWatchlistItemData(ticker) {
            // Just update the sidebar without changing the main view
            updateWatchlistSidebar();
        }

        // Price Alerts Functions
        function loadPriceAlerts() {
            const stored = localStorage.getItem('priceAlerts');
            priceAlerts = stored ? JSON.parse(stored) : [];
        }

        function savePriceAlerts() {
            localStorage.setItem('priceAlerts', JSON.stringify(priceAlerts));
        }

        function addPriceAlert(event) {
            if (event) {
                addRippleEffect(event);
            }
            
            if (!currentData || !currentData.ticker) {
                showError('Please load a stock first');
                return;
            }

            const priceInput = document.getElementById('alertPrice');
            const conditionSelect = document.getElementById('alertCondition');
            
            const targetPrice = parseFloat(priceInput.value);
            const condition = conditionSelect.value;
            const ticker = currentData.ticker;
            const currentPrice = currentData.metrics.current_price;

            if (!targetPrice || targetPrice <= 0) {
                showError('Please enter a valid target price');
                return;
            }

            // Check if alert already exists
            const exists = priceAlerts.some(alert => 
                alert.ticker === ticker && 
                alert.targetPrice === targetPrice && 
                alert.condition === condition
            );

            if (exists) {
                showToast('This alert already exists', 'info');
                return;
            }

            const alert = {
                id: Date.now(),
                ticker: ticker,
                targetPrice: targetPrice,
                condition: condition,
                currentPrice: currentPrice,
                createdAt: new Date().toISOString(),
                triggered: false
            };

            priceAlerts.push(alert);
            savePriceAlerts();
            displayPriceAlerts();

            // Show success indicator
            showToast(`Price alert added: ${ticker} ${condition} $${targetPrice.toFixed(2)}`, 'success');

            // Clear inputs
            priceInput.value = '';
            conditionSelect.value = 'above';
        }

        function deletePriceAlert(alertId) {
            priceAlerts = priceAlerts.filter(alert => alert.id !== alertId);
            savePriceAlerts();
            displayPriceAlerts();
        }

        function displayPriceAlerts() {
            const container = document.getElementById('alertsList');
            if (!container) return;

            if (priceAlerts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No price alerts set. Add one above to get notified when a stock reaches your target price.</p>';
                return;
            }

            let html = '';
            for (const alert of priceAlerts) {
                const statusClass = alert.triggered ? 'triggered' : 'active';
                const statusText = alert.triggered ? 'Triggered' : 'Active';
                const conditionText = alert.condition === 'above' ? 'above' : 'below';
                
                html += `
                    <div class="alert-item">
                        <div class="alert-info">
                            <div class="alert-ticker">${alert.ticker}</div>
                            <div class="alert-details">
                                Alert when price goes ${conditionText} $${alert.targetPrice.toFixed(2)}<br>
                                <small>Current: $${alert.currentPrice ? alert.currentPrice.toFixed(2) : 'N/A'}</small>
                            </div>
                        </div>
                        <div class="alert-actions">
                            <span class="alert-status ${statusClass}">${statusText}</span>
                            <button class="alert-delete-btn ripple-effect" onclick="deletePriceAlert(${alert.id}, event)" title="Delete alert">Ã—</button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        async function checkPriceAlerts() {
            if (priceAlerts.length === 0) return;

            const activeAlerts = priceAlerts.filter(alert => !alert.triggered);
            if (activeAlerts.length === 0) return;

            for (const alert of activeAlerts) {
                try {
                    const result = await fetchJSON(`/api/stock/${alert.ticker}?period=1d`);
                    if (result.success) {
                        const data = result.data;
                        const currentPrice = data.metrics.current_price;
                        
                        // Update current price
                        alert.currentPrice = currentPrice;

                        // Check if alert should trigger
                        let shouldTrigger = false;
                        if (alert.condition === 'above' && currentPrice >= alert.targetPrice) {
                            shouldTrigger = true;
                        } else if (alert.condition === 'below' && currentPrice <= alert.targetPrice) {
                            shouldTrigger = true;
                        }

                        if (shouldTrigger) {
                            alert.triggered = true;
                            alert.triggeredAt = new Date().toISOString();
                            
                            // Show notification
                            showAlertNotification(alert, currentPrice);
                            
                            // Update display
                            displayPriceAlerts();
                            savePriceAlerts();
                        }
                    }
                } catch (error) {
                    console.error(`Error checking alert for ${alert.ticker}:`, error);
                }
            }
        }

        function showAlertNotification(alert, currentPrice) {
            const message = `${alert.ticker} is now $${currentPrice.toFixed(2)} (${alert.condition === 'above' ? 'above' : 'below'} target of $${alert.targetPrice.toFixed(2)})`;
            const title = `Price Alert: ${alert.ticker}`;
            
            const alertData = {
                type: 'price',
                ticker: alert.ticker,
                title: title,
                message: message,
                priority: 'high',
                data: {
                    targetPrice: alert.targetPrice,
                    currentPrice: currentPrice,
                    condition: alert.condition,
                    triggeredAt: alert.triggeredAt
                }
            };

            // Browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: message,
                    icon: 'ðŸ“ˆ',
                    tag: `alert-${alert.id}`
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };

                // Save notification to history
                saveAlertToHistory({
                    ...alertData,
                    type: 'notification'
                });
            }

            // Play sound alert (will also save to history)
            playSoundAlert('breaking', alertData);

            // Save price alert to history
            saveAlertToHistory(alertData);

            // In-app notification
            const notification = document.createElement('div');
            notification.className = 'success-message';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.style.maxWidth = '400px';
            notification.innerHTML = `ðŸ”” <strong>Price Alert!</strong><br>${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        function startAlertChecker() {
            // Check alerts every 30 seconds
            if (alertCheckInterval) {
                clearInterval(alertCheckInterval);
            }
            alertCheckInterval = setInterval(checkPriceAlerts, 30000);
            
            // Also check immediately
            checkPriceAlerts();
        }

        // Earnings Calendar Functions
        let allEarningsData = [];
        let currentEarningsFilter = 'all';
        let earningsCalendarLoaded = false;

        // Economic Calendar Functions
        let allEconomicData = [];
        let currentEconomicFilter = 'all';
        let economicCalendarLoaded = false;

        async function loadEarningsCalendar() {
            const container = document.getElementById('earningsCalendarContent');
            if (!container) {
                console.error('earningsCalendarContent container not found');
                return;
            }
            console.log('Loading earnings calendar...');
            
            container.innerHTML = `
                <div class="skeleton-card">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text" style="width: 80%;"></div>
                    <div style="margin-top: 20px;">
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('/api/earnings-calendar');
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP ${response.status}: Failed to load earnings calendar`);
                }

                const data = await response.json();
                console.log('Earnings calendar response:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                allEarningsData = data.earnings || [];
                console.log('Loaded earnings data:', allEarningsData.length, 'items', allEarningsData.slice(0, 3));
                
                if (allEarningsData.length === 0) {
                    container.innerHTML = `
                        <div class="earnings-calendar-empty">
                            <div class="earnings-calendar-empty-icon">ðŸ“…</div>
                            <p>No upcoming earnings found in the next 90 days.</p>
                            <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.7;">Earnings data is updated regularly. Try again later.</p>
                        </div>
                    `;
                    return;
                }

                // Reset filter to 'all' to show all earnings by default
                currentEarningsFilter = 'all';
                document.querySelectorAll('.earnings-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.trim().toLowerCase() === 'all') {
                        btn.classList.add('active');
                    }
                });

                displayEarningsCalendar();
            } catch (error) {
                console.error('Earnings calendar error:', error);
                container.innerHTML = `
                    <div class="error">
                        Error loading earnings calendar: ${error.message}<br><br>
                        <button onclick="loadEarningsCalendar()" style="margin-top: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        }

        function filterEarnings(filter) {
            currentEarningsFilter = filter;
            
            // Update active button
            document.querySelectorAll('.earnings-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.textContent.toLowerCase().trim();
                if (filter === 'all' && btnText === 'all') {
                    btn.classList.add('active');
                } else if (filter === 'this-week' && btnText === 'this week') {
                    btn.classList.add('active');
                } else if (filter === 'this-month' && btnText === 'this month') {
                    btn.classList.add('active');
                } else if (filter === 'next-month' && btnText === 'next month') {
                    btn.classList.add('active');
                }
            });

            displayEarningsCalendar();
        }

        function displayEarningsCalendar() {
            const container = document.getElementById('earningsCalendarContent');
            
            if (!allEarningsData || allEarningsData.length === 0) {
                container.innerHTML = `
                    <div class="earnings-calendar-empty">
                        <div class="earnings-calendar-empty-icon">ðŸ“…</div>
                        <p>No earnings data available at the moment.</p>
                        <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.7;">Try refreshing the page.</p>
                    </div>
                `;
                return;
            }

            // Filter earnings based on current filter
            let filteredEarnings = [...allEarningsData];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            console.log('Total earnings:', allEarningsData.length, 'Filter:', currentEarningsFilter);

            if (currentEarningsFilter === 'this-week') {
                const weekEnd = new Date(today);
                weekEnd.setDate(today.getDate() + 7);
                weekEnd.setHours(23, 59, 59);
                filteredEarnings = filteredEarnings.filter(e => {
                    const earningsDate = new Date(e.earnings_date + 'T00:00:00');
                    return earningsDate >= today && earningsDate <= weekEnd;
                });
            } else if (currentEarningsFilter === 'this-month') {
                const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                monthEnd.setHours(23, 59, 59);
                filteredEarnings = filteredEarnings.filter(e => {
                    const earningsDate = new Date(e.earnings_date + 'T00:00:00');
                    return earningsDate >= today && earningsDate <= monthEnd;
                });
            } else if (currentEarningsFilter === 'next-month') {
                const nextMonthStart = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                nextMonthStart.setHours(0, 0, 0);
                const nextMonthEnd = new Date(today.getFullYear(), today.getMonth() + 2, 0);
                nextMonthEnd.setHours(23, 59, 59);
                filteredEarnings = filteredEarnings.filter(e => {
                    const earningsDate = new Date(e.earnings_date + 'T00:00:00');
                    return earningsDate >= nextMonthStart && earningsDate <= nextMonthEnd;
                });
            }
            
            console.log('Filtered earnings:', filteredEarnings.length, 'out of', allEarningsData.length);

            if (filteredEarnings.length === 0) {
                container.innerHTML = `
                    <div class="earnings-calendar-empty">
                        <div class="earnings-calendar-empty-icon">ðŸ“…</div>
                        <p>No earnings found for the selected period.</p>
                        <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.7;">Try selecting "All" to see all available earnings.</p>
                        <button onclick="filterEarnings('all')" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Show All Earnings</button>
                    </div>
                `;
                return;
            }

            let html = `<div style="margin-bottom: 15px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; color: var(--text-secondary); font-size: 0.9em;">
                Showing <strong>${filteredEarnings.length}</strong> earnings${currentEarningsFilter !== 'all' ? ' for selected period' : ''}
            </div>`;
            
            for (const earnings of filteredEarnings) {
                const earningsDate = new Date(earnings.earnings_date + 'T00:00:00');
                const todayStr = today.toDateString();
                const earningsDateStr = earningsDate.toDateString();
                const isToday = earningsDateStr === todayStr;
                const isPast = earningsDate < today;
                
                const itemClass = isToday ? 'today' : (isPast ? 'past' : '');
                
                html += `
                    <div class="earnings-calendar-item ${itemClass}" onclick="loadEarningsStock('${earnings.ticker}')">
                        <div class="earnings-item-info">
                            <div class="earnings-item-ticker">${earnings.ticker}</div>
                            <div class="earnings-item-company">${earnings.company_name}</div>
                            <div class="earnings-item-date">
                                ðŸ“… ${earnings.earnings_date_display}
                                ${earnings.sector && earnings.sector !== 'N/A' ? `<span style="margin-left: 15px; padding: 4px 10px; background: rgba(102, 126, 234, 0.1); color: #667eea; border-radius: 12px; font-size: 0.85em;">${earnings.sector}</span>` : ''}
                            </div>
                        </div>
                        <div class="earnings-item-metrics">
                            ${earnings.eps_estimate !== null ? `
                                <div class="earnings-eps">
                                    <div class="earnings-eps-label">EPS Estimate</div>
                                    <div class="earnings-eps-value">$${earnings.eps_estimate.toFixed(2)}</div>
                                </div>
                            ` : ''}
                            ${earnings.eps_reported !== null ? `
                                <div class="earnings-eps" style="margin-top: 10px;">
                                    <div class="earnings-eps-label">EPS Reported</div>
                                    <div class="earnings-eps-value">$${earnings.eps_reported.toFixed(2)}</div>
                                </div>
                            ` : ''}
                            ${earnings.surprise_pct !== null ? `
                                <div class="earnings-surprise ${earnings.surprise_pct >= 0 ? 'positive' : 'negative'}">
                                    ${earnings.surprise_pct >= 0 ? '+' : ''}${earnings.surprise_pct.toFixed(2)}% Surprise
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function loadEarningsStock(ticker) {
            showStockAnalysis();
            document.getElementById('tickerInput').value = ticker;
            currentTimeframe = '1y';
            
            // Update timeframe buttons
            const timeframeButtons = document.querySelectorAll('.timeframe-btn');
            if (timeframeButtons.length > 0) {
                timeframeButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-period') === '1y') {
                        btn.classList.add('active');
                    }
                });
            }
            
            setTimeout(async () => {
                await searchStock();
            }, 100);
        }

        // Economic Calendar Functions
        async function loadEconomicCalendar() {
            const container = document.getElementById('economicCalendarContent');
            if (!container) {
                console.error('economicCalendarContent container not found');
                return;
            }
            console.log('Loading economic calendar...');
            
            container.innerHTML = `
                <div class="skeleton-card">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text" style="width: 80%;"></div>
                    <div style="margin-top: 20px;">
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                    </div>
                </div>
            `;

            try {
                const result = await fetchJSON('/api/economic-calendar', {}, container);
                
                if (!result.success) {
                    return; // Error already displayed by fetchJSON
                }

                const data = result.data;
                console.log('Economic calendar response:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                allEconomicData = data.events || [];
                console.log('Loaded economic data:', allEconomicData.length, 'items');
                
                if (allEconomicData.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                            <div style="font-size: 3em; margin-bottom: 20px;">ðŸ“Š</div>
                            <p>No economic events found for the next 7 days.</p>
                            <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.7;">Economic data is updated regularly. Try again later.</p>
                        </div>
                    `;
                    return;
                }

                // Reset filter to 'all'
                currentEconomicFilter = 'all';
                document.querySelectorAll('.economic-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.trim().toLowerCase() === 'all') {
                        btn.classList.add('active');
                    }
                });

                displayEconomicCalendar();
            } catch (error) {
                console.error('Economic calendar error:', error);
                container.innerHTML = `
                    <div class="error">
                        Error loading economic calendar: ${error.message}<br><br>
                        <button onclick="loadEconomicCalendar()" style="margin-top: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        }

        function filterEconomicCalendar(filter) {
            currentEconomicFilter = filter;
            
            // Update active button
            document.querySelectorAll('.economic-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim().toLowerCase() === filter.toLowerCase()) {
                    btn.classList.add('active');
                }
            });
            
            displayEconomicCalendar();
        }

        function displayEconomicCalendar() {
            const container = document.getElementById('economicCalendarContent');
            if (!container) return;
            
            let filteredEvents = [...allEconomicData];
            // Get today's date in local timezone (YYYY-MM-DD format)
            const today = new Date();
            const todayStr = today.getFullYear() + '-' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(today.getDate()).padStart(2, '0');
            
            if (currentEconomicFilter === 'today') {
                filteredEvents = filteredEvents.filter(e => e.date === todayStr);
            } else if (currentEconomicFilter === 'tomorrow') {
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.getFullYear() + '-' + 
                                   String(tomorrow.getMonth() + 1).padStart(2, '0') + '-' + 
                                   String(tomorrow.getDate()).padStart(2, '0');
                filteredEvents = filteredEvents.filter(e => e.date === tomorrowStr);
            } else if (currentEconomicFilter === 'this-week') {
                // Find this Monday (start of this week)
                const daysSinceMonday = (today.getDay() + 6) % 7; // Monday = 0, Sunday = 6
                const thisMonday = new Date(today);
                thisMonday.setDate(today.getDate() - daysSinceMonday);
                
                // This Sunday (end of this week)
                const thisSunday = new Date(thisMonday);
                thisSunday.setDate(thisMonday.getDate() + 6);
                
                const thisWeekStartStr = thisMonday.getFullYear() + '-' + 
                                       String(thisMonday.getMonth() + 1).padStart(2, '0') + '-' + 
                                       String(thisMonday.getDate()).padStart(2, '0');
                const thisWeekEndStr = thisSunday.getFullYear() + '-' + 
                                     String(thisSunday.getMonth() + 1).padStart(2, '0') + '-' + 
                                     String(thisSunday.getDate()).padStart(2, '0');
                filteredEvents = filteredEvents.filter(e => {
                    return e.date >= thisWeekStartStr && e.date <= thisWeekEndStr;
                });
            } else if (currentEconomicFilter === 'next-week') {
                // Find next Monday (start of next week)
                const daysUntilNextMonday = (1 - today.getDay() + 7) % 7 || 7;
                const nextMonday = new Date(today);
                nextMonday.setDate(today.getDate() + daysUntilNextMonday);
                
                // Next Sunday (end of next week)
                const nextSunday = new Date(nextMonday);
                nextSunday.setDate(nextMonday.getDate() + 6);
                
                const nextWeekStartStr = nextMonday.getFullYear() + '-' + 
                                        String(nextMonday.getMonth() + 1).padStart(2, '0') + '-' + 
                                        String(nextMonday.getDate()).padStart(2, '0');
                const nextWeekEndStr = nextSunday.getFullYear() + '-' + 
                                      String(nextSunday.getMonth() + 1).padStart(2, '0') + '-' + 
                                      String(nextSunday.getDate()).padStart(2, '0');
                filteredEvents = filteredEvents.filter(e => {
                    return e.date >= nextWeekStartStr && e.date <= nextWeekEndStr;
                });
            }
            
            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 3em; margin-bottom: 20px;">ðŸ“Š</div>
                        <p>No economic events found for the selected period.</p>
                        <button onclick="filterEconomicCalendar('all')" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Show All Events</button>
                    </div>
                `;
                return;
            }
            
            // Group events by date
            const eventsByDate = {};
            filteredEvents.forEach(event => {
                if (!eventsByDate[event.date]) {
                    eventsByDate[event.date] = [];
                }
                eventsByDate[event.date].push(event);
            });
            
            let html = `<div style="margin-bottom: 20px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; color: var(--text-secondary); font-size: 0.9em;">
                Showing <strong>${filteredEvents.length}</strong> economic event${filteredEvents.length !== 1 ? 's' : ''}${currentEconomicFilter !== 'all' ? ' for selected period' : ''}
            </div>`;
            
            // Sort dates
            const sortedDates = Object.keys(eventsByDate).sort();
            
            sortedDates.forEach(date => {
                const events = eventsByDate[date];
                // Parse date correctly (YYYY-MM-DD format) - use local timezone
                const [year, month, day] = date.split('-').map(Number);
                const dateObj = new Date(year, month - 1, day); // month is 0-indexed, use local timezone
                const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const isToday = date === todayStr;
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.3em; padding-bottom: 10px; border-bottom: 2px solid var(--border-color);">
                            ${isToday ? 'ðŸ“… Today - ' : ''}${dateStr}
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                `;
                
                events.forEach((event, index) => {
                    // Impact indicator (bull icons)
                    const impactIcons = 'ðŸ‚'.repeat(Math.min(event.impact || 0, 3));
                    const impactColor = event.impact >= 3 ? '#ef4444' : event.impact === 2 ? '#f59e0b' : '#10b981';
                    const eventName = (event.event || 'N/A').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const eventId = `economic-event-${date.replace(/-/g, '')}-${index}`;
                    
                    html += `
                        <div id="${eventId}" class="economic-event-item" data-event-name="${eventName}" style="padding: 20px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; transition: all 0.3s; cursor: pointer;" 
                             onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateX(5px)'" 
                             onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateX(0)'">
                            <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 15px; align-items: start;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.2em; font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">${event.time || 'N/A'}</div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary); padding: 4px 8px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; font-weight: 600;">${event.currency || 'N/A'}</div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <span style="font-size: 1.5em;">${impactIcons}</span>
                                        <span style="font-size: 0.85em; color: var(--text-secondary);">${event.country || 'N/A'}</span>
                                    </div>
                                    <div style="font-size: 1.1em; font-weight: 700; color: var(--text-primary); margin-bottom: 10px;" data-event-name="${(event.event || 'N/A').replace(/"/g, '&quot;')}">${event.event || 'N/A'}</div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                                        <div>
                                            <div style="color: var(--text-secondary); margin-bottom: 4px;">Actual:</div>
                                            <div style="font-weight: 600; color: ${event.actual && event.actual !== 'N/A' ? '#10b981' : 'var(--text-tertiary)'};">${event.actual || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-secondary); margin-bottom: 4px;">Consensus:</div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${event.consensus || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="color: var(--text-secondary); margin-bottom: 4px;">Previous:</div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${event.previous || 'N/A'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add click handlers to all economic events after HTML is inserted
            setTimeout(() => {
                const eventElements = document.querySelectorAll('.economic-event-item');
                console.log('Found', eventElements.length, 'economic event elements');
                eventElements.forEach((element, index) => {
                    element.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const eventName = this.getAttribute('data-event-name') || 'Unknown Event';
                        console.log('Clicked event element:', index, 'Event name:', eventName);
                        showEconomicEventExplanation(eventName);
                    });
                });
            }, 100);
        }

        async function showEconomicEventExplanation(eventName) {
            console.log('showEconomicEventExplanation called with:', eventName);
            const modal = document.getElementById('economicEventModal');
            const modalContent = document.getElementById('economicEventModalContent');
            
            if (!modal) {
                console.error('Modal not found');
                return;
            }
            if (!modalContent) {
                console.error('Modal content not found');
                return;
            }
            
            console.log('Modal found, showing...');
            
            // Show modal with loading state
            modal.style.display = 'block';
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 20px; color: var(--text-secondary);">Loading explanation...</p>
                </div>
            `;
            
            try {
                const result = await fetchJSON(`/api/economic-event-explanation?event=${encodeURIComponent(eventName)}`, {}, modalContent);
                
                if (!result.success) {
                    return; // Error already displayed by fetchJSON
                }
                
                const data = result.data;
                
                // Display explanation
                modalContent.innerHTML = `
                    <h2 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.8em; border-bottom: 3px solid #667eea; padding-bottom: 15px;">
                        ðŸ“Š ${data.event_name}
                    </h2>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 12px; color: var(--text-primary); font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">ðŸ’¡</span> Co to je?
                        </h3>
                        <div style="padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; border-left: 4px solid #667eea; color: var(--text-primary); line-height: 1.7; font-size: 1.05em;">
                            ${data.what}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 12px; color: var(--text-primary); font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">ðŸŸ¢</span> Kdy je to BULLISH?
                        </h3>
                        <div style="padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border-left: 4px solid #10b981; color: var(--text-primary); line-height: 1.7; font-size: 1.05em;">
                            ${data.bullish}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 12px; color: var(--text-primary); font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">ðŸ”´</span> Kdy je to BEARISH?
                        </h3>
                        <div style="padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 12px; border-left: 4px solid #ef4444; color: var(--text-primary); line-height: 1.7; font-size: 1.05em;">
                            ${data.bearish}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading economic event explanation:', error);
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">âŒ</div>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Error loading explanation: ${error.message}</p>
                        <button onclick="closeEconomicEventModal()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>
                    </div>
                `;
            }
        }

        function closeEconomicEventModal() {
            const modal = document.getElementById('economicEventModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('economicEventModal');
            if (modal && event.target === modal) {
                closeEconomicEventModal();
            }
        });

        function loadWatchlistFromStorage() {
            const watchlist = getWatchlist();
            const container = document.getElementById('watchlistTickers');
            const allTickers = getAllTickers();
            
            if (allTickers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No tickers in watchlist. Add some to get started!</p>';
                document.getElementById('watchlistNewsContent').innerHTML = '';
                return;
            }

            container.innerHTML = allTickers.map(ticker => {
                const groupName = getTickerGroup(ticker);
                return `
                    <div class="watchlist-ticker-badge">
                        <span>${ticker}${groupName && groupName !== "Uncategorized" ? ` <small style="opacity: 0.7;">(${groupName})</small>` : ''}</span>
                        <button class="remove-btn ripple-effect" onclick="removeFromWatchlist('${ticker}', event)" title="Remove">Ã—</button>
                    </div>
                `;
            }).join('');
        }

        // Store watchlist news data globally for AI summary
        let currentWatchlistNewsData = [];
        window.currentWatchlistNewsData = currentWatchlistNewsData; // Make it globally accessible

        // Real-time Updates Variables
        let autoRefreshInterval = null;
        let lastNewsHash = null;
        let readNewsIds = new Set(JSON.parse(localStorage.getItem('readNewsIds') || '[]'));
        let notificationPermission = Notification.permission;

        // Initialize real-time updates on page load
        function initRealTimeUpdates() {
            // Load saved settings
            const autoRefresh = localStorage.getItem('autoRefreshEnabled') === 'true';
            const notifications = localStorage.getItem('notificationsEnabled') === 'true';
            const soundAlerts = localStorage.getItem('soundAlertsEnabled') === 'true';
            const interval = parseInt(localStorage.getItem('autoRefreshInterval') || '60');

            // Safely access elements - they might not exist
            const autoRefreshEnabledEl = document.getElementById('autoRefreshEnabled');
            const notificationsEnabledEl = document.getElementById('notificationsEnabled');
            const soundAlertsEnabledEl = document.getElementById('soundAlertsEnabled');
            const autoRefreshIntervalEl = document.getElementById('autoRefreshInterval');

            if (autoRefresh && autoRefreshEnabledEl) {
                autoRefreshEnabledEl.checked = true;
                startAutoRefresh();
            }
            if (notifications && notificationsEnabledEl) {
                notificationsEnabledEl.checked = true;
            }
            if (soundAlerts && soundAlertsEnabledEl) {
                soundAlertsEnabledEl.checked = true;
            }
            if (autoRefreshIntervalEl) {
                autoRefreshIntervalEl.value = interval;
            }

            // Request notification permission if not already granted
            if (notifications && notificationPermission === 'default') {
                requestNotificationPermission();
            }
        }

        // Request browser notification permission
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                if (permission === 'granted') {
                    showNotification('Notifications Enabled', 'You will now receive alerts for breaking news!');
                }
            }
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshEnabled') || document.getElementById('settingsAutoRefreshEnabled');
            const enabled = checkbox ? checkbox.checked : false;
            localStorage.setItem('autoRefreshEnabled', enabled);
            if (enabled) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        // Start auto-refresh
        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing interval
            const input = document.getElementById('autoRefreshInterval') || document.getElementById('settingsAutoRefreshInterval');
            const interval = input ? parseInt(input.value) * 1000 : 60000;
            autoRefreshInterval = setInterval(() => {
                if (document.getElementById('watchlistSection') && !document.getElementById('watchlistSection').classList.contains('hidden')) {
                    loadWatchlistNews(true); // Pass true to indicate auto-refresh
                }
            }, interval);
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Update auto-refresh interval
        function updateAutoRefreshInterval() {
            const input = document.getElementById('autoRefreshInterval') || document.getElementById('settingsAutoRefreshInterval');
            const interval = input ? parseInt(input.value) : 60;
            localStorage.setItem('autoRefreshInterval', interval);
            const checkbox = document.getElementById('autoRefreshEnabled') || document.getElementById('settingsAutoRefreshEnabled');
            if (checkbox && checkbox.checked) {
                startAutoRefresh();
            }
        }

        // Toggle notifications
        function toggleNotifications() {
            const checkbox = document.getElementById('notificationsEnabled') || document.getElementById('settingsNotificationsEnabled');
            const enabled = checkbox ? checkbox.checked : false;
            localStorage.setItem('notificationsEnabled', enabled);
            if (enabled) {
                requestNotificationPermission();
            }
        }

        // Toggle sound alerts
        function toggleSoundAlerts() {
            const checkbox = document.getElementById('soundAlertsEnabled') || document.getElementById('settingsSoundAlertsEnabled');
            const enabled = checkbox ? checkbox.checked : false;
            localStorage.setItem('soundAlertsEnabled', enabled);
        }

        // Play sound alert
        function playSoundAlert(type = 'default', alertData = null) {
            if (document.getElementById('soundAlertsEnabled') && !document.getElementById('soundAlertsEnabled').checked) {
                return;
            }

            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                if (type === 'breaking') {
                    // High-pitched alert for breaking news
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } else {
                    // Default notification sound
                    oscillator.frequency.value = 600;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }

                // Save to history
                if (alertData) {
                    saveAlertToHistory({
                        type: 'sound',
                        ...alertData
                    });
                } else {
                    saveAlertToHistory({
                        type: 'sound',
                        title: type === 'breaking' ? 'Breaking News Alert' : 'News Alert',
                        message: 'Sound alert triggered'
                    });
                }
            } catch (error) {
                console.error('Error playing sound alert:', error);
            }
        }

        // Show browser notification
        function showNotification(title, body, icon = null, alertData = null) {
            if (!('Notification' in window)) {
                return;
            }

            if (document.getElementById('notificationsEnabled') && !document.getElementById('notificationsEnabled').checked) {
                return;
            }

            if (Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: icon || '/favicon.ico',
                    badge: '/favicon.ico',
                    tag: 'watchlist-news',
                    requireInteraction: false
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };

                setTimeout(() => notification.close(), 5000);

                // Save to history
                if (alertData) {
                    saveAlertToHistory({
                        type: 'notification',
                        ...alertData
                    });
                } else {
                    // Extract ticker from title if possible
                    const tickerMatch = title.match(/^([A-Z]+):/);
                    saveAlertToHistory({
                        type: 'notification',
                        ticker: tickerMatch ? tickerMatch[1] : '',
                        title: title,
                        message: body
                    });
                }
            }
        }

        // Generate hash for news to detect changes
        function generateNewsHash(newsGroups) {
            const newsIds = [];
            for (const group of newsGroups) {
                for (const news of group.news) {
                    const id = `${news.link || news.title || ''}_${news.published || ''}`;
                    if (id) newsIds.push(id);
                }
            }
            return newsIds.sort().join('|');
        }

        // Mark news as read
        function markNewsAsRead(newsId) {
            readNewsIds.add(newsId);
            localStorage.setItem('readNewsIds', JSON.stringify(Array.from(readNewsIds)));
        }

        // Get unread news count
        function getUnreadNewsCount(newsGroups) {
            let unreadCount = 0;
            for (const group of newsGroups) {
                for (const news of group.news) {
                    const newsId = `${news.link || news.title || ''}_${news.published || ''}`;
                    if (newsId && !readNewsIds.has(newsId)) {
                        unreadCount++;
                    }
                }
            }
            return unreadCount;
        }

        // Update live badge
        function updateLiveBadge(count) {
            const badge = document.getElementById('liveBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Detect new news and trigger alerts
        function detectNewNews(newNewsGroups, isAutoRefresh = false) {
            if (!lastNewsHash) {
                lastNewsHash = generateNewsHash(newNewsGroups);
                return;
            }

            const currentHash = generateNewsHash(newNewsGroups);
            if (currentHash === lastNewsHash) {
                return; // No new news
            }

            // Find new news items
            const newNews = [];
            for (const group of newNewsGroups) {
                for (const news of group.news) {
                    const newsId = `${news.link || news.title || ''}_${news.published || ''}`;
                    if (newsId && !readNewsIds.has(newsId)) {
                        newNews.push({ ...news, ticker: group.ticker, company_name: group.company_name });
                    }
                }
            }

            if (newNews.length > 0) {
                // Update badge
                const unreadCount = getUnreadNewsCount(newNewsGroups);
                updateLiveBadge(unreadCount);

                // Show notifications and play sounds for important news
                if (isAutoRefresh) {
                    for (const news of newNews) {
                        const isBreaking = news.impact_score > 0.7 || 
                                         news.sentiment === 'negative' || 
                                         (news.sentiment === 'positive' && news.impact_score > 0.5);

                        if (isBreaking) {
                            const title = `ðŸ”” ${news.ticker}: ${news.title.substring(0, 50)}${news.title.length > 50 ? '...' : ''}`;
                            const body = `${news.summary.substring(0, 100)}${news.summary.length > 100 ? '...' : ''}`;
                            const alertData = {
                                ticker: news.ticker,
                                title: news.title,
                                message: body,
                                sentiment: news.sentiment,
                                impact_score: news.impact_score,
                                link: news.link,
                                priority: 'high',
                                data: { company_name: news.company_name }
                            };
                            showNotification(title, body, null, alertData);
                            playSoundAlert('breaking', alertData);
                        } else if (newNews.length <= 3) {
                            // Show notification for first few new items
                            const title = `ðŸ“° ${news.ticker}: New News`;
                            const body = news.title.substring(0, 80);
                            const alertData = {
                                ticker: news.ticker,
                                title: news.title,
                                message: body,
                                sentiment: news.sentiment,
                                impact_score: news.impact_score,
                                link: news.link,
                                priority: 'normal',
                                data: { company_name: news.company_name }
                            };
                            showNotification(title, body, null, alertData);
                            playSoundAlert('default', alertData);
                        }
                    }
                }
            }

            lastNewsHash = currentHash;
        }

        async function loadNewsForTicker() {
            const tickerInput = document.getElementById('newsTickerInput');
            const ticker = tickerInput.value.trim().toUpperCase();
            
            if (!ticker) {
                showError('Please enter a ticker symbol');
                tickerInput.focus();
                return;
            }

            const container = document.getElementById('newsContent');
            const loadBtn = document.getElementById('loadNewsBtn');
            const aiSummaryBtn = document.getElementById('newsAISummaryBtn');
            
            // Disable button during loading
            loadBtn.disabled = true;
            loadBtn.textContent = 'Loading...';
            
            container.innerHTML = `
                <div class="skeleton-card">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-news-item"></div>
                    <div class="skeleton skeleton-news-item"></div>
                    <div class="skeleton skeleton-news-item"></div>
                    <div class="skeleton skeleton-news-item"></div>
                </div>
            `;

            try {
                // Use new news endpoint with impact analysis (with pagination)
                let newsPage = window.newsCurrentPage || 1;
                let newsLimit = window.newsLimit || 20;
                const response = await window.cachedFetch(`/api/news/${ticker}?page=${newsPage}&limit=${newsLimit}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to load news for ${ticker}`);
                }
                
                const data = await response.json();
                
                // Store pagination info
                if (data.total_pages) {
                    window.newsCurrentPage = data.page || 1;
                    window.newsTotalPages = data.total_pages || 0;
                    window.newsTotal = data.total || 0;
                    window.newsLimit = data.limit || 20;
                }
                
                if (!data.news || data.news.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 3em; margin-bottom: 20px;">ðŸ“°</div>
                            <h3>No News Found</h3>
                            <p>No news articles available for ${ticker} at this time.</p>
                        </div>
                    `;
                    loadBtn.disabled = false;
                    loadBtn.textContent = 'ðŸ“° Load News';
                    return;
                }

                // Get company name from stock endpoint
                let companyName = ticker;
                try {
                    const stockResponse = await fetch(`/api/stock/${ticker}`);
                    if (stockResponse.ok) {
                        const stockData = await stockResponse.json();
                        companyName = stockData.company_info?.name || ticker;
                    }
                } catch (e) {
                    console.warn('Could not fetch company name:', e);
                }

                // Store news data globally for AI summary
                currentNewsData = {
                    ticker: ticker,
                    news: data.news,
                    company_name: companyName,
                    historical_patterns: data.historical_patterns
                };
                window.currentNewsData = currentNewsData;

                // Show AI Summary button
                aiSummaryBtn.style.display = 'inline-block';

                // Update News Alerts button
                updateNewsAlertsButton();

                // Pass the full object to displayNews so it can store ticker info
                displayNewsForNewsSection(currentNewsData);
                
                // Add pagination UI if there are multiple pages
                if (window.newsTotalPages > 1) {
                    addNewsPagination(container, ticker);
                }
                
                loadBtn.disabled = false;
                loadBtn.textContent = 'ðŸ“° Load News';
            } catch (error) {
                console.error('Error loading news:', error);
                container.innerHTML = `
                    <div class="error">
                        <div class="error-title">Error loading news</div>
                        <p>${error.message}</p>
                        <button onclick="loadNewsForTicker()" style="margin-top: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
                    </div>
                `;
                loadBtn.disabled = false;
                loadBtn.textContent = 'ðŸ“° Load News';
            }
        }

        // Generate consistent color for ticker based on hash
        function getTickerColor(ticker) {
            if (!ticker) return '#667eea';
            
            // Hash function to generate consistent color
            let hash = 0;
            for (let i = 0; i < ticker.length; i++) {
                hash = ticker.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            // Generate HSL color with good saturation and lightness
            const hue = Math.abs(hash) % 360;
            const saturation = 65 + (Math.abs(hash) % 20); // 65-85%
            const lightness = 50 + (Math.abs(hash) % 15); // 50-65%
            
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        // Convert impact score to star rating (1-5 stars)
        // Accepts both 0-1 scale (old) and 0-100 scale (new)
        function getImpactStars(impactScore) {
            if (!impactScore || impactScore <= 0) return '';
            
            // Normalize to 0-1 scale if it's 0-100
            let normalizedScore = impactScore;
            if (impactScore > 1) {
                normalizedScore = impactScore / 100;
            }
            
            let stars = 0;
            if (normalizedScore > 0.8) stars = 5;
            else if (normalizedScore > 0.6) stars = 4;
            else if (normalizedScore > 0.4) stars = 3;
            else if (normalizedScore > 0.2) stars = 2;
            else if (normalizedScore > 0.1) stars = 1;
            
            if (stars === 0) return '';
            return 'â­'.repeat(stars);
        }

        function addNewsPagination(container, ticker) {
            // Remove existing pagination if any
            const existingPagination = document.getElementById('newsPagination');
            if (existingPagination) {
                existingPagination.remove();
            }
            
            const paginationHtml = `
                <div id="newsPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; padding: 20px; border-top: 1px solid var(--border-color);">
                    <button onclick="loadNewsPage(${Math.max(1, window.newsCurrentPage - 1)})" ${window.newsCurrentPage <= 1 ? 'disabled' : ''} style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary); cursor: pointer; ${window.newsCurrentPage <= 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">â€¹ Prev</button>
                    <span style="padding: 8px 16px; color: var(--text-primary);">Page ${window.newsCurrentPage} of ${window.newsTotalPages} (${window.newsTotal} total)</span>
                    <button onclick="loadNewsPage(${Math.min(window.newsTotalPages, window.newsCurrentPage + 1)})" ${window.newsCurrentPage >= window.newsTotalPages ? 'disabled' : ''} style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); color: var(--text-primary); cursor: pointer; ${window.newsCurrentPage >= window.newsTotalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}">Next â€º</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', paginationHtml);
        }
        
        function loadNewsPage(page) {
            window.newsCurrentPage = page;
            loadNewsForTicker();
        }
        
        function displayNewsForNewsSection(newsData) {
            const container = document.getElementById('newsContent');
            
            // Remove existing pagination if any
            const existingPagination = document.getElementById('newsPagination');
            if (existingPagination) {
                existingPagination.remove();
            }
            
            if (!newsData || !newsData.news || newsData.news.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No news found for this ticker.</p>';
                return;
            }

            const ticker = newsData.ticker;
            const companyName = newsData.company_name || ticker;
            const news = newsData.news;
            const tickerColor = getTickerColor(ticker);

            // Sort news by date (newest first)
            const sortedNews = [...news].sort((a, b) => {
                try {
                    const dateA = new Date(a.published || 0);
                    const dateB = new Date(b.published || 0);
                    return dateB - dateA;
                } catch {
                    return 0;
                }
            });

            // Calculate sentiment summary
            const sentiments = sortedNews.map(n => n.sentiment);
            const positiveCount = sentiments.filter(s => s === 'positive').length;
            const negativeCount = sentiments.filter(s => s === 'negative').length;
            const neutralCount = sentiments.filter(s => s === 'neutral').length;
            const total = sortedNews.length;

            let html = '';

            // Header with ticker info
            html += `<div class="watchlist-news-group" style="border-left: 4px solid ${tickerColor}; margin-bottom: 30px;">`;
            html += `<div class="watchlist-news-group-header" style="border-left: 3px solid ${tickerColor}; background: linear-gradient(135deg, ${tickerColor}15 0%, ${tickerColor}05 100%);">`;
            html += `<div>`;
            html += `<div class="watchlist-news-group-title" style="display: flex; align-items: center; gap: 10px;">`;
            html += `<span class="ticker-color-badge" style="width: 12px; height: 12px; border-radius: 50%; background: ${tickerColor}; display: inline-block; box-shadow: 0 0 8px ${tickerColor}80;"></span>`;
            html += `<span>${companyName} (${ticker})</span>`;
            html += `</div>`;
            html += `<div style="color: var(--text-secondary); font-size: 0.9em; margin-top: 5px;">${total} news articles</div>`;
            html += `</div>`;
            html += `<div class="watchlist-sentiment-summary">`;
            html += `<div class="sentiment-summary-item sentiment-summary-positive">ðŸ‘ ${positiveCount}</div>`;
            html += `<div class="sentiment-summary-item sentiment-summary-negative">ðŸ‘Ž ${negativeCount}</div>`;
            html += `<div class="sentiment-summary-item sentiment-summary-neutral">âž– ${neutralCount}</div>`;
            html += `</div>`;
            html += `</div>`;

            // Display news items
            for (const newsItem of sortedNews) {
                    const sentimentClass = `sentiment-${newsItem.sentiment}`;
                    const sentimentLabel = newsItem.sentiment_label || newsItem.sentiment;
                    const sentimentScore = newsItem.sentiment_score !== undefined ? newsItem.sentiment_score : null;
                    
                    html += `<div class="news-item" style="border-left: 3px solid ${tickerColor}40; position: relative;">`;
                    html += '<div class="news-item-content">';
                    
                    // Add thumbnail if available (left side)
                    if (newsItem.thumbnail) {
                        html += `<div class="news-thumbnail-container">`;
                        html += `<img src="${newsItem.thumbnail}" alt="${newsItem.title || 'News thumbnail'}" class="news-thumbnail" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`;
                        html += `<div class="news-thumbnail-placeholder" style="display: none; width: 120px; height: 80px; background: linear-gradient(135deg, ${tickerColor}20 0%, ${tickerColor}10 100%); border-radius: 8px; align-items: center; justify-content: center; color: ${tickerColor}; font-size: 2em;">ðŸ“°</div>`;
                        html += `</div>`;
                    }
                    
                    html += '<div class="news-item-text">';
                    html += '<div class="news-header">';
                    
                    if (newsItem.link) {
                        html += `<h3 class="news-title"><a href="${newsItem.link}" target="_blank" rel="noopener noreferrer">${newsItem.title || 'No title'}</a></h3>`;
                    } else {
                        html += `<h3 class="news-title">${newsItem.title || 'No title'}</h3>`;
                    }
                    
                    // Add emoji indicator based on sentiment
                    let sentimentEmoji = 'âšª';
                    if (newsItem.sentiment === 'positive') {
                        sentimentEmoji = 'ðŸŸ¢';
                    } else if (newsItem.sentiment === 'negative') {
                        sentimentEmoji = 'ðŸ”´';
                    }
                    
                    html += `<span class="sentiment-badge ${sentimentClass}">${sentimentEmoji} ${sentimentLabel}`;
                    if (sentimentScore !== null) {
                        const scoreSign = sentimentScore >= 0 ? '+' : '';
                        html += `<span class="sentiment-score">${scoreSign}${sentimentScore.toFixed(2)}</span>`;
                    }
                    html += '</span>';
                    
                    // Add impact score stars (original)
                    if (newsItem.impact_score !== undefined && newsItem.impact_score > 0) {
                        const stars = getImpactStars(newsItem.impact_score);
                        if (stars) {
                            html += `<span class="impact-score-stars" style="margin-left: 8px;" title="Impact Score: ${newsItem.impact_score.toFixed(1)}/100">${stars}</span>`;
                        }
                    }
                    
                    // Add news type badge
                    if (newsItem.news_type && newsItem.news_type !== 'other') {
                        const typeLabels = {
                            'earnings': 'ðŸ“Š Earnings',
                            'product_launch': 'ðŸš€ Product Launch',
                            'regulatory': 'âš–ï¸ Regulatory',
                            'm_a': 'ðŸ¤ M&A',
                            'management': 'ðŸ‘” Management',
                            'financial': 'ðŸ’° Financial',
                            'partnership': 'ðŸ¤ Partnership',
                            'guidance': 'ðŸ“ˆ Guidance'
                        };
                        const typeLabel = typeLabels[newsItem.news_type] || newsItem.news_type;
                        html += `<span class="news-type-badge" style="background: rgba(102, 126, 234, 0.1); color: #667eea; padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 600; margin-left: 8px;">${typeLabel}</span>`;
                    }
                    
                    html += '</div>';
                    
                    if (newsItem.summary && newsItem.summary !== 'No summary available') {
                        html += `<p class="news-summary">${newsItem.summary}</p>`;
                    }
                    
                    // Meta info with better formatting
                    html += '<div class="news-meta">';
                    if (newsItem.publisher && newsItem.publisher !== 'Unknown') {
                        html += `<div class="news-publisher">ðŸ“° ${newsItem.publisher}</div>`;
                    }
                    // Always show date - formatRelativeTime handles N/A and other cases
                    const relativeTime = formatRelativeTime(newsItem.published);
                    html += `<div class="news-date"><span class="news-date-icon">ðŸ“…</span><span>${relativeTime}</span></div>`;
                    html += '</div>';
                    
                    html += '</div>'; // Close news-item-text
                    html += '</div>'; // Close news-item-content
                    html += '</div>'; // Close news-item
            }

            html += '</div>'; // Close watchlist-news-group
            
            // Add Historical News Impact Patterns section
            if (newsData.historical_patterns && newsData.historical_patterns.by_type) {
                html += '<div class="card" style="margin-top: 30px; padding: 25px;">';
                html += '<h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">ðŸ“Š Historical News Impact Patterns</h3>';
                
                // By Type
                if (Object.keys(newsData.historical_patterns.by_type).length > 0) {
                    html += '<div style="margin-bottom: 25px;">';
                    html += '<h4 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1em;">Average Price Impact by News Type</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
                    
                    const typeLabels = {
                        'earnings': 'ðŸ“Š Earnings',
                        'product_launch': 'ðŸš€ Product Launch',
                        'regulatory': 'âš–ï¸ Regulatory',
                        'm_a': 'ðŸ¤ M&A',
                        'management': 'ðŸ‘” Management',
                        'financial': 'ðŸ’° Financial',
                        'partnership': 'ðŸ¤ Partnership',
                        'guidance': 'ðŸ“ˆ Guidance',
                        'other': 'ðŸ“° Other'
                    };
                    
                    for (const [newsType, data] of Object.entries(newsData.historical_patterns.by_type)) {
                        const typeLabel = typeLabels[newsType] || newsType;
                        html += '<div style="padding: 15px; background: var(--bg-card); border-radius: 10px; border: 2px solid var(--border-color);">';
                        html += `<div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">${typeLabel}</div>`;
                        html += `<div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Count: ${data.count}</div>`;
                        
                        if (data.avg_1d_pct !== null) {
                            const color1d = data.avg_1d_pct >= 0 ? '#10b981' : '#ef4444';
                            html += `<div style="color: ${color1d}; font-weight: 600;">1d: ${data.avg_1d_pct >= 0 ? '+' : ''}${data.avg_1d_pct}%</div>`;
                        }
                        if (data.avg_1w_pct !== null) {
                            const color1w = data.avg_1w_pct >= 0 ? '#10b981' : '#ef4444';
                            html += `<div style="color: ${color1w}; font-weight: 600; margin-top: 5px;">1w: ${data.avg_1w_pct >= 0 ? '+' : ''}${data.avg_1w_pct}%</div>`;
                        }
                        
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    html += '</div>';
                }
                
                // By Sentiment
                if (newsData.historical_patterns.by_sentiment && Object.keys(newsData.historical_patterns.by_sentiment).length > 0) {
                    html += '<div>';
                    html += '<h4 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1em;">Average Price Impact by Sentiment</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
                    
                    for (const [sentiment, data] of Object.entries(newsData.historical_patterns.by_sentiment)) {
                        const sentimentEmoji = sentiment === 'positive' ? 'ðŸŸ¢' : sentiment === 'negative' ? 'ðŸ”´' : 'âšª';
                        const sentimentColor = sentiment === 'positive' ? '#10b981' : sentiment === 'negative' ? '#ef4444' : '#6b7280';
                        
                        html += '<div style="padding: 15px; background: var(--bg-card); border-radius: 10px; border: 2px solid var(--border-color);">';
                        html += `<div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">${sentimentEmoji} ${sentiment.charAt(0).toUpperCase() + sentiment.slice(1)}</div>`;
                        html += `<div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Count: ${data.count}</div>`;
                        
                        if (data.avg_1d_pct !== null) {
                            html += `<div style="color: ${sentimentColor}; font-weight: 600;">1d: ${data.avg_1d_pct >= 0 ? '+' : ''}${data.avg_1d_pct}%</div>`;
                        }
                        
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        async function generateNewsAISummary() {
            const button = document.getElementById('newsAISummaryBtn');
            const container = document.getElementById('newsContent');
            
            if (!currentNewsData || !currentNewsData.news || currentNewsData.news.length === 0) {
                showToast('Please load news first', 'info');
                return;
            }
            
            // Show loading state
            if (button) {
                button.disabled = true;
                const originalText = button.innerHTML;
                button.innerHTML = 'â³ Generating Summary...';
                
                // Show loading in container
                const summaryContainer = document.getElementById('newsAISummaryContainer');
                if (summaryContainer) {
                    summaryContainer.style.display = 'block';
                    summaryContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: var(--metric-bg); border-radius: 12px; margin-bottom: 30px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 20px; color: var(--text-secondary);">Generating AI summary...</p>
                            <p style="font-size: 0.85em; color: var(--text-tertiary); margin-top: 10px;">This may take 30-60 seconds</p>
                        </div>
                    `;
                } else {
                    // Create summary container if it doesn't exist
                    const summaryDiv = document.createElement('div');
                    summaryDiv.id = 'newsAISummaryContainer';
                    summaryDiv.style.display = 'block';
                    summaryDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: var(--metric-bg); border-radius: 12px; margin-bottom: 30px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 20px; color: var(--text-secondary);">Generating AI summary...</p>
                            <p style="font-size: 0.85em; color: var(--text-tertiary); margin-top: 10px;">This may take 30-60 seconds</p>
                        </div>
                    `;
                    container.insertBefore(summaryDiv, container.firstChild);
                }
                
                try {
                    // Convert single ticker news to array format for API
                    const newsDataArray = [currentNewsData];
                    
                    const response = await fetch('/api/analyze-watchlist-summary', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            news_data: newsDataArray
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to generate AI summary');
                    }
                    
                    // Display results
                    displayNewsAISummary(data);
                    
                    showToast('AI summary generated successfully', 'success');
                    
                } catch (error) {
                    console.error('Error generating watchlist AI summary:', error);
                    const summaryContainer = document.getElementById('watchlistAISummaryContainer');
                    if (summaryContainer) {
                        summaryContainer.innerHTML = `
                            <div style="padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border-left: 4px solid #ef4444; margin-bottom: 30px;">
                                <div style="color: #ef4444; font-weight: 600; margin-bottom: 10px;">âŒ Error</div>
                                <div style="color: var(--text-secondary);">${error.message}</div>
                                <button onclick="generateWatchlistAISummary()" style="margin-top: 15px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
                            </div>
                        `;
                    }
                    showToast('Error generating AI summary', 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }
        }

        function displayWatchlistAISummary(data) {
            const container = document.getElementById('watchlistNewsContent');
            const summaryContainer = document.getElementById('watchlistAISummaryContainer');
            
            if (!summaryContainer) {
                // Create container if it doesn't exist
                const summaryDiv = document.createElement('div');
                summaryDiv.id = 'watchlistAISummaryContainer';
                summaryDiv.style.display = 'block';
                container.insertBefore(summaryDiv, container.firstChild);
            }
            
            const structured = data.structured_data || {};
            const tickerStats = data.ticker_stats || {};
            
            // Helper function to escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Color coding for sentiment
            const sentimentColors = {
                'positive': { bg: 'rgba(16, 185, 129, 0.1)', border: '#10b981', emoji: 'ðŸŸ¢' },
                'negative': { bg: 'rgba(239, 68, 68, 0.1)', border: '#ef4444', emoji: 'ðŸ”´' },
                'neutral': { bg: 'rgba(245, 158, 11, 0.1)', border: '#f59e0b', emoji: 'ðŸŸ¡' }
            };
            
            const sentimentLabels = {
                'positive': 'PozitivnÃ­',
                'negative': 'NegativnÃ­',
                'neutral': 'NeutrÃ¡lnÃ­'
            };
            
            const overallSentiment = structured.overall_sentiment || 'neutral';
            const colors = sentimentColors[overallSentiment] || sentimentColors['neutral'];
            
            // Calculate total news count
            const totalNews = Object.values(tickerStats).reduce((sum, stat) => sum + (stat.count || 0), 0);
            const tickerCount = Object.keys(tickerStats).length;
            
            let html = `
                <div style="margin-bottom: 30px; padding: 25px; background: var(--bg-card); border-radius: 15px; border: 2px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            ðŸ¤– AI Watchlist Summary
                        </h3>
                        <div style="display: flex; gap: 15px; align-items: center; font-size: 0.9em; color: var(--text-secondary);">
                            <span>${tickerCount} tickerÅ¯</span>
                            <span>â€¢</span>
                            <span>${totalNews} news</span>
                        </div>
                    </div>
                    
                    ${structured.executive_summary ? `
                        <div style="margin-bottom: 25px; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ“‹ Executive Summary</h5>
                            <p style="color: var(--text-primary); line-height: 1.7; margin: 0; white-space: pre-wrap;">${escapeHtml(structured.executive_summary)}</p>
                        </div>
                    ` : ''}
                    
                    ${structured.key_themes && structured.key_themes.length > 0 ? `
                        <div style="margin-bottom: 25px;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">ðŸŽ¯ Key Themes & Trends</h5>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${structured.key_themes.map(theme => `
                                    <li style="padding: 10px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                        <span style="position: absolute; left: 0; color: #667eea;">â†’</span>${escapeHtml(theme)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${structured.significant_events && structured.significant_events.length > 0 ? `
                        <div style="margin-bottom: 25px;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">â­ Most Significant Events</h5>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${structured.significant_events.map(event => `
                                    <li style="padding: 10px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                        <span style="position: absolute; left: 0; color: #f59e0b;">â­</span>${escapeHtml(event)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${structured.overall_sentiment ? `
                        <div style="margin-bottom: 25px; padding: 20px; background: ${colors.bg}; border-radius: 10px; border-left: 4px solid ${colors.border};">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1.1em;">
                                ${colors.emoji} Overall Watchlist Sentiment: ${sentimentLabels[overallSentiment]}
                            </h5>
                            ${structured.sentiment_explanation ? `
                                <p style="color: var(--text-primary); margin: 0; line-height: 1.6; white-space: pre-wrap;">${escapeHtml(structured.sentiment_explanation)}</p>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${structured.key_insights && structured.key_insights.length > 0 ? `
                        <div style="margin-bottom: 25px;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ’¡ Key Insights</h5>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${structured.key_insights.map(insight => `
                                    <li style="padding: 10px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                        <span style="position: absolute; left: 0; color: #10b981;">ðŸ’¡</span>${escapeHtml(insight)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${data.summary ? `
                        <div style="margin-top: 25px; padding: 20px; background: var(--metric-bg); border-radius: 10px;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ“ Full AI Summary</h5>
                            <div style="color: var(--text-primary); line-height: 1.8; white-space: pre-wrap;">${escapeHtml(data.summary)}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (summaryContainer) {
                summaryContainer.innerHTML = html;
            } else {
                // Insert at the beginning of container
                const summaryDiv = document.createElement('div');
                summaryDiv.id = 'watchlistAISummaryContainer';
                summaryDiv.innerHTML = html;
                container.insertBefore(summaryDiv, container.firstChild);
            }
        }

        // Settings Functions
        function loadSettings() {
            const container = document.getElementById('settingsContent');
            if (!container) {
                console.error('Settings container not found');
                return;
            }
            
            // Ensure settings section is visible
            const settingsSection = document.getElementById('settingsSection');
            if (settingsSection) {
                settingsSection.classList.remove('hidden');
                settingsSection.style.setProperty('display', 'block', 'important');
                settingsSection.style.removeProperty('display'); // Remove inline display to use CSS
            }

            // Load current settings from localStorage
            const darkMode = localStorage.getItem('darkMode') === 'true';
            const notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
            const soundAlertsEnabled = localStorage.getItem('soundAlertsEnabled') === 'true';
            const autoRefreshEnabled = localStorage.getItem('autoRefreshEnabled') === 'true';
            const autoRefreshInterval = parseInt(localStorage.getItem('autoRefreshInterval') || '60');

            console.log('About to set container.innerHTML, container:', container);
            container.innerHTML = `
                <!-- Appearance Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                        <span>ðŸŽ¨</span> Appearance
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                        <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Theme</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Current: ${darkMode ? 'Dark Mode' : 'Light Mode'}</div>
                        </div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="setThemeMode('light'); loadSettings();" style="flex: 1; padding: 12px 20px; background: ${!darkMode ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'var(--metric-bg)'}; color: ${!darkMode ? 'white' : 'var(--text-primary)'}; border: 2px solid ${!darkMode ? 'transparent' : 'var(--border-color)'}; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                                â˜€ï¸ Light Mode
                            </button>
                            <button onclick="setThemeMode('dark'); loadSettings();" style="flex: 1; padding: 12px 20px; background: ${darkMode ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'var(--metric-bg)'}; color: ${darkMode ? 'white' : 'var(--text-primary)'}; border: 2px solid ${darkMode ? 'transparent' : 'var(--border-color)'}; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                                ðŸŒ™ Dark Mode
                        </button>
                        </div>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                        <span>ðŸ””</span> Notifications
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Enable Notifications</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Receive browser notifications for alerts</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 60px; height: 30px;">
                                <input type="checkbox" id="settingsNotificationsEnabled" onchange="toggleNotifications(); loadSettings();" ${notificationsEnabled ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${notificationsEnabled ? '#10b981' : '#ccc'}; border-radius: 30px; transition: 0.3s;">
                                    <span style="position: absolute; content: ''; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: 0.3s; transform: translateX(${notificationsEnabled ? '26px' : '0'});"></span>
                                </span>
                            </label>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Sound Alerts</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Play sound when alerts are triggered</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 60px; height: 30px;">
                                <input type="checkbox" id="settingsSoundAlertsEnabled" onchange="toggleSoundAlerts(); loadSettings();" ${soundAlertsEnabled ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${soundAlertsEnabled ? '#10b981' : '#ccc'}; border-radius: 30px; transition: 0.3s;">
                                    <span style="position: absolute; content: ''; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: 0.3s; transform: translateX(${soundAlertsEnabled ? '26px' : '0'});"></span>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Auto Refresh Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                        <span>ðŸ”„</span> Auto Refresh
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Enable Auto Refresh</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Automatically refresh watchlist news</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 60px; height: 30px;">
                                <input type="checkbox" id="settingsAutoRefreshEnabled" onchange="toggleAutoRefresh(); loadSettings();" ${autoRefreshEnabled ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${autoRefreshEnabled ? '#10b981' : '#ccc'}; border-radius: 30px; transition: 0.3s;">
                                    <span style="position: absolute; content: ''; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: 0.3s; transform: translateX(${autoRefreshEnabled ? '26px' : '0'});"></span>
                                </span>
                            </label>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Refresh Interval</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Time between refreshes (seconds)</div>
                            </div>
                            <input type="number" id="settingsAutoRefreshInterval" value="${autoRefreshInterval}" min="10" max="600" step="10" onchange="updateAutoRefreshInterval(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); width: 100px; font-size: 1em;">
                        </div>
                    </div>
                </div>

                <!-- Data Management Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                        <span>ðŸ’¾</span> Data Management
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button onclick="exportData()" style="padding: 12px 24px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); transition: all 0.3s ease;">
                            ðŸ“¥ Export Data
                        </button>
                        <button onclick="importData()" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;">
                            ðŸ“¤ Import Data
                        </button>
                        <button onclick="clearAllData()" style="padding: 12px 24px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); transition: all 0.3s ease;">
                            ðŸ—‘ï¸ Clear All Data
                        </button>
                    </div>
                </div>

                <!-- Keyboard Shortcuts Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                        <span>âŒ¨ï¸</span> Keyboard Shortcuts
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="padding: 12px; background: var(--metric-bg); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">Navigation</div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">Quick navigation between sections</div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                                    <kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace; font-size: 0.85em;">Ctrl+1</kbd>
                                    <kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace; font-size: 0.85em;">Ctrl+2</kbd>
                                    <kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace; font-size: 0.85em;">Ctrl+3</kbd>
                                </div>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                                <div>Ctrl+1: Stock Analysis | Ctrl+2: Financials | Ctrl+3: News</div>
                                <div>Ctrl+4: Earnings | Ctrl+5: Economic Data | Ctrl+6: Portfolio</div>
                                <div>Ctrl+7: Alerts | Ctrl+8: Analyst & Insider | Ctrl+9: AI Recommendations</div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: var(--metric-bg); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">Quick Actions</div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">Common actions</div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                                    <kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace; font-size: 0.85em;">Ctrl+K</kbd>
                                    <kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace; font-size: 0.85em;">Esc</kbd>
                                    <kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace; font-size: 0.85em;">?</kbd>
                                </div>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                                <div>Ctrl+K: Focus search | Esc: Close modals | ?: Show all shortcuts</div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: var(--metric-bg); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">Chart Controls</div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary);">When chart is focused</div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                                    <kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace; font-size: 0.85em;">+/-</kbd>
                                    <kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace; font-size: 0.85em;">â†â†’</kbd>
                                </div>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                                <div>+/-: Zoom in/out | â†â†’: Pan left/right</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- About & Information Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                        <span>â„¹ï¸</span> About & Information
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">Application</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); line-height: 1.6;">
                                <div><strong>Name:</strong> Stock Analysis Tool</div>
                                <div><strong>Version:</strong> 1.0.0</div>
                                <div><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">System Information</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); line-height: 1.6;" id="systemInfo">
                                <div><strong>Browser:</strong> ${navigator.userAgent.split(' ').slice(-2).join(' ')}</div>
                                <div><strong>Screen:</strong> ${screen.width}x${screen.height}</div>
                                <div><strong>Viewport:</strong> ${window.innerWidth}x${window.innerHeight}</div>
                            </div>
                        </div>
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">Storage Usage</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); line-height: 1.6;" id="storageUsage">
                                <div>Calculating...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Default Values Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                        <span>âš™ï¸</span> Default Values
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Default Chart Timeframe</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Initial timeframe when opening charts</div>
                            </div>
                            <select id="defaultTimeframe" onchange="updateDefaultTimeframe(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1em;">
                                <option value="5d" ${localStorage.getItem('defaultTimeframe') === '5d' ? 'selected' : ''}>5 Days</option>
                                <option value="1mo" ${localStorage.getItem('defaultTimeframe') === '1mo' ? 'selected' : ''}>1 Month</option>
                                <option value="3mo" ${localStorage.getItem('defaultTimeframe') === '3mo' ? 'selected' : ''}>3 Months</option>
                                <option value="6mo" ${localStorage.getItem('defaultTimeframe') === '6mo' ? 'selected' : ''}>6 Months</option>
                                <option value="1y" ${!localStorage.getItem('defaultTimeframe') || localStorage.getItem('defaultTimeframe') === '1y' ? 'selected' : ''}>1 Year</option>
                                <option value="5y" ${localStorage.getItem('defaultTimeframe') === '5y' ? 'selected' : ''}>5 Years</option>
                            </select>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Default Chart Type</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Initial chart type (line or candlestick)</div>
                            </div>
                            <select id="defaultChartType" onchange="updateDefaultChartType(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1em;">
                                <option value="line" ${!localStorage.getItem('defaultChartType') || localStorage.getItem('defaultChartType') === 'line' ? 'selected' : ''}>Line</option>
                                <option value="candlestick" ${localStorage.getItem('defaultChartType') === 'candlestick' ? 'selected' : ''}>Candlestick</option>
                            </select>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Default News Count</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Number of news articles to show by default</div>
                            </div>
                            <input type="number" id="defaultNewsCount" value="${parseInt(localStorage.getItem('defaultNewsCount') || '10')}" min="5" max="50" step="5" onchange="updateDefaultNewsCount(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); width: 100px; font-size: 1em;">
                        </div>
                    </div>
                </div>

                <!-- Performance & Cache Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                        <span>âš¡</span> Performance & Cache
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">Cache Information</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); line-height: 1.6;" id="cacheInfo">
                                <div>Calculating cache size...</div>
                            </div>
                            <button onclick="clearCache(); loadSettings();" style="margin-top: 10px; padding: 8px 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em;">
                                ðŸ—‘ï¸ Clear Cache
                            </button>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Data Retention (days)</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">How long to keep historical data</div>
                            </div>
                            <input type="number" id="dataRetentionDays" value="${parseInt(localStorage.getItem('dataRetentionDays') || '30')}" min="7" max="365" step="7" onchange="updateDataRetention(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); width: 100px; font-size: 1em;">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Chart Quality</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Rendering quality vs performance</div>
                            </div>
                            <select id="chartQuality" onchange="updateChartQuality(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1em;">
                                <option value="high" ${localStorage.getItem('chartQuality') === 'high' ? 'selected' : ''}>High</option>
                                <option value="medium" ${!localStorage.getItem('chartQuality') || localStorage.getItem('chartQuality') === 'medium' ? 'selected' : ''}>Medium</option>
                                <option value="low" ${localStorage.getItem('chartQuality') === 'low' ? 'selected' : ''}>Low</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Privacy & Data Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                        <span>ðŸ”’</span> Privacy & Data
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">What Data is Stored Locally</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); line-height: 1.8;">
                                <div>â€¢ Search history</div>
                                <div>â€¢ Watchlist and groups</div>
                                <div>â€¢ Price alerts and notifications</div>
                                <div>â€¢ Portfolio positions</div>
                                <div>â€¢ User preferences (theme, settings)</div>
                                <div>â€¢ ML prediction history</div>
                            </div>
                        </div>
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">Clear Specific Data</div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <button onclick="clearSearchHistory(); loadSettings();" style="padding: 10px 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-weight: 600; text-align: left;">
                                    ðŸ—‘ï¸ Clear Search History
                                </button>
                                <button onclick="clearWatchlistData(); loadSettings();" style="padding: 10px 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-weight: 600; text-align: left;">
                                    ðŸ—‘ï¸ Clear Watchlist
                                </button>
                                <button onclick="clearAlertsData(); loadSettings();" style="padding: 10px 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-weight: 600; text-align: left;">
                                    ðŸ—‘ï¸ Clear Alerts
                                </button>
                                <button onclick="clearMLHistory(); loadSettings();" style="padding: 10px 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-weight: 600; text-align: left;">
                                    ðŸ—‘ï¸ Clear ML Prediction History
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Export Format</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Default format for data export</div>
                            </div>
                            <select id="exportFormat" onchange="updateExportFormat(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1em;">
                                <option value="json" ${!localStorage.getItem('exportFormat') || localStorage.getItem('exportFormat') === 'json' ? 'selected' : ''}>JSON</option>
                                <option value="csv" ${localStorage.getItem('exportFormat') === 'csv' ? 'selected' : ''}>CSV</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- UI Customization Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                        <span>ðŸŽ¨</span> UI Customization
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Sidebar Width</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Navigation sidebar width</div>
                            </div>
                            <select id="sidebarWidth" onchange="updateSidebarWidth(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1em;">
                                <option value="narrow" ${localStorage.getItem('sidebarWidth') === 'narrow' ? 'selected' : ''}>Narrow (240px)</option>
                                <option value="normal" ${!localStorage.getItem('sidebarWidth') || localStorage.getItem('sidebarWidth') === 'normal' ? 'selected' : ''}>Normal (280px)</option>
                                <option value="wide" ${localStorage.getItem('sidebarWidth') === 'wide' ? 'selected' : ''}>Wide (320px)</option>
                            </select>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Font Size</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Base font size for the application</div>
                            </div>
                            <select id="fontSize" onchange="updateFontSize(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1em;">
                                <option value="small" ${localStorage.getItem('fontSize') === 'small' ? 'selected' : ''}>Small</option>
                                <option value="normal" ${!localStorage.getItem('fontSize') || localStorage.getItem('fontSize') === 'normal' ? 'selected' : ''}>Normal</option>
                                <option value="large" ${localStorage.getItem('fontSize') === 'large' ? 'selected' : ''}>Large</option>
                            </select>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Animation Speed</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">UI animation speed</div>
                            </div>
                            <select id="animationSpeed" onchange="updateAnimationSpeed(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1em;">
                                <option value="fast" ${localStorage.getItem('animationSpeed') === 'fast' ? 'selected' : ''}>Fast</option>
                                <option value="normal" ${!localStorage.getItem('animationSpeed') || localStorage.getItem('animationSpeed') === 'normal' ? 'selected' : ''}>Normal</option>
                                <option value="slow" ${localStorage.getItem('animationSpeed') === 'slow' ? 'selected' : ''}>Slow</option>
                                <option value="off" ${localStorage.getItem('animationSpeed') === 'off' ? 'selected' : ''}>Off</option>
                            </select>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Card Spacing</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Spacing between cards</div>
                            </div>
                            <select id="cardSpacing" onchange="updateCardSpacing(); loadSettings();" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1em;">
                                <option value="compact" ${localStorage.getItem('cardSpacing') === 'compact' ? 'selected' : ''}>Compact</option>
                                <option value="normal" ${!localStorage.getItem('cardSpacing') || localStorage.getItem('cardSpacing') === 'normal' ? 'selected' : ''}>Normal</option>
                                <option value="relaxed" ${localStorage.getItem('cardSpacing') === 'relaxed' ? 'selected' : ''}>Relaxed</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            // Update dynamic content
            updateStorageUsage();
            updateCacheInfo();            const computedAfter = window.getComputedStyle(container);
            
            console.log('Settings content loaded, container.innerHTML length:', container.innerHTML.length);
            console.log('Settings content preview:', container.innerHTML.substring(0, 200));
            
            // Force reflow after content is loaded
            const settingsSectionEl = document.getElementById('settingsSection');
            if (settingsSectionEl) {
                settingsSectionEl.offsetHeight; // Force reflow                const sectionComputed = window.getComputedStyle(settingsSectionEl);
                const cardEl = settingsSectionEl.querySelector('.card');
                const cardComputedAfter = cardEl ? window.getComputedStyle(cardEl) : null;
                
                console.log('After content load - settingsSection offsetHeight:', settingsSectionEl.offsetHeight, 'scrollHeight:', settingsSectionEl.scrollHeight, 'clientHeight:', settingsSectionEl.clientHeight);
                
                // If still 0, force display again
                if (settingsSectionEl.offsetHeight === 0) {                    const beforeForce = window.getComputedStyle(settingsSectionEl);
                    
                    console.log('Still 0 height after content load, forcing again...');
                    settingsSectionEl.style.setProperty('display', 'block', 'important');
                    settingsSectionEl.style.setProperty('min-height', '500px', 'important');
                    const card = settingsSectionEl.querySelector('.card');
                    if (card) {
                        card.style.setProperty('min-height', '500px', 'important');
                        card.style.setProperty('display', 'block', 'important');
                    }
                    settingsSectionEl.offsetHeight; // Force reflow again                    const afterForce = window.getComputedStyle(settingsSectionEl);
                    
                    console.log('After second force - offsetHeight:', settingsSectionEl.offsetHeight);
                }
            }
        }
        
        // Make loadSettings globally available
        window.loadSettings = loadSettings;

        // Storage Usage Calculation
        function updateStorageUsage() {
            const storageUsageEl = document.getElementById('storageUsage');
            if (!storageUsageEl) return;
            
            try {
                let totalSize = 0;
                const items = {};
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    const size = new Blob([value]).size;
                    totalSize += size;
                    items[key] = size;
                }
                
                const formatBytes = (bytes) => {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                };
                
                const topItems = Object.entries(items)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([key, size]) => `<div><strong>${key}:</strong> ${formatBytes(size)}</div>`)
                    .join('');
                
                storageUsageEl.innerHTML = `
                    <div><strong>Total:</strong> ${formatBytes(totalSize)}</div>
                    <div style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;">Top items:</div>
                    ${topItems}
                `;
            } catch (e) {
                storageUsageEl.innerHTML = '<div style="color: #ef4444;">Error calculating storage usage</div>';
            }
        }

        // Cache Info Calculation
        function updateCacheInfo() {
            const cacheInfoEl = document.getElementById('cacheInfo');
            if (!cacheInfoEl) return;
            
            try {
                let cacheSize = 0;
                let cacheCount = 0;
                
                // Check ML predictions cache
                const mlCacheKeys = Object.keys(localStorage).filter(k => k.startsWith('ml_prediction_') || k.includes('prediction'));
                cacheCount += mlCacheKeys.length;
                mlCacheKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) cacheSize += new Blob([value]).size;
                });
                
                const formatBytes = (bytes) => {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                };
                
                cacheInfoEl.innerHTML = `
                    <div><strong>Cache Size:</strong> ${formatBytes(cacheSize)}</div>
                    <div><strong>Cache Items:</strong> ${cacheCount}</div>
                `;
            } catch (e) {
                cacheInfoEl.innerHTML = '<div style="color: #ef4444;">Error calculating cache info</div>';
            }
        }

        // Clear Cache
        function clearCache() {
            if (!confirm('Are you sure you want to clear all cache? This will remove cached prediction data.')) {
                return;
            }
            
            try {
                const keysToRemove = Object.keys(localStorage).filter(k => 
                    k.startsWith('ml_prediction_') || 
                    k.includes('prediction') ||
                    k.includes('cache')
                );
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                showToast('Cache cleared successfully', 'success');
                updateCacheInfo();
            } catch (e) {
                showToast('Error clearing cache', 'error');
            }
        }

        // Default Values Functions
        function updateDefaultTimeframe() {
            const value = document.getElementById('defaultTimeframe')?.value;
            if (value) {
                localStorage.setItem('defaultTimeframe', value);
                showToast('Default timeframe updated', 'success');
            }
        }

        function updateDefaultChartType() {
            const value = document.getElementById('defaultChartType')?.value;
            if (value) {
                localStorage.setItem('defaultChartType', value);
                showToast('Default chart type updated', 'success');
            }
        }

        function updateDefaultNewsCount() {
            const value = parseInt(document.getElementById('defaultNewsCount')?.value);
            if (value && value >= 5 && value <= 50) {
                localStorage.setItem('defaultNewsCount', value.toString());
                showToast('Default news count updated', 'success');
            }
        }

        // Performance & Cache Functions
        function updateDataRetention() {
            const value = parseInt(document.getElementById('dataRetentionDays')?.value);
            if (value && value >= 7 && value <= 365) {
                localStorage.setItem('dataRetentionDays', value.toString());
                showToast('Data retention updated', 'success');
                cleanupOldData();
            }
        }

        function updateChartQuality() {
            const value = document.getElementById('chartQuality')?.value;
            if (value) {
                localStorage.setItem('chartQuality', value);
                showToast('Chart quality updated', 'success');
            }
        }

        function cleanupOldData() {
            const retentionDays = parseInt(localStorage.getItem('dataRetentionDays') || '30');
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
            const cutoffTimestamp = Math.floor(cutoffDate.getTime() / 1000);
            
            try {
                const keysToCheck = Object.keys(localStorage).filter(k => k.includes('timestamp') || k.includes('history'));
                let cleaned = 0;
                
                keysToCheck.forEach(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data.timestamp && data.timestamp < cutoffTimestamp) {
                            localStorage.removeItem(key);
                            cleaned++;
                        }
                    } catch (e) {
                        // Not JSON, skip
                    }
                });
                
                if (cleaned > 0) {
                    showToast(`Cleaned ${cleaned} old data entries`, 'success');
                }
            } catch (e) {
                console.error('Error cleaning old data:', e);
            }
        }

        // Privacy & Data Functions
        function clearSearchHistory() {
            if (!confirm('Clear all search history?')) return;
            localStorage.removeItem('searchHistory');
            localStorage.removeItem('recentSearches');
            showToast('Search history cleared', 'success');
        }

        function clearWatchlistData() {
            if (!confirm('Clear all watchlist data? This cannot be undone.')) return;
            localStorage.removeItem('watchlist');
            localStorage.removeItem('stockWatchlist');
            showToast('Watchlist cleared', 'success');
        }

        function clearAlertsData() {
            if (!confirm('Clear all alerts? This cannot be undone.')) return;
            localStorage.removeItem('priceAlerts');
            localStorage.removeItem('newsAlerts');
            showToast('Alerts cleared', 'success');
        }

        function clearMLHistory() {
            if (!confirm('Clear all ML prediction history? This cannot be undone.')) return;
            const mlKeys = Object.keys(localStorage).filter(k => k.includes('prediction') || k.includes('ml'));
            mlKeys.forEach(key => localStorage.removeItem(key));
            showToast('ML history cleared', 'success');
        }

        function updateExportFormat() {
            const value = document.getElementById('exportFormat')?.value;
            if (value) {
                localStorage.setItem('exportFormat', value);
                showToast('Export format updated', 'success');
            }
        }

        // UI Customization Functions
        function updateSidebarWidth() {
            const value = document.getElementById('sidebarWidth')?.value;
            if (value) {
                localStorage.setItem('sidebarWidth', value);
                const widths = { narrow: '240px', normal: '280px', wide: '320px' };
                const sidebar = document.getElementById('sidebar');
                const container = document.querySelector('.container');
                if (sidebar) sidebar.style.width = widths[value];
                if (container && window.innerWidth > 1024) {
                    container.style.marginLeft = widths[value];
                }
                showToast('Sidebar width updated', 'success');
            }
        }

        function updateFontSize() {
            const value = document.getElementById('fontSize')?.value;
            if (value) {
                localStorage.setItem('fontSize', value);
                const sizes = { small: '14px', normal: '16px', large: '18px' };
                document.documentElement.style.setProperty('--font-size-base', sizes[value]);
                showToast('Font size updated', 'success');
            }
        }

        function updateAnimationSpeed() {
            const value = document.getElementById('animationSpeed')?.value;
            if (value) {
                localStorage.setItem('animationSpeed', value);
                const speeds = { fast: '0.15s', normal: '0.3s', slow: '0.6s', off: '0s' };
                document.documentElement.style.setProperty('--transition-speed', speeds[value]);
                showToast('Animation speed updated', 'success');
            }
        }

        function updateCardSpacing() {
            const value = document.getElementById('cardSpacing')?.value;
            if (value) {
                localStorage.setItem('cardSpacing', value);
                const spacings = { compact: '15px', normal: '30px', relaxed: '45px' };
                document.documentElement.style.setProperty('--card-spacing', spacings[value]);
                showToast('Card spacing updated', 'success');
            }
        }

        // Keyboard Shortcuts Implementation
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Don't trigger if typing in input/textarea
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    if (e.key === 'Escape') {
                        const modals = document.querySelectorAll('[style*="display: block"][style*="position: fixed"]');
                        modals.forEach(modal => {
                            if (modal.id && modal.id.includes('Modal')) {
                                modal.style.display = 'none';
                            }
                        });
                    }
                    return;
                }
                
                // Ctrl+K: Focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.getElementById('globalSearchInput') || document.getElementById('tickerInput');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }
                
                // ?: Show shortcuts help
                if (e.key === '?' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                    e.preventDefault();
                    showShortcutsHelp();
                }
                
                // Ctrl+1-9: Navigate to sections
                if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '9') {
                    e.preventDefault();
                    const sectionMap = {
                        '1': 'stockAnalysisSection',
                        '2': 'financialsSection',
                        '3': 'newsSection',
                        '4': 'earningsCalendarSection',
                        '5': 'economicCalendarSection',
                        '6': 'portfolioSection',
                        '7': 'alertsDashboardSection',
                        '8': 'analystInsiderSection',
                        '9': 'aiRecommendationsSection'
                    };
                    const sectionId = sectionMap[e.key];
                    if (sectionId && typeof navigateToSection === 'function') {
                        navigateToSection(sectionId);
                    }
                }
            });
        }

        function showShortcutsHelp() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 16px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative;">
                    <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 2em; color: var(--text-secondary); cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">Ã—</button>
                    <h2 style="margin: 0 0 20px 0; color: var(--text-primary);">âŒ¨ï¸ Keyboard Shortcuts</h2>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div>
                            <h3 style="color: var(--text-primary); margin-bottom: 10px;">Navigation</h3>
                            <div style="font-size: 0.9em; color: var(--text-secondary); line-height: 1.8;">
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Ctrl+1</kbd> Stock Analysis</div>
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Ctrl+2</kbd> Financials</div>
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Ctrl+3</kbd> News</div>
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Ctrl+4</kbd> Earnings Calendar</div>
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Ctrl+5</kbd> Economic Data</div>
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Ctrl+6</kbd> Portfolio</div>
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Ctrl+7</kbd> Alerts Dashboard</div>
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Ctrl+8</kbd> Analyst & Insider</div>
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Ctrl+9</kbd> AI Recommendations</div>
                            </div>
                        </div>
                        <div>
                            <h3 style="color: var(--text-primary); margin-bottom: 10px;">Quick Actions</h3>
                            <div style="font-size: 0.9em; color: var(--text-secondary); line-height: 1.8;">
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Ctrl+K</kbd> Focus search</div>
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">Esc</kbd> Close modals</div>
                                <div><kbd style="padding: 4px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; font-family: monospace;">?</kbd> Show this help</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            modal.onclick = function(e) {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }

        // Initialize keyboard shortcuts on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initKeyboardShortcuts);
        } else {
            initKeyboardShortcuts();
        }

        // Apply UI customization on page load
        function applyUICustomization() {
            const sidebarWidth = localStorage.getItem('sidebarWidth');
            if (sidebarWidth) {
                const widths = { narrow: '240px', normal: '280px', wide: '320px' };
                const sidebar = document.getElementById('sidebar');
                const container = document.querySelector('.container');
                if (sidebar) sidebar.style.width = widths[sidebarWidth];
                if (container && window.innerWidth > 1024) {
                    container.style.marginLeft = widths[sidebarWidth];
                }
            }
            
            const fontSize = localStorage.getItem('fontSize');
            if (fontSize) {
                const sizes = { small: '14px', normal: '16px', large: '18px' };
                document.documentElement.style.setProperty('--font-size-base', sizes[fontSize]);
            }
            
            const animationSpeed = localStorage.getItem('animationSpeed');
            if (animationSpeed) {
                const speeds = { fast: '0.15s', normal: '0.3s', slow: '0.6s', off: '0s' };
                document.documentElement.style.setProperty('--transition-speed', speeds[animationSpeed]);
            }
            
            const cardSpacing = localStorage.getItem('cardSpacing');
            if (cardSpacing) {
                const spacings = { compact: '15px', normal: '30px', relaxed: '45px' };
                document.documentElement.style.setProperty('--card-spacing', spacings[cardSpacing]);
            }
        }

        // Apply UI customization on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', applyUICustomization);
        } else {
            applyUICustomization();
        }

        // Data Management Functions
        function exportData() {
            try {
                const data = {
                    darkMode: localStorage.getItem('darkMode'),
                    notificationsEnabled: localStorage.getItem('notificationsEnabled'),
                    soundAlertsEnabled: localStorage.getItem('soundAlertsEnabled'),
                    autoRefreshEnabled: localStorage.getItem('autoRefreshEnabled'),
                    autoRefreshInterval: localStorage.getItem('autoRefreshInterval'),
                    stockWatchlist: localStorage.getItem('stockWatchlist'),
                    priceAlerts: localStorage.getItem('priceAlerts'),
                    newsAlerts: localStorage.getItem('newsAlerts'),
                    portfolioPositions: localStorage.getItem('portfolioPositions'),
                    recentSearches: localStorage.getItem('recentSearches'),
                    favoriteTickers: localStorage.getItem('favoriteTickers'),
                    alertsHistory: localStorage.getItem('alertsHistory'),
                    readNewsIds: localStorage.getItem('readNewsIds'),
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `stock-analysis-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast('Data exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast('Failed to export data', 'error');
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // Confirm before importing
                        if (!confirm('This will overwrite your current data. Are you sure you want to continue?')) {
                            return;
                        }

                        // Import all available data
                        if (data.darkMode !== undefined) localStorage.setItem('darkMode', data.darkMode);
                        if (data.notificationsEnabled !== undefined) localStorage.setItem('notificationsEnabled', data.notificationsEnabled);
                        if (data.soundAlertsEnabled !== undefined) localStorage.setItem('soundAlertsEnabled', data.soundAlertsEnabled);
                        if (data.autoRefreshEnabled !== undefined) localStorage.setItem('autoRefreshEnabled', data.autoRefreshEnabled);
                        if (data.autoRefreshInterval !== undefined) localStorage.setItem('autoRefreshInterval', data.autoRefreshInterval);
                        if (data.stockWatchlist !== undefined) localStorage.setItem('stockWatchlist', data.stockWatchlist);
                        if (data.priceAlerts !== undefined) localStorage.setItem('priceAlerts', data.priceAlerts);
                        if (data.newsAlerts !== undefined) localStorage.setItem('newsAlerts', data.newsAlerts);
                        if (data.portfolioPositions !== undefined) localStorage.setItem('portfolioPositions', data.portfolioPositions);
                        if (data.recentSearches !== undefined) localStorage.setItem('recentSearches', data.recentSearches);
                        if (data.favoriteTickers !== undefined) localStorage.setItem('favoriteTickers', data.favoriteTickers);
                        if (data.alertsHistory !== undefined) localStorage.setItem('alertsHistory', data.alertsHistory);
                        if (data.readNewsIds !== undefined) localStorage.setItem('readNewsIds', data.readNewsIds);

                        showToast('Data imported successfully', 'success');
                        
                        // Reload settings to show updated values
                        if (document.getElementById('settingsSection') && !document.getElementById('settingsSection').classList.contains('hidden')) {
                            loadSettings();
                        }
                        
                        // Reload dark mode if changed
                        if (data.darkMode !== undefined) {
                            initDarkMode();
                        }
                    } catch (error) {
                        console.error('Error importing data:', error);
                        showToast('Failed to import data. Invalid file format.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                return;
            }

            if (!confirm('This will delete your watchlist, alerts, portfolio, and all other data. Are you absolutely sure?')) {
                return;
            }

            try {
                // Clear all localStorage data
                localStorage.removeItem('darkMode');
                localStorage.removeItem('notificationsEnabled');
                localStorage.removeItem('soundAlertsEnabled');
                localStorage.removeItem('autoRefreshEnabled');
                localStorage.removeItem('autoRefreshInterval');
                localStorage.removeItem('stockWatchlist');
                localStorage.removeItem('priceAlerts');
                localStorage.removeItem('newsAlerts');
                localStorage.removeItem('portfolioPositions');
                localStorage.removeItem('recentSearches');
                localStorage.removeItem('favoriteTickers');
                localStorage.removeItem('alertsHistory');
                localStorage.removeItem('readNewsIds');

                showToast('All data cleared successfully', 'success');
                
                // Reload settings
                if (document.getElementById('settingsSection') && !document.getElementById('settingsSection').classList.contains('hidden')) {
                    loadSettings();
                }
                
                // Reset dark mode to default
                initDarkMode();
            } catch (error) {
                console.error('Error clearing data:', error);
                showToast('Failed to clear data', 'error');
            }
        }

        // Alerts Dashboard Functions
        let allAlertsData = {
            price_alerts: [],
            earnings_alerts: [],
            news_alerts: [],
            tracked_news_tickers: []
        };
        let currentAlertsFilter = 'all';
        let showingAlertsHistory = false;

        // Alert History Functions
        function getAlertsHistory() {
            try {
                const history = localStorage.getItem('alertsHistory');
                return history ? JSON.parse(history) : [];
            } catch (error) {
                console.error('Error loading alerts history:', error);
                return [];
            }
        }

        function saveAlertToHistory(alertData) {
            try {
                const history = getAlertsHistory();
                const alertEntry = {
                    id: Date.now() + Math.random(),
                    timestamp: new Date().toISOString(),
                    type: alertData.type, // 'notification', 'sound', 'price', 'earnings', 'news'
                    ticker: alertData.ticker || '',
                    title: alertData.title || '',
                    message: alertData.message || '',
                    sentiment: alertData.sentiment || null,
                    impact_score: alertData.impact_score || null,
                    link: alertData.link || null,
                    priority: alertData.priority || 'normal',
                    data: alertData.data || {}
                };
                
                history.unshift(alertEntry); // Add to beginning
                
                // Keep only last 500 alerts
                if (history.length > 500) {
                    history.splice(500);
                }
                
                localStorage.setItem('alertsHistory', JSON.stringify(history));
                
                // Update badge if history view is active
                if (showingAlertsHistory) {
                    showAlertsHistory();
                }
            } catch (error) {
                console.error('Error saving alert to history:', error);
            }
        }

        function clearAlertsHistory() {
            if (confirm('Are you sure you want to clear all alert history? This cannot be undone.')) {
                localStorage.removeItem('alertsHistory');
                if (showingAlertsHistory) {
                    showAlertsHistory();
                } else {
                    loadAlertsDashboard();
                }
            }
        }

        function deleteAlertFromHistory(alertId) {
            try {
                console.log('Deleting alert with ID:', alertId, typeof alertId);
                
                const history = getAlertsHistory();
                console.log('Current history length:', history.length);
                
                const initialLength = history.length;
                const filteredHistory = history.filter(alert => {
                    // Compare both as numbers and strings to handle type mismatches
                    const alertIdStr = String(alert.id);
                    const deleteIdStr = String(alertId);
                    const matches = alertIdStr === deleteIdStr || alert.id === alertId;
                    if (matches) {
                        console.log('Found matching alert:', alert.id, alert.title);
                    }
                    return !matches;
                });
                
                console.log('Filtered history length:', filteredHistory.length);
                
                if (filteredHistory.length === initialLength) {
                    console.warn('Alert not found in history. ID:', alertId);
                    alert('Alert not found in history.');
                    return;
                }
                
                localStorage.setItem('alertsHistory', JSON.stringify(filteredHistory));
                console.log('Alert deleted successfully. New history length:', filteredHistory.length);
                
                // Refresh history view
                if (showingAlertsHistory) {
                    showAlertsHistory();
                } else {
                    // If not showing history, refresh dashboard
                    loadAlertsDashboard();
                }
            } catch (error) {
                console.error('Error deleting alert from history:', error);
                alert('Error deleting alert: ' + error.message);
            }
        }

        function showAlertsHistory() {
            showingAlertsHistory = true;
            const container = document.getElementById('alertsDashboardContent');
            if (!container) return;

            const history = getAlertsHistory();
            
            // Update button state
            const historyBtn = document.getElementById('alertsHistoryBtn');
            if (historyBtn) {
                historyBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                historyBtn.textContent = 'ðŸ“œ Alert History (Active)';
            }

            if (history.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 3em; margin-bottom: 20px;">ðŸ“œ</div>
                        <h3>No Alert History</h3>
                        <p>Alert history will appear here when you receive notifications or sound alerts from your watchlist.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; color: var(--text-secondary);">
                    <strong>Total History Entries:</strong> ${history.length}
                </div>
            `;

            for (const alert of history) {
                const date = new Date(alert.timestamp);
                const timeAgo = formatRelativeTime(alert.timestamp);
                
                let typeIcon = 'ðŸ””';
                let typeColor = '#667eea';
                if (alert.type === 'notification') {
                    typeIcon = 'ðŸ“±';
                    typeColor = '#10b981';
                } else if (alert.type === 'sound') {
                    typeIcon = 'ðŸ”Š';
                    typeColor = '#f59e0b';
                } else if (alert.type === 'price') {
                    typeIcon = 'ðŸ’°';
                    typeColor = '#667eea';
                } else if (alert.type === 'earnings') {
                    typeIcon = 'ðŸ“…';
                    typeColor = '#f59e0b';
                } else if (alert.type === 'news') {
                    typeIcon = 'ðŸ“°';
                    typeColor = alert.sentiment === 'negative' ? '#ef4444' : (alert.sentiment === 'positive' ? '#10b981' : '#667eea');
                }

                let sentimentBadge = '';
                if (alert.sentiment) {
                    const sentimentEmoji = alert.sentiment === 'positive' ? 'ðŸŸ¢' : (alert.sentiment === 'negative' ? 'ðŸ”´' : 'âšª');
                    sentimentBadge = `<span style="padding: 4px 10px; background: rgba(${alert.sentiment === 'positive' ? '16, 185, 129' : (alert.sentiment === 'negative' ? '239, 68, 68' : '102, 126, 234')}, 0.1); color: ${alert.sentiment === 'positive' ? '#10b981' : (alert.sentiment === 'negative' ? '#ef4444' : '#667eea')}; border-radius: 12px; font-size: 0.85em; font-weight: 600; margin-left: 10px;">${sentimentEmoji} ${alert.sentiment}</span>`;
                }

                let impactStars = '';
                if (alert.impact_score && alert.impact_score > 0) {
                    const stars = getImpactStars(alert.impact_score);
                    if (stars) {
                        impactStars = `<span style="margin-left: 10px; font-size: 1.1em;">${stars}</span>`;
                    }
                }

                // Price alert specific details
                let priceDetails = '';
                if (alert.type === 'price' && alert.data) {
                    const targetPrice = alert.data.targetPrice;
                    const currentPrice = alert.data.currentPrice;
                    const condition = alert.data.condition;
                    const conditionText = condition === 'above' ? 'above' : 'below';
                    if (targetPrice && currentPrice) {
                        priceDetails = `
                            <div style="margin-top: 8px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 0.9em;">
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <div><strong>Target:</strong> $${targetPrice.toFixed(2)}</div>
                                    <div><strong>Current:</strong> $${currentPrice.toFixed(2)}</div>
                                    <div><strong>Condition:</strong> ${conditionText}</div>
                                    ${currentPrice >= targetPrice && condition === 'above' ? '<span style="color: #10b981; font-weight: 600;">âœ“ Target Reached</span>' : ''}
                                    ${currentPrice <= targetPrice && condition === 'below' ? '<span style="color: #10b981; font-weight: 600;">âœ“ Target Reached</span>' : ''}
                                </div>
                            </div>
                        `;
                    }
                }

                html += `
                    <div class="alert-item" style="margin-bottom: 15px; padding: 15px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border-color); border-left: 4px solid ${typeColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 1.5em;">${typeIcon}</span>
                                    <div style="font-weight: 600; font-size: 1.1em; color: var(--text-primary);">
                                        ${alert.ticker ? `${alert.ticker} - ` : ''}${alert.title || 'Alert'}
                                    </div>
                                    ${sentimentBadge}
                                    ${impactStars}
                                </div>
                                ${alert.message ? `<div style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 8px; line-height: 1.5;">${alert.message}</div>` : ''}
                                ${priceDetails}
                                <div style="display: flex; gap: 15px; align-items: center; font-size: 0.85em; color: var(--text-tertiary); margin-top: 8px;">
                                    <span>ðŸ“… ${date.toLocaleString()}</span>
                                    <span>(${timeAgo})</span>
                                    ${alert.priority === 'high' ? '<span style="padding: 3px 8px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border-radius: 8px; font-weight: 600;">HIGH PRIORITY</span>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                ${alert.link ? `<a href="${alert.link}" target="_blank" rel="noopener noreferrer" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; text-decoration: none; white-space: nowrap;">View â†’</a>` : (alert.type === 'price' && alert.ticker ? `<button onclick="loadAlertsStock('${alert.ticker}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">View Stock â†’</button>` : '')}
                                <button onclick="deleteAlertFromHistory(${JSON.stringify(alert.id)})" style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; white-space: nowrap; transition: all 0.2s; display: flex; align-items: center; gap: 4px;" title="Delete this alert" onmouseover="this.style.background='#dc2626'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#ef4444'; this.style.transform='scale(1)'">
                                    ðŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        async function loadAlertsDashboard() {
            const container = document.getElementById('alertsDashboardContent');
            if (!container) {
                console.error('alertsDashboardContent container not found');
                return;
            }
            console.log('Loading alerts dashboard...');
            
            container.innerHTML = `
                <div class="skeleton-card">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-news-item"></div>
                    <div class="skeleton skeleton-news-item"></div>
                    <div class="skeleton skeleton-news-item"></div>
                </div>
            `;

            try {
                // Get watchlist
                const allTickers = getAllTickers();

                // Get price alerts from localStorage
                loadPriceAlerts();
                allAlertsData.price_alerts = priceAlerts.filter(alert => !alert.triggered);

                // Get news alerts tickers from localStorage
                allAlertsData.tracked_news_tickers = getNewsAlerts();

                // Fetch earnings and news alerts from backend (only if watchlist exists)
                if (allTickers.length > 0) {
                const response = await fetch('/api/alerts-dashboard', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                        body: JSON.stringify({ watchlist: allTickers })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to load alerts`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                allAlertsData.earnings_alerts = data.earnings_alerts || [];
                allAlertsData.news_alerts = data.news_alerts || [];
                } else {
                    // No watchlist, but still show tracked news tickers and price alerts
                    allAlertsData.earnings_alerts = [];
                    allAlertsData.news_alerts = [];
                }

                // Reset filter to 'all' if not showing history
                if (!showingAlertsHistory) {
                    currentAlertsFilter = 'all';
                    document.querySelectorAll('.alerts-filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.getAttribute('data-filter') === 'all') {
                            btn.classList.add('active');
                        }
                    });
                    displayAlertsDashboard();
                } else {
                    showAlertsHistory();
                }
                
                // Reset history button state
                const historyBtn = document.getElementById('alertsHistoryBtn');
                if (historyBtn && !showingAlertsHistory) {
                    historyBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    historyBtn.textContent = 'ðŸ“œ Alert History';
                }
            } catch (error) {
                console.error('Alerts dashboard error:', error);
                container.innerHTML = `
                    <div class="error">
                        Error loading alerts: ${error.message}<br><br>
                        <button onclick="loadAlertsDashboard()" style="margin-top: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        }

        function filterAlerts(filter) {
            currentAlertsFilter = filter;
            
            // Update active button
            document.querySelectorAll('.alerts-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-filter') === filter) {
                    btn.classList.add('active');
                }
            });

            displayAlertsDashboard();
        }

        function displayAlertsDashboard() {
            const container = document.getElementById('alertsDashboardContent');
            if (!container) return;

            // Filter alerts based on current filter
            let priceAlerts = allAlertsData.price_alerts || [];
            let earningsAlerts = allAlertsData.earnings_alerts || [];
            let newsAlerts = allAlertsData.news_alerts || [];
            let trackedNewsTickers = allAlertsData.tracked_news_tickers || [];

            if (currentAlertsFilter === 'price') {
                earningsAlerts = [];
                newsAlerts = [];
                trackedNewsTickers = [];
            } else if (currentAlertsFilter === 'earnings') {
                priceAlerts = [];
                newsAlerts = [];
                trackedNewsTickers = [];
            } else if (currentAlertsFilter === 'news') {
                priceAlerts = [];
                earningsAlerts = [];
            }

            const totalAlerts = priceAlerts.length + earningsAlerts.length + newsAlerts.length;
            const showTrackedTickers = (currentAlertsFilter === 'all' || currentAlertsFilter === 'news') && trackedNewsTickers.length > 0;

            if (totalAlerts === 0 && !showTrackedTickers) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 3em; margin-bottom: 20px;">ðŸ””</div>
                        <h3>No Alerts Found</h3>
                        <p>${currentAlertsFilter === 'all' ? 'No alerts available at the moment.' : `No ${currentAlertsFilter} alerts found.`}</p>
                        <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.7;">Add stocks to your watchlist and set price alerts to see them here.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; color: var(--text-secondary);">
                    <strong>Total Alerts:</strong> ${totalAlerts} 
                    ${priceAlerts.length > 0 ? `| ðŸ’° Price: ${priceAlerts.length}` : ''}
                    ${earningsAlerts.length > 0 ? `| ðŸ“… Earnings: ${earningsAlerts.length}` : ''}
                    ${newsAlerts.length > 0 ? `| ðŸ“° News: ${newsAlerts.length}` : ''}
                    ${showTrackedTickers ? `| ðŸ“‹ Tracked News: ${trackedNewsTickers.length}` : ''}
                </div>
            `;

            // Tracked News Tickers Section (show first)
            if (showTrackedTickers) {
                html += `<div style="margin-bottom: 30px;"><h3 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ“‹ Tracked News Tickers</h3>`;
                html += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">`;
                for (const ticker of trackedNewsTickers) {
                    html += `
                        <div class="alert-item" style="padding: 15px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1.1em; color: var(--text-primary); margin-bottom: 5px;">${ticker}</div>
                                <div style="color: var(--text-secondary); font-size: 0.85em;">News tracking active</div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button onclick="loadAlertsStock('${ticker}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">View</button>
                                <button onclick="removeTickerFromNewsAlerts('${ticker}'); loadAlertsDashboard();" style="padding: 8px 16px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; cursor: pointer; font-size: 0.9em;" title="Remove from News Alerts">âœ•</button>
                            </div>
                        </div>
                    `;
                }
                html += `</div></div>`;
            }

            // Price Alerts
            if (priceAlerts.length > 0) {
                html += `<div style="margin-bottom: 30px;"><h3 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ’° Price Alerts</h3>`;
                for (const alert of priceAlerts) {
                    const conditionText = alert.condition === 'above' ? 'above' : 'below';
                    html += `
                        <div class="alert-item" style="margin-bottom: 15px; padding: 15px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; font-size: 1.1em; color: var(--text-primary); margin-bottom: 5px;">${alert.ticker}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.9em;">
                                        Alert when price goes ${conditionText} $${alert.targetPrice.toFixed(2)}<br>
                                        <small>Current: $${alert.currentPrice ? alert.currentPrice.toFixed(2) : 'N/A'}</small>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <span style="padding: 5px 12px; background: rgba(16, 185, 129, 0.1); color: #10b981; border-radius: 12px; font-size: 0.85em; font-weight: 600;">Active</span>
                                    <button onclick="loadAlertsStock('${alert.ticker}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">View</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += `</div>`;
            }

            // Earnings Alerts
            if (earningsAlerts.length > 0) {
                html += `<div style="margin-bottom: 30px;"><h3 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ“… Upcoming Earnings</h3>`;
                for (const alert of earningsAlerts) {
                    const priorityClass = alert.priority === 'high' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)';
                    const priorityColor = alert.priority === 'high' ? '#ef4444' : '#f59e0b';
                    html += `
                        <div class="alert-item" style="margin-bottom: 15px; padding: 15px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; font-size: 1.1em; color: var(--text-primary); margin-bottom: 5px;">${alert.ticker} - ${alert.company_name}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.9em;">
                                        ðŸ“… ${alert.earnings_date_display}<br>
                                        <small>${alert.days_until === 0 ? 'Today' : `${alert.days_until} day${alert.days_until > 1 ? 's' : ''} away`}</small>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <span style="padding: 5px 12px; background: ${priorityClass}; color: ${priorityColor}; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${alert.priority.toUpperCase()}</span>
                                    <button onclick="loadAlertsStock('${alert.ticker}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">View</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += `</div>`;
            }

            // News Alerts
            if (newsAlerts.length > 0) {
                html += `<div style="margin-bottom: 30px;"><h3 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ“° Important News</h3>`;
                for (const alert of newsAlerts) {
                    const sentimentClass = alert.sentiment === 'positive' ? 'positive' : (alert.sentiment === 'negative' ? 'negative' : 'neutral');
                    const sentimentLabel = alert.sentiment === 'positive' ? 'ðŸ˜Š Positive' : (alert.sentiment === 'negative' ? 'ðŸ˜Ÿ Negative' : 'ðŸ˜ Neutral');
                    const priorityClass = alert.priority === 'high' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)';
                    const priorityColor = alert.priority === 'high' ? '#ef4444' : '#f59e0b';
                    html += `
                        <div class="alert-item" style="margin-bottom: 15px; padding: 15px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 1em; color: var(--text-primary); margin-bottom: 5px;">
                                        ${alert.ticker} - ${alert.title}
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 10px;">
                                        ${alert.summary || ''}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                        <span class="sentiment-badge ${sentimentClass}">${sentimentLabel}</span>
                                        ${alert.publisher ? `<span style="font-size: 0.85em; color: var(--text-tertiary);">ðŸ“° ${alert.publisher}</span>` : ''}
                                        ${alert.published ? `<span style="font-size: 0.85em; color: var(--text-tertiary);">${formatRelativeTime(alert.published)}</span>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center; margin-left: 15px;">
                                    <span style="padding: 5px 12px; background: ${priorityClass}; color: ${priorityColor}; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${alert.priority.toUpperCase()}</span>
                                    ${alert.link ? `<a href="${alert.link}" target="_blank" rel="noopener noreferrer" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; text-decoration: none;">Read</a>` : ''}
                                    <button onclick="loadAlertsStock('${alert.ticker}')" style="padding: 8px 16px; background: rgba(102, 126, 234, 0.1); color: #667eea; border: 1px solid #667eea; border-radius: 8px; cursor: pointer; font-size: 0.9em;">View Stock</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += `</div>`;
            }

            container.innerHTML = html;
        }

        function loadAlertsStock(ticker) {
            showStockAnalysis();
            document.getElementById('tickerInput').value = ticker;
            currentTimeframe = '1y';
            
            // Update timeframe buttons
            const timeframeButtons = document.querySelectorAll('.timeframe-btn');
            if (timeframeButtons.length > 0) {
                timeframeButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-period') === '1y') {
                        btn.classList.add('active');
                    }
                });
            }
            
            setTimeout(async () => {
                await searchStock();
            }, 100);
        }

        // Financials Functions
        let currentFinancialsData = null;
        let financialsPeriod = 'quarterly'; // 'quarterly' or 'annual'

        async function loadFinancials() {
            console.log('[DEBUG] loadFinancials: Function called');
            const ticker = document.getElementById('financialsTickerInput').value.trim().toUpperCase();
            console.log('[DEBUG] loadFinancials: Ticker extracted', {ticker});
            if (!ticker) {
                showError('Please enter a stock ticker');
                return;
            }

            const container = document.getElementById('financialsContent');
            container.innerHTML = `
                <div class="skeleton-card">
                    <div class="skeleton skeleton-title"></div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="skeleton skeleton-metric"></div>
                        <div class="skeleton skeleton-metric"></div>
                        <div class="skeleton skeleton-metric"></div>
                        <div class="skeleton skeleton-metric"></div>
                    </div>
                    <div class="skeleton skeleton-chart" style="margin-top: 30px;"></div>
                    <div style="margin-top: 20px;">
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                    </div>
                </div>
            `;

            try {
                // Add to recent searches
                console.log('[DEBUG] loadFinancials: Fetching financials data for', ticker);
                const result = await fetchJSON(`/api/financials/${ticker}`, {}, container);
                
                if (!result.success) {
                    return; // Error already displayed by fetchJSON
                }
                
                const data = result.data;
                trackDataTimestamp(`/api/financials/${ticker}`, result.timestamp || Date.now());
                updateDataFreshnessIndicator(result.timestamp || new Date().toISOString(), 'financialsContent');
                
                console.log('[DEBUG] loadFinancials: Data received', {
                    hasData: !!data,
                    hasForwardEstimates: !!data.forward_estimates,
                    dataKeys: Object.keys(data || {})
                });

                // Add to recent searches
                const companyName = data.company_name || ticker;
                addToRecentSearches(ticker, companyName);
                
                currentFinancialsData = data;
                
                // Debug: Check if detailed data exists
                console.log('ðŸ” [DEBUG] loadFinancials: About to call displayFinancials');
                console.log('ðŸ” [DEBUG] loadFinancials: Data keys:', Object.keys(data || {}));
                console.log('ðŸ” [DEBUG] loadFinancials: Has detailed_income_statement?', !!data?.detailed_income_statement);
                if (data?.detailed_income_statement) {
                    console.log('ðŸ” [DEBUG] loadFinancials: quarterly length:', data.detailed_income_statement.quarterly?.length || 0);
                    console.log('ðŸ” [DEBUG] loadFinancials: annual length:', data.detailed_income_statement.annual?.length || 0);
                }
                
                displayFinancials(data, ticker);
            } catch (error) {
                container.innerHTML = `
                    <div class="error">
                        Error loading financials: ${error.message}<br><br>
                        <button onclick="loadFinancials()" style="margin-top: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
                    </div>
                `;
            } finally {
                const button = document.querySelector('button[onclick*="loadFinancials"]');
                if (button && button.classList.contains('loading')) {
                    button.classList.remove('loading');
                    button.innerHTML = button.dataset.originalText || 'ðŸ” Load Financials';
                }
            }
        }

        function changeFinancialsPeriod(period) {
            financialsPeriod = period;
            document.querySelectorAll('.financials-period-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-period') === period) {
                    btn.classList.add('active');
                }
            });
            if (currentFinancialsData) {
                displayFinancials(currentFinancialsData);
            }
        }

        // Helper function to safely format numbers with toFixed
        function safeToFixed(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value) || typeof value !== 'number') {
                return null;
            }
            return value.toFixed(decimals);
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value) || typeof value !== 'number') return 'N/A';
            if (Math.abs(value) >= 1e12) return `$${(value / 1e12).toFixed(2)}T`;
            if (Math.abs(value) >= 1e9) return `$${(value / 1e9).toFixed(2)}B`;
            if (Math.abs(value) >= 1e6) return `$${(value / 1e6).toFixed(2)}M`;
            if (Math.abs(value) >= 1e3) return `$${(value / 1e3).toFixed(2)}K`;
            return `$${value.toFixed(2)}`;
        }

        function displayFinancials(data, ticker) {
            console.log('ðŸš€ [DEBUG] displayFinancials: FUNCTION CALLED with ticker:', ticker);
            const container = document.getElementById('financialsContent');
            console.log('ðŸš€ [DEBUG] displayFinancials: Container found:', !!container);
            
            if (!container) {
                console.error('âŒ [DEBUG] displayFinancials: financialsContent container not found!');
                return;
            }
            
            // Hide initial placeholder if visible
            const placeholder = container.querySelector('div[style*="text-align: center"]');
            if (placeholder) {
                placeholder.style.display = 'none';
                console.log('âœ… [DEBUG] displayFinancials: Placeholder hidden');
            }
            
            // Hide skeleton/loading content
            container.innerHTML = '';
            
            let html = '';
            
            // Validate data structure
            if (!data || typeof data !== 'object') {
                console.error('âŒ [DEBUG] displayFinancials: Invalid data structure');
                container.innerHTML = '<p style="color: var(--text-secondary);">Invalid financial data received.</p>';
                return;
            }
            
            console.log('âœ… [DEBUG] displayFinancials: Data validated, starting HTML generation...');
            
            // Ensure income_statement, cash_flow, and margins are objects if they exist
            if (data.income_statement && typeof data.income_statement !== 'object') {
                data.income_statement = {};
            }
            if (data.cash_flow && typeof data.cash_flow !== 'object') {
                data.cash_flow = {};
            }
            if (data.margins && typeof data.margins !== 'object') {
                data.margins = {};
            }
            
            const snapshot = data.executive_snapshot || {};
            const companyStage = data.company_stage || 'unknown';
            const mainVerdict = data.main_verdict_sentence || '';
            const fundamentalsVerdict = data.fundamentals_verdict || 'neutral';
            
            // Stage Badge Mapping
            const stageMap = {
                'early_stage': { icon: 'ðŸ§ª', label: 'Early-stage', color: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
                'growth': { icon: 'ðŸš€', label: 'Growth', color: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                'mature': { icon: 'ðŸ¦', label: 'Mature', color: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
                'turnaround': { icon: 'ðŸ§¯', label: 'Turnaround', color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                'unknown': { icon: 'ðŸ“Š', label: 'Unknown', color: '#6b7280', bg: 'rgba(107, 114, 128, 0.1)' }
            };
            
            const stage = stageMap[companyStage] || stageMap['unknown'];
            
            // Financials Score
            const financialsScore = data.financials_score || {};
            const scoreValue = financialsScore.score || 0;
            const scoreGrade = financialsScore.grade || 'N/A';
            const scoreColor = financialsScore.grade_color || '#6b7280';
            const scoreBreakdown = financialsScore.breakdown || {};
            
            // 1. Financials Score Widget (Left Top) + Stage Badge + Main Verdict
            const favoriteBadge = isFavorite(ticker) ? '<span style="font-size: 0.8em; margin-left: 8px;">â­</span>' : '';
            html += `
                <div style="display: grid; grid-template-columns: minmax(250px, 300px) 1fr; gap: 20px; margin-bottom: 30px;" class="financials-header-grid">
                    <!-- Financials Score Widget (Left) -->
                    <div class="card" style="background: linear-gradient(135deg, ${scoreColor}15 0%, rgba(255,255,255,0.05) 100%); border: 2px solid ${scoreColor}40; padding: 25px; text-align: center;">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                            CelkovÃ© HodnocenÃ­
                        </div>
                        <div style="font-size: 3.5em; font-weight: 800; color: ${scoreColor}; margin-bottom: 10px; line-height: 1;">
                            ${(scoreValue !== null && scoreValue !== undefined && !isNaN(scoreValue) && typeof scoreValue === 'number') ? scoreValue.toFixed(0) : 'N/A'}
                        </div>
                        <div style="font-size: 1.1em; font-weight: 700; color: ${scoreColor}; margin-bottom: 15px;">
                            ${scoreGrade}
                        </div>
                        <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 15px;">
                            z 100 bodÅ¯
                        </div>
                        ${Object.keys(scoreBreakdown).length > 0 ? `
                            <div style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 15px;">
                                <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">RozdÄ›lenÃ­:</div>
                                ${Object.entries(scoreBreakdown).map(([key, value]) => {
                                    const labels = {
                                        'revenue_growth': 'RÅ¯st trÅ¾eb',
                                        'profitability': 'Ziskovost',
                                        'cash_flow': 'Cash flow',
                                        'debt': 'Dluh',
                                        'stability': 'Stabilita',
                                        'efficiency': 'Efektivita'
                                    };
                                    const formattedValue = (value !== null && value !== undefined && !isNaN(value) && typeof value === 'number') ? value.toFixed(1) : 'N/A';
                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.75em;">
                                            <span style="color: var(--text-secondary);">${labels[key] || key}:</span>
                                            <span style="font-weight: 600; color: var(--text-primary);">${formattedValue}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Stage Badge + Main Verdict (Right) -->
                    <div class="card" style="background: linear-gradient(135deg, ${stage.bg} 0%, rgba(255,255,255,0.05) 100%); border: 2px solid ${stage.color}20;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">${stage.icon}</span>
                            <div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 3px;">Company Stage</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: ${stage.color};">
                                    ${data.company_name || ticker} ${favoriteBadge}
                                    <button class="favorite-btn" onclick="toggleFavorite('${ticker}', event)" style="margin-left: 10px; font-size: 0.6em; vertical-align: middle;" title="${isFavorite(ticker) ? 'Remove from favorites' : 'Add to favorites'}">
                                        ${isFavorite(ticker) ? 'â­' : 'â˜†'}
                                    </button>
                                </div>
                                    ${data.industry_ranking ? `
                                        <div style="margin-top: 8px; padding: 6px 12px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; display: inline-block; font-size: 0.9em; color: var(--text-primary);">
                                            <span style="font-weight: 600;">ðŸ“Š Industry Ranking:</span> ${data.industry_ranking.position}. z ${data.industry_ranking.total} firem v ${data.industry_ranking.category}
                                        </div>
                                    ` : ''}
                            </div>
                        </div>
                        <div style="padding: 8px 16px; background: ${stage.bg}; border-radius: 8px; border: 1px solid ${stage.color}40;">
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Fundamentals</div>
                            <div style="font-size: 1em; font-weight: 600; color: ${fundamentalsVerdict === 'strong' ? '#10b981' : fundamentalsVerdict === 'weak' ? '#ef4444' : '#f59e0b'};">
                                ${fundamentalsVerdict === 'strong' ? 'Strong' : fundamentalsVerdict === 'weak' ? 'Weak' : 'Neutral'}
                            </div>
                        </div>
                    </div>
                    ${mainVerdict ? `
                        <div style="padding: 25px; background: rgba(102, 126, 234, 0.05); border-radius: 12px; border-left: 4px solid #667eea; margin-top: 20px;">
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; font-weight: 600;">Fundamentals Verdict:</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary); line-height: 1.4;">
                                ${mainVerdict}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // 2. ðŸ§  Overview Section (Snapshot)
            html += `
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="display: flex; align-items: center; gap: 10px;">
                        ðŸ§  Overview
                        <span style="font-size: 0.7em; font-weight: normal; color: var(--text-secondary);">(Snapshot)</span>
                        ${data.sector_averages ? `<span style="font-size: 0.7em; font-weight: normal; color: #667eea; margin-left: auto;">ðŸ“Š Sector: ${data.sector_averages.sector} (avg from ${data.sector_averages.sample_size} companies)</span>` : ''}
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
            `;

            // Revenue
            if (snapshot.revenue_ttm) {
                const revenueYoy = snapshot.revenue_yoy || 0;
                const revenueTrend = snapshot.revenue_trend || 'stable';
                // Unified scale: Strong / Mixed / Weak
                let revenueStatus = 'Mixed';
                let statusColor = '#f59e0b';
                let statusEmoji = 'ðŸŸ¡';
                let statusText = '';
                if (revenueYoy >= 5) {
                    revenueStatus = 'Strong';
                    statusColor = '#10b981';
                    statusEmoji = 'ðŸŸ¢';
                    statusText = 'RychlÃ½ rÅ¯st trÅ¾eb';
                } else if (revenueYoy < 0) {
                    revenueStatus = 'Weak';
                    statusColor = '#ef4444';
                    statusEmoji = 'ðŸ”´';
                    statusText = 'KlesajÃ­cÃ­ trÅ¾by';
                } else {
                    statusText = 'MÃ­rnÃ½ rÅ¯st trÅ¾eb';
                }
                const trendText = revenueTrend === 'improving' ? ' (zlepÅ¡ujÃ­cÃ­ se)' : revenueTrend === 'deteriorating' ? ' (zhorÅ¡ujÃ­cÃ­ se)' : '';
                
                // Get revenue trend data for sparkline
                const revenueTrendData = (data.income_statement?.quarterly || []).slice(-8).map(q => q.revenue).filter(v => v !== null && v !== undefined);
                const revenueSparklineId = `revenue-sparkline-${Date.now()}`;
                const revenueDataStr = revenueTrendData.length > 0 ? JSON.stringify(revenueTrendData) : '';
                
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid ${statusColor}; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Revenue (TTM)</div>
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                <span class="tooltiptext" style="width: 280px; white-space: normal;">
                                    <strong>Revenue (TTM)</strong><br>
                                    CelkovÃ© trÅ¾by za poslednÃ­ch 12 mÄ›sÃ­cÅ¯ (Trailing Twelve Months).<br><br>
                                    <strong>YoY</strong> = Year-over-Year - porovnÃ¡nÃ­ s pÅ™edchozÃ­m rokem.<br><br>
                                    <strong>Co hledat:</strong> StabilnÃ­ rÅ¯st trÅ¾eb je znÃ¡mkou zdravÃ© firmy.
                                </span>
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <div style="font-size: 1.8em; font-weight: 700; color: var(--text-primary);">${formatCurrency(snapshot.revenue_ttm)}</div>
                            ${revenueTrendData.length > 0 ? `<canvas id="${revenueSparklineId}" data-sparkline="${revenueDataStr}" style="width: 80px; height: 30px; margin-left: 10px;"></canvas>` : ''}
                        </div>
                        <div style="font-size: 0.9em; color: ${statusColor}; font-weight: 600; margin-bottom: 5px;">
                            â†’ YoY ${(revenueYoy !== null && revenueYoy !== undefined && !isNaN(revenueYoy) && typeof revenueYoy === 'number') ? (revenueYoy >= 0 ? '+' : '') + revenueYoy.toFixed(1) + '%' : 'N/A'}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <div style="font-size: 0.75em; color: var(--text-tertiary);">${statusEmoji} ${revenueStatus} - ${statusText}${trendText}</div>
                        </div>
                    </div>
                `;
            }

            // Net Income
            if (snapshot.net_income_ttm !== null && snapshot.net_income_ttm !== undefined) {
                const incomeYoy = snapshot.net_income_yoy || 0;
                const incomeValue = snapshot.net_income_ttm;
                const incomeTrend = snapshot.earnings_trend || 'stable';
                // Unified scale: Strong / Mixed / Weak
                let incomeStatus = 'Mixed';
                let statusColor = '#f59e0b';
                let statusEmoji = 'ðŸŸ¡';
                let statusText = '';
                if (incomeValue >= 0) {
                    if (incomeYoy >= 10) {
                        incomeStatus = 'Strong';
                        statusColor = '#10b981';
                        statusEmoji = 'ðŸŸ¢';
                        statusText = 'RychlÃ½ rÅ¯st zisku';
                    } else if (incomeYoy >= 0) {
                        statusText = 'Zisk roste';
                    } else {
                        incomeStatus = 'Weak';
                        statusColor = '#ef4444';
                        statusEmoji = 'ðŸ”´';
                        statusText = 'Zisk klesÃ¡';
                    }
                } else {
                    // Negative earnings
                    if (incomeYoy > 0) {
                        statusText = 'ZtrÃ¡ty se zmenÅ¡ujÃ­';
                    } else if (companyStage === 'early_stage') {
                        statusText = 'ZtrÃ¡ty oÄekÃ¡vanÃ© (early-stage, heavy investment phase)';
                    } else {
                        incomeStatus = 'Weak';
                        statusColor = '#ef4444';
                        statusEmoji = 'ðŸ”´';
                        statusText = 'ZtrÃ¡ty pokraÄujÃ­';
                    }
                }
                const trendText = incomeTrend === 'improving' ? ' (zlepÅ¡ujÃ­cÃ­ se)' : incomeTrend === 'deteriorating' ? ' (zhorÅ¡ujÃ­cÃ­ se)' : '';
                
                // Get earnings trend data for sparkline
                const earningsTrendData = (data.income_statement?.quarterly || []).slice(-8).map(q => q.net_income).filter(v => v !== null && v !== undefined);
                const earningsSparklineId = `earnings-sparkline-${Date.now()}`;
                const earningsDataStr = earningsTrendData.length > 0 ? JSON.stringify(earningsTrendData) : '';
                
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid ${statusColor}; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Earnings (TTM)</div>
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                <span class="tooltiptext" style="width: 280px; white-space: normal;">
                                    <strong>Net Income / Earnings</strong><br>
                                    ÄŒistÃ½ zisk po vÅ¡ech nÃ¡kladech a danÃ­ch za poslednÃ­ch 12 mÄ›sÃ­cÅ¯.<br><br>
                                    <strong>ProÄ je dÅ¯leÅ¾itÃ©:</strong> Ukazuje, kolik firma skuteÄnÄ› vydÄ›lÃ¡vÃ¡. RÅ¯st zisku rychleji neÅ¾ trÅ¾eb = zlepÅ¡ujÃ­cÃ­ se efektivita.
                                </span>
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <div style="font-size: 1.8em; font-weight: 700; color: var(--text-primary);">${formatCurrency(incomeValue)}</div>
                            ${earningsTrendData.length > 0 ? `<canvas id="${earningsSparklineId}" data-sparkline="${earningsDataStr}" style="width: 80px; height: 30px; margin-left: 10px;"></canvas>` : ''}
                        </div>
                        <div style="font-size: 0.9em; color: ${statusColor}; font-weight: 600; margin-bottom: 5px;">
                            â†’ YoY ${(incomeYoy !== null && incomeYoy !== undefined && !isNaN(incomeYoy) && typeof incomeYoy === 'number') ? (incomeYoy >= 0 ? '+' : '') + incomeYoy.toFixed(1) + '%' : 'N/A'}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <div style="font-size: 0.75em; color: var(--text-tertiary);">${statusEmoji} ${incomeStatus} - ${statusText}${trendText}</div>
                        </div>
                    </div>
                `;
            }

            // FCF
            if (snapshot.fcf_ttm !== null && snapshot.fcf_ttm !== undefined) {
                const fcfValue = snapshot.fcf_ttm;
                const fcfMargin = snapshot.fcf_margin || 0;
                const fcfTrend = snapshot.fcf_trend || 'stable';
                // Unified scale: Strong / Mixed / Weak
                let fcfStatus = 'Mixed';
                let statusColor = '#f59e0b';
                let statusEmoji = 'ðŸŸ¡';
                let statusText = '';
                if (fcfValue >= 0) {
                    if (fcfMargin >= 20) {
                        fcfStatus = 'Strong';
                        statusColor = '#10b981';
                        statusEmoji = 'ðŸŸ¢';
                        statusText = 'VÃ½bornÃ½ FCF margin';
                    } else if (fcfMargin >= 10) {
                        statusText = 'DobrÃ½ FCF margin';
                    } else {
                        statusText = 'PozitivnÃ­ FCF, nÃ­zkÃ¡ marÅ¾e';
                    }
                } else {
                    // Negative FCF
                    if (companyStage === 'early_stage') {
                        statusText = 'NegativnÃ­ FCF oÄekÃ¡vanÃ© (early-stage, heavy investment phase)';
                    } else {
                        fcfStatus = 'Weak';
                        statusColor = '#ef4444';
                        statusEmoji = 'ðŸ”´';
                        statusText = 'NegativnÃ­ FCF (burn rate)';
                    }
                }
                const trendText = fcfTrend === 'improving' ? ' (zlepÅ¡ujÃ­cÃ­ se)' : fcfTrend === 'deteriorating' ? ' (zhorÅ¡ujÃ­cÃ­ se)' : '';
                
                // Get FCF trend data for sparkline
                const fcfTrendData = (data.cash_flow?.quarterly || []).slice(-8).map(q => q.fcf).filter(v => v !== null && v !== undefined);
                const fcfSparklineId = `fcf-sparkline-${Date.now()}`;
                const fcfDataStr = fcfTrendData.length > 0 ? JSON.stringify(fcfTrendData) : '';
                
                // Calculate burn rate if FCF is negative
                const balanceSheet = data.balance_sheet || {};
                const cash = balanceSheet.cash || 0;
                let burnRateHtml = '';
                if (fcfValue < 0 && cash > 0) {
                    const monthlyBurn = Math.abs(fcfValue) / 12; // Annual FCF converted to monthly
                    const monthsRemaining = Math.floor(cash / monthlyBurn);
                    const burnRateColor = monthsRemaining < 6 ? '#ef4444' : monthsRemaining < 12 ? '#f59e0b' : '#10b981';
                    burnRateHtml = `
                        <div style="margin-top: 10px; padding: 12px; background: ${burnRateColor}15; border-radius: 8px; border-left: 3px solid ${burnRateColor};">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">â±ï¸ Burn Rate</div>
                            <div style="font-size: 1.1em; font-weight: 600; color: ${burnRateColor};">
                                ${monthsRemaining} mÄ›sÃ­cÅ¯ pÅ™i stÃ¡vajÃ­cÃ­m cash flow
                            </div>
                            <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">
                                Cash: ${formatCurrency(cash)} | MÄ›sÃ­ÄnÃ­ burn: ${formatCurrency(monthlyBurn)}
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid ${statusColor}; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary);">FCF (TTM)</div>
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Free Cash Flow (FCF)</strong><br>
                                    PenÃ­ze, kterÃ© firmÄ› zÅ¯stanou po vÅ¡ech vÃ½dajÃ­ch vÄetnÄ› investic (CapEx).<br><br>
                                    <strong>FCF = Operating Cash Flow - Capital Expenditures</strong><br><br>
                                    <strong>ProÄ je dÅ¯leÅ¾itÃ©:</strong> FCF je skuteÄnÃ© penÃ­ze, kterÃ© mÅ¯Å¾e firma pouÅ¾Ã­t na dividendy, akvizice nebo rÅ¯st. LepÅ¡Ã­ neÅ¾ ÄistÃ½ zisk, protoÅ¾e zohledÅˆuje skuteÄnÃ½ cash flow.
                                </span>
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <div style="font-size: 1.8em; font-weight: 700; color: var(--text-primary);">${formatCurrency(fcfValue)}</div>
                            ${fcfTrendData.length > 0 ? `<canvas id="${fcfSparklineId}" data-sparkline="${fcfDataStr}" style="width: 80px; height: 30px; margin-left: 10px;"></canvas>` : ''}
                        </div>
                        <div style="font-size: 0.9em; color: ${statusColor}; font-weight: 600; margin-bottom: 5px;">
                            â†’ FCF margin ${(fcfMargin !== null && fcfMargin !== undefined && !isNaN(fcfMargin) && typeof fcfMargin === 'number' && fcfMargin >= 0) ? fcfMargin.toFixed(1) + '%' : 'N/A'}
                        </div>
                        ${burnRateHtml}
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <div style="font-size: 0.75em; color: var(--text-tertiary);">${statusEmoji} ${fcfStatus} - ${statusText}${trendText}</div>
                        </div>
                    </div>
                `;
            }

            // Gross Margin
            if (snapshot.gross_margin !== null && snapshot.gross_margin !== undefined) {
                const gm = snapshot.gross_margin;
                // Unified scale: Strong / Mixed / Weak
                let gmStatus = 'Mixed';
                let statusColor = '#f59e0b';
                let statusEmoji = 'ðŸŸ¡';
                let statusText = '';
                if (gm >= 40) {
                    gmStatus = 'Strong';
                    statusColor = '#10b981';
                    statusEmoji = 'ðŸŸ¢';
                    statusText = 'VysokÃ¡ marÅ¾e - silnÃ¡ pricing power';
                } else if (gm >= 30) {
                    statusText = 'StabilnÃ­ marÅ¾e - dobrÃ¡ kontrola nÃ¡kladÅ¯';
                } else {
                    gmStatus = 'Weak';
                    statusColor = '#ef4444';
                    statusEmoji = 'ðŸ”´';
                    statusText = 'NÃ­zkÃ¡ marÅ¾e - tlak na ziskovost';
                }
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid ${statusColor}; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Gross Margin</div>
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Gross Margin</strong><br>
                                    Procento z trÅ¾eb, kterÃ© zÅ¯stane po pÅ™Ã­mÃ½ch nÃ¡kladech (COGS).<br><br>
                                    <strong>Vzorec:</strong> (Revenue - Cost of Goods Sold) / Revenue Ã— 100<br><br>
                                    <strong>Co znamenÃ¡:</strong> VysokÃ¡ marÅ¾e = silnÃ¡ pricing power (firma mÅ¯Å¾e ÃºÄtovat vyÅ¡Å¡Ã­ ceny). StabilnÃ­ marÅ¾e = dobrÃ¡ kontrola nÃ¡kladÅ¯.
                                </span>
                            </span>
                        </div>
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">${(gm !== null && gm !== undefined && !isNaN(gm) && typeof gm === 'number') ? gm.toFixed(1) + '%' : 'N/A'}</div>
                        <div style="font-size: 0.9em; color: ${statusColor}; font-weight: 600; margin-bottom: 5px;">
                            ${statusEmoji} ${gmStatus}
                        </div>
                        <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">${statusText}</div>
                    </div>
                `;
            }

            // Debt/FCF
            if (snapshot.debt_fcf_ratio !== null && snapshot.debt_fcf_ratio !== undefined) {
                const ratio = snapshot.debt_fcf_ratio;
                // Unified scale: Strong / Mixed / Weak
                let ratioStatus = 'Mixed';
                let statusColor = '#f59e0b';
                let statusEmoji = 'ðŸŸ¡';
                let statusText = '';
                if (ratio < 2) {
                    ratioStatus = 'Strong';
                    statusColor = '#10b981';
                    statusEmoji = 'ðŸŸ¢';
                    statusText = 'NÃ­zkÃ½ dluh vzhledem k FCF';
                } else if (ratio < 4) {
                    statusText = 'StÅ™ednÃ­ dluh - pozor na vÃ½voj';
                } else {
                    ratioStatus = 'Weak';
                    statusColor = '#ef4444';
                    statusEmoji = 'ðŸ”´';
                    statusText = 'VysokÃ½ dluh - rizikovÃ©';
                }
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid ${statusColor}; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Debt / FCF</div>
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Debt to Free Cash Flow Ratio</strong><br>
                                    Kolik let by trvalo splatit dluh z aktuÃ¡lnÃ­ho FCF.<br><br>
                                    <strong>HodnocenÃ­:</strong><br>
                                    â€¢ &lt; 2Ã— = ZdravÃ© (nÃ­zkÃ½ dluh)<br>
                                    â€¢ 2-4Ã— = Pozor (stÅ™ednÃ­ riziko)<br>
                                    â€¢ &gt; 4Ã— = RizikovÃ© (vysokÃ½ dluh)<br><br>
                                    <strong>Co hledat:</strong> NiÅ¾Å¡Ã­ je lepÅ¡Ã­. VysokÃ½ pomÄ›r = firma mÃ¡ hodnÄ› dluhu vzhledem k cash flow.
                                </span>
                            </span>
                        </div>
                        <div style="font-size: 1.8em; font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">${(ratio !== null && ratio !== undefined && !isNaN(ratio) && typeof ratio === 'number') ? ratio.toFixed(1) + 'Ã—' : 'N/A'}</div>
                        <div style="font-size: 0.9em; color: ${statusColor}; font-weight: 600; margin-bottom: 5px;">
                            ${statusEmoji} ${ratioStatus}
                        </div>
                        <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">${statusText}</div>
                    </div>
                `;
            }

            html += `</div></div>`;

            // 2.5. ðŸ“Š Sector Comparison Section - REMOVED
            if (false && data.sector_averages && data.sector_averages.averages) {
                const sectorAvgs = data.sector_averages.averages;
                const info = data.info || {};
                
                html += `
                    <div class="card" style="margin-bottom: 15px; padding: 15px;">
                        <h3 style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; font-size: 0.9em;">
                            ðŸ“Š Sector Comparison
                            <span style="font-size: 0.6em; font-weight: normal; color: var(--text-secondary);">(${data.sector_averages.sector} - ${data.sector_averages.sample_size} companies)</span>
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px;">
                `;
                
                // Helper function to format comparison
                const formatComparison = (current, sectorAvg, format = 'number', unit = '') => {
                    if (current === null || current === undefined || sectorAvg === null || sectorAvg === undefined) {
                        return { html: '', color: 'var(--text-secondary)' };
                    }
                    
                    const diff = current - sectorAvg;
                    const diffPercent = sectorAvg !== 0 ? (diff / Math.abs(sectorAvg)) * 100 : 0;
                    const isBetter = Math.abs(diffPercent) > 5; // Only highlight if > 5% difference
                    const color = isBetter ? (diff > 0 ? '#10b981' : '#ef4444') : 'var(--text-secondary)';
                    const arrow = diff > 0 ? 'â†‘' : diff < 0 ? 'â†“' : 'â†’';
                    
                    let currentFormatted = '';
                    let sectorFormatted = '';
                    
                    if (format === 'percent') {
                        currentFormatted = (current * 100).toFixed(2) + '%';
                        sectorFormatted = (sectorAvg * 100).toFixed(2) + '%';
                    } else if (format === 'ratio') {
                        currentFormatted = current.toFixed(2) + unit;
                        sectorFormatted = sectorAvg.toFixed(2) + unit;
                    } else {
                        currentFormatted = current.toFixed(2) + unit;
                        sectorFormatted = sectorAvg.toFixed(2) + unit;
                    }
                    
                    return {
                        html: `
                            <div style="padding: 6px; background: var(--metric-bg); border-radius: 4px; border-left: 2px solid ${color};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                                    <div style="font-size: 0.7em; color: var(--text-secondary); font-weight: 600;">Current</div>
                                    <div style="font-size: 0.85em; font-weight: 700; color: var(--text-primary);">${currentFormatted}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; padding-top: 3px; border-top: 1px solid var(--border-color);">
                                    <div style="font-size: 0.65em; color: var(--text-secondary);">Avg</div>
                                    <div style="font-size: 0.75em; font-weight: 600; color: var(--text-secondary);">${sectorFormatted}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 3px; padding-top: 3px; border-top: 1px solid var(--border-color);">
                                    <div style="font-size: 0.65em; color: var(--text-secondary);">vs</div>
                                    <div style="font-size: 0.75em; font-weight: 600; color: ${color};">
                                        ${arrow} ${Math.abs(diffPercent).toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                        `,
                        color: color
                    };
                };
                
                // P/E Ratio
                if (info.trailingPE !== null && info.trailingPE !== undefined && sectorAvgs.pe_ratio !== null && sectorAvgs.pe_ratio !== undefined) {
                    const comp = formatComparison(info.trailingPE, sectorAvgs.pe_ratio, 'ratio', 'Ã—');
                    html += `
                        <div>
                            <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600;">P/E Ratio</div>
                            ${comp.html}
                        </div>
                    `;
                }
                
                // Profit Margin
                if (info.profitMargins !== null && info.profitMargins !== undefined && sectorAvgs.profit_margin !== null && sectorAvgs.profit_margin !== undefined) {
                    const comp = formatComparison(info.profitMargins, sectorAvgs.profit_margin, 'percent');
                    html += `
                        <div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; font-weight: 600;">Profit Margin</div>
                            ${comp.html}
                        </div>
                    `;
                }
                
                // Operating Margin
                if (info.operatingMargins !== null && info.operatingMargins !== undefined && sectorAvgs.operating_margin !== null && sectorAvgs.operating_margin !== undefined) {
                    const comp = formatComparison(info.operatingMargins, sectorAvgs.operating_margin, 'percent');
                    html += `
                        <div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; font-weight: 600;">Operating Margin</div>
                            ${comp.html}
                        </div>
                    `;
                }
                
                // Revenue Growth
                if (info.revenueGrowth !== null && info.revenueGrowth !== undefined && sectorAvgs.revenue_growth !== null && sectorAvgs.revenue_growth !== undefined) {
                    const comp = formatComparison(info.revenueGrowth, sectorAvgs.revenue_growth, 'percent');
                    html += `
                        <div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; font-weight: 600;">Revenue Growth</div>
                            ${comp.html}
                        </div>
                    `;
                }
                
                // ROE
                if (info.returnOnEquity !== null && info.returnOnEquity !== undefined && sectorAvgs.return_on_equity !== null && sectorAvgs.return_on_equity !== undefined) {
                    const comp = formatComparison(info.returnOnEquity, sectorAvgs.return_on_equity, 'percent');
                    html += `
                        <div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; font-weight: 600;">Return on Equity (ROE)</div>
                            ${comp.html}
                        </div>
                    `;
                }
                
                // Debt to Equity
                if (info.debtToEquity !== null && info.debtToEquity !== undefined && sectorAvgs.debt_to_equity !== null && sectorAvgs.debt_to_equity !== undefined) {
                    const comp = formatComparison(info.debtToEquity, sectorAvgs.debt_to_equity, 'ratio', 'Ã—');
                    html += `
                        <div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; font-weight: 600;">Debt to Equity</div>
                            ${comp.html}
                        </div>
                    `;
                }
                
                html += `
                        </div>
                        <div style="margin-top: 6px; padding: 6px; background: rgba(102, 126, 234, 0.05); border-radius: 4px; font-size: 0.7em; color: var(--text-secondary); line-height: 1.3;">
                            <strong>ðŸ’¡ Tip:</strong> PorovnÃ¡nÃ­ se sektorem pomÃ¡hÃ¡ posoudit, jak si firma vede relativnÄ› ke konkurenci. ZelenÃ¡ Å¡ipka â†‘ = nad prÅ¯mÄ›rem, ÄervenÃ¡ â†“ = pod prÅ¯mÄ›rem.
                        </div>
                    </div>
                `;
            }

            // 2. ðŸ“ˆ Performance Section (Revenue, Earnings) - Advanced Bar Charts
            const incomeData = data.income_statement?.[financialsPeriod] || [];
            html += `
                <div class="card" style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                            ðŸ“ˆ Performance
                            <span style="font-size: 0.7em; font-weight: normal; color: var(--text-secondary);">(Revenue & Earnings)</span>
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="financials-period-btn ${financialsPeriod === 'quarterly' ? 'active' : ''}" onclick="changeFinancialsPeriod('quarterly')" data-period="quarterly" style="padding: 8px 16px; background: ${financialsPeriod === 'quarterly' ? '#667eea' : 'var(--metric-bg)'}; color: ${financialsPeriod === 'quarterly' ? 'white' : 'var(--text-primary)'}; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Quarterly</button>
                            <button class="financials-period-btn ${financialsPeriod === 'annual' ? 'active' : ''}" onclick="changeFinancialsPeriod('annual')" data-period="annual" style="padding: 8px 16px; background: ${financialsPeriod === 'annual' ? '#667eea' : 'var(--metric-bg)'}; color: ${financialsPeriod === 'annual' ? 'white' : 'var(--text-primary)'}; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Annual</button>
                        </div>
                    </div>
            `;
            
            if (incomeData.length > 0) {
                html += `
                    <!-- Revenue and EPS Charts - Vertical Stack -->
                    <div style="margin-bottom: 30px;">
                    <!-- Revenue Chart -->
                        <div style="margin-bottom: 60px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <h4 style="margin: 0; font-size: 1.2em; color: var(--text-primary);">${data.company_name || ticker} Revenue</h4>
                            <div style="display: flex; gap: 5px; background: var(--metric-bg); padding: 4px; border-radius: 8px;">
                                <button class="performance-tab-btn active" onclick="switchPerformanceTab('revenue', 'value')" data-metric="revenue" data-type="value" style="padding: 6px 14px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">Revenue</button>
                                <button class="performance-tab-btn" onclick="switchPerformanceTab('revenue', 'growth')" data-metric="revenue" data-type="growth" style="padding: 6px 14px; background: transparent; color: var(--text-primary); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">Revenue Growth</button>
                            </div>
                        </div>
                            <div style="padding: 25px; background: var(--metric-bg); border-radius: 12px;">
                                <canvas id="revenueChart" style="max-height: 600px; min-height: 500px; height: 500px; width: 100% !important; display: block;"></canvas>
                            </div>
                    </div>
                    
                    <!-- EPS Chart -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <h4 style="margin: 0; font-size: 1.2em; color: var(--text-primary);">${data.company_name || ticker} EPS</h4>
                            <div style="display: flex; gap: 5px; background: var(--metric-bg); padding: 4px; border-radius: 8px;">
                                <button class="performance-tab-btn active" onclick="switchPerformanceTab('eps', 'value')" data-metric="eps" data-type="value" style="padding: 6px 14px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">EPS</button>
                                <button class="performance-tab-btn" onclick="switchPerformanceTab('eps', 'growth')" data-metric="eps" data-type="growth" style="padding: 6px 14px; background: transparent; color: var(--text-primary); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">EPS Growth</button>
                            </div>
                        </div>
                            <div style="padding: 25px; background: var(--metric-bg); border-radius: 12px;">
                                <canvas id="epsChart" style="max-height: 600px; min-height: 500px; height: 500px; width: 100% !important;"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div id="incomeStatementInsights" style="margin-top: 30px; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 10px;"></div>
                `;
            }
            
            html += `</div>`;

            // 2.5. Industry Comparison Bars (Peer Comparison)
            if (data.peer_comparison && data.peer_comparison.peers && data.peer_comparison.peers.length > 0) {
                html += `
                    <div class="card" style="margin-bottom: 30px;">
                        <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                            ðŸ“Š Industry Comparison
                            <span style="font-size: 0.7em; font-weight: normal; color: var(--text-secondary);">(${data.peer_comparison.category} Peers)</span>
                        </h3>
                        <div id="sectorComparisonChart" style="min-height: 200px;">
                            <canvas id="sectorComparisonBars" style="max-height: 250px; width: 100%;"></canvas>
                        </div>
                    </div>
                `;
            }

            // 2.6. Forward-Looking Data (Analyst Estimates) - Smaller, compact version
            if (data.forward_estimates && (data.forward_estimates.revenue || data.forward_estimates.eps)) {
                html += `
                    <div class="card" style="margin-bottom: 30px; max-width: 500px;">
                        <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 1.1em;">
                            ðŸ”® Forward-Looking Data
                            <span style="font-size: 0.7em; font-weight: normal; color: var(--text-secondary);">(Analyst Estimates)</span>
                        </h3>
                        <div id="analystEstimatesTable" style="overflow-x: auto;">
                            <!-- Table will be generated by JavaScript -->
                        </div>
                    </div>
                `;
            }

            // 3. Margins Section
            const marginsData = data.margins?.[financialsPeriod] || [];
            if (marginsData.length > 0 || snapshot.gross_margin !== null) {
                html += `
                    <div class="card" style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">ðŸ“Š MarÅ¾e â€“ tichÃ½ zabijÃ¡k / vÃ­tÄ›z</h3>
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                <span class="tooltiptext" style="width: 320px; white-space: normal;">
                                    <strong>MarÅ¾e ukazujÃ­ skuteÄnou ziskovost</strong><br><br>
                                    <strong>Gross Margin:</strong> Zisk po pÅ™Ã­mÃ½ch nÃ¡kladech (COGS)<br>
                                    <strong>Operating Margin:</strong> Zisk po vÅ¡ech provoznÃ­ch nÃ¡kladech<br>
                                    <strong>Net Margin:</strong> FinÃ¡lnÃ­ zisk po danÃ­ch<br><br>
                                    <strong>ProÄ je dÅ¯leÅ¾itÃ©:</strong> StabilnÃ­ nebo rostoucÃ­ marÅ¾e = firma mÃ¡ kontrolu nad nÃ¡klady a mÅ¯Å¾e ÃºÄtovat vyÅ¡Å¡Ã­ ceny. KlesajÃ­cÃ­ marÅ¾e = tlak na ziskovost.
                                </span>
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                `;
                
                if (snapshot.gross_margin !== null) {
                    html += `
                        <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px;">
                            <div style="font-size: 1.2em; font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">Gross Margin</div>
                            <div style="font-size: 2em; font-weight: 700; color: #667eea; margin-bottom: 10px;">${(snapshot.gross_margin !== null && snapshot.gross_margin !== undefined && !isNaN(snapshot.gross_margin) && typeof snapshot.gross_margin === 'number') ? snapshot.gross_margin.toFixed(1) + '%' : 'N/A'}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Zisk po pÅ™Ã­mÃ½ch nÃ¡kladech</div>
                            <div style="font-size: 0.8em; color: var(--text-tertiary); margin-top: 5px;">(Revenue - COGS) / Revenue</div>
                        </div>
                    `;
                }
                
                if (data.margins?.quarterly?.[0]?.operating_margin !== null && data.margins?.quarterly?.[0]?.operating_margin !== undefined) {
                    const opMargin = data.margins?.quarterly?.[0]?.operating_margin;
                    html += `
                        <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px;">
                            <div style="font-size: 1.2em; font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">Operating Margin</div>
                            <div style="font-size: 2em; font-weight: 700; color: #667eea; margin-bottom: 10px;">${(opMargin !== null && opMargin !== undefined && !isNaN(opMargin) && typeof opMargin === 'number') ? opMargin.toFixed(1) + '%' : 'N/A'}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Zisk po provoznÃ­ch nÃ¡kladech</div>
                            <div style="font-size: 0.8em; color: var(--text-tertiary); margin-top: 5px;">Efektivita operacÃ­</div>
                        </div>
                    `;
                }
                
                if (data.margins?.quarterly?.[0]?.net_margin !== null && data.margins?.quarterly?.[0]?.net_margin !== undefined) {
                    const netMargin = data.margins?.quarterly?.[0]?.net_margin;
                    html += `
                        <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px;">
                            <div style="font-size: 1.2em; font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">Net Margin</div>
                            <div style="font-size: 2em; font-weight: 700; color: #667eea; margin-bottom: 10px;">${netMargin !== null && netMargin !== undefined ? netMargin.toFixed(1) + '%' : 'N/A'}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">FinÃ¡lnÃ­ ziskovost</div>
                            <div style="font-size: 0.8em; color: var(--text-tertiary); margin-top: 5px;">Po vÅ¡ech nÃ¡kladech a danÃ­ch</div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(16, 185, 129, 0.05); border-radius: 10px; border-left: 4px solid #10b981;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">ðŸ’¡ Insight:</div>
                            <div style="color: var(--text-secondary);">MarÅ¾e jsou ${snapshot.gross_margin !== null && snapshot.gross_margin !== undefined ? (snapshot.gross_margin >= 40 ? 'silnÃ©' : snapshot.gross_margin >= 30 ? 'stabilnÃ­' : 'slabÅ¡Ã­') + ' â†’ ' + (snapshot.gross_margin >= 40 ? 'vÃ½bornÃ¡ pricing power (firma mÅ¯Å¾e ÃºÄtovat vyÅ¡Å¡Ã­ ceny)' : snapshot.gross_margin >= 30 ? 'dobrÃ¡ kontrola nÃ¡kladÅ¯' : 'moÅ¾nÃ© tlaky na marÅ¾e (konkurence, inflace)') : 'N/A'}.</div>
                        </div>
                    </div>
                `;
            }

            // 4. ðŸ’° Cash & Balance Sheet Section
            const cfData = data.cash_flow?.[financialsPeriod] || [];
            html += `
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="display: flex; align-items: center; gap: 10px;">
                        ðŸ’° Cash & Balance Sheet
                    </h3>
            `;
            
            if (cfData.length > 0 || snapshot.fcf_ttm) {
                html += `
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-primary);">Cash Flow Quality</h4>
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                <span class="tooltiptext" style="width: 320px; white-space: normal;">
                                    <strong>Kvalita cash flow</strong><br>
                                    PorovnÃ¡nÃ­ Free Cash Flow s Net Income.<br><br>
                                    <strong>ðŸŸ¢ Cash-based:</strong> FCF â‰¥ Net Income<br>
                                    SkuteÄnÃ© penÃ­ze = zisk (vÃ½bornÃ©!)<br><br>
                                    <strong>ðŸŸ¡ Mixed:</strong> FCF mezi 70-100% zisku<br>
                                    ÄŒÃ¡steÄnÄ› cash-based<br><br>
                                    <strong>ðŸ”´ Accounting-heavy:</strong> FCF &lt; 70% zisku<br>
                                    Zisk mÅ¯Å¾e bÃ½t "papÃ­rovÃ½" (pozor!)
                                </span>
                            </span>
                        </div>
                `;
                
                if (cfData.length > 0 || (data.cash_flow_analysis && data.cash_flow_analysis.quarterly_breakdown && data.cash_flow_analysis.quarterly_breakdown.length > 0)) {
                    html += `
                        <div style="margin-bottom: 15px; padding: 12px; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                            <div style="font-size: 0.9em; color: var(--text-secondary);">
                                <strong>Operating CF:</strong> PenÃ­ze z provozu | 
                                <strong>CapEx:</strong> Investice do majetku | 
                                <strong>FCF:</strong> VolnÃ½ cash flow (Operating CF - CapEx)
                            </div>
                        </div>
                        <canvas id="cashFlowBreakdownChart-${ticker}" style="max-height: 400px; margin-top: 10px;"></canvas>
                    `;
                }
                
                // FCF Quality Check - unified scale
                let fcfQualityStatus = 'Mixed';
                let fcfQualityColor = '#f59e0b';
                let fcfQualityEmoji = 'ðŸŸ¡';
                let fcfQualityDesc = '';
                
                if (snapshot.fcf_ttm !== null && snapshot.fcf_ttm !== undefined && snapshot.net_income_ttm !== null && snapshot.net_income_ttm !== undefined) {
                    // Both positive: FCF should be >= Net Income
                    if (snapshot.net_income_ttm > 0 && snapshot.fcf_ttm > 0) {
                        if (snapshot.fcf_ttm >= snapshot.net_income_ttm) {
                            fcfQualityStatus = 'Strong';
                            fcfQualityColor = '#10b981';
                            fcfQualityEmoji = 'ðŸŸ¢';
                            fcfQualityDesc = 'Firma generuje vÃ­ce skuteÄnÃ½ch penÄ›z neÅ¾ je zisk - vÃ½bornÃ©!';
                        } else if (snapshot.fcf_ttm >= snapshot.net_income_ttm * 0.7) {
                            fcfQualityDesc = 'FCF je blÃ­zko zisku - vÄ›tÅ¡ina zisku je skuteÄnÃ½ cash';
                        } else {
                            fcfQualityStatus = 'Weak';
                            fcfQualityColor = '#ef4444';
                            fcfQualityEmoji = 'ðŸ”´';
                            fcfQualityDesc = 'FCF je vÃ½raznÄ› niÅ¾Å¡Ã­ neÅ¾ zisk - ÄÃ¡st zisku mÅ¯Å¾e bÃ½t "papÃ­rovÃ¡" (pozor na accounting tricks)';
                        }
                    }
                    // Both negative: FCF should be less negative (closer to zero) than Net Income
                    else if (snapshot.net_income_ttm < 0 && snapshot.fcf_ttm < 0) {
                        if (snapshot.fcf_ttm > snapshot.net_income_ttm) {
                            // FCF is less negative, which is better
                            fcfQualityStatus = 'Strong';
                            fcfQualityColor = '#10b981';
                            fcfQualityEmoji = 'ðŸŸ¢';
                            fcfQualityDesc = 'Firma generuje vÃ­ce skuteÄnÃ½ch penÄ›z neÅ¾ je ztrÃ¡ta - cash flow je lepÅ¡Ã­ neÅ¾ ÃºÄetnÃ­ zisk';
                        } else if (snapshot.fcf_ttm >= snapshot.net_income_ttm * 0.7) {
                            fcfQualityDesc = 'FCF je blÃ­zko ztrÃ¡ty - vÄ›tÅ¡ina ztrÃ¡ty je skuteÄnÃ½ cash outflow';
                        } else {
                            fcfQualityStatus = 'Weak';
                            fcfQualityColor = '#ef4444';
                            fcfQualityEmoji = 'ðŸ”´';
                            fcfQualityDesc = 'FCF je vÃ½raznÄ› horÅ¡Ã­ neÅ¾ ztrÃ¡ta - firma spaluje vÃ­ce cash neÅ¾ ukazuje ÃºÄetnictvÃ­';
                        }
                    }
                    // Mixed: one positive, one negative
                    else if (snapshot.fcf_ttm > 0 && snapshot.net_income_ttm < 0) {
                        fcfQualityStatus = 'Strong';
                        fcfQualityColor = '#10b981';
                        fcfQualityEmoji = 'ðŸŸ¢';
                        fcfQualityDesc = 'Firma generuje pozitivnÃ­ cash flow navzdory ÃºÄetnÃ­ ztrÃ¡tÄ› - vÃ½bornÃ©!';
                    } else if (snapshot.fcf_ttm < 0 && snapshot.net_income_ttm > 0) {
                        fcfQualityStatus = 'Weak';
                        fcfQualityColor = '#ef4444';
                        fcfQualityEmoji = 'ðŸ”´';
                        fcfQualityDesc = 'Firma mÃ¡ negativnÃ­ cash flow navzdory ÃºÄetnÃ­mu zisku - pozor na accounting tricks!';
                    }
                }
                
                html += `
                        <div style="margin-top: 20px; padding: 20px; background: var(--metric-bg); border-radius: 12px;">
                            <div style="font-size: 1.1em; font-weight: 600; color: var(--text-primary); margin-bottom: 15px;">Quality Verdict:</div>
                            <div style="font-size: 1.3em; font-weight: 700; color: ${fcfQualityColor}; margin-bottom: 10px;">
                                ${fcfQualityEmoji} ${fcfQualityStatus}
                            </div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px;">
                                ${snapshot.fcf_ttm ? `FCF: ${formatCurrency(snapshot.fcf_ttm)} | Net Income: ${formatCurrency(snapshot.net_income_ttm)}` : ''}
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-tertiary); font-style: italic;">
                                ${fcfQualityDesc}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Balance Sheet (in same section)
            const bs = data.balance_sheet || {};
            console.log('[Financials] Balance Sheet data:', bs);
            console.log('[Financials] Balance Sheet data type:', typeof bs, 'keys:', Object.keys(bs));
            
            // Always show Balance Sheet section, even if data is missing
            // Show Balance Sheet section if we have at least one value (including 0)
            const hasBalanceSheetData = (bs.cash !== null && bs.cash !== undefined) || 
                                       (bs.total_debt !== null && bs.total_debt !== undefined) || 
                                       (bs.equity !== null && bs.equity !== undefined) || 
                                       (bs.current_ratio !== null && bs.current_ratio !== undefined) ||
                                       (bs.net_debt !== null && bs.net_debt !== undefined);
            
            console.log('[Financials] hasBalanceSheetData:', hasBalanceSheetData, {
                cash: bs.cash,
                total_debt: bs.total_debt,
                equity: bs.equity,
                current_ratio: bs.current_ratio,
                net_debt: bs.net_debt
            });
            
            // Always show Balance Sheet section (even if no data)
            console.log('[Financials] About to create Balance Sheet HTML, hasBalanceSheetData:', hasBalanceSheetData);
            if (true) {
                console.log('[Financials] Creating Balance Sheet HTML section');
                html += `
                        <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--border-color);">
                            <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-primary);">Balance Sheet â€“ jen to dÅ¯leÅ¾itÃ©</h4>
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Rozvaha ukazuje finanÄnÃ­ zdravÃ­</strong><br><br>
                                    <strong>Cash:</strong> Hotovost a ekvivalenty<br>
                                    <strong>Total Debt:</strong> CelkovÃ½ dluh<br>
                                    <strong>Net Debt:</strong> Dluh minus hotovost (zÃ¡pornÃ© = vÃ­ce hotovosti neÅ¾ dluhu!)<br>
                                    <strong>Equity:</strong> VlastnÃ­ kapitÃ¡l<br>
                                    <strong>Current Ratio:</strong> KrÃ¡tkodobÃ¡ aktiva / krÃ¡tkodobÃ© zÃ¡vazky (&gt;1 = mÅ¯Å¾e splatit krÃ¡tkodobÃ© dluhy)
                                </span>
                            </span>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                `;
                
                console.log('[Financials] Checking cash:', bs.cash, 'is not null:', bs.cash !== null, 'is not undefined:', bs.cash !== undefined);
                if (bs.cash !== null && bs.cash !== undefined) {
                    console.log('[Financials] Adding Cash card to HTML');
                    html += `
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Cash & Equivalents</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary);">${formatCurrency(bs.cash)}</div>
                            <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">Hotovost a ekvivalenty</div>
                        </div>
                    `;
                } else {
                    console.log('[Financials] Cash is null/undefined, skipping');
                }
                
                if (bs.total_debt !== null && bs.total_debt !== undefined) {
                    html += `
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Total Debt</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary);">${formatCurrency(bs.total_debt)}</div>
                            <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">CelkovÃ½ dluh</div>
                        </div>
                    `;
                }
                
                if (bs.net_debt !== null && bs.net_debt !== undefined) {
                    // Unified scale: Strong / Mixed / Weak
                    let netDebtStatus = 'Mixed';
                    let netDebtColor = '#f59e0b';
                    let netDebtEmoji = 'ðŸŸ¡';
                    let netDebtDesc = '';
                    if (bs.net_debt < 0) {
                        netDebtStatus = 'Strong';
                        netDebtColor = '#10b981';
                        netDebtEmoji = 'ðŸŸ¢';
                        netDebtDesc = 'VÃ­ce hotovosti neÅ¾ dluhu';
                    } else if (bs.net_debt < bs.cash) {
                        netDebtDesc = 'Dluh je pokrytÃ½ hotovostÃ­';
                    } else {
                        netDebtStatus = 'Weak';
                        netDebtColor = '#ef4444';
                        netDebtEmoji = 'ðŸ”´';
                        netDebtDesc = 'Dluh pÅ™evyÅ¡uje hotovost';
                    }
                    html += `
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px; border-left: 4px solid ${netDebtColor};">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Net Debt</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: ${netDebtColor};">${formatCurrency(bs.net_debt)}</div>
                            <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">${netDebtEmoji} ${netDebtStatus} - ${netDebtDesc}</div>
                        </div>
                    `;
                }
                
                if (bs.equity !== null && bs.equity !== undefined) {
                    html += `
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Equity</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary);">${formatCurrency(bs.equity)}</div>
                            <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">VlastnÃ­ kapitÃ¡l</div>
                        </div>
                    `;
                }
                
                if (bs.current_ratio !== null && bs.current_ratio !== undefined) {
                    // Unified scale: Strong / Mixed / Weak
                    let crStatus = 'Mixed';
                    let crColor = '#f59e0b';
                    let crEmoji = 'ðŸŸ¡';
                    let crDesc = '';
                    if (bs.current_ratio !== null && bs.current_ratio !== undefined) {
                        if (bs.current_ratio >= 2) {
                            crStatus = 'Strong';
                            crColor = '#10b981';
                            crEmoji = 'ðŸŸ¢';
                            crDesc = 'VÃ½bornÃ¡ likvidita';
                        } else if (bs.current_ratio >= 1) {
                            crDesc = 'DostateÄnÃ¡ likvidita';
                        } else {
                            crStatus = 'Weak';
                            crColor = '#ef4444';
                            crEmoji = 'ðŸ”´';
                            crDesc = 'NÃ­zkÃ¡ likvidita';
                        }
                    }
                    html += `
                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px; border-left: 4px solid ${crColor};">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Current Ratio</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: ${crColor};">${(bs.current_ratio !== null && bs.current_ratio !== undefined && !isNaN(bs.current_ratio) && typeof bs.current_ratio === 'number') ? bs.current_ratio.toFixed(2) : 'N/A'}</div>
                            <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">${crEmoji} ${crStatus} - ${crDesc}</div>
                        </div>
                    `;
                }
                
                // Improved balance sheet verdict logic - unified scale
                let bsVerdict = 'Mixed';
                let bsVerdictDesc = '';
                let bsVerdictColor = '#f59e0b';
                let bsVerdictBg = 'rgba(245, 158, 11, 0.1)';
                let bsVerdictEmoji = 'ðŸŸ¡';
                
                if (bs.net_debt !== null && bs.net_debt < 0 && bs.current_ratio !== null && bs.current_ratio !== undefined && bs.current_ratio >= 1.5) {
                    bsVerdict = 'Strong';
                    bsVerdictDesc = 'VÃ­ce hotovosti neÅ¾ dluhu a silnÃ¡ likvidita (Current Ratio: ' + ((bs.current_ratio !== null && bs.current_ratio !== undefined && !isNaN(bs.current_ratio) && typeof bs.current_ratio === 'number') ? bs.current_ratio.toFixed(2) : 'N/A') + ')';
                    bsVerdictColor = '#10b981';
                    bsVerdictBg = 'rgba(16, 185, 129, 0.1)';
                    bsVerdictEmoji = 'ðŸŸ¢';
                } else if (bs.net_debt !== null && bs.net_debt < 0) {
                    bsVerdict = 'Strong';
                    bsVerdictDesc = 'VÃ­ce hotovosti neÅ¾ dluhu, ale pozor na likviditu (Current Ratio: ' + ((bs.current_ratio !== null && bs.current_ratio !== undefined && !isNaN(bs.current_ratio) && typeof bs.current_ratio === 'number') ? bs.current_ratio.toFixed(2) : 'N/A') + ')';
                    bsVerdictColor = '#10b981';
                    bsVerdictBg = 'rgba(16, 185, 129, 0.1)';
                    bsVerdictEmoji = 'ðŸŸ¢';
                } else if (bs.current_ratio !== null && bs.current_ratio !== undefined && bs.current_ratio >= 1 && bs.net_debt !== null && bs.net_debt < bs.cash) {
                    bsVerdictDesc = 'StabilnÃ­ finanÄnÃ­ pozice - dostateÄnÃ¡ likvidita (Current Ratio: ' + ((bs.current_ratio !== null && bs.current_ratio !== undefined && !isNaN(bs.current_ratio) && typeof bs.current_ratio === 'number') ? bs.current_ratio.toFixed(2) : 'N/A') + ')';
                } else if (bs.current_ratio !== null && bs.current_ratio !== undefined && bs.current_ratio < 1) {
                    bsVerdict = 'Weak';
                    bsVerdictDesc = `NÃ­zkÃ¡ likvidita (Current Ratio: ${(bs.current_ratio !== null && bs.current_ratio !== undefined && !isNaN(bs.current_ratio) && typeof bs.current_ratio === 'number') ? bs.current_ratio.toFixed(2) : 'N/A'}) - firma mÅ¯Å¾e mÃ­t problÃ©my splatit krÃ¡tkodobÃ© zÃ¡vazky${bs.net_debt !== null && bs.net_debt > 0 ? '. Net debt je pozitivnÃ­.' : ''}`;
                    bsVerdictColor = '#ef4444';
                    bsVerdictBg = 'rgba(239, 68, 68, 0.1)';
                    bsVerdictEmoji = 'ðŸ”´';
                } else {
                    bsVerdictDesc = 'FinanÄnÃ­ pozice vyÅ¾aduje dalÅ¡Ã­ analÃ½zu';
                }
                
                html += `
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: ${bsVerdictBg}; border-radius: 10px; border-left: 4px solid ${bsVerdictColor};">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">${bsVerdictEmoji} Balance sheet: ${bsVerdict}</div>
                                <div style="font-size: 0.9em; color: var(--text-secondary);">${bsVerdictDesc}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Balance Sheet Details Section
                const hasDetailedData = (bs.total_assets !== null && bs.total_assets !== undefined) ||
                                       (bs.total_liabilities !== null && bs.total_liabilities !== undefined) ||
                                       (bs.current_assets !== null && bs.current_assets !== undefined) ||
                                       (bs.current_liabilities !== null && bs.current_liabilities !== undefined) ||
                                       (bs.long_term_debt !== null && bs.long_term_debt !== undefined) ||
                                       (bs.short_term_debt !== null && bs.short_term_debt !== undefined) ||
                                       (bs.working_capital !== null && bs.working_capital !== undefined) ||
                                       (bs.quick_ratio !== null && bs.quick_ratio !== undefined) ||
                                       (bs.debt_to_equity !== null && bs.debt_to_equity !== undefined) ||
                                       (bs.debt_to_assets !== null && bs.debt_to_assets !== undefined);
                
                if (hasDetailedData) {
                    html += `
                        <div class="card" style="margin-top: 30px; margin-bottom: 30px;">
                            <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                                ðŸ“Š Balance Sheet Details
                            </h3>
                    `;
                    
                    // Total Assets and Total Liabilities
                    if ((bs.total_assets !== null && bs.total_assets !== undefined) || (bs.total_liabilities !== null && bs.total_liabilities !== undefined)) {
                        html += `
                            <div style="margin-bottom: 25px;">
                                <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-primary);">Total Assets & Liabilities</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        `;
                        
                        if (bs.total_assets !== null && bs.total_assets !== undefined) {
                            html += `
                                <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Total Assets</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary);">${formatCurrency(bs.total_assets)}</div>
                                    <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">CelkovÃ¡ aktiva</div>
                                </div>
                            `;
                        }
                        
                        if (bs.total_liabilities !== null && bs.total_liabilities !== undefined) {
                            html += `
                                <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Total Liabilities</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary);">${formatCurrency(bs.total_liabilities)}</div>
                                    <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">CelkovÃ¡ pasiva</div>
                                </div>
                            `;
                        }
                        
                        html += `</div></div>`;
                    }
                    
                    // Current Assets and Current Liabilities
                    if ((bs.current_assets !== null && bs.current_assets !== undefined) || (bs.current_liabilities !== null && bs.current_liabilities !== undefined)) {
                        html += `
                            <div style="margin-bottom: 25px;">
                                <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-primary);">Current Assets & Liabilities</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        `;
                        
                        if (bs.current_assets !== null && bs.current_assets !== undefined) {
                            html += `
                                <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Current Assets</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary);">${formatCurrency(bs.current_assets)}</div>
                                    <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">KrÃ¡tkodobÃ¡ aktiva</div>
                                </div>
                            `;
                        }
                        
                        if (bs.current_liabilities !== null && bs.current_liabilities !== undefined) {
                            html += `
                                <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Current Liabilities</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary);">${formatCurrency(bs.current_liabilities)}</div>
                                    <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">KrÃ¡tkodobÃ© zÃ¡vazky</div>
                                </div>
                            `;
                        }
                        
                        html += `</div></div>`;
                    }
                    
                    // Working Capital
                    if (bs.working_capital !== null && bs.working_capital !== undefined) {
                        let wcStatus = 'Mixed';
                        let wcColor = '#f59e0b';
                        let wcEmoji = 'ðŸŸ¡';
                        let wcDesc = '';
                        if (bs.working_capital > 0) {
                            wcStatus = 'Strong';
                            wcColor = '#10b981';
                            wcEmoji = 'ðŸŸ¢';
                            wcDesc = 'PozitivnÃ­ working capital - firma mÅ¯Å¾e financovat provoz';
                        } else {
                            wcStatus = 'Weak';
                            wcColor = '#ef4444';
                            wcEmoji = 'ðŸ”´';
                            wcDesc = 'NegativnÃ­ working capital - potenciÃ¡lnÃ­ problÃ©my s likviditou';
                        }
                        html += `
                            <div style="margin-bottom: 25px;">
                                <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-primary);">Working Capital</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                    <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px; border-left: 4px solid ${wcColor};">
                                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Working Capital</div>
                                        <div style="font-size: 1.5em; font-weight: 700; color: ${wcColor};">${formatCurrency(bs.working_capital)}</div>
                                        <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">${wcEmoji} ${wcStatus} - ${wcDesc}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Long-term and Short-term Debt
                    if ((bs.long_term_debt !== null && bs.long_term_debt !== undefined) || (bs.short_term_debt !== null && bs.short_term_debt !== undefined)) {
                        html += `
                            <div style="margin-bottom: 25px;">
                                <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-primary);">Debt Breakdown</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        `;
                        
                        if (bs.long_term_debt !== null && bs.long_term_debt !== undefined) {
                            html += `
                                <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Long-term Debt</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary);">${formatCurrency(bs.long_term_debt)}</div>
                                    <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">DlouhodobÃ½ dluh</div>
                                </div>
                            `;
                        }
                        
                        if (bs.short_term_debt !== null && bs.short_term_debt !== undefined) {
                            html += `
                                <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px;">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Short-term Debt</div>
                                    <div style="font-size: 1.5em; font-weight: 700; color: var(--text-primary);">${formatCurrency(bs.short_term_debt)}</div>
                                    <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">KrÃ¡tkodobÃ½ dluh</div>
                                </div>
                            `;
                        }
                        
                        html += `</div></div>`;
                    }
                    
                    // Quick Ratio
                    if (bs.quick_ratio !== null && bs.quick_ratio !== undefined) {
                        let qrStatus = 'Mixed';
                        let qrColor = '#f59e0b';
                        let qrEmoji = 'ðŸŸ¡';
                        let qrDesc = '';
                        if (bs.quick_ratio >= 1) {
                            qrStatus = 'Strong';
                            qrColor = '#10b981';
                            qrEmoji = 'ðŸŸ¢';
                            qrDesc = 'VÃ½bornÃ¡ likvidita (bez zÃ¡sob)';
                        } else if (bs.quick_ratio >= 0.5) {
                            qrDesc = 'DostateÄnÃ¡ likvidita';
                        } else {
                            qrStatus = 'Weak';
                            qrColor = '#ef4444';
                            qrEmoji = 'ðŸ”´';
                            qrDesc = 'NÃ­zkÃ¡ likvidita (bez zÃ¡sob)';
                        }
                        html += `
                            <div style="margin-bottom: 25px;">
                                <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-primary);">Liquidity Ratios</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                    <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px; border-left: 4px solid ${qrColor};">
                                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Quick Ratio</div>
                                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                            <span class="tooltiptext" style="max-width: 300px; white-space: normal;">
                                                <strong>Quick Ratio</strong><br>
                                                (Current Assets - Inventory) / Current Liabilities<br><br>
                                                MÄ›Å™Ã­ likviditu bez zapoÄtenÃ­ zÃ¡sob. &gt;1 = mÅ¯Å¾e splatit krÃ¡tkodobÃ© zÃ¡vazky i bez prodeje zÃ¡sob.
                                            </span>
                                        </span>
                                        <div style="font-size: 1.5em; font-weight: 700; color: ${qrColor}; margin-top: 5px;">${(bs.quick_ratio !== null && bs.quick_ratio !== undefined && !isNaN(bs.quick_ratio) && typeof bs.quick_ratio === 'number') ? bs.quick_ratio.toFixed(2) : 'N/A'}</div>
                                        <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">${qrEmoji} ${qrStatus} - ${qrDesc}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Debt Ratios
                    if ((bs.debt_to_equity !== null && bs.debt_to_equity !== undefined) || (bs.debt_to_assets !== null && bs.debt_to_assets !== undefined)) {
                        html += `
                            <div style="margin-bottom: 25px;">
                                <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-primary);">Debt Ratios</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        `;
                        
                        if (bs.debt_to_equity !== null && bs.debt_to_equity !== undefined) {
                            let dteStatus = 'Mixed';
                            let dteColor = '#f59e0b';
                            let dteEmoji = 'ðŸŸ¡';
                            let dteDesc = '';
                            if (bs.debt_to_equity < 1) {
                                dteStatus = 'Strong';
                                dteColor = '#10b981';
                                dteEmoji = 'ðŸŸ¢';
                                dteDesc = 'ZdravÃ½ pomÄ›r dluhu k vlastnÃ­mu kapitÃ¡lu';
                            } else if (bs.debt_to_equity < 2) {
                                dteDesc = 'PÅ™ijatelnÃ½ pomÄ›r dluhu';
                            } else {
                                dteStatus = 'Weak';
                                dteColor = '#ef4444';
                                dteEmoji = 'ðŸ”´';
                                dteDesc = 'VysokÃ½ pomÄ›r dluhu - rizikovÃ©';
                            }
                            html += `
                                <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px; border-left: 4px solid ${dteColor};">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Debt-to-Equity</div>
                                    <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                        <span class="tooltiptext" style="max-width: 300px; white-space: normal;">
                                            <strong>Debt-to-Equity Ratio</strong><br>
                                            Total Debt / Equity<br><br>
                                            NiÅ¾Å¡Ã­ je lepÅ¡Ã­. &lt;1 = zdravÃ©, 1-2 = pÅ™ijatelnÃ©, &gt;2 = rizikovÃ©.
                                        </span>
                                    </span>
                                    <div style="font-size: 1.5em; font-weight: 700; color: ${dteColor}; margin-top: 5px;">${(bs.debt_to_equity !== null && bs.debt_to_equity !== undefined && !isNaN(bs.debt_to_equity) && typeof bs.debt_to_equity === 'number') ? bs.debt_to_equity.toFixed(2) + 'Ã—' : 'N/A'}</div>
                                    <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">${dteEmoji} ${dteStatus} - ${dteDesc}</div>
                                </div>
                            `;
                        }
                        
                        if (bs.debt_to_assets !== null && bs.debt_to_assets !== undefined) {
                            let dtaStatus = 'Mixed';
                            let dtaColor = '#f59e0b';
                            let dtaEmoji = 'ðŸŸ¡';
                            let dtaDesc = '';
                            if (bs.debt_to_assets < 0.3) {
                                dtaStatus = 'Strong';
                                dtaColor = '#10b981';
                                dtaEmoji = 'ðŸŸ¢';
                                dtaDesc = 'NÃ­zkÃ½ dluh vzhledem k aktivÅ¯m';
                            } else if (bs.debt_to_assets < 0.6) {
                                dtaDesc = 'StÅ™ednÃ­ dluh vzhledem k aktivÅ¯m';
                            } else {
                                dtaStatus = 'Weak';
                                dtaColor = '#ef4444';
                                dtaEmoji = 'ðŸ”´';
                                dtaDesc = 'VysokÃ½ dluh vzhledem k aktivÅ¯m';
                            }
                            html += `
                                <div style="padding: 15px; background: var(--metric-bg); border-radius: 10px; border-left: 4px solid ${dtaColor};">
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Debt-to-Assets</div>
                                    <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                        <span class="tooltiptext" style="max-width: 300px; white-space: normal;">
                                            <strong>Debt-to-Assets Ratio</strong><br>
                                            Total Debt / Total Assets<br><br>
                                            &lt;0.3 = nÃ­zkÃ½ dluh, 0.3-0.6 = stÅ™ednÃ­, &gt;0.6 = vysokÃ½ dluh.
                                        </span>
                                    </span>
                                    <div style="font-size: 1.5em; font-weight: 700; color: ${dtaColor}; margin-top: 5px;">${(bs.debt_to_assets !== null && bs.debt_to_assets !== undefined && !isNaN(bs.debt_to_assets) && typeof bs.debt_to_assets === 'number') ? (bs.debt_to_assets * 100).toFixed(1) + '%' : 'N/A'}</div>
                                    <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">${dtaEmoji} ${dtaStatus} - ${dtaDesc}</div>
                                </div>
                            `;
                        }
                        
                        html += `</div></div>`;
                    }
                    
                    // Balance Sheet Structure Visualization
                    if (bs.total_assets !== null && bs.total_assets !== undefined) {
                        html += `
                            <div style="margin-top: 30px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-primary);">Balance Sheet Structure</h4>
                                <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                    <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                        <strong>Struktura Balance Sheet</strong><br>
                                        Graf ukazuje, jak jsou aktiva a pasiva strukturovÃ¡na. Aktiva = co firma vlastnÃ­, Pasiva = co firma dluÅ¾Ã­ + vlastnÃ­ kapitÃ¡l.
                                    </span>
                                </span>
                                <div style="position: relative; height: 400px; margin-top: 20px; background: var(--metric-bg); border-radius: 12px; padding: 20px;">
                                    <canvas id="balanceSheetStructureChart-${ticker}"></canvas>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                }
                console.log('[Financials] Balance Sheet HTML created, length after:', html.length);
                console.log('[Financials] Balance Sheet HTML snippet:', html.substring(html.length - 500));
            } else {
                // Show placeholder if no balance sheet data
                html += `
                    <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--border-color);">
                        <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: var(--text-primary);">Balance Sheet â€“ jen to dÅ¯leÅ¾itÃ©</h4>
                        <div style="padding: 20px; background: var(--metric-bg); border-radius: 10px; text-align: center; color: var(--text-secondary);">
                            Balance Sheet data nenÃ­ k dispozici pro tento ticker.
                        </div>
                    </div>
                `;
            }

            // 5. âš ï¸ Risks Section
            html += `
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="display: flex; align-items: center; gap: 10px;">
                        âš ï¸ Risks
                    </h3>
            `;
            
            const redFlags = data.red_flags || [];
            if (redFlags.length > 0) {
                html += `
                        <div style="margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; font-size: 1.1em; color: var(--text-primary);">Red Flags</h4>
                                <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                    <span class="tooltiptext" style="width: 280px; white-space: normal;">
                                        <strong>Red Flags = varovnÃ© signÃ¡ly</strong><br><br>
                                        Automaticky detekovanÃ© problÃ©my ve finanÄnÃ­ch datech, kterÃ© vyÅ¾adujÃ­ pozornost. Ne vÅ¡echny red flags jsou kritickÃ©, ale je dobrÃ© je znÃ¡t.
                                    </span>
                                </span>
                            </div>
                `;
                
                for (const flag of redFlags) {
                    const flagColor = flag.severity === 'high' ? '#ef4444' : '#f59e0b';
                    const flagSeverityDesc = flag.severity === 'high' ? 'VysokÃ¡ zÃ¡vaÅ¾nost - vyÅ¾aduje okamÅ¾itou pozornost' : 'StÅ™ednÃ­ zÃ¡vaÅ¾nost - sledujte vÃ½voj';
                    html += `
                        <div style="padding: 15px; margin-bottom: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border-left: 4px solid ${flagColor};">
                            <div style="font-weight: 600; color: ${flagColor}; margin-bottom: 5px;">â— ${flag.message}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">
                                <strong>Severity:</strong> ${flag.severity.toUpperCase()} - ${flagSeverityDesc}
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            } else {
                html += `
                        <div style="margin-top: 20px; padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border-left: 4px solid #10b981;">
                            <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">âœ… Å½Ã¡dnÃ© vÃ½znamnÃ© varovnÃ© signÃ¡ly</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">V aktuÃ¡lnÃ­ch finanÄnÃ­ch datech nebyly detekovÃ¡ny Å¾Ã¡dnÃ© vÃ½znamnÃ© red flags.</div>
                        </div>
                `;
            }
            
            html += `</div>`;

            // 8. ðŸ“„ Earnings Call Analysis Section
            html += `
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="display: flex; align-items: center; gap: 10px;">
                        ðŸ“„ Earnings Call Analysis
                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                            <span class="tooltiptext" style="width: 300px; white-space: normal;">
                                <strong>Earnings Call Analysis</strong><br>
                                Nahrajte PDF s earnings call prezentacÃ­ a AI automaticky analyzuje dÅ¯leÅ¾itÃ© faktory, metriky a management komentÃ¡Å™e.<br><br>
                                <strong>Co AI analyzuje:</strong> FinanÄnÃ­ metriky, strategickÃ© iniciativy, management outlook, rizika a celkovÃ½ sentiment.
                            </span>
                        </span>
                    </h3>
                    
                    <div style="margin-top: 20px; padding: 30px; border: 2px dashed var(--border-color); border-radius: 12px; text-align: center; background: var(--metric-bg);">
                        <div style="font-size: 3em; margin-bottom: 15px;">ðŸ“¤</div>
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">Upload earnings call presentation PDF</p>
                        
                        <form id="earningsCallUploadForm" onsubmit="uploadEarningsCall(event, '${ticker}'); return false;" style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                            <input type="file" id="earningsCallFileInput" accept=".pdf" required style="display: none;" onchange="handleEarningsCallFileSelect(event)" />
                            <button type="button" onclick="document.getElementById('earningsCallFileInput').click()" class="ripple-effect" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                ðŸ“ Choose PDF File
                            </button>
                            <div id="earningsCallFileName" style="color: var(--text-secondary); font-size: 0.9em; min-height: 20px;"></div>
                            <button type="submit" id="earningsCallUploadBtn" class="ripple-effect" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: none;">
                                ðŸ¤– Analyze with AI
                            </button>
                        </form>
                        
                        <div id="earningsCallAnalysisResult" style="margin-top: 30px; text-align: left;"></div>
                    </div>
                </div>
            `;

            // Add Advanced Analysis Sections
            
            // 1. Cash Flow Statement Analysis
            if (data.cash_flow_analysis) {
                const cfAnalysis = data.cash_flow_analysis;
                html += `
                    <div class="card" style="margin-bottom: 30px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                            <h3 style="display: flex; align-items: center; gap: 10px; margin: 0;">
                                ðŸ’° Cash Flow Statement Analysis
                            </h3>
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Cash Flow Statement</strong><br><br>
                                    <strong>Operating CF:</strong> PenÃ­ze z hlavnÃ­ Äinnosti firmy (prodej, sluÅ¾by). PozitivnÃ­ = firma generuje cash.<br><br>
                                    <strong>Investing CF:</strong> PenÃ­ze za investice (nÃ¡kup/prodej zaÅ™Ã­zenÃ­, nemovitostÃ­). Obvykle negativnÃ­ (firma investuje).<br><br>
                                    <strong>Financing CF:</strong> PenÃ­ze z financovÃ¡nÃ­ (pÅ¯jÄky, emise akciÃ­, dividendy).<br><br>
                                    <strong>Free Cash Flow (FCF):</strong> Operating CF - CapEx. SkuteÄnÃ© penÃ­ze, kterÃ© mÃ¡ firma k dispozici.
                                </span>
                            </span>
                        </div>
                        
                        ${cfAnalysis.quarterly_breakdown && cfAnalysis.quarterly_breakdown.length > 0 ? `
                            <div style="margin-top: 20px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        ðŸ“Š Operating/Investing/Financing Breakdown
                                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                            <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                                <strong>Co vidÃ­te:</strong> Jak firma zÃ­skÃ¡vÃ¡ a utrÃ¡cÃ­ penÃ­ze ve tÅ™ech kategoriÃ­ch. ZelenÃ¡ = penÃ­ze z provozu, ÄervenÃ¡ = investice (obvykle negativnÃ­), modrÃ¡ = financovÃ¡nÃ­.
                                            </span>
                                        </span>
                                    </h4>
                                </div>
                                <div style="position: relative; height: 350px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%); border-radius: 12px; padding: 15px;">
                                    <canvas id="cashFlowBreakdownChart-${ticker}"></canvas>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${cfAnalysis.fcf_trend && cfAnalysis.fcf_trend.length > 0 ? `
                            <div style="margin-top: 30px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        ðŸ“ˆ Free Cash Flow Trend ${cfAnalysis.fcf_projection ? 'with Projection' : ''}
                                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                            <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                                <strong>Free Cash Flow (FCF):</strong> PenÃ­ze, kterÃ© firmÄ› zÅ¯stanou po vÅ¡ech vÃ½dajÃ­ch. RÅ¯st = dobrÃ© znamenÃ­. Projekce ukazuje oÄekÃ¡vanÃ½ trend.
                                            </span>
                                        </span>
                                    </h4>
                                </div>
                                <div style="position: relative; height: 350px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(245, 158, 11, 0.05) 100%); border-radius: 12px; padding: 15px;">
                                    <canvas id="fcfTrendChart-${ticker}"></canvas>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${cfAnalysis.cash_conversion_cycle && cfAnalysis.cash_conversion_cycle.ccc !== null ? `
                            <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%); border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        â±ï¸ Cash Conversion Cycle
                                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                            <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                                <strong>Cash Conversion Cycle (CCC):</strong> Kolik dnÃ­ trvÃ¡, neÅ¾ se investice do zÃ¡sob vrÃ¡tÃ­ jako hotovost.<br><br>
                                                <strong>DSO:</strong> Dny, neÅ¾ dostanete zaplaceno od zÃ¡kaznÃ­kÅ¯. NiÅ¾Å¡Ã­ = lepÅ¡Ã­.<br><br>
                                                <strong>DIO:</strong> Dny, neÅ¾ prodÃ¡te zÃ¡soby. NiÅ¾Å¡Ã­ = lepÅ¡Ã­.<br><br>
                                                <strong>DPO:</strong> Dny, neÅ¾ zaplatÃ­te dodavatelÅ¯m. VyÅ¡Å¡Ã­ = lepÅ¡Ã­ (delÅ¡Ã­ doba na zaplacenÃ­).<br><br>
                                                <strong>CCC = DSO + DIO - DPO</strong><br>
                                                NiÅ¾Å¡Ã­ CCC = firma rychleji pÅ™emÄ›Åˆuje investice na hotovost.
                                            </span>
                                        </span>
                                    </h4>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                    <div style="padding: 15px; background: rgba(102, 126, 234, 0.15); border-radius: 10px; border-left: 4px solid #667eea; text-align: center;">
                                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">CCC</div>
                                        <div style="font-size: 2em; font-weight: 800; color: #667eea; margin-bottom: 5px;">${cfAnalysis.cash_conversion_cycle.ccc}</div>
                                        <div style="font-size: 0.75em; color: var(--text-tertiary);">days</div>
                                    </div>
                                    <div style="padding: 15px; background: rgba(16, 185, 129, 0.15); border-radius: 10px; border-left: 4px solid #10b981; text-align: center;">
                                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">DSO</div>
                                        <div style="font-size: 1.5em; font-weight: 700; color: #10b981; margin-bottom: 5px;">${cfAnalysis.cash_conversion_cycle.dso || 'N/A'}</div>
                                        <div style="font-size: 0.75em; color: var(--text-tertiary);">days</div>
                                    </div>
                                    <div style="padding: 15px; background: rgba(245, 158, 11, 0.15); border-radius: 10px; border-left: 4px solid #f59e0b; text-align: center;">
                                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">DIO</div>
                                        <div style="font-size: 1.5em; font-weight: 700; color: #f59e0b; margin-bottom: 5px;">${cfAnalysis.cash_conversion_cycle.dio || 'N/A'}</div>
                                        <div style="font-size: 0.75em; color: var(--text-tertiary);">days</div>
                                    </div>
                                    <div style="padding: 15px; background: rgba(239, 68, 68, 0.15); border-radius: 10px; border-left: 4px solid #ef4444; text-align: center;">
                                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">DPO</div>
                                        <div style="font-size: 1.5em; font-weight: 700; color: #ef4444; margin-bottom: 5px;">${cfAnalysis.cash_conversion_cycle.dpo || 'N/A'}</div>
                                        <div style="font-size: 0.75em; color: var(--text-tertiary);">days</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${cfAnalysis.cash_runway && cfAnalysis.cash_runway.months !== null ? `
                            <div style="margin-top: 20px; padding: 20px; background: ${cfAnalysis.cash_runway.status === 'critical' ? 'rgba(239, 68, 68, 0.1)' : cfAnalysis.cash_runway.status === 'warning' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; border-radius: 12px; border-left: 4px solid ${cfAnalysis.cash_runway.status === 'critical' ? '#ef4444' : cfAnalysis.cash_runway.status === 'warning' ? '#f59e0b' : '#10b981'};">
                                <h4 style="margin-bottom: 10px; color: var(--text-primary);">Cash Runway</h4>
                                <div style="font-size: 2em; font-weight: 700; color: ${cfAnalysis.cash_runway.status === 'critical' ? '#ef4444' : cfAnalysis.cash_runway.status === 'warning' ? '#f59e0b' : '#10b981'};">
                                    ${cfAnalysis.cash_runway.months} months
                                </div>
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 5px;">
                                    ${cfAnalysis.cash_runway.status === 'critical' ? 'âš ï¸ Critical - Low cash runway' : cfAnalysis.cash_runway.status === 'warning' ? 'âš ï¸ Warning - Monitor closely' : 'âœ… Sufficient cash runway'}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Cash Flow Quality Verdict -->
                        ${(() => {
                            let verdict = 'Neutral';
                            let verdictColor = '#f59e0b';
                            let verdictBg = 'rgba(245, 158, 11, 0.1)';
                            let verdictEmoji = 'ðŸŸ¡';
                            let verdictText = '';
                            const reasons = [];
                            
                            // Analyze FCF trend
                            if (cfAnalysis.fcf_trend && cfAnalysis.fcf_trend.length >= 2) {
                                const latest = cfAnalysis.fcf_trend[0]?.fcf || 0;
                                const previous = cfAnalysis.fcf_trend[1]?.fcf || 0;
                                
                                if (latest > 0 && previous > 0) {
                                    const growth = ((latest - previous) / previous) * 100;
                                    if (growth > 20) {
                                        verdict = 'Strong';
                                        verdictColor = '#10b981';
                                        verdictBg = 'rgba(16, 185, 129, 0.1)';
                                        verdictEmoji = 'ðŸŸ¢';
                                        reasons.push('RychlÃ½ rÅ¯st FCF');
                                    } else if (growth > 0) {
                                        reasons.push('PozitivnÃ­ FCF trend');
                                    } else {
                                        reasons.push('FCF klesÃ¡');
                                    }
                                } else if (latest > 0) {
                                    reasons.push('PozitivnÃ­ FCF');
                                } else {
                                    verdict = 'Weak';
                                    verdictColor = '#ef4444';
                                    verdictBg = 'rgba(239, 68, 68, 0.1)';
                                    verdictEmoji = 'ðŸ”´';
                                    reasons.push('NegativnÃ­ FCF');
                                }
                            }
                            
                            // Analyze Operating CF
                            if (cfAnalysis.quarterly_breakdown && cfAnalysis.quarterly_breakdown.length > 0) {
                                const latestOcf = cfAnalysis.quarterly_breakdown[0]?.operating_cf || 0;
                                if (latestOcf > 0) {
                                    reasons.push('PozitivnÃ­ Operating CF');
                                } else {
                                    reasons.push('NegativnÃ­ Operating CF');
                                    if (verdict !== 'Strong') {
                                        verdict = 'Weak';
                                        verdictColor = '#ef4444';
                                        verdictBg = 'rgba(239, 68, 68, 0.1)';
                                        verdictEmoji = 'ðŸ”´';
                                    }
                                }
                            }
                            
                            // Cash runway analysis
                            if (cfAnalysis.cash_runway && cfAnalysis.cash_runway.months !== null) {
                                if (cfAnalysis.cash_runway.months < 6) {
                                    verdict = 'Weak';
                                    verdictColor = '#ef4444';
                                    verdictBg = 'rgba(239, 68, 68, 0.1)';
                                    verdictEmoji = 'ðŸ”´';
                                    reasons.push('KritickÃ½ cash runway');
                                } else if (cfAnalysis.cash_runway.months < 12) {
                                    if (verdict === 'Strong') verdict = 'Neutral';
                                    reasons.push('KrÃ¡tkÃ½ cash runway');
                                }
                            }
                            
                            // CCC analysis
                            if (cfAnalysis.cash_conversion_cycle && cfAnalysis.cash_conversion_cycle.ccc !== null) {
                                const ccc = cfAnalysis.cash_conversion_cycle.ccc;
                                if (ccc < 0) {
                                    reasons.push('NegativnÃ­ CCC (dobrÃ©)');
                                    if (verdict === 'Neutral') {
                                        verdict = 'Strong';
                                        verdictColor = '#10b981';
                                        verdictBg = 'rgba(16, 185, 129, 0.1)';
                                        verdictEmoji = 'ðŸŸ¢';
                                    }
                                } else if (ccc > 90) {
                                    reasons.push('DlouhÃ½ CCC');
                                }
                            }
                            
                            if (reasons.length === 0) {
                                verdictText = 'Cash flow data vyÅ¾adujÃ­ dalÅ¡Ã­ analÃ½zu';
                            } else {
                                verdictText = reasons.join(', ');
                            }
                            
                            return `
                                <div style="margin-top: 30px; padding: 25px; background: ${verdictBg}; border-radius: 12px; border: 2px solid ${verdictColor};">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                        <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                            ${verdictEmoji} Cash Flow Quality Verdict
                                        </h4>
                                        <div style="font-size: 1.5em; font-weight: 800; color: ${verdictColor};">
                                            ${verdict}
                                        </div>
                                    </div>
                                    <div style="font-size: 1em; color: var(--text-primary); line-height: 1.6;">
                                        ${verdictText}
                                    </div>
                                </div>
                            `;
                        })()}
                    </div>
                `;
            }
            
            // 2. Profitability Deep Dive
            if (data.profitability_analysis) {
                const profAnalysis = data.profitability_analysis;
                html += `
                    <div class="card" style="margin-bottom: 30px;">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            ðŸ“Š Profitability Deep Dive
                        </h3>
                        
                        ${profAnalysis.margin_trends && profAnalysis.margin_trends.length > 0 ? `
                            <div style="margin-top: 20px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        ðŸ“Š Margin Trends (Gross/Operating/Net)
                                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                            <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                                <strong>MarÅ¾e:</strong> Procento z trÅ¾eb, kterÃ© zÅ¯stane jako zisk.<br><br>
                                                <strong>Gross Margin:</strong> Po pÅ™Ã­mÃ½ch nÃ¡kladech (COGS). Ukazuje pricing power firmy.<br><br>
                                                <strong>Operating Margin:</strong> Po provoznÃ­ch nÃ¡kladech. Ukazuje efektivitu provozu.<br><br>
                                                <strong>Net Margin:</strong> Po vÅ¡ech nÃ¡kladech a danÃ­ch. FinÃ¡lnÃ­ ziskovost.<br><br>
                                                <strong>Co hledat:</strong> RostoucÃ­ marÅ¾e = firma zlepÅ¡uje efektivitu. KlesajÃ­cÃ­ = tlak na ziskovost.
                                            </span>
                                        </span>
                                    </h4>
                                </div>
                                <div style="position: relative; height: 350px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(102, 126, 234, 0.05) 100%); border-radius: 12px; padding: 15px;">
                                    <canvas id="marginTrendsChart-${ticker}"></canvas>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${profAnalysis.operating_leverage !== null ? `
                            <div style="margin-top: 20px; padding: 25px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(16, 185, 129, 0.15) 100%); border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        âš™ï¸ Operating Leverage
                                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                            <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                                <strong>Operating Leverage:</strong> MÄ›Å™Ã­, jak rychle roste provoznÃ­ zisk vzhledem k rÅ¯stu trÅ¾eb.<br><br>
                                                <strong>&gt; 1x:</strong> ProvoznÃ­ zisk roste rychleji neÅ¾ trÅ¾by = dobrÃ© znamenÃ­ (firma zlepÅ¡uje efektivitu).<br><br>
                                                <strong>&lt; 1x:</strong> ProvoznÃ­ zisk roste pomaleji neÅ¾ trÅ¾by = nÃ¡klady rostou rychleji.<br><br>
                                                <strong>VysokÃ¡ leverage:</strong> Firma mÃ¡ fixnÃ­ nÃ¡klady, takÅ¾e rÅ¯st trÅ¾eb vede k vÄ›tÅ¡Ã­mu rÅ¯stu zisku.
                                            </span>
                                        </span>
                                    </h4>
                                </div>
                                <div style="font-size: 3em; font-weight: 800; color: ${profAnalysis.operating_leverage > 1 ? '#10b981' : profAnalysis.operating_leverage < 1 ? '#ef4444' : '#f59e0b'}; text-align: center; margin-bottom: 10px;">
                                    ${profAnalysis.operating_leverage}x
                                </div>
                                <div style="font-size: 1em; color: var(--text-secondary); text-align: center; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                                    ${profAnalysis.operating_leverage > 1 ? 'âœ… Positive leverage - operating income grows faster than revenue' : profAnalysis.operating_leverage < 1 ? 'âš ï¸ Negative leverage - operating income grows slower than revenue' : 'âž¡ï¸ Neutral leverage'}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${profAnalysis.break_even_analysis ? `
                            <div style="margin-top: 20px; padding: 25px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%); border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        ðŸŽ¯ Break-Even Analysis
                                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                            <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                                <strong>Break-Even Analysis:</strong> Odhad, kdy firma dosÃ¡hne ziskovosti (pÅ™estane bÃ½t ve ztrÃ¡tÄ›).<br><br>
                                                <strong>Pro growth companies:</strong> Ukazuje, kolik Äasu potÅ™ebuje firma na rÅ¯st do ziskovosti.<br><br>
                                                <strong>Co znamenÃ¡:</strong> Pokud je odhad rozumnÃ½ (&lt;8 kvartÃ¡lÅ¯), firma mÃ¡ realistickÃ½ plÃ¡n na ziskovost. Pokud je velmi dlouhÃ½, mÅ¯Å¾e bÃ½t rizikovÃ©.
                                            </span>
                                        </span>
                                    </h4>
                                </div>
                                <div style="font-size: 2em; font-weight: 800; color: #667eea; text-align: center; margin-bottom: 15px;">
                                    ${profAnalysis.break_even_analysis.estimated_quarters} quarters
                                </div>
                                <div style="font-size: 0.95em; color: var(--text-secondary); text-align: center; margin-bottom: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                                    Estimated time to profitability
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 0.9em;">
                                    <div style="padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                        <div style="color: var(--text-secondary); margin-bottom: 5px;">Current Revenue</div>
                                        <div style="color: var(--text-primary); font-weight: 600;">${formatCurrency(profAnalysis.break_even_analysis.current_revenue)}</div>
                                    </div>
                                    <div style="padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                                        <div style="color: var(--text-secondary); margin-bottom: 5px;">Break-Even Revenue</div>
                                        <div style="color: var(--text-primary); font-weight: 600;">${formatCurrency(profAnalysis.break_even_analysis.estimated_revenue)}</div>
                                    </div>
                                    <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                        <div style="color: var(--text-secondary); margin-bottom: 5px;">Avg Growth Rate</div>
                                        <div style="color: var(--text-primary); font-weight: 600;">${profAnalysis.break_even_analysis.avg_growth_rate.toFixed(1)}%</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Profitability Quality Verdict -->
                        ${(() => {
                            let verdict = 'Neutral';
                            let verdictColor = '#f59e0b';
                            let verdictBg = 'rgba(245, 158, 11, 0.1)';
                            let verdictEmoji = 'ðŸŸ¡';
                            const reasons = [];
                            
                            // Analyze margin trends
                            if (profAnalysis.margin_trends && profAnalysis.margin_trends.length >= 2) {
                                const latest = profAnalysis.margin_trends[0];
                                const previous = profAnalysis.margin_trends[1];
                                
                                // Gross margin analysis
                                if (latest.gross_margin !== null && previous.gross_margin !== null) {
                                    const gmChange = latest.gross_margin - previous.gross_margin;
                                    if (gmChange > 5) {
                                        reasons.push('RostoucÃ­ gross margin');
                                        if (verdict !== 'Weak') {
                                            verdict = 'Strong';
                                            verdictColor = '#10b981';
                                            verdictBg = 'rgba(16, 185, 129, 0.1)';
                                            verdictEmoji = 'ðŸŸ¢';
                                        }
                                    } else if (gmChange < -5) {
                                        reasons.push('KlesajÃ­cÃ­ gross margin');
                                        verdict = 'Weak';
                                        verdictColor = '#ef4444';
                                        verdictBg = 'rgba(239, 68, 68, 0.1)';
                                        verdictEmoji = 'ðŸ”´';
                                    }
                                    
                                    if (latest.gross_margin >= 40) {
                                        reasons.push('VysokÃ¡ gross margin');
                                    } else if (latest.gross_margin < 20) {
                                        reasons.push('NÃ­zkÃ¡ gross margin');
                                    }
                                }
                                
                                // Operating margin analysis
                                if (latest.operating_margin !== null && previous.operating_margin !== null) {
                                    const omChange = latest.operating_margin - previous.operating_margin;
                                    if (omChange > 5) {
                                        reasons.push('RostoucÃ­ operating margin');
                                        if (verdict !== 'Weak') {
                                            verdict = 'Strong';
                                            verdictColor = '#10b981';
                                            verdictBg = 'rgba(16, 185, 129, 0.1)';
                                            verdictEmoji = 'ðŸŸ¢';
                                        }
                                    } else if (omChange < -5) {
                                        reasons.push('KlesajÃ­cÃ­ operating margin');
                                        if (verdict === 'Neutral') {
                                            verdict = 'Weak';
                                            verdictColor = '#ef4444';
                                            verdictBg = 'rgba(239, 68, 68, 0.1)';
                                            verdictEmoji = 'ðŸ”´';
                                        }
                                    }
                                }
                                
                                // Net margin analysis
                                if (latest.net_margin !== null && previous.net_margin !== null) {
                                    if (latest.net_margin > 0 && previous.net_margin <= 0) {
                                        reasons.push('DosaÅ¾enÃ­ ziskovosti');
                                        verdict = 'Strong';
                                        verdictColor = '#10b981';
                                        verdictBg = 'rgba(16, 185, 129, 0.1)';
                                        verdictEmoji = 'ðŸŸ¢';
                                    } else if (latest.net_margin < 0 && previous.net_margin >= 0) {
                                        reasons.push('ZtrÃ¡ta ziskovosti');
                                        verdict = 'Weak';
                                        verdictColor = '#ef4444';
                                        verdictBg = 'rgba(239, 68, 68, 0.1)';
                                        verdictEmoji = 'ðŸ”´';
                                    }
                                }
                            }
                            
                            // Operating leverage analysis
                            if (profAnalysis.operating_leverage !== null) {
                                if (profAnalysis.operating_leverage > 1.5) {
                                    reasons.push('SilnÃ¡ operating leverage');
                                    if (verdict !== 'Weak') {
                                        verdict = 'Strong';
                                        verdictColor = '#10b981';
                                        verdictBg = 'rgba(16, 185, 129, 0.1)';
                                        verdictEmoji = 'ðŸŸ¢';
                                    }
                                } else if (profAnalysis.operating_leverage < 0.5) {
                                    reasons.push('SlabÃ¡ operating leverage');
                                    if (verdict === 'Neutral') {
                                        verdict = 'Weak';
                                        verdictColor = '#ef4444';
                                        verdictBg = 'rgba(239, 68, 68, 0.1)';
                                        verdictEmoji = 'ðŸ”´';
                                    }
                                }
                            }
                            
                            // Break-even analysis
                            if (profAnalysis.break_even_analysis) {
                                const quarters = profAnalysis.break_even_analysis.estimated_quarters;
                                if (quarters <= 4) {
                                    reasons.push('BlÃ­zkÃ½ break-even');
                                    if (verdict !== 'Weak') {
                                        verdict = 'Strong';
                                        verdictColor = '#10b981';
                                        verdictBg = 'rgba(16, 185, 129, 0.1)';
                                        verdictEmoji = 'ðŸŸ¢';
                                    }
                                } else if (quarters > 12) {
                                    reasons.push('VzdÃ¡lenÃ½ break-even');
                                    if (verdict === 'Neutral') {
                                        verdict = 'Weak';
                                        verdictColor = '#ef4444';
                                        verdictBg = 'rgba(239, 68, 68, 0.1)';
                                        verdictEmoji = 'ðŸ”´';
                                    }
                                }
                            }
                            
                            const verdictText = reasons.length > 0 ? reasons.join(', ') : 'Profitability data vyÅ¾adujÃ­ dalÅ¡Ã­ analÃ½zu';
                            
                            return `
                                <div style="margin-top: 30px; padding: 25px; background: ${verdictBg}; border-radius: 12px; border: 2px solid ${verdictColor};">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                        <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                            ${verdictEmoji} Profitability Quality Verdict
                                        </h4>
                                        <div style="font-size: 1.5em; font-weight: 800; color: ${verdictColor};">
                                            ${verdict}
                                        </div>
                                    </div>
                                    <div style="font-size: 1em; color: var(--text-primary); line-height: 1.6;">
                                        ${verdictText}
                                    </div>
                                </div>
                            `;
                        })()}
                    </div>
                `;
            }
            
            // 3. Balance Sheet Health Score
            if (data.balance_sheet_health) {
                const bsHealth = data.balance_sheet_health;
                html += `
                    <div class="card" style="margin-bottom: 30px;">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            ðŸ¥ Balance Sheet Health Score
                        </h3>
                        
                        <div style="margin-top: 20px; padding: 25px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(102, 126, 234, 0.05) 100%); border-radius: 12px; border: 2px solid #667eea; text-align: center;">
                            <div style="font-size: 3em; font-weight: 800; color: #667eea; margin-bottom: 10px;">
                                ${bsHealth.health_score}/100
                            </div>
                            <div style="font-size: 1.1em; color: var(--text-secondary);">Health Score</div>
                            ${bsHealth.breakdown && Object.keys(bsHealth.breakdown).length > 0 ? `
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; font-weight: 600;">Breakdown:</div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.85em;">
                                        ${Object.entries(bsHealth.breakdown).map(([key, value]) => `
                                            <div>
                                                <div style="color: var(--text-secondary);">${key.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}:</div>
                                                <div style="color: var(--text-primary); font-weight: 600;">${value}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${bsHealth.trends && bsHealth.trends.length > 0 ? `
                            <div style="margin-top: 30px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        ðŸ“ˆ Balance Sheet Trends
                                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                            <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                                <strong>Current Ratio:</strong> Aktiva / ZÃ¡vazky. &gt;1.5 = dobrÃ¡ likvidita. Ukazuje schopnost splatit krÃ¡tkodobÃ© dluhy.<br><br>
                                                <strong>Quick Ratio:</strong> (Aktiva - ZÃ¡soby) / ZÃ¡vazky. PÅ™Ã­snÄ›jÅ¡Ã­ test likvidity, bez zÃ¡sob.<br><br>
                                                <strong>Debt-to-Equity:</strong> Dluh / VlastnÃ­ kapitÃ¡l. NiÅ¾Å¡Ã­ = mÃ©nÄ› zadluÅ¾enÃ¡ firma. &lt;0.5 = zdravÃ©.<br><br>
                                                <strong>Co hledat:</strong> StabilnÃ­ nebo zlepÅ¡ujÃ­cÃ­ se pomÄ›ry = zdravÃ¡ finanÄnÃ­ pozice.
                                            </span>
                                        </span>
                                    </h4>
                                </div>
                                <div style="position: relative; height: 350px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%); border-radius: 12px; padding: 15px;">
                                    <canvas id="balanceSheetTrendsChart-${ticker}"></canvas>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Balance Sheet Quality Verdict -->
                        ${(() => {
                            let verdict = 'Neutral';
                            let verdictColor = '#f59e0b';
                            let verdictBg = 'rgba(245, 158, 11, 0.1)';
                            let verdictEmoji = 'ðŸŸ¡';
                            const reasons = [];
                            
                            const score = bsHealth.health_score || 0;
                            
                            // Determine verdict based on health score
                            if (score >= 75) {
                                verdict = 'Strong';
                                verdictColor = '#10b981';
                                verdictBg = 'rgba(16, 185, 129, 0.1)';
                                verdictEmoji = 'ðŸŸ¢';
                            } else if (score < 40) {
                                verdict = 'Weak';
                                verdictColor = '#ef4444';
                                verdictBg = 'rgba(239, 68, 68, 0.1)';
                                verdictEmoji = 'ðŸ”´';
                            }
                            
                            // Analyze trends if available
                            if (bsHealth.trends && bsHealth.trends.length >= 2) {
                                const latest = bsHealth.trends[0];
                                const previous = bsHealth.trends[1];
                                
                                // Current ratio analysis
                                if (latest.current_ratio !== null && previous.current_ratio !== null) {
                                    if (latest.current_ratio >= 2.0) {
                                        reasons.push('VÃ½bornÃ¡ likvidita (Current Ratio)');
                                        if (verdict !== 'Weak') {
                                            verdict = 'Strong';
                                            verdictColor = '#10b981';
                                            verdictBg = 'rgba(16, 185, 129, 0.1)';
                                            verdictEmoji = 'ðŸŸ¢';
                                        }
                                    } else if (latest.current_ratio < 1.0) {
                                        reasons.push('NÃ­zkÃ¡ likvidita');
                                        verdict = 'Weak';
                                        verdictColor = '#ef4444';
                                        verdictBg = 'rgba(239, 68, 68, 0.1)';
                                        verdictEmoji = 'ðŸ”´';
                                    }
                                    
                                    const crChange = latest.current_ratio - previous.current_ratio;
                                    if (crChange > 0.3) {
                                        reasons.push('ZlepÅ¡ujÃ­cÃ­ se likvidita');
                                    } else if (crChange < -0.3) {
                                        reasons.push('ZhorÅ¡ujÃ­cÃ­ se likvidita');
                                    }
                                }
                                
                                // Debt-to-equity analysis
                                if (latest.debt_to_equity !== null && previous.debt_to_equity !== null) {
                                    if (latest.debt_to_equity <= 0.3) {
                                        reasons.push('NÃ­zkÃ½ dluh');
                                        if (verdict !== 'Weak') {
                                            verdict = 'Strong';
                                            verdictColor = '#10b981';
                                            verdictBg = 'rgba(16, 185, 129, 0.1)';
                                            verdictEmoji = 'ðŸŸ¢';
                                        }
                                    } else if (latest.debt_to_equity > 2.0) {
                                        reasons.push('VysokÃ½ dluh');
                                        verdict = 'Weak';
                                        verdictColor = '#ef4444';
                                        verdictBg = 'rgba(239, 68, 68, 0.1)';
                                        verdictEmoji = 'ðŸ”´';
                                    }
                                    
                                    const dteChange = latest.debt_to_equity - previous.debt_to_equity;
                                    if (dteChange > 0.5) {
                                        reasons.push('RostoucÃ­ zadluÅ¾enÃ­');
                                        if (verdict === 'Neutral') {
                                            verdict = 'Weak';
                                            verdictColor = '#ef4444';
                                            verdictBg = 'rgba(239, 68, 68, 0.1)';
                                            verdictEmoji = 'ðŸ”´';
                                        }
                                    }
                                }
                                
                                // Working capital efficiency
                                if (latest.working_capital_efficiency !== null) {
                                    if (latest.working_capital_efficiency <= 10) {
                                        reasons.push('EfektivnÃ­ working capital');
                                    } else if (latest.working_capital_efficiency > 30) {
                                        reasons.push('NeefektivnÃ­ working capital');
                                    }
                                }
                                
                                // Asset turnover
                                if (latest.asset_turnover !== null) {
                                    if (latest.asset_turnover >= 1.0) {
                                        reasons.push('VysokÃ¡ efektivita aktiv');
                                        if (verdict !== 'Weak') {
                                            verdict = 'Strong';
                                            verdictColor = '#10b981';
                                            verdictBg = 'rgba(16, 185, 129, 0.1)';
                                            verdictEmoji = 'ðŸŸ¢';
                                        }
                                    } else if (latest.asset_turnover < 0.3) {
                                        reasons.push('NÃ­zkÃ¡ efektivita aktiv');
                                    }
                                }
                            }
                            
                            // Add score-based reason
                            if (score >= 75) {
                                reasons.unshift('VysokÃ© health score');
                            } else if (score < 40) {
                                reasons.unshift('NÃ­zkÃ© health score');
                            }
                            
                            const verdictText = reasons.length > 0 ? reasons.join(', ') : `Health Score: ${score}/100`;
                            
                            return `
                                <div style="margin-top: 30px; padding: 25px; background: ${verdictBg}; border-radius: 12px; border: 2px solid ${verdictColor};">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                        <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                            ${verdictEmoji} Balance Sheet Quality Verdict
                                        </h4>
                                        <div style="font-size: 1.5em; font-weight: 800; color: ${verdictColor};">
                                            ${verdict}
                                        </div>
                                    </div>
                                    <div style="font-size: 1em; color: var(--text-primary); line-height: 1.6;">
                                        ${verdictText}
                                    </div>
                                </div>
                            `;
                        })()}
                    </div>
                `;
            }
            
            // 4. Management Guidance Tracking
            if (data.management_guidance) {
                const guidance = data.management_guidance;
                html += `
                    <div class="card" style="margin-bottom: 30px;">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            ðŸ“‹ Management Guidance Tracking
                        </h3>
                        
                        ${guidance.accuracy_score !== null ? `
                            <div style="margin-top: 20px; padding: 20px; background: var(--metric-bg); border-radius: 12px; text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #667eea; margin-bottom: 5px;">
                                    ${guidance.accuracy_score}%
                                </div>
                                <div style="font-size: 1em; color: var(--text-secondary);">Guidance Accuracy Score</div>
                            </div>
                        ` : ''}
                        
                        ${guidance.guidance_history && guidance.guidance_history.length > 0 ? `
                            <div style="margin-top: 30px;">
                                <h4 style="margin-bottom: 15px; color: var(--text-primary);">Guidance vs Actual Results</h4>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: var(--metric-bg); border-bottom: 2px solid var(--border-color);">
                                                <th style="padding: 12px; text-align: left; color: var(--text-primary); font-weight: 600;">Date</th>
                                                <th style="padding: 12px; text-align: right; color: var(--text-primary); font-weight: 600;">Revenue Guidance</th>
                                                <th style="padding: 12px; text-align: right; color: var(--text-primary); font-weight: 600;">Actual Revenue</th>
                                                <th style="padding: 12px; text-align: right; color: var(--text-primary); font-weight: 600;">EPS Guidance</th>
                                                <th style="padding: 12px; text-align: right; color: var(--text-primary); font-weight: 600;">Actual EPS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${guidance.guidance_history.map(entry => `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 12px; color: var(--text-primary);">${entry.date || 'N/A'}</td>
                                                    <td style="padding: 12px; text-align: right; color: var(--text-primary);">${entry.revenue_guidance ? formatCurrency(entry.revenue_guidance) : 'N/A'}</td>
                                                    <td style="padding: 12px; text-align: right; color: var(--text-primary);">${entry.actual_revenue ? formatCurrency(entry.actual_revenue) : 'N/A'}</td>
                                                    <td style="padding: 12px; text-align: right; color: var(--text-primary);">${entry.eps_guidance !== null && entry.eps_guidance !== undefined ? entry.eps_guidance.toFixed(2) : 'N/A'}</td>
                                                    <td style="padding: 12px; text-align: right; color: var(--text-primary);">${entry.actual_eps !== null && entry.actual_eps !== undefined ? entry.actual_eps.toFixed(2) : 'N/A'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${guidance.forward_guidance ? `
                            <div style="margin-top: 20px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; border-left: 4px solid #667eea;">
                                <h4 style="margin-bottom: 10px; color: var(--text-primary);">Forward Guidance</h4>
                                <div style="font-size: 0.9em; color: var(--text-secondary);">
                                    <div>Date: ${guidance.forward_guidance.date || 'N/A'}</div>
                                    ${guidance.forward_guidance.revenue_guidance ? `<div>Revenue: ${formatCurrency(guidance.forward_guidance.revenue_guidance)}</div>` : ''}
                                    ${guidance.forward_guidance.eps_guidance !== null ? `<div>EPS: ${guidance.forward_guidance.eps_guidance.toFixed(2)}</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // 5. Segment/Geography Breakdown
            if (data.segment_breakdown && data.segment_breakdown.available) {
                html += `
                    <div class="card" style="margin-bottom: 30px;">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            ðŸŒ Segment & Geography Analysis
                        </h3>
                        <div style="margin-top: 20px; padding: 20px; background: var(--metric-bg); border-radius: 12px; text-align: center; color: var(--text-secondary);">
                            Segment and geography data will be displayed here when available.
                        </div>
                    </div>
                `;
            }

            console.log('[Financials] Final HTML length before setting innerHTML:', html.length);
            console.log('[Financials] HTML contains Balance Sheet:', html.includes('Balance Sheet'));
            console.log('[Financials] HTML contains cash:', html.includes('Cash & Equivalents'));
            container.innerHTML = html;
            console.log('[Financials] innerHTML set, checking DOM...');
            
            // Check if Balance Sheet section exists in DOM
            setTimeout(() => {
                const bsSection = document.querySelector('h4:contains("Balance Sheet")') || 
                                 Array.from(document.querySelectorAll('h4')).find(h => h.textContent.includes('Balance Sheet'));
                console.log('[Financials] Balance Sheet section in DOM:', bsSection);
                if (bsSection) {
                    console.log('[Financials] Balance Sheet section parent:', bsSection.parentElement);
                    console.log('[Financials] Balance Sheet section computed style:', window.getComputedStyle(bsSection));
                }
            }, 100);

            // Create charts (use setTimeout to ensure DOM is updated)
            setTimeout(() => {
                if (incomeData && incomeData.length > 0) {
                    console.log('Creating charts with incomeData:', incomeData);
                    console.log('IncomeData length:', incomeData.length);
                    console.log('First item:', incomeData[0]);
                    try {
                        createRevenueChart(incomeData, ticker, data.forward_estimates);
                    } catch (e) {
                        console.error('Error creating revenue chart:', e);
                    }
                    try {
                        createEPSChart(incomeData, ticker, data.forward_estimates);
                    } catch (e) {
                        console.error('Error creating EPS chart:', e);
                    }
                    generateIncomeInsights(incomeData);
                } else {
                    console.warn('No incomeData available for charts');
                }
                
                if (cfData && cfData.length > 0) {
                    createCashFlowChart(cfData);
                }
                
                // Render sparklines
                renderSparklines();
                
                // Create sector comparison bars - REMOVED
                if (false && data.peer_comparison && data.peer_comparison.peers && data.peer_comparison.peers.length > 0) {
                    try {
                        createSectorComparisonChart(data, ticker);
                    } catch (e) {
                        console.error('Error creating sector comparison chart:', e);
                    }
                }
                
                // Create advanced analysis charts
                if (data.cash_flow_analysis) {
                    try {
                        console.log('[Financials] Creating cash flow charts, data:', data.cash_flow_analysis);
                        createCashFlowBreakdownChart(data.cash_flow_analysis, ticker);
                        if (data.cash_flow_analysis.fcf_trend && data.cash_flow_analysis.fcf_trend.length > 0) {
                            // Add small delay to ensure canvas is in DOM
                            setTimeout(() => {
                                try {
                                    createFCFTrendChart(data.cash_flow_analysis, ticker);
                                } catch (e) {
                                    console.error('[FCF Chart] Error creating FCF trend chart:', e);
                                }
                            }, 100);
                        } else {
                            console.warn('[FCF Chart] No FCF trend data or empty array');
                        }
                    } catch (e) {
                        console.error('Error creating cash flow charts:', e);
                        console.error('Stack trace:', e.stack);
                    }
                } else {
                    console.warn('[Financials] No cash_flow_analysis data available');
                }
                
                if (data.profitability_analysis && data.profitability_analysis.margin_trends && data.profitability_analysis.margin_trends.length > 0) {
                    try {
                        createMarginTrendsChart(data.profitability_analysis, ticker);
                    } catch (e) {
                        console.error('Error creating margin trends chart:', e);
                    }
                }
                
                if (data.balance_sheet_health && data.balance_sheet_health.trends && data.balance_sheet_health.trends.length > 0) {
                    try {
                        createBalanceSheetTrendsChart(data.balance_sheet_health, ticker);
                    } catch (e) {
                        console.error('Error creating balance sheet trends chart:', e);
                    }
                }
                
                // Create Balance Sheet Structure Chart
                if (data.balance_sheet && data.balance_sheet.total_assets !== null && data.balance_sheet.total_assets !== undefined) {
                    try {
                        setTimeout(() => {
                            createBalanceSheetStructureChart(data.balance_sheet, ticker);
                        }, 100);
                    } catch (e) {
                        console.error('Error creating balance sheet structure chart:', e);
                    }
                }
                
                // Create analyst estimates table
                console.log('[DEBUG] loadFinancials: Checking forward_estimates', {
                    hasForwardEstimates: !!data.forward_estimates,
                    forwardEstimatesKeys: data.forward_estimates ? Object.keys(data.forward_estimates) : [],
                    revenueKeys: data.forward_estimates?.revenue ? Object.keys(data.forward_estimates.revenue) : [],
                    epsKeys: data.forward_estimates?.eps ? Object.keys(data.forward_estimates.eps) : [],
                    incomeDataLength: incomeData?.length || 0
                });
                if (data.forward_estimates) {
                    console.log('[DEBUG] loadFinancials: Calling createAnalystEstimatesTable');
                    try {
                        createAnalystEstimatesTable(data.forward_estimates, ticker, incomeData);
                        console.log('[DEBUG] loadFinancials: createAnalystEstimatesTable called successfully');
                    } catch (e) {
                        console.error('Error creating analyst estimates table:', e);
                    }
                } else {
                    console.log('[DEBUG] loadFinancials: No forward_estimates in data', {dataKeys: Object.keys(data)});
                }
            }, 200);
        }
        
        let currentPerformanceTabs = {
            revenue: 'value',
            eps: 'value'
        };
        
        function switchPerformanceTab(metric, type) {
            currentPerformanceTabs[metric] = type;
            
            // Update button states with animations
            document.querySelectorAll(`button[data-metric="${metric}"]`).forEach(btn => {
                if (btn.getAttribute('data-type') === type) {
                    btn.classList.add('active');
                    if (metric === 'revenue') {
                        btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        btn.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.3)';
                    } else {
                        btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                        btn.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.3)';
                    }
                    btn.style.color = 'white';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'transparent';
                    btn.style.boxShadow = 'none';
                    btn.style.color = 'var(--text-primary)';
                    btn.style.transform = 'scale(1)';
                }
            });
            
            // Re-render chart
            const incomeData = currentFinancialsData?.income_statement?.[financialsPeriod] || [];
            if (incomeData.length > 0) {
                if (metric === 'revenue') {
                    createRevenueChart(incomeData, currentFinancialsData?.ticker || '');
                } else if (metric === 'eps') {
                    createEPSChart(incomeData, currentFinancialsData?.ticker || '');
                }
            }
        }
        
        function renderSparklines() {
            // Find all canvas elements with sparkline data attribute
            const sparklineCanvases = document.querySelectorAll('canvas[data-sparkline]');
            
            sparklineCanvases.forEach(canvas => {
                const dataStr = canvas.getAttribute('data-sparkline');
                if (!dataStr) return;
                
                let data;
                try {
                    data = JSON.parse(dataStr);
                } catch (e) {
                    console.error('Error parsing sparkline data:', e);
                    return;
                }
                
                if (!data || data.length === 0) return;
                
                const ctx = canvas.getContext('2d');
                const width = canvas.width = canvas.offsetWidth * 2; // For retina
                const height = canvas.height = canvas.offsetHeight * 2;
                ctx.scale(2, 2); // Scale for retina
                
                // Clear canvas
                ctx.clearRect(0, 0, width / 2, height / 2);
                
                // Normalize data
                const min = Math.min(...data);
                const max = Math.max(...data);
                const range = max - min || 1;
                
                // Draw sparkline
                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary') || '#667eea';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                const stepX = (width / 2 - 4) / (data.length - 1);
                const padding = 2;
                
                data.forEach((value, index) => {
                    const x = padding + index * stepX;
                    const normalizedValue = (value - min) / range;
                    const y = padding + (height / 2 - padding * 2) * (1 - normalizedValue);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // Fill area under line
                ctx.lineTo(width / 2 - padding, height / 2 - padding);
                ctx.lineTo(padding, height / 2 - padding);
                ctx.closePath();
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary') || '#667eea';
                ctx.globalAlpha = 0.1;
                ctx.fill();
                ctx.globalAlpha = 1.0;
            });
        }

        function createRevenueChart(data, ticker, forwardEstimates = null) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) {
                console.error('revenueChart canvas element not found!');
                return;
            }
            
            // Check canvas dimensions
            console.log('Canvas dimensions:', {
                width: ctx.width,
                height: ctx.height,
                clientWidth: ctx.clientWidth,
                clientHeight: ctx.clientHeight,
                offsetWidth: ctx.offsetWidth,
                offsetHeight: ctx.offsetHeight,
                style: ctx.style.cssText
            });
            
            // Debug: Log incoming data
            console.log('=== createRevenueChart called ===');
            console.log('Data received:', data);
            console.log('Data length:', data.length);
            if (data.length > 0) {
                console.log('First item:', data[0]);
                console.log('First item revenue_estimate:', data[0].revenue_estimate);
                console.log('All revenue_estimates:', data.map(d => ({ quarter: d.quarter, revenue: d.revenue, revenue_estimate: d.revenue_estimate })));
            }
            
            // Destroy existing chart if it exists
            if (window.revenueChartInstance) {
                window.revenueChartInstance.destroy();
            }

            const labels = data.map(d => {
                const quarter = d.quarter || d.date;
                // Format: Q4 '22 -> Q4 '22, or 2024-Q4 -> Q4 '24
                if (quarter.includes('-Q')) {
                    const [year, q] = quarter.split('-Q');
                    return `Q${q} '${year.slice(-2)}`;
                }
                return quarter;
            }).reverse(); // Reverse to show oldest to newest
            
            const showGrowth = currentPerformanceTabs.revenue === 'growth';
            
            let chartData, chartLabels, expectations, beatMissed;
            
            if (showGrowth) {
                // Calculate growth rates
                const revenues = data.map(d => d.revenue || 0).reverse();
                chartData = [];
                chartLabels = labels.slice(1); // Skip first label (no previous quarter to compare)
                
                for (let i = 1; i < revenues.length; i++) {
                    if (revenues[i-1] > 0) {
                        const growth = ((revenues[i] - revenues[i-1]) / revenues[i-1]) * 100;
                        chartData.push(growth);
                    } else {
                        chartData.push(0);
                    }
                }
                expectations = null;
                beatMissed = null;
            } else {
                // Show actual revenue values
                // IMPORTANT: yfinance returns data from NEWEST to OLDEST
                // So data[0] = newest quarter, data[data.length-1] = oldest quarter
                // After reverse: chartData[0] = oldest, chartData[chartData.length-1] = newest
                const revenues = data.map(d => d.revenue || 0);
                chartData = [...revenues].reverse(); // Reverse to show oldest to newest
                chartLabels = labels;
                
                // Get estimates from backend data (if available) or calculate fallback
                // Backend provides revenue_estimate field if available
                // Both revenue and revenue_estimate are in actual dollars (not millions)
                // Data from backend is newest first, so we need to match estimates by quarter string
                
                // Create a map of quarter -> estimate for easier lookup
                const estimateMap = {};
                data.forEach((d, idx) => {
                    const quarter = d.quarter || d.date;
                    if (quarter && d.revenue_estimate !== null && d.revenue_estimate !== undefined && !isNaN(d.revenue_estimate) && d.revenue_estimate > 0) {
                        estimateMap[quarter] = d.revenue_estimate;
                    }
                });
                
                // Estimate expectations: use backend estimates if available, otherwise calculate
                // chartData is now: [oldest, ..., newest] (after reverse)
                // We need to match estimates by quarter string, not by index
                expectations = [];
                beatMissed = [];
                
                for (let i = 0; i < chartData.length; i++) {
                    let estimate = null;
                    
                    // Get quarter string for this index (after reverse, so oldest first)
                    // data is newest first, so data[data.length - 1 - i] is the i-th oldest
                    const quarterStr = data[data.length - 1 - i]?.quarter || data[data.length - 1 - i]?.date;
                    
                    // Use backend estimate if available (lookup by quarter string)
                    if (quarterStr && estimateMap[quarterStr]) {
                        estimate = estimateMap[quarterStr];
                    }
                    // No fallback - if estimate not available, leave as null
                    
                    expectations.push(estimate);
                    
                    // Determine Beat/Missed only if we have an estimate
                    if (estimate !== null && estimate !== undefined && !isNaN(estimate) && estimate > 0) {
                        const actual = chartData[i];
                        const threshold = estimate * 0.98;
                        const isBeat = actual >= threshold;
                        beatMissed.push(isBeat ? 'Beat' : 'Missed');
                    } else {
                        beatMissed.push(null); // No estimate available
                    }
                }
                
                // Debug: Log final expectations array
                console.log('Final Expectations Array:', expectations);
                console.log('Expectations count:', expectations.length, 'Chart data count:', chartData.length);
                
                // Add future quarters from forward_estimates if available
                if (forwardEstimates && forwardEstimates.revenue) {
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth() + 1;
                    const currentQuarter = Math.ceil(currentMonth / 3);
                    
                    const futureRevenueEstimates = forwardEstimates.revenue;
                    const futureQuarters = Object.keys(futureRevenueEstimates)
                        .filter(quarter => {
                            if (!quarter.includes('-Q')) return false;
                            const [year, q] = quarter.split('-Q');
                            const quarterYear = parseInt(year);
                            const quarterNum = parseInt(q);
                            return quarterYear > currentYear || (quarterYear === currentYear && quarterNum > currentQuarter);
                        })
                        .sort()
                        .slice(0, 4); // Next 4 future quarters
                    
                    console.log('Future quarters to add:', futureQuarters);
                    
                    // Add future quarters to chart
                    futureQuarters.forEach(quarter => {
                        const revenueEst = futureRevenueEstimates[quarter];
                        if (revenueEst && revenueEst > 0) {
                            // Format quarter label
                            const [year, q] = quarter.split('-Q');
                            const quarterLabel = `Q${q} '${year.slice(-2)}`;
                            
                            // Add to chart data (use estimate value for bar, but mark as future)
                            // This way the bar shows the estimate, but is styled differently
                            chartData.push(revenueEst); // Use estimate value for bar height
                            chartLabels.push(quarterLabel);
                            expectations.push(revenueEst);
                            beatMissed.push('Future'); // Mark as future quarter
                        }
                    });
                    
                    console.log('After adding future quarters - Chart data count:', chartData.length, 'Labels count:', chartLabels.length);
                }
            }
            
            // Create solid colors first (gradients will be added via plugin)
            const barColors = showGrowth 
                ? chartData.map((v, i) => {
                    return v >= 0 
                        ? 'rgba(16, 185, 129, 0.9)'
                        : 'rgba(239, 68, 68, 0.9)';
                })
                : chartData.map((v, i) => {
                    // Future quarters (no actual data) - use different color
                    if (beatMissed && beatMissed[i] === 'Future') {
                        return 'rgba(156, 163, 175, 0.3)'; // Light gray for future quarters
                    }
                    if (expectations && beatMissed && beatMissed[i] !== null && beatMissed[i] !== 'Future') {
                        return beatMissed[i] === 'Beat' 
                            ? 'rgba(16, 185, 129, 0.9)'
                            : 'rgba(239, 68, 68, 0.9)';
                    }
                    return 'rgba(102, 126, 234, 0.9)';
                });

            // Check if we should add estimate line
            // We should add estimate line if we have at least one valid estimate
            const hasValidEstimates = expectations && expectations.length > 0 && 
                expectations.some(e => e !== null && e !== undefined && !isNaN(e) && e > 0);
            const shouldAddEstimateLine = !showGrowth && hasValidEstimates;
            
            console.log('Should add estimate line?', shouldAddEstimateLine, {
                showGrowth,
                hasExpectations: !!expectations,
                expectationsLength: expectations ? expectations.length : 0,
                hasValidValues: hasValidEstimates,
                expectationsArray: expectations
            });

            // Build datasets array - use spread operator like EPS chart
            const barDataset = {
                label: showGrowth ? 'Revenue Growth %' : 'Actual Revenue',
                data: chartData,
                backgroundColor: barColors,
                borderColor: showGrowth 
                    ? chartData.map(v => v >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)')
                    : chartData.map((v, i) => {
                        // Future quarters (no actual data) - use different color
                        if (beatMissed && beatMissed[i] === 'Future') {
                            return 'rgba(156, 163, 175, 0.6)'; // Gray for future quarters
                        }
                        if (expectations && beatMissed) {
                            return beatMissed[i] === 'Beat' ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';
                        }
                        return 'rgba(102, 126, 234, 1)';
                    }),
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
                barThickness: 'flex',
                maxBarThickness: 60
            };

            const estimateDataset = shouldAddEstimateLine ? {
                label: 'Estimate',
                data: expectations,
                type: 'line',
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                borderWidth: 3,
                borderDash: [8, 4],
                pointRadius: 6,
                pointHoverRadius: 8,
                pointBackgroundColor: '#f59e0b',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointHoverBackgroundColor: '#fbbf24',
                pointHoverBorderColor: '#ffffff',
                fill: false,
                tension: 0.1,
                spanGaps: true
            } : null;

            const datasets = [
                barDataset,
                ...(shouldAddEstimateLine && estimateDataset ? [estimateDataset] : [])
            ];

            console.log('Final datasets array:', datasets);
            console.log('Datasets count:', datasets ? datasets.length : 0);
            console.log('Chart labels:', chartLabels);
            console.log('Chart labels count:', chartLabels ? chartLabels.length : 0);

            // Chart.js 4.x supports mixed charts natively - just specify type per dataset
            // The first dataset determines the base chart type (bar), others can override with type: 'line'
            console.log('Creating Chart.js instance with:', {
                labelsCount: chartLabels ? chartLabels.length : 0,
                datasetsCount: datasets.length,
                firstDatasetType: datasets[0]?.type || 'bar',
                secondDatasetType: datasets[1]?.type || 'none',
                chartDataSample: chartData ? chartData.slice(0, 3) : null,
                expectationsSample: expectations ? expectations.slice(0, 3) : null
            });
            
            // Verify Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded!');
                return;
            }
            
            try {
                console.log('Creating Chart.js instance...');
                window.revenueChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart',
                        delay: (context) => {
                            let delay = 0;
                            if (context.type === 'data' && context.mode === 'default') {
                                delay = context.dataIndex * 100;
                            }
                            return delay;
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: showGrowth ? false : true,
                            ticks: {
                                callback: function(value) {
                                    if (showGrowth) {
                                        if (value === null || value === undefined || isNaN(value) || typeof value !== 'number') {
                                            return 'N/A';
                                        }
                                        return value.toFixed(1) + '%';
                                    }
                                    return formatCurrency(value);
                                },
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || 'var(--text-secondary)',
                                font: {
                                    size: 14,
                                    weight: '600'
                                },
                                padding: 8
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() || 'rgba(255, 255, 255, 0.05)',
                                lineWidth: 1,
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || 'var(--text-secondary)',
                                font: {
                                    size: 14,
                                    weight: '600'
                                },
                                padding: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() || 'var(--text-primary)',
                                font: {
                                    size: 14,
                                    weight: '600'
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: document.body.classList.contains('dark-mode') ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            titleFont: {
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (showGrowth) {
                                        label += context.parsed.y.toFixed(1) + '%';
                                    } else {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    if (!showGrowth && expectations && context.datasetIndex === 0) {
                                        const estimate = expectations[context.dataIndex];
                                        const actual = context.parsed.y;
                                        const diff = actual - estimate;
                                        // Use absolute value of estimate to handle negative values correctly
                                        // For negative EPS: actual -0.03 vs estimate -0.10 means actual is better (less negative)
                                        // diff = +0.07, so we want +70% (not -70%)
                                        const diffPct = estimate !== 0 ? ((diff / Math.abs(estimate)) * 100).toFixed(1) : '0.0';
                                        const diffPctNum = parseFloat(diffPct);
                                        label += ` (${diffPctNum >= 0 ? '+' : ''}${diffPct}% vs estimate)`;
                                    }
                                    return label;
                                }
                            }
                        },
                        annotation: {
                            annotations: {}
                        }
                    }
                },
                plugins: [{
                    id: 'beatMissedLabels',
                    afterDraw: (chart) => {
                        if (!showGrowth && beatMissed && beatMissed.length > 0) {
                            const ctx = chart.ctx;
                            ctx.save();
                            chart.data.datasets.forEach((dataset, i) => {
                                if (i === 0) { // Only for first dataset (bars)
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((bar, index) => {
                                        // Chart.js displays data in the same order as provided
                                        // chartData and beatMissed are both in order [oldest, ..., newest]
                                        // So index should match directly
                                        if (index >= beatMissed.length || beatMissed[index] === null) {
                                            // Skip if no estimate available
                                            return;
                                        }
                                        
                                        const value = dataset.data[index];
                                        const x = bar.x;
                                        const y = bar.y;
                                        
                                        const isBeat = beatMissed[index] === 'Beat';
                                        const bgColor = isBeat ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                                        const textColor = isBeat ? '#10b981' : '#ef4444';
                                        
                                        // Draw background rounded rectangle
                                        const labelText = beatMissed[index];
                                        ctx.font = 'bold 12px Arial';
                                        const textMetrics = ctx.measureText(labelText);
                                        const textWidth = textMetrics.width;
                                        const padding = 6;
                                        const rectWidth = textWidth + padding * 2;
                                        const rectHeight = 18;
                                        const rectX = x - rectWidth / 2;
                                        const rectY = value >= 0 ? y - 60 : y + 25;
                                        
                                        // Rounded rectangle
                                        ctx.fillStyle = bgColor;
                                        ctx.beginPath();
                                        const radius = 6;
                                        ctx.moveTo(rectX + radius, rectY);
                                        ctx.lineTo(rectX + rectWidth - radius, rectY);
                                        ctx.quadraticCurveTo(rectX + rectWidth, rectY, rectX + rectWidth, rectY + radius);
                                        ctx.lineTo(rectX + rectWidth, rectY + rectHeight - radius);
                                        ctx.quadraticCurveTo(rectX + rectWidth, rectY + rectHeight, rectX + rectWidth - radius, rectY + rectHeight);
                                        ctx.lineTo(rectX + radius, rectY + rectHeight);
                                        ctx.quadraticCurveTo(rectX, rectY + rectHeight, rectX, rectY + rectHeight - radius);
                                        ctx.lineTo(rectX, rectY + radius);
                                        ctx.quadraticCurveTo(rectX, rectY, rectX + radius, rectY);
                                        ctx.closePath();
                                        ctx.fill();
                                        
                                        // Border
                                        ctx.strokeStyle = textColor;
                                        ctx.lineWidth = 1.5;
                                        ctx.stroke();
                                        
                                        // Text
                                        ctx.fillStyle = textColor;
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        ctx.fillText(labelText, x, rectY + rectHeight / 2);
                                    });
                                }
                            });
                            ctx.restore();
                        }
                    }
                }]
            });
            
            console.log('Chart created successfully:', window.revenueChartInstance);
            console.log('Chart data:', window.revenueChartInstance?.data);
            console.log('Chart datasets:', window.revenueChartInstance?.data?.datasets);
            console.log('Chart width:', window.revenueChartInstance?.width);
            console.log('Chart height:', window.revenueChartInstance?.height);
            console.log('Chart canvas:', window.revenueChartInstance?.canvas);
            
            // Force update/redraw
            if (window.revenueChartInstance) {
                window.revenueChartInstance.update('none'); // Update without animation
                console.log('Chart updated (forced redraw)');
            }
            
            } catch (error) {
                console.error('Error creating revenue chart:', error);
                console.error('Error stack:', error.stack);
                console.error('Chart data:', {
                    labels: chartLabels,
                    datasets: datasets,
                    chartData: chartData,
                    expectations: expectations
                });
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    chartLabels: chartLabels,
                    datasets: datasets,
                    chartData: chartData,
                    expectations: expectations
                });
            }
        }
        
        function createCashFlowBreakdownChart(cfAnalysis, ticker) {
            const ctx = document.getElementById(`cashFlowBreakdownChart-${ticker}`);
            if (!ctx || typeof Chart === 'undefined') {
                console.warn('[Cash Flow Chart] Canvas or Chart.js not available');
                return;
            }
            
            const breakdown = cfAnalysis.quarterly_breakdown || [];
            if (breakdown.length === 0) {
                console.warn('[Cash Flow Chart] No breakdown data available');
                return;
            }
            
            console.log('[Cash Flow Chart] Breakdown data:', breakdown);
            
            const labels = breakdown.map(q => {
                const qStr = q.quarter || q.date;
                if (qStr && qStr.includes('-Q')) {
                    const [year, qNum] = qStr.split('-Q');
                    return `Q${qNum} '${year.slice(-2)}`;
                }
                return qStr || 'N/A';
            }).reverse();
            
            const operating = breakdown.map(q => {
                const val = q.operating_cf;
                return (val !== null && val !== undefined && !isNaN(val)) ? parseFloat(val) : 0;
            }).reverse();
            const investing = breakdown.map(q => {
                const val = q.investing_cf;
                return (val !== null && val !== undefined && !isNaN(val)) ? parseFloat(val) : 0;
            }).reverse();
            const financing = breakdown.map(q => {
                const val = q.financing_cf;
                return (val !== null && val !== undefined && !isNaN(val)) ? parseFloat(val) : 0;
            }).reverse();
            
            console.log('[Cash Flow Chart] Data arrays:', { operating, investing, financing, labels });
            
            const isDark = document.body.classList.contains('dark-mode');
            const chartTextColor = isDark ? '#e5e7eb' : '#1f2937';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)';
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ðŸ’° Operating CF',
                            data: operating,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 2.5,
                            borderRadius: 6,
                            borderSkipped: false
                        },
                        {
                            label: 'ðŸ“‰ Investing CF',
                            data: investing,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: '#ef4444',
                            borderWidth: 2.5,
                            borderRadius: 6,
                            borderSkipped: false
                        },
                        {
                            label: 'ðŸ’³ Financing CF',
                            data: financing,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 2.5,
                            borderRadius: 6,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart',
                        delay: (context) => context.dataIndex * 100
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            stacked: false,
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                },
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                padding: 10
                            },
                            grid: {
                                color: gridColor,
                                lineWidth: 1,
                                drawBorder: false
                            },
                            // Always use linear scale for better visibility
                            type: 'linear'
                        },
                        x: {
                            stacked: false,
                            ticks: {
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                padding: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: chartTextColor,
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            titleFont: {
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const label = context.dataset.label.replace(/[ðŸ’°ðŸ“‰ðŸ’³]/g, '').trim();
                                    const value = formatCurrency(context.parsed.y);
                                    const sign = context.parsed.y >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
                                    return `${sign} ${label}: ${value}`;
                                },
                                footer: function(tooltipItems) {
                                    const total = tooltipItems.reduce((sum, item) => sum + item.parsed.y, 0);
                                    return `Total: ${formatCurrency(total)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createBalanceSheetStructureChart(balanceSheet, ticker) {
            const ctx = document.getElementById(`balanceSheetStructureChart-${ticker}`);
            if (!ctx || typeof Chart === 'undefined') {
                console.warn('[Balance Sheet Chart] Canvas or Chart.js not available');
                return;
            }
            
            const bs = balanceSheet;
            if (!bs || (bs.total_assets === null || bs.total_assets === undefined)) {
                console.warn('[Balance Sheet Chart] No balance sheet data available');
                return;
            }
            
            console.log('[Balance Sheet Chart] Creating chart with data:', bs);
            
            // Calculate values for Assets and Liabilities + Equity
            const cash = bs.cash || 0;
            const currentAssets = bs.current_assets || 0;
            const totalAssets = bs.total_assets || 0;
            const nonCurrentAssets = totalAssets - currentAssets;
            const currentAssetsMinusCash = Math.max(0, currentAssets - cash);
            
            const currentLiabilities = bs.current_liabilities || 0;
            const longTermDebt = bs.long_term_debt || 0;
            const shortTermDebt = bs.short_term_debt || 0;
            const totalLiabilities = bs.total_liabilities || 0;
            const equity = bs.equity || 0;
            const otherLiabilities = Math.max(0, totalLiabilities - currentLiabilities - (longTermDebt + shortTermDebt));
            
            const isDark = document.body.classList.contains('dark-mode');
            const chartTextColor = isDark ? '#e5e7eb' : '#1f2937';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)';
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Assets', 'Liabilities & Equity'],
                    datasets: [
                        {
                            label: 'ðŸ’° Cash',
                            data: [cash, 0],
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 2
                        },
                        {
                            label: 'ðŸ“¦ Current Assets (ex Cash)',
                            data: [currentAssetsMinusCash, 0],
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderColor: '#667eea',
                            borderWidth: 2
                        },
                        {
                            label: 'ðŸ¢ Non-Current Assets',
                            data: [nonCurrentAssets, 0],
                            backgroundColor: 'rgba(102, 126, 234, 0.5)',
                            borderColor: '#667eea',
                            borderWidth: 2
                        },
                        {
                            label: 'âš¡ Current Liabilities',
                            data: [0, currentLiabilities],
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: '#ef4444',
                            borderWidth: 2
                        },
                        {
                            label: 'ðŸ“Š Long-term Debt',
                            data: [0, longTermDebt],
                            backgroundColor: 'rgba(245, 158, 11, 0.7)',
                            borderColor: '#f59e0b',
                            borderWidth: 2
                        },
                        {
                            label: 'ðŸ“Š Short-term Debt',
                            data: [0, shortTermDebt],
                            backgroundColor: 'rgba(245, 158, 11, 0.5)',
                            borderColor: '#f59e0b',
                            borderWidth: 2
                        },
                        {
                            label: 'ðŸ“‹ Other Liabilities',
                            data: [0, otherLiabilities],
                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                            borderColor: '#ef4444',
                            borderWidth: 2
                        },
                        {
                            label: 'ðŸ’Ž Equity',
                            data: [0, equity],
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderColor: '#10b981',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: chartTextColor,
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                padding: 12,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label.replace(/[ðŸ’°ðŸ“¦ðŸ¢âš¡ðŸ“ŠðŸ“‹ðŸ’Ž]/g, '').trim();
                                    const value = formatCurrency(context.parsed.x);
                                    const percent = context.dataset.label.includes('Assets') || context.parsed.x === 0
                                        ? totalAssets > 0 ? ((context.parsed.x / totalAssets) * 100).toFixed(1) + '%'
                                        : '0%'
                                        : (totalAssets > 0 ? ((context.parsed.x / totalAssets) * 100).toFixed(1) + '%' : '0%');
                                    return `${label}: ${value} (${percent})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                },
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '600'
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                color: chartTextColor,
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function createFCFTrendChart(cfAnalysis, ticker) {
            console.log('[FCF Chart] Creating FCF trend chart for', ticker, cfAnalysis);
            const ctx = document.getElementById(`fcfTrendChart-${ticker}`);
            if (!ctx) {
                console.error('[FCF Chart] Canvas element not found:', `fcfTrendChart-${ticker}`);
                return;
            }
            if (typeof Chart === 'undefined') {
                console.error('[FCF Chart] Chart.js is not loaded');
                return;
            }
            
            const trend = cfAnalysis.fcf_trend || [];
            if (trend.length === 0) {
                console.warn('[FCF Chart] No FCF trend data available');
                return;
            }
            
            console.log('[FCF Chart] Trend data:', trend);
            
            const labels = trend.map(q => {
                const qStr = q.quarter || q.date;
                if (!qStr) return 'N/A';
                if (qStr && typeof qStr === 'string' && qStr.includes('-Q')) {
                    const [year, qNum] = qStr.split('-Q');
                    return `Q${qNum} '${year.slice(-2)}`;
                }
                return qStr;
            }).reverse();
            
            const fcf = trend.map(q => q.fcf || 0).reverse();
            
            const isDark = document.body.classList.contains('dark-mode');
            const chartTextColor = isDark ? '#e5e7eb' : '#1f2937';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)';
            
            const datasets = [{
                label: 'ðŸ’° Free Cash Flow',
                data: fcf,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderWidth: 4,
                fill: true,
                tension: 0.5,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointHoverBackgroundColor: '#764ba2',
                pointHoverBorderColor: '#ffffff'
            }];
            
            // Add projection if available
            if (cfAnalysis.fcf_projection && cfAnalysis.fcf_projection.next_quarter !== null) {
                const projectionLabels = [...labels];
                const lastQuarter = labels[labels.length - 1];
                // Estimate next quarter label
                const nextQuarter = lastQuarter.replace(/'(\d{2})/, (match, year) => {
                    const nextYear = (parseInt(year) + 1) % 100;
                    return `'${nextYear.toString().padStart(2, '0')}`;
                });
                projectionLabels.push(nextQuarter);
                
                datasets.push({
                    label: 'ðŸ”® Projected FCF',
                    data: [...fcf, cfAnalysis.fcf_projection.next_quarter],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.05)',
                    borderWidth: 3,
                    borderDash: [8, 4],
                    fill: false,
                    tension: 0.5,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#f59e0b',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: '#fbbf24'
                });
            }
            
            // Determine which labels to use
            let finalLabels = labels;
            if (datasets.length > 1 && cfAnalysis.fcf_projection && cfAnalysis.fcf_projection.next_quarter !== null) {
                const projectionLabels = [...labels];
                const lastQuarter = labels[labels.length - 1];
                // Estimate next quarter label
                const nextQuarter = lastQuarter.replace(/'(\d{2})/, (match, year) => {
                    const nextYear = (parseInt(year) + 1) % 100;
                    return `'${nextYear.toString().padStart(2, '0')}`;
                });
                projectionLabels.push(nextQuarter);
                finalLabels = projectionLabels;
            }
            
            console.log('[FCF Chart] Final labels:', finalLabels);
            console.log('[FCF Chart] Final datasets:', datasets);
            
            // Destroy existing chart if it exists
            if (window[`fcfTrendChartInstance_${ticker}`]) {
                window[`fcfTrendChartInstance_${ticker}`].destroy();
            }
            
            try {
                window[`fcfTrendChartInstance_${ticker}`] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: finalLabels,
                        datasets: datasets
                    },
                    options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                },
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                padding: 10
                            },
                            grid: {
                                color: gridColor,
                                lineWidth: 1,
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                padding: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: chartTextColor,
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            titleFont: {
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const label = context.dataset.label.replace(/[ðŸ’°ðŸ”®]/g, '').trim();
                                    const value = formatCurrency(context.parsed.y);
                                    const trend = context.parsed.y >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
                                    return `${trend} ${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
                });
                console.log('[FCF Chart] Chart created successfully for', ticker);
            } catch (error) {
                console.error('[FCF Chart] Error creating chart for', ticker, ':', error);
                console.error('[FCF Chart] Error details:', {
                    message: error.message,
                    stack: error.stack,
                    labels: finalLabels,
                    datasetsCount: datasets.length
                });
            }
        }
        
        function createMarginTrendsChart(profAnalysis, ticker) {
            const ctx = document.getElementById(`marginTrendsChart-${ticker}`);
            if (!ctx || typeof Chart === 'undefined') return;
            
            const trends = profAnalysis.margin_trends || [];
            if (trends.length === 0) return;
            
            const labels = trends.map(t => {
                const qStr = t.quarter || t.date;
                if (qStr && qStr.includes('-Q')) {
                    const [year, qNum] = qStr.split('-Q');
                    return `Q${qNum} '${year.slice(-2)}`;
                }
                return qStr;
            }).reverse();
            
            const gross = trends.map(t => t.gross_margin || 0).reverse();
            const operating = trends.map(t => t.operating_margin || 0).reverse();
            const net = trends.map(t => t.net_margin || 0).reverse();
            
            const isDark = document.body.classList.contains('dark-mode');
            const chartTextColor = isDark ? '#e5e7eb' : '#1f2937';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)';
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ðŸ“Š Gross Margin',
                            data: gross,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.25)',
                            borderWidth: 3.5,
                            fill: true,
                            tension: 0.5,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2.5,
                            pointHoverBackgroundColor: '#059669',
                            pointHoverBorderColor: '#ffffff'
                        },
                        {
                            label: 'âš™ï¸ Operating Margin',
                            data: operating,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.25)',
                            borderWidth: 3.5,
                            fill: true,
                            tension: 0.5,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2.5,
                            pointHoverBackgroundColor: '#764ba2',
                            pointHoverBorderColor: '#ffffff'
                        },
                        {
                            label: 'ðŸ’° Net Margin',
                            data: net,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.25)',
                            borderWidth: 3.5,
                            fill: true,
                            tension: 0.5,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2.5,
                            pointHoverBackgroundColor: '#fbbf24',
                            pointHoverBorderColor: '#ffffff'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart',
                        delay: (context) => context.dataIndex * 50
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                },
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                padding: 10
                            },
                            grid: {
                                color: gridColor,
                                lineWidth: 1,
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                padding: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: chartTextColor,
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            titleFont: {
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const label = context.dataset.label.replace(/[ðŸ“Šâš™ï¸ðŸ’°]/g, '').trim();
                                    const value = context.parsed.y.toFixed(1) + '%';
                                    const trend = context.parsed.y >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
                                    return `${trend} ${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createBalanceSheetTrendsChart(bsHealth, ticker) {
            const ctx = document.getElementById(`balanceSheetTrendsChart-${ticker}`);
            if (!ctx || typeof Chart === 'undefined') return;
            
            const trends = bsHealth.trends || [];
            if (trends.length === 0) return;
            
            const labels = trends.map(t => {
                const qStr = t.quarter || t.date;
                if (qStr && qStr.includes('-Q')) {
                    const [year, qNum] = qStr.split('-Q');
                    return `Q${qNum} '${year.slice(-2)}`;
                }
                return qStr;
            }).reverse();
            
            const currentRatio = trends.map(t => t.current_ratio || 0).reverse();
            const quickRatio = trends.map(t => t.quick_ratio || 0).reverse();
            const debtToEquity = trends.map(t => t.debt_to_equity || 0).reverse();
            
            const isDark = document.body.classList.contains('dark-mode');
            const chartTextColor = isDark ? '#e5e7eb' : '#1f2937';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)';
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ðŸ’§ Current Ratio',
                            data: currentRatio,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.25)',
                            borderWidth: 3.5,
                            fill: true,
                            tension: 0.5,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2.5,
                            pointHoverBackgroundColor: '#059669',
                            yAxisID: 'y'
                        },
                        {
                            label: 'âš¡ Quick Ratio',
                            data: quickRatio,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.25)',
                            borderWidth: 3.5,
                            fill: true,
                            tension: 0.5,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2.5,
                            pointHoverBackgroundColor: '#764ba2',
                            yAxisID: 'y'
                        },
                        {
                            label: 'ðŸ“Š Debt-to-Equity',
                            data: debtToEquity,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.25)',
                            borderWidth: 3.5,
                            fill: true,
                            tension: 0.5,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2.5,
                            pointHoverBackgroundColor: '#fbbf24',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart',
                        delay: (context) => context.dataIndex * 50
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                padding: 10
                            },
                            grid: {
                                color: gridColor,
                                lineWidth: 1,
                                drawBorder: false
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            ticks: {
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                padding: 10
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: chartTextColor,
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                padding: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: chartTextColor,
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            titleFont: {
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const label = context.dataset.label.replace(/[ðŸ’§âš¡ðŸ“Š]/g, '').trim();
                                    const value = context.parsed.y.toFixed(2);
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createEPSChart(data, ticker) {
            const ctx = document.getElementById('epsChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (window.epsChartInstance) {
                window.epsChartInstance.destroy();
            }

            const labels = data.map(d => {
                const quarter = d.quarter || d.date;
                if (quarter.includes('-Q')) {
                    const [year, q] = quarter.split('-Q');
                    return `Q${q} '${year.slice(-2)}`;
                }
                return quarter;
            }).reverse();
            
            const showGrowth = currentPerformanceTabs.eps === 'growth';
            
            // Get EPS from data (must be explicitly provided - no fallback calculation)
            const epsData = data.map(d => {
                // Only use EPS if it's explicitly provided and not null/undefined
                if (d.eps !== null && d.eps !== undefined && !isNaN(d.eps)) {
                    return d.eps;
                }
                // Return null if EPS is not available (will be filtered out)
                return null;
            }).reverse();
            
            // Filter out null values and track indices for label alignment
            const validEpsIndices = [];
            const validEpsData = [];
            epsData.forEach((val, idx) => {
                if (val !== null && val !== undefined && !isNaN(val)) {
                    validEpsIndices.push(idx);
                    validEpsData.push(val);
                }
            });
            
            // If no valid EPS data, show message instead of chart
            if (validEpsData.length === 0) {
                const container = ctx.parentElement;
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <p>EPS data not available for this company.</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Filter labels to match valid EPS data indices
            const filteredLabels = validEpsIndices.map(idx => labels[idx]);
            const filteredData = data.filter((d, idx) => {
                const reversedIdx = data.length - 1 - idx;
                return validEpsIndices.includes(reversedIdx);
            }).reverse(); // Reverse to match the order of validEpsData (oldest first)
            
            let chartData, chartLabels, expectations, beatMissed;
            
            if (showGrowth) {
                chartData = [];
                chartLabels = filteredLabels.slice(1);
                
                for (let i = 1; i < validEpsData.length; i++) {
                    if (validEpsData[i-1] !== 0 && validEpsData[i-1] !== null && validEpsData[i-1] !== undefined) {
                        const growth = ((validEpsData[i] - validEpsData[i-1]) / Math.abs(validEpsData[i-1])) * 100;
                        chartData.push(growth);
                    } else {
                        chartData.push(0);
                    }
                }
                expectations = null;
                beatMissed = null;
            } else {
                chartData = validEpsData;
                chartLabels = filteredLabels;
                
                // Estimate expectations: use backend estimates if available, otherwise None
                // chartData is now: [oldest, ..., newest] (after reverse)
                // Get EPS estimates from backend data (if available)
                // Create a map of quarter -> estimate for easier lookup
                const epsEstimateMap = {};
                filteredData.forEach(d => {
                    const quarter = d.quarter || d.date;
                    if (quarter && d.eps_estimate !== null && d.eps_estimate !== undefined && !isNaN(d.eps_estimate) && d.eps_estimate !== 0) {
                        epsEstimateMap[quarter] = d.eps_estimate;
                    }
                });
                
                console.log('EPS Estimate Map:', epsEstimateMap);
                
                expectations = [];
                beatMissed = [];
                
                for (let i = 0; i < chartData.length; i++) {
                    let estimate = null;
                    
                    // Get quarter string from filtered data (which matches valid EPS indices)
                    const quarterStr = filteredData[i]?.quarter || filteredData[i]?.date;
                    
                    // Use backend estimate if available (lookup by quarter string)
                    if (quarterStr && epsEstimateMap[quarterStr]) {
                        estimate = epsEstimateMap[quarterStr];
                        console.log(`Using backend EPS estimate for quarter ${i} (${quarterStr}): ${estimate}`);
                    }
                    // No fallback - if estimate not available, leave as null
                    
                    expectations.push(estimate);
                    
                    // Determine Beat/Missed only if we have an estimate
                    if (estimate !== null && estimate !== undefined && !isNaN(estimate)) {
                        const actual = chartData[i];
                        const threshold = estimate * 0.98;
                        const isBeat = actual >= threshold;
                        beatMissed.push(isBeat ? 'Beat' : 'Missed');
                    } else {
                        beatMissed.push(null); // No estimate available
                    }
                }
            }
            
            // Create solid colors first (gradients will be added via plugin)
            const barColors = showGrowth 
                ? chartData.map((v, i) => {
                    return v >= 0 
                        ? 'rgba(16, 185, 129, 0.9)'
                        : 'rgba(239, 68, 68, 0.9)';
                })
                : chartData.map((v, i) => {
                    if (expectations && beatMissed && beatMissed[i] !== null) {
                        return beatMissed[i] === 'Beat' 
                            ? 'rgba(16, 185, 129, 0.9)'
                            : 'rgba(239, 68, 68, 0.9)';
                    }
                    return v >= 0 
                        ? 'rgba(16, 185, 129, 0.9)'
                        : 'rgba(239, 68, 68, 0.9)';
                });

            window.epsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: showGrowth ? 'EPS Growth %' : 'Actual EPS',
                            data: chartData,
                            backgroundColor: barColors,
                            borderColor: showGrowth 
                                ? chartData.map(v => v >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)')
                                : chartData.map((v, i) => {
                                    if (expectations && beatMissed && beatMissed[i] !== null) {
                                        return beatMissed[i] === 'Beat' ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';
                                    }
                                    return v >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';
                                }),
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                            barThickness: 45,
                            maxBarThickness: 45,
                            barPercentage: 0.5,
                            categoryPercentage: 0.7
                        },
                        ...(showGrowth ? [] : (expectations && expectations.some(e => e !== null && e !== undefined && !isNaN(e) && e !== 0)) ? [{
                            label: 'Estimate',
                            data: expectations,
                            type: 'line',
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 3,
                            borderDash: [8, 4],
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverBackgroundColor: '#fbbf24',
                            pointHoverBorderColor: '#ffffff',
                            fill: true,
                            tension: 0.4,
                            spanGaps: false
                        }] : [])
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart',
                        delay: (context) => {
                            let delay = 0;
                            if (context.type === 'data' && context.mode === 'default') {
                                delay = context.dataIndex * 100;
                            }
                            return delay;
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: showGrowth ? false : false, // Don't force zero for EPS - let it auto-scale for better visibility
                            ticks: {
                                callback: function(value) {
                                    if (showGrowth) {
                                        return value.toFixed(1) + '%';
                                    }
                                    // Format EPS values - handle small values better
                                    if (Math.abs(value) < 0.01) {
                                        return '$' + value.toFixed(4);
                                    } else if (Math.abs(value) < 1) {
                                        return '$' + value.toFixed(3);
                                    } else {
                                    return '$' + value.toFixed(2);
                                    }
                                },
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || 'var(--text-secondary)',
                                font: {
                                    size: 14,
                                    weight: '600'
                                },
                                padding: 12
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() || 'rgba(255, 255, 255, 0.05)',
                                lineWidth: 1,
                                drawBorder: false,
                                zeroLineColor: 'rgba(255, 255, 255, 0.2)',
                                zeroLineWidth: 2
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || 'var(--text-secondary)',
                                font: {
                                    size: 14,
                                    weight: '600'
                                },
                                padding: 15
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() || 'var(--text-primary)',
                                font: {
                                    size: 14,
                                    weight: '600'
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: document.body.classList.contains('dark-mode') ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            titleFont: {
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (showGrowth) {
                                        label += context.parsed.y.toFixed(1) + '%';
                                    } else {
                                        // Format EPS values better in tooltip
                                        const epsValue = context.parsed.y;
                                        if (Math.abs(epsValue) < 0.01) {
                                            label += '$' + epsValue.toFixed(4);
                                        } else if (Math.abs(epsValue) < 1) {
                                            label += '$' + epsValue.toFixed(3);
                                        } else {
                                            label += '$' + epsValue.toFixed(2);
                                        }
                                    }
                                    if (!showGrowth && expectations && context.datasetIndex === 0) {
                                        const estimate = expectations[context.dataIndex];
                                        if (estimate !== null && estimate !== undefined && !isNaN(estimate)) {
                                        const actual = context.parsed.y;
                                        const diff = actual - estimate;
                                        // Use absolute value of estimate to handle negative values correctly
                                        // For negative EPS: actual -0.03 vs estimate -0.10 means actual is better (less negative)
                                        // diff = +0.07, so we want +70% (not -70%)
                                        const diffPct = estimate !== 0 ? ((diff / Math.abs(estimate)) * 100).toFixed(1) : '0.0';
                                        const diffPctNum = parseFloat(diffPct);
                                        label += ` (${diffPctNum >= 0 ? '+' : ''}${diffPct}% vs estimate)`;
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'beatMissedLabels',
                    afterDraw: (chart) => {
                        if (!showGrowth && beatMissed && beatMissed.length > 0) {
                            const ctx = chart.ctx;
                            ctx.save();
                            chart.data.datasets.forEach((dataset, i) => {
                                if (i === 0) {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((bar, index) => {
                                        // Chart.js displays data in the same order as provided
                                        // chartData and beatMissed are both in order [oldest, ..., newest]
                                        // So index should match directly
                                        if (index >= beatMissed.length || beatMissed[index] === null) {
                                            // Skip if no estimate available
                                            return;
                                        }
                                        
                                        const value = dataset.data[index];
                                        const x = bar.x;
                                        const y = bar.y;
                                        
                                        const isBeat = beatMissed[index] === 'Beat';
                                        const bgColor = isBeat ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                                        const textColor = isBeat ? '#10b981' : '#ef4444';
                                        
                                        // Draw background rounded rectangle
                                        const labelText = beatMissed[index];
                                        ctx.font = 'bold 12px Arial';
                                        const textMetrics = ctx.measureText(labelText);
                                        const textWidth = textMetrics.width;
                                        const padding = 6;
                                        const rectWidth = textWidth + padding * 2;
                                        const rectHeight = 18;
                                        const rectX = x - rectWidth / 2;
                                        const rectY = value >= 0 ? y - 60 : y + 25;
                                        
                                        // Rounded rectangle
                                        ctx.fillStyle = bgColor;
                                        ctx.beginPath();
                                        const radius = 6;
                                        ctx.moveTo(rectX + radius, rectY);
                                        ctx.lineTo(rectX + rectWidth - radius, rectY);
                                        ctx.quadraticCurveTo(rectX + rectWidth, rectY, rectX + rectWidth, rectY + radius);
                                        ctx.lineTo(rectX + rectWidth, rectY + rectHeight - radius);
                                        ctx.quadraticCurveTo(rectX + rectWidth, rectY + rectHeight, rectX + rectWidth - radius, rectY + rectHeight);
                                        ctx.lineTo(rectX + radius, rectY + rectHeight);
                                        ctx.quadraticCurveTo(rectX, rectY + rectHeight, rectX, rectY + rectHeight - radius);
                                        ctx.lineTo(rectX, rectY + radius);
                                        ctx.quadraticCurveTo(rectX, rectY, rectX + radius, rectY);
                                        ctx.closePath();
                                        ctx.fill();
                                        
                                        // Border
                                        ctx.strokeStyle = textColor;
                                        ctx.lineWidth = 1.5;
                                        ctx.stroke();
                                        
                                        // Text
                                        ctx.fillStyle = textColor;
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        ctx.fillText(labelText, x, rectY + rectHeight / 2);
                                    });
                                }
                            });
                            ctx.restore();
                        }
                    }
                }]
            });
        }

        function createCashFlowChart(data) {
            const ctx = document.getElementById('cashFlowChart');
            if (!ctx) return;

            const labels = data.map(d => d.quarter || d.date);
            const ocf = data.map(d => d.operating_cf || 0);
            const capex = data.map(d => d.capex || 0);
            const fcf = data.map(d => d.fcf || 0);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Operating CF',
                            data: ocf,
                            backgroundColor: 'rgba(102, 126, 234, 0.6)'
                        },
                        {
                            label: 'CapEx',
                            data: capex,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)'
                        },
                        {
                            label: 'Free Cash Flow',
                            data: fcf,
                            backgroundColor: 'rgba(16, 185, 129, 0.6)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateIncomeInsights(data) {
            const container = document.getElementById('incomeStatementInsights');
            if (!container || data.length < 2) return;

            const revenues = data.map(d => d.revenue).filter(r => r !== null && r !== undefined);
            const incomes = data.map(d => d.net_income).filter(i => i !== null && i !== undefined);

            let insights = [];

            // Calculate average revenue growth
            // Note: data is ordered from newest to oldest (revenues[0] = most recent, revenues[1] = previous, etc.)
            // To calculate growth, we compare each quarter to the PREVIOUS (newer) quarter
            // Growth from Q2 to Q1 = (Q1 - Q2) / Q2
            // So: (revenues[i] - revenues[i-1]) / revenues[i-1]
            if (revenues.length >= 2) {
                const growthRates = [];
                for (let i = 1; i < revenues.length; i++) {
                    // revenues[i-1] is newer quarter, revenues[i] is older quarter
                    // Growth = (older - newer) / newer = (revenues[i] - revenues[i-1]) / revenues[i-1]
                    if (revenues[i-1] > 0 && revenues[i-1] !== null && revenues[i] !== null) {
                        const growth = ((revenues[i] - revenues[i-1]) / revenues[i-1]) * 100;
                        growthRates.push(growth);
                    }
                }
                if (growthRates.length > 0) {
                    const avgGrowth = growthRates.reduce((a, b) => a + b, 0) / growthRates.length;
                    // Use correct wording based on sign
                    if (avgGrowth > 0) {
                        insights.push(`Revenue roste prÅ¯mÄ›rnÄ› +${avgGrowth.toFixed(1)}% ${financialsPeriod === 'quarterly' ? 'kvartÃ¡lnÄ›' : 'roÄnÄ›'}.`);
                    } else if (avgGrowth < 0) {
                        insights.push(`Revenue klesÃ¡ prÅ¯mÄ›rnÄ› ${avgGrowth.toFixed(1)}% ${financialsPeriod === 'quarterly' ? 'kvartÃ¡lnÄ›' : 'roÄnÄ›'}.`);
                    } else {
                        insights.push(`Revenue je stabilnÃ­ (prÅ¯mÄ›rnÃ½ rÅ¯st ${avgGrowth.toFixed(1)}% ${financialsPeriod === 'quarterly' ? 'kvartÃ¡lnÄ›' : 'roÄnÄ›'}).`);
                    }
                }
            }

            // Check if income grows faster than revenue
            // Note: data is ordered from newest to oldest
            if (revenues.length >= 2 && incomes.length >= 2) {
                // Compare newest (index 0) to oldest (last index)
                const oldestRevenue = revenues[revenues.length - 1];
                const newestRevenue = revenues[0];
                const oldestIncome = incomes[incomes.length - 1];
                const newestIncome = incomes[0];
                
                if (oldestRevenue > 0 && oldestIncome !== null && newestIncome !== null && newestRevenue !== null) {
                    const revenueGrowth = ((newestRevenue - oldestRevenue) / oldestRevenue) * 100;
                    const incomeGrowth = ((newestIncome - oldestIncome) / oldestIncome) * 100;
                    if (incomeGrowth > revenueGrowth && revenueGrowth > 0) {
                        insights.push('Zisk roste rychleji neÅ¾ trÅ¾by (to je dÅ¯leÅ¾itÃ©!) â†’ zlepÅ¡ujÃ­cÃ­ se efektivita.');
                    }
                }
            }

            if (insights.length > 0) {
                container.innerHTML = '<div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">ðŸ’¡ Insights:</div>' +
                    insights.map(insight => `<div style="color: var(--text-secondary); margin-bottom: 5px;">â€¢ ${insight}</div>`).join('');
            }
        }

        // Earnings Call Analysis Functions
        let selectedEarningsCallFile = null;

        function handleEarningsCallFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedEarningsCallFile = file;
                const fileNameDiv = document.getElementById('earningsCallFileName');
                const uploadBtn = document.getElementById('earningsCallUploadBtn');
                
                if (fileNameDiv) {
                    fileNameDiv.innerHTML = `Selected: <strong>${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                }
                if (uploadBtn) {
                    uploadBtn.style.display = 'block';
                }
            }
        }

        async function uploadEarningsCall(event, ticker) {
            event.preventDefault();
            
            if (!selectedEarningsCallFile) {
                showToast('Please select a PDF file first', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', selectedEarningsCallFile);
            formData.append('ticker', ticker || '');
            
            const resultDiv = document.getElementById('earningsCallAnalysisResult');
            const uploadBtn = document.getElementById('earningsCallUploadBtn');
            
            if (!resultDiv || !uploadBtn) {
                showToast('Error: UI elements not found', 'error');
                return;
            }
            
            // Show loading state
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = 'â³ Analyzing...';
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 20px; color: var(--text-secondary);">Analyzing earnings call presentation...</p>
                    <p style="font-size: 0.85em; color: var(--text-tertiary); margin-top: 10px;">This may take 30-60 seconds</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/analyze-earnings-call', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to analyze earnings call');
                }
                
                // Display results
                displayEarningsCallAnalysis(data);
                
                showToast('Earnings call analyzed successfully', 'success');
                
            } catch (error) {
                console.error('Error analyzing earnings call:', error);
                resultDiv.innerHTML = `
                    <div style="padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border-left: 4px solid #ef4444;">
                        <div style="color: #ef4444; font-weight: 600; margin-bottom: 10px;">âŒ Error</div>
                        <div style="color: var(--text-secondary);">${error.message}</div>
                        <button onclick="uploadEarningsCall(event, '${ticker}')" style="margin-top: 15px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
                    </div>
                `;
                showToast('Error analyzing earnings call', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'ðŸ¤– Analyze with AI';
            }
        }

        function displayEarningsCallAnalysis(data) {
            const resultDiv = document.getElementById('earningsCallAnalysisResult');
            if (!resultDiv) return;
            
            const structured = data.structured_data || {};
            
            // Helper function to escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            let html = `
                <div style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0; color: var(--text-primary);">ðŸ¤– AI Analysis Results</h4>
                        <span style="font-size: 0.85em; color: var(--text-secondary);">${data.pages_extracted || 0} pages analyzed</span>
                    </div>
                    
                    ${structured.executive_summary ? `
                        <div style="margin-bottom: 25px; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ“‹ Executive Summary</h5>
                            <p style="color: var(--text-primary); line-height: 1.6; margin: 0;">${escapeHtml(structured.executive_summary)}</p>
                        </div>
                    ` : ''}
                    
                    ${structured.financial_highlights && structured.financial_highlights.length > 0 ? `
                        <div style="margin-bottom: 25px;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ’° Key Financial Highlights</h5>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${structured.financial_highlights.map(highlight => `
                                    <li style="padding: 10px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                        <span style="position: absolute; left: 0; color: #10b981;">âœ“</span>${escapeHtml(highlight)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${structured.strategic_initiatives && structured.strategic_initiatives.length > 0 ? `
                        <div style="margin-bottom: 25px;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">ðŸš€ Strategic Initiatives</h5>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${structured.strategic_initiatives.map(initiative => `
                                    <li style="padding: 10px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                        <span style="position: absolute; left: 0; color: #667eea;">â†’</span>${escapeHtml(initiative)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${structured.management_outlook && structured.management_outlook.length > 0 ? `
                        <div style="margin-bottom: 25px;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ”® Management Outlook</h5>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${structured.management_outlook.map(outlook => `
                                    <li style="padding: 10px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                        <span style="position: absolute; left: 0; color: #f59e0b;">ðŸ“Š</span>${escapeHtml(outlook)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${structured.risks_challenges && structured.risks_challenges.length > 0 ? `
                        <div style="margin-bottom: 25px;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">âš ï¸ Risks & Challenges</h5>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${structured.risks_challenges.map(risk => `
                                    <li style="padding: 10px 0; padding-left: 25px; position: relative; color: var(--text-primary); border-bottom: 1px solid var(--border-light);">
                                        <span style="position: absolute; left: 0; color: #ef4444;">âš </span>${escapeHtml(risk)}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${structured.overall_sentiment ? `
                        <div style="margin-top: 25px; padding: 20px; background: ${structured.overall_sentiment === 'positive' ? 'rgba(16, 185, 129, 0.1)' : structured.overall_sentiment === 'negative' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; border-radius: 10px; border-left: 4px solid ${structured.overall_sentiment === 'positive' ? '#10b981' : structured.overall_sentiment === 'negative' ? '#ef4444' : '#f59e0b'};">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 1.1em;">
                                ${structured.overall_sentiment === 'positive' ? 'ðŸŸ¢' : structured.overall_sentiment === 'negative' ? 'ðŸ”´' : 'ðŸŸ¡'} Overall Sentiment: ${structured.overall_sentiment === 'positive' ? 'Positive' : structured.overall_sentiment === 'negative' ? 'Negative' : 'Neutral'}
                            </h5>
                            ${structured.sentiment_explanation ? `
                                <p style="color: var(--text-secondary); margin: 0; line-height: 1.6;">${escapeHtml(structured.sentiment_explanation)}</p>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${data.ai_summary ? `
                        <div style="margin-top: 25px; padding: 20px; background: var(--metric-bg); border-radius: 10px;">
                            <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1em;">ðŸ“ Full AI Summary</h5>
                            <div style="color: var(--text-primary); line-height: 1.8; white-space: pre-wrap;">${escapeHtml(data.ai_summary)}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        // Allow Enter key in financials input
        document.addEventListener('DOMContentLoaded', function() {
            const financialsInput = document.getElementById('financialsTickerInput');
            if (financialsInput) {
                financialsInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loadFinancials();
                    }
                });
            }
            
            const analystInsiderInput = document.getElementById('analystInsiderTickerInput');
            if (analystInsiderInput) {
                analystInsiderInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loadAnalystInsider();
                    }
                });
            }
        });

        // Analyst & Insider Functions
        async function loadAnalystInsider() {
            const ticker = document.getElementById('analystInsiderTickerInput').value.trim().toUpperCase();
            if (!ticker) {
                showError('Please enter a stock ticker');
                return;
            }
            
            const container = document.getElementById('analystInsiderContent');
            container.innerHTML = `
                <div class="skeleton-card">
                    <div class="skeleton skeleton-title"></div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="skeleton skeleton-metric"></div>
                        <div class="skeleton skeleton-metric"></div>
                        <div class="skeleton skeleton-metric"></div>
                    </div>
                    <div style="margin-top: 30px;">
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                        <div class="skeleton skeleton-table-row"></div>
                    </div>
                </div>
            `;
            
            try {
                const [analystResponse, insiderResponse, institutionalResponse] = await Promise.all([
                    window.cachedFetch(`/api/analyst-data/${ticker}`),
                    window.cachedFetch(`/api/insider-trading/${ticker}?page=1&limit=20`),
                    window.cachedFetch(`/api/institutional-analysis/${ticker}`)
                ]);
                
                // Add to recent searches
                let companyName = ticker;
                if (analystResponse.ok) {
                    const analystDataTemp = await analystResponse.clone().json();
                    companyName = analystDataTemp.company_name || ticker;
                }
                addToRecentSearches(ticker, companyName);
                
                let analystData = null;
                let insiderData = null;
                let institutionalData = null;
                let errors = [];
                
                if (analystResponse.ok) {
                    analystData = await analystResponse.json();
                    if (analystData.error) {
                        errors.push(`Analyst data: ${analystData.error}`);
                    }
                } else {
                    const errorText = await analystResponse.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        errors.push(`Analyst data: ${errorJson.error || 'Not available'}`);
                    } catch {
                        errors.push(`Analyst data: Not available (${analystResponse.status})`);
                    }
                }
                
                if (insiderResponse.ok) {
                    insiderData = await insiderResponse.json();
                    if (insiderData.error) {
                        errors.push(`Insider data: ${insiderData.error}`);
                    }
                } else {
                    const errorText = await insiderResponse.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        errors.push(`Insider data: ${errorJson.error || 'Not available'}`);
                    } catch {
                        errors.push(`Insider data: Not available (${insiderResponse.status})`);
                    }
                }
                
                if (institutionalResponse.ok) {
                    try {
                        institutionalData = await institutionalResponse.json();
                        if (institutionalData && institutionalData.error) {
                            errors.push(`Institutional data: ${institutionalData.error}`);
                            institutionalData = null; // Set to null if there's an error
                        }
                    } catch (e) {
                        console.error('Error parsing institutional data:', e);
                        errors.push(`Institutional data: Parse error`);
                        institutionalData = null;
                    }
                } else {
                    const errorText = await institutionalResponse.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        errors.push(`Institutional data: ${errorJson.error || 'Not available'}`);
                    } catch {
                        errors.push(`Institutional data: Not available (${institutionalResponse.status})`);
                    }
                    institutionalData = null;
                }
                
                // Display data even if one endpoint failed
                displayAnalystInsider(analystData, insiderData, institutionalData, ticker, errors);
            } catch (error) {
                console.error('Error loading analyst/insider data:', error);
                container.innerHTML = `<div class="error">Error loading data: ${error.message}. Please check if the ticker "${ticker}" is valid.</div>`;
            } finally {
                const button = document.querySelector('button[onclick*="loadAnalystInsider"]');
                if (button && button.classList.contains('loading')) {
                    button.classList.remove('loading');
                    button.innerHTML = button.dataset.originalText || 'ðŸ” Load Data';
                }
            }
        }

        async function loadInsiderPage(page, ticker) {
            window.insiderCurrentPage = page;
            try {
                const response = await window.cachedFetch(`/api/insider-trading/${ticker}?page=${page}&limit=20`);
                if (!response.ok) throw new Error('Failed to load insider data');
                const insiderData = await response.json();
                
                // Reload analyst & insider section
                const analystResponse = await window.cachedFetch(`/api/analyst-data/${ticker}`);
                const analystData = analystResponse.ok ? await analystResponse.json() : null;
                
                const institutionalResponse = await window.cachedFetch(`/api/institutional-analysis/${ticker}`);
                const institutionalData = institutionalResponse.ok ? await institutionalResponse.json() : null;
                
                displayAnalystInsider(analystData, insiderData, institutionalData, ticker);
            } catch (error) {
                console.error('Error loading insider page:', error);
                showError('Failed to load insider trading data');
            }
        }
        
        function displayAnalystInsider(analystData, insiderData, institutionalData, ticker, errors = []) {
            const container = document.getElementById('analystInsiderContent');
            let html = '';
            
            // Store insider pagination info if available
            if (insiderData && insiderData.total_pages) {
                window.insiderCurrentPage = insiderData.page || 1;
                window.insiderTotalPages = insiderData.total_pages || 0;
                window.insiderTotal = insiderData.total || 0;
                window.insiderLimit = insiderData.limit || 20;
            } else {
                window.insiderCurrentPage = 1;
                window.insiderTotalPages = 0;
                window.insiderTotal = 0;
            }
            
            const favoriteBadge = isFavorite(ticker) ? 'â­' : '';
            const companyName = analystData?.company_name || ticker;
            
            // Header with ticker and favorite button
            html += `
                <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-card); border-radius: 10px; border: 2px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <h2 style="margin: 0; color: var(--text-primary);">
                                ${ticker} ${favoriteBadge} - ${companyName}
                            </h2>
                        </div>
                        <button class="favorite-btn" onclick="toggleFavorite('${ticker}', event)" style="padding: 8px 16px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; color: white; cursor: pointer; font-size: 1em;" title="${isFavorite(ticker) ? 'Remove from favorites' : 'Add to favorites'}">
                            ${isFavorite(ticker) ? 'â­ Remove from Favorites' : 'â˜† Add to Favorites'}
                        </button>
                    </div>
                </div>
            `;
            
            // Show errors if any
            if (errors.length > 0) {
                html += `
                    <div style="padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">âš ï¸ Some data may not be available:</div>
                        ${errors.map(e => `<div style="color: var(--text-secondary); font-size: 0.9em; margin-top: 5px;">â€¢ ${e}</div>`).join('')}
                    </div>
                `;
            }
            
            // Analyst Ratings Section
            html += `
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="display: flex; align-items: center; gap: 10px;">
                        ðŸ“ˆ Analyst Ratings & Price Targets
                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                            <span class="tooltiptext" style="width: 300px; white-space: normal;">
                                <strong>Analyst Ratings</strong><br>
                                Wall Street analyst recommendations and price targets.<br><br>
                                <strong>Price Target:</strong> PrÅ¯mÄ›rnÃ¡ cÃ­lovÃ¡ cena od analytikÅ¯<br>
                                <strong>Upside:</strong> PotenciÃ¡lnÃ­ rÅ¯st k cÃ­lovÃ© cenÄ›<br><br>
                                <strong>Co hledat:</strong> VysokÃ½ upside = analytikovÃ© vidÃ­ potenciÃ¡l rÅ¯stu. Consensus Buy = pozitivnÃ­ sentiment.
                            </span>
                        </span>
                    </h3>
            `;
            
            if (analystData && !analystData.error) {
                // Price Targets
                if (analystData.target_mean_price || analystData.current_price) {
                    const currentPrice = analystData.current_price || 0;
                    const targetPrice = analystData.target_mean_price;
                    const upside = analystData.upside_pct;
                    
                    html += `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid #667eea;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Current Price</div>
                                <div style="font-size: 1.8em; font-weight: 700; color: var(--text-primary);">$${currentPrice.toFixed(2)}</div>
                            </div>
                    `;
                    
                    if (targetPrice) {
                        const upsideColor = upside > 0 ? '#10b981' : upside < 0 ? '#ef4444' : '#6b7280';
                        html += `
                            <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid ${upsideColor};">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Target Price (Mean)</div>
                                <div style="font-size: 1.8em; font-weight: 700; color: var(--text-primary);">$${targetPrice.toFixed(2)}</div>
                                ${upside !== null ? `
                                    <div style="font-size: 0.9em; color: ${upsideColor}; font-weight: 600; margin-top: 5px;">
                                        ${upside > 0 ? '+' : ''}${upside.toFixed(1)}% upside
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    if (analystData.target_high_price) {
                        html += `
                            <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid #10b981;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Target High</div>
                                <div style="font-size: 1.8em; font-weight: 700; color: var(--text-primary);">$${analystData.target_high_price.toFixed(2)}</div>
                            </div>
                        `;
                    }
                    
                    if (analystData.target_low_price) {
                        html += `
                            <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid #ef4444;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Target Low</div>
                                <div style="font-size: 1.8em; font-weight: 700; color: var(--text-primary);">$${analystData.target_low_price.toFixed(2)}</div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                }
                
                // Individual Price Targets (if available)
                if (analystData.individual_targets && analystData.individual_targets.length > 0) {
                    html += `
                        <div style="margin-top: 30px;">
                            <h4 style="margin-bottom: 15px;">Individual Price Targets</h4>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--input-border);">
                                            <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Firm</th>
                                            <th style="padding: 12px; text-align: right; color: var(--text-secondary);">Target Price</th>
                                            <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Rating</th>
                                            <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    for (const target of analystData.individual_targets.slice(0, 10)) {
                        const currentPrice = analystData.current_price || 0;
                        const targetPrice = target.target_price || 0;
                        const upside = currentPrice > 0 ? ((targetPrice - currentPrice) / currentPrice) * 100 : 0;
                        const upsideColor = upside > 0 ? '#10b981' : upside < 0 ? '#ef4444' : '#6b7280';
                        const ratingColor = target.rating.includes('Buy') ? '#10b981' : target.rating.includes('Hold') ? '#f59e0b' : '#ef4444';
                        
                        html += `
                            <tr style="border-bottom: 1px solid var(--input-border);">
                                <td style="padding: 12px; font-weight: 600;">${target.firm || 'N/A'}</td>
                                <td style="padding: 12px; text-align: right;">
                                    <span style="font-weight: 700; color: var(--text-primary);">$${targetPrice.toFixed(2)}</span>
                                    ${currentPrice > 0 ? `
                                        <div style="font-size: 0.85em; color: ${upsideColor};">
                                            ${upside > 0 ? '+' : ''}${upside.toFixed(1)}%
                                        </div>
                                    ` : ''}
                                </td>
                                <td style="padding: 12px; color: ${ratingColor}; font-weight: 600;">${target.rating || 'N/A'}</td>
                                <td style="padding: 12px; color: var(--text-secondary);">${target.date || 'N/A'}</td>
                            </tr>
                        `;
                    }
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                // Recommendation Summary
                if (analystData.recommendation_summary) {
                    const summary = analystData.recommendation_summary;
                    const total = summary.strong_buy + summary.buy + summary.hold + summary.sell + summary.strong_sell;
                    
                    if (total > 0) {
                        html += `
                            <div style="margin-top: 30px;">
                                <h4 style="margin-bottom: 15px;">Consensus Rating</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                                    <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; text-align: center;">
                                        <div style="font-size: 2em; font-weight: 700; color: #10b981;">${summary.strong_buy}</div>
                                        <div style="font-size: 0.85em; color: var(--text-secondary);">Strong Buy</div>
                                    </div>
                                    <div style="padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; text-align: center;">
                                        <div style="font-size: 2em; font-weight: 700; color: #3b82f6;">${summary.buy}</div>
                                        <div style="font-size: 0.85em; color: var(--text-secondary);">Buy</div>
                                    </div>
                                    <div style="padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; text-align: center;">
                                        <div style="font-size: 2em; font-weight: 700; color: #f59e0b;">${summary.hold}</div>
                                        <div style="font-size: 0.85em; color: var(--text-secondary);">Hold</div>
                                    </div>
                                    <div style="padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; text-align: center;">
                                        <div style="font-size: 2em; font-weight: 700; color: #ef4444;">${summary.sell}</div>
                                        <div style="font-size: 0.85em; color: var(--text-secondary);">Sell</div>
                                    </div>
                                    <div style="padding: 15px; background: rgba(127, 29, 29, 0.1); border-radius: 10px; text-align: center;">
                                        <div style="font-size: 2em; font-weight: 700; color: #7f1d1d;">${summary.strong_sell}</div>
                                        <div style="font-size: 0.85em; color: var(--text-secondary);">Strong Sell</div>
                                    </div>
                                </div>
                                ${(() => {
                                    const total = summary.strong_buy + summary.buy + summary.hold + summary.sell + summary.strong_sell;
                                    const displayCount = analystData.number_of_analysts || total;
                                    return total > 0 ? `
                                        <div style="margin-top: 15px; text-align: center; color: var(--text-secondary); font-size: 0.9em;">
                                            Based on ${displayCount} analyst opinions
                                        </div>
                                    ` : '';
                                })()}
                            </div>
                        `;
                    }
                }
                
                // Recent Recommendations
                if (analystData.recommendations && analystData.recommendations.length > 0) {
                    // Check if we have valid data (not all N/A)
                    const hasValidData = analystData.recommendations.some(rec => 
                        (rec.firm && rec.firm !== 'N/A') || 
                        (rec.to_grade && rec.to_grade !== 'N/A') || 
                        (rec.from_grade && rec.from_grade !== 'N/A')
                    );
                    
                    if (hasValidData) {
                        html += `
                            <div style="margin-top: 30px;">
                                <h4 style="margin-bottom: 15px;">Recent Recommendations</h4>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid var(--input-border);">
                                                <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Date</th>
                                                <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Firm</th>
                                                <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Rating</th>
                                                <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Target Price</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        for (const rec of analystData.recommendations.slice(0, 10)) {
                            const toGrade = rec.to_grade || 'N/A';
                            const gradeColor = toGrade.includes('Buy') || toGrade.includes('Strong Buy') ? '#10b981' : 
                                             toGrade.includes('Hold') || toGrade.includes('Neutral') ? '#f59e0b' : 
                                             toGrade.includes('Sell') || toGrade.includes('Underperform') ? '#ef4444' : '#6b7280';
                            const targetPrice = rec.target_price ? `$${rec.target_price.toFixed(2)}` : 'N/A';
                            html += `
                                <tr style="border-bottom: 1px solid var(--input-border);">
                                    <td style="padding: 12px;">${rec.date || 'N/A'}</td>
                                    <td style="padding: 12px; font-weight: 600;">${rec.firm || 'N/A'}</td>
                                    <td style="padding: 12px; color: ${gradeColor}; font-weight: 600;">${toGrade}</td>
                                    <td style="padding: 12px; color: var(--text-secondary);">${targetPrice}</td>
                                </tr>
                            `;
                        }
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="margin-top: 30px; padding: 15px; background: rgba(107, 114, 128, 0.1); border-radius: 10px; color: var(--text-secondary);">
                                <div style="font-weight: 600; margin-bottom: 5px;">Recent Recommendations</div>
                                <div style="font-size: 0.9em;">Individual analyst recommendations with firm names are not available for this stock. Only consensus summary is shown above.</div>
                            </div>
                        `;
                    }
                }
            } else {
                html += `<div style="padding: 20px; color: var(--text-secondary);">Analyst data not available for ${ticker}</div>`;
            }
            
            html += `</div>`;
            
            // Insider Trading Section
            html += `
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="display: flex; align-items: center; gap: 10px;">
                        ðŸ‘” Insider Trading Activity
                        <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                            <span class="tooltiptext" style="width: 300px; white-space: normal;">
                                <strong>Insider Trading</strong><br>
                                NÃ¡kupy a prodeje akciÃ­ od insiderÅ¯ (management, Å™editelÃ©).<br><br>
                                <strong>ProÄ je dÅ¯leÅ¾itÃ©:</strong> Insideri Äasto vÄ›dÃ­ vÃ­c neÅ¾ trh. Pokud nakupujÃ­ = dobrÃ½ signÃ¡l. Pokud prodÃ¡vajÃ­ = moÅ¾nÃ½ varovnÃ½ signÃ¡l (ale mÅ¯Å¾e to bÃ½t i jen diverzifikace portfolia).
                            </span>
                        </span>
                    </h3>
            `;
            
            if (insiderData && !insiderData.error) {
                // Ownership Section
                if (insiderData.ownership) {
                    const ownership = insiderData.ownership;
                    html += `
                        <div style="margin-top: 30px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                ðŸ‘¥ Ownership Information
                                <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                    <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                        <strong>Insider Ownership:</strong> Procento akciÃ­ drÅ¾enÃ½ch insidery (management, zamÄ›stnanci)<br><br>
                                        <strong>Institutional Ownership:</strong> Procento akciÃ­ drÅ¾enÃ½ch institucionÃ¡lnÃ­mi investory (fondy, penzijnÃ­ fondy)<br><br>
                                        <strong>% Change:</strong> ZmÄ›na v drÅ¾enÃ­ za poslednÃ­ obdobÃ­
                                    </span>
                                </span>
                            </h4>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    `;
                    
                    // Insider Ownership
                    if (ownership.insider_ownership_pct !== undefined) {
                        html += `
                            <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid #667eea;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Insider Ownership</div>
                                <div style="font-size: 2em; font-weight: 700; color: var(--text-primary);">
                                    ${ownership.insider_ownership_pct.toFixed(2)}%
                                </div>
                                <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">
                                    ${ownership.insider_ownership_pct < 5 ? 'ðŸ”´ Low' : ownership.insider_ownership_pct < 15 ? 'ðŸŸ¡ Moderate' : 'ðŸŸ¢ High'}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Institutional Ownership
                    if (ownership.institutional_ownership_pct !== undefined) {
                        const instChange = ownership.institutional_ownership_change_pct || 0;
                        const instChangeColor = instChange > 0 ? '#10b981' : instChange < 0 ? '#ef4444' : '#6b7280';
                        html += `
                            <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid #10b981;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Institutional Ownership</div>
                                <div style="font-size: 2em; font-weight: 700; color: var(--text-primary);">
                                    ${ownership.institutional_ownership_pct.toFixed(2)}%
                                </div>
                                ${instChange !== 0 ? `
                                    <div style="font-size: 0.9em; color: ${instChangeColor}; font-weight: 600; margin-top: 5px;">
                                        ${instChange > 0 ? '+' : ''}${instChange.toFixed(2)}% change
                                    </div>
                                ` : ''}
                                ${ownership.institutional_count ? `
                                    <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">
                                        ${ownership.institutional_count} institutions
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    // Institutional Float
                    if (ownership.institutional_float_pct !== undefined) {
                        html += `
                            <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid #8b5cf6;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Institutional Float</div>
                                <div style="font-size: 2em; font-weight: 700; color: var(--text-primary);">
                                    ${ownership.institutional_float_pct.toFixed(2)}%
                                </div>
                                <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">
                                    Of available float
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                    
                    // Ownership Pie Chart
                    const insiderPct = ownership.insider_ownership_pct || 0;
                    const institutionalPct = ownership.institutional_ownership_pct || 0;
                    const floatPct = ownership.institutional_float_pct || (100 - insiderPct - institutionalPct);
                    const otherPct = Math.max(0, 100 - insiderPct - institutionalPct);
                    
                    if (insiderPct > 0 || institutionalPct > 0) {
                        const chartId = 'ownershipPieChart_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        html += `
                            <div style="margin-top: 30px;">
                                <h5 style="margin-bottom: 15px;">Ownership Distribution</h5>
                                <div style="display: flex; gap: 30px; align-items: center; flex-wrap: wrap;">
                                    <div style="flex: 1; min-width: 250px; max-width: 400px;">
                                        <canvas id="${chartId}" style="max-width: 100%; height: auto;"></canvas>
                                    </div>
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="display: flex; flex-direction: column; gap: 15px;">
                                            ${insiderPct > 0 ? `
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <div style="width: 20px; height: 20px; background: #667eea; border-radius: 4px;"></div>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 600; color: var(--text-primary);">Insider Ownership</div>
                                                        <div style="font-size: 1.2em; color: #667eea; font-weight: 700;">${insiderPct.toFixed(2)}%</div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${institutionalPct > 0 ? `
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <div style="width: 20px; height: 20px; background: #10b981; border-radius: 4px;"></div>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 600; color: var(--text-primary);">Institutional Ownership</div>
                                                        <div style="font-size: 1.2em; color: #10b981; font-weight: 700;">${institutionalPct.toFixed(2)}%</div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${otherPct > 0 ? `
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <div style="width: 20px; height: 20px; background: #6b7280; border-radius: 4px;"></div>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 600; color: var(--text-primary);">Other / Float</div>
                                                        <div style="font-size: 1.2em; color: #6b7280; font-weight: 700;">${otherPct.toFixed(2)}%</div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Create pie chart after HTML is inserted
                        setTimeout(() => {
                            const ctx = document.getElementById(chartId);
                            if (ctx && typeof Chart !== 'undefined') {
                                const isDark = document.body.classList.contains('dark-mode');
                                const labels = [];
                                const data = [];
                                const colors = [];
                                
                                if (insiderPct > 0) {
                                    labels.push('Insider');
                                    data.push(insiderPct);
                                    colors.push('#667eea');
                                }
                                if (institutionalPct > 0) {
                                    labels.push('Institutional');
                                    data.push(institutionalPct);
                                    colors.push('#10b981');
                                }
                                if (otherPct > 0) {
                                    labels.push('Other / Float');
                                    data.push(otherPct);
                                    colors.push('#6b7280');
                                }
                                
                                new Chart(ctx, {
                                    type: 'pie',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            data: data,
                                            backgroundColor: colors,
                                            borderColor: isDark ? '#1a1a1a' : '#ffffff',
                                            borderWidth: 2
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: true,
                                        plugins: {
                                            legend: {
                                                display: false
                                            },
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        const label = context.label || '';
                                                        const value = context.parsed || 0;
                                                        return label + ': ' + value.toFixed(2) + '%';
                                                    }
                                                },
                                                backgroundColor: isDark ? 'rgba(26, 26, 26, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                                                titleColor: isDark ? '#e0e0e0' : '#333333',
                                                bodyColor: isDark ? '#e0e0e0' : '#333333',
                                                borderColor: isDark ? '#404040' : '#e0e0e0',
                                                borderWidth: 1
                                            }
                                        }
                                    }
                                });
                            }
                        }, 100);
                    }
                    
                    // Top Institutional Holders
                    if (ownership.top_institutional_holders && ownership.top_institutional_holders.length > 0) {
                        html += `
                            <div style="margin-top: 30px;">
                                <h5 style="margin-bottom: 15px;">Top Institutional Holders</h5>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid var(--input-border);">
                                                <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Holder</th>
                                                <th style="padding: 12px; text-align: right; color: var(--text-secondary);">Shares</th>
                                                <th style="padding: 12px; text-align: right; color: var(--text-secondary);">Value</th>
                                                <th style="padding: 12px; text-align: right; color: var(--text-secondary);">% Change</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        for (const holder of ownership.top_institutional_holders) {
                            const changeColor = holder.pct_change > 0 ? '#10b981' : holder.pct_change < 0 ? '#ef4444' : '#6b7280';
                            html += `
                                <tr style="border-bottom: 1px solid var(--input-border);">
                                    <td style="padding: 12px; font-weight: 600;">${holder.name}</td>
                                    <td style="padding: 12px; text-align: right; color: var(--text-primary);">${formatNumber(holder.shares)}</td>
                                    <td style="padding: 12px; text-align: right; color: var(--text-primary);">$${formatCurrency(holder.value)}</td>
                                    <td style="padding: 12px; text-align: right; color: ${changeColor}; font-weight: 600;">
                                        ${holder.pct_change > 0 ? '+' : ''}${holder.pct_change.toFixed(2)}%
                                    </td>
                                </tr>
                            `;
                        }
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                }
                
                // Check if we have any data
                const hasPurchases = insiderData.purchases && insiderData.purchases.length > 0;
                const hasSales = insiderData.sales && insiderData.sales.length > 0;
                const hasTransactions = insiderData.transactions && insiderData.transactions.length > 0;
                const hasTotals = (insiderData.total_purchases && insiderData.total_purchases > 0) || 
                                 (insiderData.total_sales && insiderData.total_sales > 0);
                
                // Summary - show if we have any data
                if (hasTotals || hasPurchases || hasSales || hasTransactions) {
                    const netActivity = insiderData.net_activity || 0;
                    const netColor = netActivity > 0 ? '#10b981' : netActivity < 0 ? '#ef4444' : '#6b7280';
                    
                    html += `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div style="padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border-left: 4px solid #10b981;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Total Purchases</div>
                                <div style="font-size: 1.8em; font-weight: 700; color: #10b981;">$${formatCurrency(insiderData.total_purchases || 0)}</div>
                            </div>
                            <div style="padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 12px; border-left: 4px solid #ef4444;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Total Sales</div>
                                <div style="font-size: 1.8em; font-weight: 700; color: #ef4444;">$${formatCurrency(insiderData.total_sales || 0)}</div>
                            </div>
                            <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border-left: 4px solid ${netColor};">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Net Activity</div>
                                <div style="font-size: 1.8em; font-weight: 700; color: ${netColor};">
                                    ${netActivity > 0 ? '+' : ''}$${formatCurrency(Math.abs(netActivity))}
                                </div>
                                <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">
                                    ${netActivity > 0 ? 'ðŸŸ¢ Net buying' : netActivity < 0 ? 'ðŸ”´ Net selling' : 'âž¡ï¸ Neutral'}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Recent Purchases - always show if we have any insider data
                if (hasTotals || hasSales || hasTransactions) {
                    html += `
                        <div style="margin-top: 30px;">
                            <h4 style="margin-bottom: 15px; color: #10b981;">ðŸŸ¢ Recent Purchases</h4>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--input-border);">
                                            <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Date</th>
                                            <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Insider</th>
                                            <th style="padding: 12px; text-align: right; color: var(--text-secondary);">Value</th>
                                            <th style="padding: 12px; text-align: right; color: var(--text-secondary);">Shares</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    if (hasPurchases) {
                        for (const purchase of insiderData.purchases) {
                            html += `
                                <tr style="border-bottom: 1px solid var(--input-border);">
                                    <td style="padding: 12px;">${purchase.date}</td>
                                    <td style="padding: 12px;">${purchase.insider}</td>
                                    <td style="padding: 12px; text-align: right; color: #10b981; font-weight: 600;">$${formatCurrency(purchase.value || 0)}</td>
                                    <td style="padding: 12px; text-align: right; color: var(--text-secondary);">${formatNumber(purchase.shares || 0)}</td>
                                </tr>
                            `;
                        }
                    } else {
                        html += `
                            <tr>
                                <td colspan="4" style="padding: 20px; text-align: center; color: var(--text-secondary);">
                                    No recent purchases available
                                </td>
                            </tr>
                        `;
                    }
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                // Recent Sales
                if (hasSales) {
                    html += `
                        <div style="margin-top: 30px;">
                            <h4 style="margin-bottom: 15px; color: #ef4444;">ðŸ”´ Recent Sales</h4>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--input-border);">
                                            <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Date</th>
                                            <th style="padding: 12px; text-align: left; color: var(--text-secondary);">Insider</th>
                                            <th style="padding: 12px; text-align: right; color: var(--text-secondary);">Value</th>
                                            <th style="padding: 12px; text-align: right; color: var(--text-secondary);">Shares</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    for (const sale of insiderData.sales) {
                        html += `
                            <tr style="border-bottom: 1px solid var(--input-border);">
                                <td style="padding: 12px;">${sale.date}</td>
                                <td style="padding: 12px;">${sale.insider}</td>
                                <td style="padding: 12px; text-align: right; color: #ef4444; font-weight: 600;">$${formatCurrency(sale.value || 0)}</td>
                                <td style="padding: 12px; text-align: right; color: var(--text-secondary);">${formatNumber(sale.shares || 0)}</td>
                            </tr>
                        `;
                    }
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                // Only show "no data" message if we have absolutely no data at all
                if (!hasTotals && !hasPurchases && !hasSales && !hasTransactions) {
                    html += `<div style="padding: 20px; color: var(--text-secondary);">No recent insider trading activity available for ${ticker}</div>`;
                }
            } else {
                html += `<div style="padding: 20px; color: var(--text-secondary);">Insider trading data not available for ${ticker}</div>`;
            }
            
            html += `</div>`;
            
            // Institutional Analysis Section
            if (institutionalData && !institutionalData.error && (institutionalData.ownership || institutionalData.flow || institutionalData.retail_indicators || institutionalData.whales)) {
                html += `
                    <div class="card" style="margin-top: 30px;">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            ðŸ›ï¸ Institutional Analysis
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.9em;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Institutional Analysis</strong><br>
                                    Track institutional ownership, flow, and retail activity.<br><br>
                                    <strong>Ownership %:</strong> Kolik % akciÃ­ vlastnÃ­ instituce<br>
                                    <strong>Flow:</strong> NÃ¡kupy/prodeje institucÃ­<br>
                                    <strong>Whales:</strong> NejvÄ›tÅ¡Ã­ institucionÃ¡lnÃ­ pozice
                                </span>
                            </span>
                        </h3>
                `;
                
                // Institutional Ownership
                if (institutionalData.ownership) {
                    const ownership = institutionalData.ownership;
                    html += `
                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ“Š Institutional Ownership</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid var(--border-color);">
                                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Ownership %</div>
                                    <div style="font-size: 2em; font-weight: 700; color: var(--text-primary);">${ownership.ownership_pct ? ownership.ownership_pct.toFixed(2) + '%' : 'N/A'}</div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">held by institutions</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Institutional Flow
                if (institutionalData.flow) {
                    const flow = institutionalData.flow;
                    const flowColor = flow.flow_direction === 'positive' ? '#10b981' : flow.flow_direction === 'negative' ? '#ef4444' : '#f59e0b';
                    html += `
                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ’° Institutional Flow</h4>
                            <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid ${flowColor};">
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">3-Month Change</div>
                                <div style="font-size: 2em; font-weight: 700; color: ${flowColor};">
                                    ${flow.inst_trans_pct ? (flow.inst_trans_pct >= 0 ? '+' : '') + flow.inst_trans_pct.toFixed(2) + '%' : 'N/A'}
                                </div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                                    ${flow.flow_direction === 'positive' ? 'ðŸ“ˆ Institutions buying' : flow.flow_direction === 'negative' ? 'ðŸ“‰ Institutions selling' : 'âž¡ï¸ Neutral'}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Retail Activity Indicators
                if (institutionalData.retail_indicators) {
                    const retail = institutionalData.retail_indicators;
                    const retailColor = retail.indicator === 'high' ? '#ef4444' : retail.indicator === 'medium' ? '#f59e0b' : '#10b981';
                    html += `
                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ‘¥ Retail Activity Indicators</h4>
                            <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid ${retailColor};">
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Retail Activity Score</div>
                                <div style="font-size: 2em; font-weight: 700; color: ${retailColor};">${retail.retail_activity_score}/100</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                                    Volume Spike: ${retail.volume_spike_ratio ? retail.volume_spike_ratio.toFixed(2) + 'x' : 'N/A'} | 
                                    Volatility: ${retail.volatility_ratio ? retail.volatility_ratio.toFixed(2) + 'x' : 'N/A'}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Whale Watching
                if (institutionalData.whales && institutionalData.whales.whales && institutionalData.whales.whales.length > 0) {
                    html += `
                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--text-primary);">ðŸ‹ Whale Watching (Top Institutional Holders)</h4>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--border-color);">
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">Rank</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">Institution</th>
                                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">Ownership %</th>
                                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">Shares</th>
                                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    institutionalData.whales.whales.forEach((whale, index) => {
                        html += `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 12px; font-weight: 600; color: var(--text-primary);">${index + 1}</td>
                                <td style="padding: 12px; color: var(--text-primary);">${whale.holder || 'N/A'}</td>
                                <td style="padding: 12px; text-align: right; color: var(--text-primary);">${whale.pct_ownership ? whale.pct_ownership.toFixed(2) + '%' : 'N/A'}</td>
                                <td style="padding: 12px; text-align: right; color: var(--text-secondary);">${whale.shares ? formatNumber(whale.shares) : 'N/A'}</td>
                                <td style="padding: 12px; text-align: right; color: var(--text-primary);">${whale.value ? '$' + formatCurrency(whale.value) : 'N/A'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            container.innerHTML = html;
        }

        // Portfolio Tracker Functions
        let portfolioPositions = [];
        let portfolioData = null;

        function switchPortfolioTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.portfolio-tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.portfolio-tab-btn').forEach(b => {
                b.classList.remove('active');
            });
            
            // Show selected tab
            const tabMap = {
                'add': 'portfolioAddTab',
                'import': 'portfolioImportTab',
                'view': 'portfolioViewTab',
                'performance': 'portfolioPerformanceTab'
            };
            
            const tabElement = document.getElementById(tabMap[tab]);
            if (tabElement) {
                tabElement.classList.remove('hidden');
            }
            
            // Update button style - find button by onclick attribute
            document.querySelectorAll('.portfolio-tab-btn').forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${tab}'`)) {
                    btn.classList.add('active');
                }
            });
            
            // Load data if needed
            if (tab === 'view') {
                calculatePortfolio();
            } else if (tab === 'performance') {
                calculatePortfolio(true);
            }
        }

        // Education Section Functions
        function switchEducationTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.education-tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.education-tab-btn').forEach(b => {
                b.classList.remove('active');
                b.style.borderBottom = '3px solid transparent';
                b.style.color = 'var(--text-secondary)';
            });
            
            // Show selected tab
            const tabMap = {
                'metrics': 'educationMetricsTab',
                'basics': 'educationBasicsTab',
                'glossary': 'educationGlossaryTab',
                'why': 'educationWhyTab'
            };
            
            const tabElement = document.getElementById(tabMap[tab]);
            if (tabElement) {
                tabElement.classList.remove('hidden');
            }
            
            // Update button style
            document.querySelectorAll('.education-tab-btn').forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${tab}'`)) {
                    btn.classList.add('active');
                    btn.style.borderBottom = '3px solid #667eea';
                    btn.style.color = '#667eea';
                }
            });
            
            // Load content if needed
            if (tab === 'metrics') {
                loadMetricsContent();
            } else if (tab === 'basics') {
                loadBasicsContent();
            } else if (tab === 'glossary') {
                loadGlossaryContent();
            } else if (tab === 'why') {
                loadWhyContent();
            }
        }
        window.switchEducationTab = switchEducationTab;

        function loadEducationContent() {
            console.log('Loading education content...');
            loadMetricsContent();
        }

        function loadMetricsContent() {
            const container = document.getElementById('metricsContent');
            if (!container) return;
            
            container.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <h3 style="margin-bottom: 30px; color: var(--text-primary);">ðŸ“Š Metric Explanations</h3>
                    <p style="margin-bottom: 30px; color: var(--text-secondary); line-height: 1.6;">
                        Understand what financial and technical metrics mean, how they're calculated, and how to interpret them for better investment decisions.
                    </p>
                    
                    <div style="display: grid; gap: 30px;">
                        <!-- Technical Metrics -->
                        <div class="metric-category" style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸ“ˆ Technical Metrics</h4>
                            
                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">RSI (Relative Strength Index)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> RSI is a momentum oscillator that measures the speed and magnitude of price changes. It ranges from 0 to 100.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> RSI = 100 - (100 / (1 + RS)), where RS = Average Gain / Average Loss over 14 periods
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>RSI > 70:</strong> Overbought - stock may be overvalued, consider selling</li>
                                    <li><strong>RSI < 30:</strong> Oversold - stock may be undervalued, consider buying</li>
                                    <li><strong>RSI 30-70:</strong> Neutral range - no strong signal</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> RSI works best in trending markets. In ranging markets, it can give false signals. Use it with other indicators for confirmation.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">MACD (Moving Average Convergence Divergence)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> MACD is a trend-following momentum indicator that shows the relationship between two moving averages of a stock's price.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> MACD Line = 12-period EMA - 26-period EMA. Signal Line = 9-period EMA of MACD Line.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>MACD crosses above Signal:</strong> Bullish signal - consider buying</li>
                                    <li><strong>MACD crosses below Signal:</strong> Bearish signal - consider selling</li>
                                    <li><strong>MACD above zero:</strong> Bullish momentum</li>
                                    <li><strong>MACD below zero:</strong> Bearish momentum</li>
                                </ul>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Bollinger Bands</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Bollinger Bands consist of a middle band (SMA) and two outer bands that are standard deviations away from the middle band.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> Upper Band = SMA(20) + (2 Ã— Standard Deviation). Lower Band = SMA(20) - (2 Ã— Standard Deviation).
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Price touches upper band:</strong> Stock may be overbought</li>
                                    <li><strong>Price touches lower band:</strong> Stock may be oversold</li>
                                    <li><strong>Bands widen:</strong> Increased volatility</li>
                                    <li><strong>Bands narrow:</strong> Decreased volatility, possible breakout coming</li>
                                </ul>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Support & Resistance Levels</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Support is a price level where buying interest is strong enough to prevent the price from falling further. Resistance is a price level where selling pressure prevents the price from rising.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>How to identify:</strong> Look for price levels where the stock has bounced multiple times (support) or been rejected multiple times (resistance).
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Price at support:</strong> Potential buying opportunity - price may bounce up</li>
                                    <li><strong>Price at resistance:</strong> Potential selling opportunity - price may fall back</li>
                                    <li><strong>Breakthrough resistance:</strong> Bullish signal - price may continue rising</li>
                                    <li><strong>Breakthrough support:</strong> Bearish signal - price may continue falling</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> The more times a level is tested, the stronger it becomes. Volume confirmation makes breakouts more reliable.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Moving Averages (SMA & EMA)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Moving averages smooth out price data to identify trends. SMA (Simple Moving Average) gives equal weight to all prices, while EMA (Exponential Moving Average) gives more weight to recent prices.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> SMA = Sum of prices over N periods / N. EMA = (Price - Previous EMA) Ã— (2 / (N + 1)) + Previous EMA
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Common periods:</strong> 50-day (short-term), 200-day (long-term trend)
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Price above MA:</strong> Uptrend - bullish signal</li>
                                    <li><strong>Price below MA:</strong> Downtrend - bearish signal</li>
                                    <li><strong>Golden Cross (50 crosses above 200):</strong> Strong bullish signal</li>
                                    <li><strong>Death Cross (50 crosses below 200):</strong> Strong bearish signal</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> EMA reacts faster to price changes than SMA, making it better for short-term trading. SMA is better for identifying long-term trends.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Stochastic Oscillator</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> A momentum indicator that compares a stock's closing price to its price range over a given time period. It ranges from 0 to 100.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> %K = ((Current Close - Lowest Low) / (Highest High - Lowest Low)) Ã— 100. %D = 3-period SMA of %K
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Above 80:</strong> Overbought - consider selling</li>
                                    <li><strong>Below 20:</strong> Oversold - consider buying</li>
                                    <li><strong>%K crosses above %D:</strong> Bullish signal</li>
                                    <li><strong>%K crosses below %D:</strong> Bearish signal</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Works best in ranging markets. In strong trends, it can stay overbought/oversold for extended periods.
                                </p>
                            </div>
                        </div>

                        <!-- Fundamental Metrics -->
                        <div class="metric-category" style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸ’° Fundamental Metrics</h4>
                            
                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">P/E Ratio (Price-to-Earnings)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> P/E ratio compares a company's stock price to its earnings per share (EPS).
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> P/E Ratio = Stock Price / Earnings Per Share (EPS)
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>High P/E (>20-25):</strong> Stock may be overvalued, or investors expect high growth</li>
                                    <li><strong>Low P/E (<15):</strong> Stock may be undervalued, or company has low growth expectations</li>
                                    <li><strong>Industry comparison:</strong> Compare to industry average - P/E ratios vary by sector</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> P/E ratio is most useful when comparing companies in the same industry. Tech stocks typically have higher P/E ratios than utilities.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Market Cap (Market Capitalization)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Market cap is the total value of all outstanding shares of a company.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> Market Cap = Stock Price Ã— Number of Outstanding Shares
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Categories:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Large Cap:</strong> > $10 billion (more stable, lower growth potential)</li>
                                    <li><strong>Mid Cap:</strong> $2-10 billion (balanced risk/reward)</li>
                                    <li><strong>Small Cap:</strong> $300M - $2B (higher risk, higher growth potential)</li>
                                    <li><strong>Micro Cap:</strong> < $300M (very high risk)</li>
                                </ul>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">EPS (Earnings Per Share)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> EPS measures the portion of a company's profit allocated to each outstanding share of common stock.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> EPS = (Net Income - Preferred Dividends) / Average Outstanding Shares
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Higher EPS:</strong> Company is more profitable per share</li>
                                    <li><strong>Growing EPS:</strong> Company is growing earnings (positive sign)</li>
                                    <li><strong>Negative EPS:</strong> Company is losing money</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Compare EPS growth rate year-over-year. Consistent EPS growth is a strong indicator of a healthy company.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">P/B Ratio (Price-to-Book)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> P/B ratio compares a stock's market price to its book value (assets minus liabilities).
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> P/B Ratio = Stock Price / Book Value Per Share
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>P/B < 1:</strong> Stock may be undervalued - trading below book value</li>
                                    <li><strong>P/B 1-3:</strong> Fair value range for most companies</li>
                                    <li><strong>P/B > 3:</strong> Stock may be overvalued, or company has intangible assets</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Most useful for asset-heavy companies (banks, manufacturing). Less relevant for tech companies with intangible assets.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">P/S Ratio (Price-to-Sales)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> P/S ratio compares a stock's market cap to its annual revenue.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> P/S Ratio = Market Cap / Annual Revenue
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>P/S < 1:</strong> Potentially undervalued - market cap less than annual sales</li>
                                    <li><strong>P/S 1-3:</strong> Typical range for mature companies</li>
                                    <li><strong>P/S > 3:</strong> High growth expectations or overvaluation</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Useful for companies with negative earnings or inconsistent profits. Compare to industry average.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Revenue Growth</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> The percentage change in revenue from one period to another (quarter-over-quarter or year-over-year).
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> Revenue Growth = ((Current Revenue - Previous Revenue) / Previous Revenue) Ã— 100%
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>High growth (>20%):</strong> Company is expanding rapidly (growth stock)</li>
                                    <li><strong>Moderate growth (5-20%):</strong> Healthy, sustainable growth</li>
                                    <li><strong>Low/negative growth:</strong> Company may be stagnating or declining</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Consistent revenue growth over multiple quarters is a strong positive signal. Compare to industry growth rate.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Profit Margins (Gross, Operating, Net)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Margins show what percentage of revenue becomes profit at different stages.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formulas:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Gross Margin:</strong> (Revenue - COGS) / Revenue Ã— 100%</li>
                                    <li><strong>Operating Margin:</strong> Operating Income / Revenue Ã— 100%</li>
                                    <li><strong>Net Margin:</strong> Net Income / Revenue Ã— 100%</li>
                                </ul>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Gross Margin:</strong> Efficiency of production - higher is better</li>
                                    <li><strong>Operating Margin:</strong> Efficiency after operating expenses - shows operational profitability</li>
                                    <li><strong>Net Margin:</strong> Final profitability after all expenses and taxes</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Compare margins to industry averages. Tech companies typically have higher margins than retailers.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">ROE, ROA, ROIC (Return Metrics)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definitions:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>ROE (Return on Equity):</strong> How efficiently company uses shareholders' equity</li>
                                    <li><strong>ROA (Return on Assets):</strong> How efficiently company uses its assets</li>
                                    <li><strong>ROIC (Return on Invested Capital):</strong> How efficiently company uses invested capital</li>
                                </ul>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formulas:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>ROE:</strong> Net Income / Shareholders' Equity Ã— 100%</li>
                                    <li><strong>ROA:</strong> Net Income / Total Assets Ã— 100%</li>
                                    <li><strong>ROIC:</strong> (Net Income - Dividends) / (Debt + Equity) Ã— 100%</li>
                                </ul>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>ROE > 15%:</strong> Excellent - company generates strong returns</li>
                                    <li><strong>ROA > 5%:</strong> Good asset efficiency</li>
                                    <li><strong>ROIC > 10%:</strong> Company creates value for investors</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> ROIC is often considered the best metric as it accounts for both debt and equity financing.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Debt-to-Equity Ratio</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Measures how much debt a company uses to finance its operations relative to equity.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> Debt-to-Equity = Total Debt / Total Equity
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Ratio < 0.5:</strong> Low debt - conservative, less risky</li>
                                    <li><strong>Ratio 0.5-2.0:</strong> Moderate debt - typical range</li>
                                    <li><strong>Ratio > 2.0:</strong> High debt - higher risk, but may indicate growth investment</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Compare to industry average. Capital-intensive industries (utilities, real estate) typically have higher ratios.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Current Ratio</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Measures a company's ability to pay short-term obligations with short-term assets.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> Current Ratio = Current Assets / Current Liabilities
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Ratio > 1:</strong> Company can pay short-term debts - healthy liquidity</li>
                                    <li><strong>Ratio < 1:</strong> Company may struggle to pay short-term debts - liquidity risk</li>
                                    <li><strong>Ratio 1.5-3.0:</strong> Ideal range - good liquidity without excess idle assets</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Too high (>3) may indicate inefficient use of assets. Too low (<1) indicates financial stress.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">FCF (Free Cash Flow)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Cash available after paying operating expenses and capital expenditures. Shows true profitability.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> FCF = Operating Cash Flow - Capital Expenditures (CapEx)
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Positive FCF:</strong> Company generates cash - can pay dividends, buy back shares, or invest</li>
                                    <li><strong>Negative FCF:</strong> Company consumes cash - may need to borrow or issue stock</li>
                                    <li><strong>Growing FCF:</strong> Strong signal of financial health and growth potential</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> FCF is often more reliable than earnings as it's harder to manipulate. Warren Buffett's favorite metric.
                                </p>
                            </div>
                        </div>

                        <!-- Advanced Metrics -->
                        <div class="metric-category" style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸš€ Advanced Metrics</h4>
                            
                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Beta</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Measures a stock's volatility relative to the overall market (typically S&P 500).
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> Beta = Covariance(Stock Returns, Market Returns) / Variance(Market Returns)
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Beta = 1:</strong> Stock moves with the market</li>
                                    <li><strong>Beta > 1:</strong> Stock is more volatile than market (e.g., Beta 1.5 = 50% more volatile)</li>
                                    <li><strong>Beta < 1:</strong> Stock is less volatile than market (e.g., Beta 0.5 = 50% less volatile)</li>
                                    <li><strong>Beta < 0:</strong> Stock moves opposite to market (rare, usually defensive stocks)</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> High beta stocks offer higher returns but more risk. Low beta stocks are more stable but may offer lower returns.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Volatility</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Measures how much a stock's price fluctuates over time. Usually measured as standard deviation of returns.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>How it's measured:</strong> Standard deviation of daily/weekly/monthly returns, or implied volatility from options.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>High volatility (>30%):</strong> Large price swings - higher risk and potential reward</li>
                                    <li><strong>Low volatility (<15%):</strong> Stable price - lower risk, more predictable</li>
                                    <li><strong>Volatility clustering:</strong> High volatility periods often follow high volatility periods</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Volatility is not the same as risk. A volatile stock can still be a good long-term investment if fundamentals are strong.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">Dividend Yield</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Annual dividend payment divided by stock price, expressed as a percentage.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> Dividend Yield = (Annual Dividend Per Share / Stock Price) Ã— 100%
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Yield 2-4%:</strong> Typical for dividend-paying stocks</li>
                                    <li><strong>Yield > 4%:</strong> High yield - attractive for income investors, but verify sustainability</li>
                                    <li><strong>Yield < 1%:</strong> Low yield - company may prioritize growth over dividends</li>
                                    <li><strong>No dividend:</strong> Company reinvests profits (common for growth stocks)</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Very high yields (>8%) may indicate dividend cut risk. Check payout ratio and dividend history.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color);">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">PEG Ratio (Price/Earnings to Growth)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> P/E ratio adjusted for growth rate. Helps identify if a growth stock is fairly valued.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> PEG Ratio = P/E Ratio / Annual EPS Growth Rate
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>PEG < 1:</strong> Potentially undervalued - growth rate exceeds P/E ratio</li>
                                    <li><strong>PEG = 1:</strong> Fairly valued - growth matches valuation</li>
                                    <li><strong>PEG > 1:</strong> Potentially overvalued - P/E ratio exceeds growth rate</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Most useful for growth stocks. A stock with P/E 30 and 30% growth has PEG 1.0, which may be reasonable.
                                </p>
                            </div>

                            <div class="metric-item" style="margin-bottom: 25px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">EV/EBITDA (Enterprise Value to EBITDA)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Definition:</strong> Measures company value relative to earnings before interest, taxes, depreciation, and amortization.
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Formula:</strong> EV/EBITDA = Enterprise Value / EBITDA, where EV = Market Cap + Debt - Cash
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Interpretation:</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>EV/EBITDA < 10:</strong> Potentially undervalued or mature company</li>
                                    <li><strong>EV/EBITDA 10-15:</strong> Typical range for most companies</li>
                                    <li><strong>EV/EBITDA > 15:</strong> High growth expectations or overvaluation</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Tip:</strong> Useful for comparing companies with different debt levels and tax situations. Common in M&A analysis.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; padding: 20px; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #667eea;">
                        <p style="margin: 0; color: var(--text-secondary); line-height: 1.6;">
                            <strong>ðŸ’¡ Pro Tip:</strong> No single metric tells the whole story. Always use multiple metrics together and compare them to industry averages for a complete picture.
                        </p>
                    </div>
                </div>
            `;
        }

        function loadBasicsContent() {
            const container = document.getElementById('basicsContent');
            if (!container) return;
            
            container.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <h3 style="margin-bottom: 30px; color: var(--text-primary);">ðŸ“š Investing Basics Guide</h3>
                    
                    <div style="display: grid; gap: 30px;">
                        <!-- Getting Started -->
                        <div style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸš€ Getting Started</h4>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">What are Stocks?</h5>
                                <p style="color: var(--text-secondary); line-height: 1.6;">
                                    Stocks (also called shares or equities) represent ownership in a company. When you buy a stock, you become a partial owner of that company and are entitled to a portion of its profits and assets.
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Types of Investing</h5>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li><strong>Buy & Hold:</strong> Long-term strategy - buy quality stocks and hold them for years</li>
                                    <li><strong>Swing Trading:</strong> Hold positions for days to weeks, based on technical analysis</li>
                                    <li><strong>Day Trading:</strong> Buy and sell within the same day (high risk, requires expertise)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">How to Start</h5>
                                <ol style="margin-left: 20px; color: var(--text-secondary); line-height: 1.6;">
                                    <li>Open a brokerage account (e.g., Interactive Brokers, TD Ameritrade, Robinhood)</li>
                                    <li>Fund your account with money you can afford to lose</li>
                                    <li>Start with small positions to learn</li>
                                    <li>Use paper trading (simulated trading) to practice</li>
                                </ol>
                            </div>
                        </div>

                        <!-- Investment Strategies -->
                        <div style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸ’¼ Investment Strategies</h4>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Value Investing</h5>
                                <p style="color: var(--text-secondary); line-height: 1.6;">
                                    Buy stocks that appear undervalued based on fundamental analysis. Look for companies with low P/E ratios, strong balance sheets, and consistent earnings. Famous value investors include Warren Buffett and Benjamin Graham.
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Growth Investing</h5>
                                <p style="color: var(--text-secondary); line-height: 1.6;">
                                    Invest in companies with strong earnings growth potential, even if they're expensive. Focus on revenue growth, expanding markets, and innovative products. Typically includes tech and biotech stocks.
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Dividend Investing</h5>
                                <p style="color: var(--text-secondary); line-height: 1.6;">
                                    Focus on companies that pay regular dividends. Ideal for income-seeking investors. Look for companies with high dividend yields, consistent payout history, and strong cash flows.
                                </p>
                            </div>
                            
                            <div>
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Index Investing</h5>
                                <p style="color: var(--text-secondary); line-height: 1.6;">
                                    Buy index funds or ETFs that track market indices (e.g., S&P 500). Low fees, diversification, and long-term returns. Best for passive investors who want market-average returns with minimal effort.
                                </p>
                            </div>
                        </div>

                        <!-- Risk Management -->
                        <div style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸ›¡ï¸ Risk Management</h4>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Diversification</h5>
                                <p style="color: var(--text-secondary); line-height: 1.6;">
                                    Don't put all your eggs in one basket. Spread investments across different sectors, industries, and asset classes. A well-diversified portfolio reduces risk.
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Position Sizing</h5>
                                <p style="color: var(--text-secondary); line-height: 1.6;">
                                    Don't invest more than 5-10% of your portfolio in a single stock. Larger positions mean higher risk if the stock performs poorly.
                                </p>
                            </div>
                            
                            <div>
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Stop Loss</h5>
                                <p style="color: var(--text-secondary); line-height: 1.6;">
                                    Set a price at which you'll automatically sell to limit losses. For example, if you buy at $100, set a stop loss at $90 (10% loss). This protects you from significant losses.
                                </p>
                            </div>
                        </div>

                        <!-- Reading Financial Statements -->
                        <div style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸ“„ Reading Financial Statements</h4>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Income Statement (Profit & Loss)</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    Shows company's revenues and expenses over a period (quarter or year). Key components:
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                                    <li><strong>Revenue (Top Line):</strong> Total sales - what company earns</li>
                                    <li><strong>Cost of Goods Sold (COGS):</strong> Direct costs of producing goods/services</li>
                                    <li><strong>Gross Profit:</strong> Revenue - COGS - shows production efficiency</li>
                                    <li><strong>Operating Expenses:</strong> R&D, marketing, salaries, overhead</li>
                                    <li><strong>Operating Income:</strong> Gross Profit - Operating Expenses</li>
                                    <li><strong>Net Income (Bottom Line):</strong> Final profit after all expenses and taxes</li>
                                </ul>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>What to look for:</strong> Growing revenue, expanding margins, consistent profitability. Compare trends over multiple periods.
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Balance Sheet</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    Snapshot of company's financial position at a specific point in time. Shows what company owns and owes. Formula: <strong>Assets = Liabilities + Equity</strong>
                                </p>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Assets (What company owns):</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                                    <li><strong>Current Assets:</strong> Cash, accounts receivable, inventory (convertible to cash within 1 year)</li>
                                    <li><strong>Non-Current Assets:</strong> Property, equipment, intangible assets (long-term)</li>
                                </ul>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Liabilities (What company owes):</strong>
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                                    <li><strong>Current Liabilities:</strong> Accounts payable, short-term debt (due within 1 year)</li>
                                    <li><strong>Long-Term Liabilities:</strong> Long-term debt, bonds (due after 1 year)</li>
                                </ul>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Equity:</strong> Shareholders' equity = Assets - Liabilities (what shareholders own)
                                </p>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>What to look for:</strong> Healthy current ratio (>1), manageable debt levels, growing equity over time.
                                </p>
                            </div>
                            
                            <div>
                                <h5 style="margin-bottom: 10px; color: var(--text-primary);">Cash Flow Statement</h5>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    Tracks actual cash moving in and out of the company. Shows liquidity and cash generation ability. Three main sections:
                                </p>
                                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                                    <li><strong>Operating Cash Flow:</strong> Cash from core business operations (most important - should be positive and growing)</li>
                                    <li><strong>Investing Cash Flow:</strong> Cash from buying/selling assets (usually negative as companies invest)</li>
                                    <li><strong>Financing Cash Flow:</strong> Cash from borrowing, issuing stock, or paying dividends</li>
                                </ul>
                                <p style="margin-bottom: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>Free Cash Flow:</strong> Operating Cash Flow - Capital Expenditures. Shows cash available for dividends, buybacks, or growth.
                                </p>
                                <p style="margin-top: 10px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>What to look for:</strong> Positive operating cash flow, growing free cash flow, cash generation matching or exceeding net income. Negative operating cash flow is a red flag.
                                </p>
                                <p style="margin-top: 10px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; color: var(--text-secondary); line-height: 1.6;">
                                    <strong>ðŸ’¡ Key Insight:</strong> A company can show profits on the income statement but still have negative cash flow. Cash flow is harder to manipulate and more reliable indicator of financial health.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadGlossaryContent() {
            const container = document.getElementById('glossaryContent');
            if (!container) return;
            
            const glossaryTerms = [
                // Fundamental Terms
                { term: 'Assets', category: 'Fundamental', definition: 'Everything a company owns that has value, including cash, inventory, property, and equipment.' },
                { term: 'Liabilities', category: 'Fundamental', definition: 'Everything a company owes, including debt, accounts payable, and obligations.' },
                { term: 'Equity', category: 'Fundamental', definition: 'The value of assets minus liabilities. Also refers to stocks (ownership shares in a company).' },
                { term: 'Revenue', category: 'Fundamental', definition: 'Total income from sales of goods or services before expenses are deducted. Also called "top line".' },
                { term: 'Earnings', category: 'Fundamental', definition: 'Company profit after all expenses, taxes, and costs. Also called "net income" or "bottom line".' },
                { term: 'EPS', category: 'Fundamental', definition: 'Earnings Per Share - company profit divided by number of outstanding shares.' },
                { term: 'Market Cap', category: 'Fundamental', definition: 'Market Capitalization - total value of all outstanding shares (Price Ã— Shares).' },
                { term: 'Enterprise Value (EV)', category: 'Fundamental', definition: 'Total company value including market cap, debt, and minus cash. Used in M&A analysis.' },
                { term: 'Book Value', category: 'Fundamental', definition: 'The value of a company\'s assets minus its liabilities. What would be left if company liquidated.' },
                { term: 'Cash Flow', category: 'Fundamental', definition: 'The net amount of cash moving in and out of a business. Operating cash flow shows day-to-day operations.' },
                { term: 'Free Cash Flow (FCF)', category: 'Fundamental', definition: 'Cash available after paying operating expenses and capital expenditures. Shows true profitability.' },
                { term: 'EBITDA', category: 'Fundamental', definition: 'Earnings Before Interest, Taxes, Depreciation, and Amortization. Operating profitability measure.' },
                { term: 'ROE', category: 'Fundamental', definition: 'Return on Equity - measures how efficiently a company uses shareholders\' equity to generate profits.' },
                { term: 'ROA', category: 'Fundamental', definition: 'Return on Assets - measures how efficiently a company uses its assets to generate profits.' },
                { term: 'ROIC', category: 'Fundamental', definition: 'Return on Invested Capital - measures efficiency of capital allocation (debt + equity).' },
                { term: 'Working Capital', category: 'Fundamental', definition: 'Current assets minus current liabilities. Measures short-term financial health and liquidity.' },
                { term: 'Current Ratio', category: 'Fundamental', definition: 'Current assets divided by current liabilities. Measures ability to pay short-term debts.' },
                { term: 'Quick Ratio', category: 'Fundamental', definition: '(Current Assets - Inventory) / Current Liabilities. More conservative liquidity measure.' },
                { term: 'Debt-to-Equity', category: 'Fundamental', definition: 'Total debt divided by total equity. Shows how much debt a company uses vs. equity financing.' },
                { term: 'P/E Ratio', category: 'Fundamental', definition: 'Price-to-Earnings ratio - stock price divided by earnings per share.' },
                { term: 'P/B Ratio', category: 'Fundamental', definition: 'Price-to-Book ratio - stock price divided by book value per share.' },
                { term: 'P/S Ratio', category: 'Fundamental', definition: 'Price-to-Sales ratio - market cap divided by annual revenue.' },
                { term: 'PEG Ratio', category: 'Fundamental', definition: 'Price/Earnings to Growth ratio - P/E divided by annual EPS growth rate.' },
                { term: 'EV/EBITDA', category: 'Fundamental', definition: 'Enterprise Value to EBITDA. Valuation metric useful for comparing companies with different debt levels.' },
                { term: 'Dividend', category: 'Fundamental', definition: 'A portion of a company\'s profits paid to shareholders, typically quarterly.' },
                { term: 'Dividend Yield', category: 'Fundamental', definition: 'Annual dividend payment divided by stock price, expressed as percentage.' },
                { term: 'Payout Ratio', category: 'Fundamental', definition: 'Percentage of earnings paid as dividends. Lower ratio means more sustainable dividends.' },
                
                // Technical Terms
                { term: 'RSI', category: 'Technical', definition: 'Relative Strength Index - momentum oscillator (0-100) measuring speed of price changes. >70 overbought, <30 oversold.' },
                { term: 'MACD', category: 'Technical', definition: 'Moving Average Convergence Divergence - trend-following momentum indicator showing relationship between two MAs.' },
                { term: 'Bollinger Bands', category: 'Technical', definition: 'Technical indicator with middle SMA and two outer bands (standard deviations). Shows volatility.' },
                { term: 'Support Level', category: 'Technical', definition: 'Price level where buying interest is strong enough to prevent price from falling further.' },
                { term: 'Resistance Level', category: 'Technical', definition: 'Price level where selling pressure prevents price from rising further.' },
                { term: 'Moving Average (MA)', category: 'Technical', definition: 'Average price over a period. SMA gives equal weight, EMA gives more weight to recent prices.' },
                { term: 'SMA', category: 'Technical', definition: 'Simple Moving Average - average of prices over N periods with equal weighting.' },
                { term: 'EMA', category: 'Technical', definition: 'Exponential Moving Average - moving average that gives more weight to recent prices.' },
                { term: 'Volume', category: 'Technical', definition: 'Number of shares traded in a given period. High volume confirms price movements.' },
                { term: 'Beta', category: 'Technical', definition: 'Measure of stock\'s volatility compared to market. >1 more volatile, <1 less volatile, =1 moves with market.' },
                { term: 'Volatility', category: 'Technical', definition: 'Degree of variation in stock price over time. Higher volatility means bigger price swings.' },
                { term: 'Alpha', category: 'Technical', definition: 'Measure of investment performance relative to a benchmark. Positive alpha = outperformance.' },
                { term: 'Candlestick', category: 'Technical', definition: 'Price chart showing open, high, low, close. Green/white = price up, red/black = price down.' },
                { term: 'Golden Cross', category: 'Technical', definition: 'Technical signal when short-term MA crosses above long-term MA (e.g., 50-day crosses 200-day).' },
                { term: 'Death Cross', category: 'Technical', definition: 'Technical signal when short-term MA crosses below long-term MA. Bearish signal.' },
                { term: 'Stochastic Oscillator', category: 'Technical', definition: 'Momentum indicator (0-100) comparing closing price to price range. >80 overbought, <20 oversold.' },
                { term: 'ATR', category: 'Technical', definition: 'Average True Range - measures market volatility by averaging true ranges over a period.' },
                
                // Market Terms
                { term: 'Bull Market', category: 'Market', definition: 'Market condition where stock prices are rising or expected to rise. Generally optimistic sentiment.' },
                { term: 'Bear Market', category: 'Market', definition: 'Market condition where stock prices are falling, typically by 20% or more from recent highs.' },
                { term: 'IPO', category: 'Market', definition: 'Initial Public Offering - when a private company first sells shares to the public.' },
                { term: 'Secondary Offering', category: 'Market', definition: 'When a public company issues additional shares after IPO, diluting existing shareholders.' },
                { term: 'Stock Split', category: 'Market', definition: 'When a company increases number of shares and reduces price proportionally (e.g., 2-for-1 split).' },
                { term: 'Reverse Split', category: 'Market', definition: 'When a company reduces number of shares and increases price proportionally. Often done to avoid delisting.' },
                { term: 'Market Order', category: 'Market', definition: 'Order to buy or sell immediately at current market price. Fastest execution but no price control.' },
                { term: 'Limit Order', category: 'Market', definition: 'Order to buy or sell only at specified price or better. Guarantees price but not execution.' },
                { term: 'Stop Loss', category: 'Market', definition: 'Order to sell when price falls to specified level, limiting losses.' },
                { term: 'Stop Limit', category: 'Market', definition: 'Combination order: stop order triggers limit order at specified price.' },
                
                // Options Terms
                { term: 'Call Option', category: 'Options', definition: 'Right to buy stock at specified price (strike) before expiration date.' },
                { term: 'Put Option', category: 'Options', definition: 'Right to sell stock at specified price (strike) before expiration date.' },
                { term: 'Strike Price', category: 'Options', definition: 'Price at which option holder can buy (call) or sell (put) the underlying stock.' },
                { term: 'Expiration Date', category: 'Options', definition: 'Date when option expires and becomes worthless if not exercised.' },
                { term: 'Premium', category: 'Options', definition: 'Price paid to buy an option. Maximum loss for option buyer.' },
                { term: 'In the Money', category: 'Options', definition: 'Option with intrinsic value. Call: stock price > strike. Put: stock price < strike.' },
                { term: 'Out of the Money', category: 'Options', definition: 'Option with no intrinsic value. Call: stock price < strike. Put: stock price > strike.' },
                
                // Additional Terms
                { term: 'Sector', category: 'Market', definition: 'Group of companies in same industry (e.g., Technology, Healthcare, Financials).' },
                { term: 'Index', category: 'Market', definition: 'Basket of stocks representing market or sector (e.g., S&P 500, NASDAQ, Dow Jones).' },
                { term: 'ETF', category: 'Market', definition: 'Exchange-Traded Fund - basket of stocks traded like a stock. Provides diversification.' },
                { term: 'Mutual Fund', category: 'Market', definition: 'Pooled investment vehicle managed by professionals, buying/selling at end of day at NAV.' },
                { term: 'Blue Chip', category: 'Market', definition: 'Large, well-established, financially stable company with reliable earnings (e.g., Apple, Microsoft).' },
                { term: 'Penny Stock', category: 'Market', definition: 'Stock trading below $5 per share. High risk, often low liquidity.' },
                { term: 'Market Maker', category: 'Market', definition: 'Financial firm that provides liquidity by buying and selling securities, earning bid-ask spread.' },
                { term: 'Bid Price', category: 'Market', definition: 'Highest price a buyer is willing to pay for a stock.' },
                { term: 'Ask Price', category: 'Market', definition: 'Lowest price a seller is willing to accept for a stock.' },
                { term: 'Spread', category: 'Market', definition: 'Difference between bid and ask price. Lower spread means better liquidity.' },
                { term: 'Liquidity', category: 'Market', definition: 'Ease of buying/selling without significantly affecting price. High volume = high liquidity.' },
                { term: 'Insider Trading', category: 'Market', definition: 'Trading by company executives, directors, or large shareholders. Legal if reported, illegal if on non-public info.' },
                { term: 'Short Selling', category: 'Market', definition: 'Borrowing shares to sell, hoping to buy back cheaper later. Profits when stock price falls.' },
                { term: 'Short Interest', category: 'Market', definition: 'Number of shares sold short. High short interest may indicate bearish sentiment.' }
            ];
            
            // Sort terms alphabetically
            glossaryTerms.sort((a, b) => a.term.localeCompare(b.term));
            
            // Group by category
            const categories = {};
            glossaryTerms.forEach(item => {
                if (!categories[item.category]) {
                    categories[item.category] = [];
                }
                categories[item.category].push(item);
            });
            
            let html = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="glossary-filter-btn active" onclick="filterGlossary('all')" style="padding: 8px 16px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">All</button>
                        <button class="glossary-filter-btn" onclick="filterGlossary('Fundamental')" style="padding: 8px 16px; border: 2px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); border-radius: 6px; cursor: pointer; font-weight: 600;">ðŸ’° Fundamental</button>
                        <button class="glossary-filter-btn" onclick="filterGlossary('Technical')" style="padding: 8px 16px; border: 2px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); border-radius: 6px; cursor: pointer; font-weight: 600;">ðŸ“ˆ Technical</button>
                        <button class="glossary-filter-btn" onclick="filterGlossary('Market')" style="padding: 8px 16px; border: 2px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); border-radius: 6px; cursor: pointer; font-weight: 600;">ðŸ“Š Market</button>
                        <button class="glossary-filter-btn" onclick="filterGlossary('Options')" style="padding: 8px 16px; border: 2px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); border-radius: 6px; cursor: pointer; font-weight: 600;">âš™ï¸ Options</button>
                    </div>
                    <div id="glossaryTerms" style="display: grid; gap: 15px;">
            `;
            
            Object.keys(categories).sort().forEach(category => {
                html += `<div class="glossary-category" data-category="${category}" style="margin-bottom: 30px;">
                    <h4 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.2em; padding-bottom: 10px; border-bottom: 2px solid var(--border-color);">${category}</h4>
                    <div style="display: grid; gap: 15px;">
                `;
                categories[category].forEach(item => {
                    html += `
                        <div class="glossary-term" data-category="${item.category}" style="padding: 20px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                            <h5 style="margin-bottom: 10px; color: var(--text-primary); font-size: 1.1em;">${item.term}</h5>
                            <p style="margin: 0; color: var(--text-secondary); line-height: 1.6;">${item.definition}</p>
                        </div>
                    `;
                });
                html += `</div></div>`;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            // Add filter function
            window.filterGlossary = function(category) {
                const buttons = document.querySelectorAll('.glossary-filter-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.background = 'var(--bg-card)';
                    btn.style.color = 'var(--text-primary)';
                    btn.style.borderColor = 'var(--border-color)';
                });
                event.target.classList.add('active');
                event.target.style.background = '#667eea';
                event.target.style.color = 'white';
                event.target.style.borderColor = '#667eea';
                
                const terms = container.querySelectorAll('.glossary-category, .glossary-term');
                terms.forEach(term => {
                    if (category === 'all') {
                        term.style.display = '';
                    } else {
                        const termCategory = term.getAttribute('data-category');
                        term.style.display = termCategory === category ? '' : 'none';
                    }
                });
            };
            
            container.innerHTML = html;
            
            // Add search functionality
            const searchInput = document.getElementById('glossarySearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const query = e.target.value.toLowerCase();
                    const terms = container.querySelectorAll('.glossary-term');
                    terms.forEach(term => {
                        const text = term.textContent.toLowerCase();
                        term.style.display = text.includes(query) ? 'block' : 'none';
                    });
                });
            }
        }

        function loadWhyContent() {
            const container = document.getElementById('whyContent');
            if (!container) return;
            
            container.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <h3 style="margin-bottom: 30px; color: var(--text-primary);">ðŸ’¡ Why This Matters</h3>
                    <p style="margin-bottom: 30px; color: var(--text-secondary); line-height: 1.6;">
                        Different metrics matter more depending on your investment strategy. Here's why certain metrics are crucial for different types of investors.
                    </p>
                    
                    <div style="display: grid; gap: 30px;">
                        <!-- Value Investors -->
                        <div style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸ’° For Value Investors</h4>
                            <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                                <li><strong>P/E Ratio:</strong> Helps identify undervalued stocks. Low P/E may indicate a bargain.</li>
                                <li><strong>Debt-to-Equity:</strong> Shows financial health. Low debt means less risk and more stability.</li>
                                <li><strong>Book Value:</strong> Indicates intrinsic value. Stocks trading below book value may be undervalued.</li>
                            </ul>
                        </div>

                        <!-- Growth Investors -->
                        <div style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸš€ For Growth Investors</h4>
                            <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                                <li><strong>Revenue Growth:</strong> Shows expanding business. Consistent growth indicates strong market position.</li>
                                <li><strong>EPS Growth:</strong> Indicates increasing profitability. Growing EPS often leads to higher stock prices.</li>
                                <li><strong>PEG Ratio:</strong> Combines P/E with growth. Lower PEG (often < 1) suggests good value for growth.</li>
                            </ul>
                        </div>

                        <!-- Dividend Investors -->
                        <div style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸ“ˆ For Dividend Investors</h4>
                            <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                                <li><strong>Dividend Yield:</strong> Shows income return. Higher yield means more income per dollar invested.</li>
                                <li><strong>Payout Ratio:</strong> Indicates sustainability. Lower ratio (< 60%) means safer dividends.</li>
                                <li><strong>Dividend History:</strong> Shows reliability. Companies with consistent dividend increases are preferred.</li>
                            </ul>
                        </div>

                        <!-- Risk Management -->
                        <div style="padding: 25px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary); font-size: 1.3em;">ðŸ›¡ï¸ For Risk Management</h4>
                            <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                                <li><strong>Beta:</strong> Measures volatility risk. Low beta (< 1) means less volatile than market.</li>
                                <li><strong>Volatility:</strong> Shows price swing risk. Lower volatility means more stable prices.</li>
                                <li><strong>Current Ratio:</strong> Indicates liquidity. Ratio > 1 means company can pay short-term debts.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        window.loadEducationContent = loadEducationContent;

        function loadPortfolio() {
            console.log('Loading portfolio...');
            const saved = localStorage.getItem('portfolioPositions');
            if (saved) {
                try {
                    portfolioPositions = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading portfolio:', e);
                    portfolioPositions = [];
                }
            }
            if (portfolioPositions.length > 0) {
                switchPortfolioTab('view');
            } else {
                switchPortfolioTab('add');
            }
        }

        function savePortfolio() {
            localStorage.setItem('portfolioPositions', JSON.stringify(portfolioPositions));
        }

        function addPosition() {
            const ticker = document.getElementById('portfolioTickerInput').value.trim().toUpperCase();
            const shares = parseFloat(document.getElementById('portfolioSharesInput').value);
            const price = parseFloat(document.getElementById('portfolioPriceInput').value);
            const date = document.getElementById('portfolioDateInput').value || new Date().toISOString().split('T')[0];
            
            if (!ticker || !shares || !price || shares <= 0 || price <= 0) {
                alert('Please fill in all required fields with valid values');
                return;
            }
            
            portfolioPositions.push({
                ticker: ticker,
                shares: shares,
                purchase_price: price,
                purchase_date: date
            });
            
            savePortfolio();
            
            // Clear form
            document.getElementById('addPositionForm').reset();
            
            // Show success message
            alert(`Position ${ticker} added successfully!`);
            
            // Switch to view tab
            switchPortfolioTab('view');
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    alert('CSV file must have at least a header and one data row');
                    return;
                }
                
                // Skip header
                const dataLines = lines.slice(1);
                let imported = 0;
                let errors = [];
                
                dataLines.forEach((line, index) => {
                    const parts = line.split(',').map(p => p.trim());
                    if (parts.length >= 3) {
                        const ticker = parts[0].toUpperCase();
                        const shares = parseFloat(parts[1]);
                        const price = parseFloat(parts[2]);
                        const date = parts[3] || new Date().toISOString().split('T')[0];
                        
                        if (ticker && shares > 0 && price > 0) {
                            portfolioPositions.push({
                                ticker: ticker,
                                shares: shares,
                                purchase_price: price,
                                purchase_date: date
                            });
                            imported++;
                        } else {
                            errors.push(`Row ${index + 2}: Invalid data`);
                        }
                    } else {
                        errors.push(`Row ${index + 2}: Not enough columns`);
                    }
                });
                
                if (imported > 0) {
                    savePortfolio();
                    alert(`Successfully imported ${imported} position(s)`);
                    if (errors.length > 0) {
                        console.warn('Import errors:', errors);
                    }
                    switchPortfolioTab('view');
                } else {
                    alert('No valid positions found in CSV file');
                }
            };
            reader.readAsText(file);
        }

        async function calculatePortfolio(showPerformance = false) {
            if (portfolioPositions.length === 0) {
                const container = showPerformance ? 
                    document.getElementById('portfolioPerformanceContainer') : 
                    document.getElementById('portfolioTableContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                            <div style="font-size: 3em; margin-bottom: 20px;">ðŸ’¼</div>
                            <p>No positions in portfolio. Add positions to get started.</p>
                        </div>
                    `;
                }
                return;
            }
            
            const container = showPerformance ? 
                document.getElementById('portfolioPerformanceContainer') : 
                document.getElementById('portfolioTableContainer');
            
            if (container) {
                container.innerHTML = `
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-chart"></div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div class="skeleton skeleton-metric" style="height: 2em;"></div>
                            <div class="skeleton skeleton-metric" style="height: 2em;"></div>
                            <div class="skeleton skeleton-metric" style="height: 2em;"></div>
                        </div>
                    </div>
                `;
            }
            
            try {
                const response = await fetch('/api/portfolio-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ positions: portfolioPositions })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to calculate portfolio');
                }
                
                const data = await response.json();
                portfolioData = data;
                
                if (showPerformance) {
                    renderPerformanceDashboard(data);
                } else {
                    renderPortfolioTable(data);
                }
                
            } catch (error) {
                console.error('Error calculating portfolio:', error);
                if (container) {
                    container.innerHTML = `
                        <div class="error">
                            Error calculating portfolio: ${error.message}
                        </div>
                    `;
                }
            }
        }

        function renderPortfolioTable(data) {
            const container = document.getElementById('portfolioTableContainer');
            if (!container) return;
            
            let html = `
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h3 style="color: var(--text-primary); margin-bottom: 5px;">Portfolio Overview</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9em;">${data.summary.position_count} position(s)</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportToCSV()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ðŸ“¥ Export CSV</button>
                        <button onclick="calculatePortfolio()" style="padding: 10px 20px; background: var(--input-bg); color: var(--text-primary); border: 2px solid var(--input-border); border-radius: 8px; cursor: pointer; font-weight: 600;">ðŸ”„ Refresh</button>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: var(--bg-card); border-radius: 12px; overflow: hidden;">
                        <thead>
                            <tr style="background: var(--table-header-bg);">
                                <th style="padding: 15px; text-align: left; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border-color);">Ticker</th>
                                <th style="padding: 15px; text-align: right; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border-color);">Shares</th>
                                <th style="padding: 15px; text-align: right; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border-color);">Avg Price</th>
                                <th style="padding: 15px; text-align: right; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border-color);">Current Price</th>
                                <th style="padding: 15px; text-align: right; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border-color);">Current Value</th>
                                <th style="padding: 15px; text-align: right; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border-color);">P&L</th>
                                <th style="padding: 15px; text-align: right; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border-color);">% Change</th>
                                <th style="padding: 15px; text-align: left; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border-color);">Sector</th>
                                <th style="padding: 15px; text-align: center; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border-color);">Favorite</th>
                                <th style="padding: 15px; text-align: center; color: var(--text-primary); font-weight: 600; border-bottom: 2px solid var(--border-color);">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.positions.forEach((pos, index) => {
                const pnlColor = pos.pnl >= 0 ? '#10b981' : '#ef4444';
                const pnlSign = pos.pnl >= 0 ? '+' : '';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='var(--table-row-hover)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 15px;">
                            <div style="font-weight: 700; color: var(--text-primary);">${pos.ticker} ${isFavorite(pos.ticker) ? 'â­' : ''}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${pos.company_name}</div>
                        </td>
                        <td style="padding: 15px; text-align: right; color: var(--text-primary);">${formatNumber(pos.shares)}</td>
                        <td style="padding: 15px; text-align: right; color: var(--text-primary);">$${formatCurrency(pos.purchase_price)}</td>
                        <td style="padding: 15px; text-align: right; color: var(--text-primary); font-weight: 600;">$${formatCurrency(pos.current_price)}</td>
                        <td style="padding: 15px; text-align: right; color: var(--text-primary); font-weight: 600;">$${formatCurrency(pos.current_value)}</td>
                        <td style="padding: 15px; text-align: right; color: ${pnlColor}; font-weight: 700;">${pnlSign}$${formatCurrency(Math.abs(pos.pnl))}</td>
                        <td style="padding: 15px; text-align: right; color: ${pnlColor}; font-weight: 700;">${pnlSign}${pos.pnl_percent.toFixed(2)}%</td>
                        <td style="padding: 15px; color: var(--text-secondary);">${pos.sector}</td>
                        <td style="padding: 15px; text-align: center;">
                            <button class="favorite-btn" onclick="toggleFavorite('${pos.ticker}', event)" style="font-size: 1.2em; padding: 4px 8px; background: transparent; border: none; cursor: pointer;" title="${isFavorite(pos.ticker) ? 'Remove from favorites' : 'Add to favorites'}">
                                ${isFavorite(pos.ticker) ? 'â­' : 'â˜†'}
                            </button>
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            <button onclick="deletePosition(${index})" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em;">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                        <tfoot>
                            <tr style="background: var(--table-header-bg); font-weight: 700;">
                                <td style="padding: 15px; color: var(--text-primary);">Total</td>
                                <td style="padding: 15px; text-align: right; color: var(--text-primary);"></td>
                                <td style="padding: 15px; text-align: right; color: var(--text-primary);"></td>
                                <td style="padding: 15px; text-align: right; color: var(--text-primary);"></td>
                                <td style="padding: 15px; text-align: right; color: var(--text-primary);">$${formatCurrency(data.summary.total_value)}</td>
                                <td style="padding: 15px; text-align: right; color: ${data.summary.total_pnl >= 0 ? '#10b981' : '#ef4444'};">
                                    ${data.summary.total_pnl >= 0 ? '+' : ''}$${formatCurrency(Math.abs(data.summary.total_pnl))}
                                </td>
                                <td style="padding: 15px; text-align: right; color: ${data.summary.total_pnl >= 0 ? '#10b981' : '#ef4444'};">
                                    ${data.summary.total_pnl >= 0 ? '+' : ''}${data.summary.total_pnl_percent.toFixed(2)}%
                                </td>
                                <td style="padding: 15px;"></td>
                                <td style="padding: 15px;"></td>
                                <td style="padding: 15px;"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function deletePosition(index) {
            if (confirm('Are you sure you want to delete this position?')) {
                portfolioPositions.splice(index, 1);
                savePortfolio();
                calculatePortfolio();
            }
        }

        function exportToCSV() {
            if (portfolioPositions.length === 0) {
                alert('No positions to export');
                return;
            }
            
            let csv = 'ticker,shares,purchase_price,purchase_date\n';
            portfolioPositions.forEach(pos => {
                csv += `${pos.ticker},${pos.shares},${pos.purchase_price},${pos.purchase_date || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function renderPerformanceDashboard(data) {
            const container = document.getElementById('portfolioPerformanceContainer');
            if (!container) return;
            
            // Summary stats
            const totalPnlColor = data.summary.total_pnl >= 0 ? '#10b981' : '#ef4444';
            const totalPnlSign = data.summary.total_pnl >= 0 ? '+' : '';
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="padding: 25px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px;">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Total Value</div>
                        <div style="font-size: 2em; font-weight: 700; color: var(--text-primary);">$${formatCurrency(data.summary.total_value)}</div>
                    </div>
                    <div style="padding: 25px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px;">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Total Cost</div>
                        <div style="font-size: 2em; font-weight: 700; color: var(--text-primary);">$${formatCurrency(data.summary.total_cost)}</div>
                    </div>
                    <div style="padding: 25px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px;">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Total P&L</div>
                        <div style="font-size: 2em; font-weight: 700; color: ${totalPnlColor};">
                            ${totalPnlSign}$${formatCurrency(Math.abs(data.summary.total_pnl))}
                        </div>
                    </div>
                    <div style="padding: 25px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px;">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Total Return</div>
                        <div style="font-size: 2em; font-weight: 700; color: ${totalPnlColor};">
                            ${totalPnlSign}${data.summary.total_pnl_percent.toFixed(2)}%
                        </div>
                    </div>
                </div>
                
                <div style="padding: 25px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Portfolio Value History (90 Days)</h3>
                        <button onclick="loadPortfolioHistory()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ðŸ”„ Refresh History</button>
                    </div>
                    <div id="portfolioHistoryChartContainer" style="position: relative; height: 350px;">
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                            <p>Loading portfolio history...</p>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px;">
                    <div style="padding: 25px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px;">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary);">Sector Allocation</h3>
                        <canvas id="sectorChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div style="padding: 25px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px;">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary);">Top Gainers / Losers</h3>
                        <canvas id="gainersLosersChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Render charts
            setTimeout(() => {
                renderSectorChart(data);
                renderGainersLosersChart(data);
                loadPortfolioHistory(); // Load portfolio history
            }, 100);
        }
        
        async function loadPortfolioHistory() {
            if (portfolioPositions.length === 0) {
                const container = document.getElementById('portfolioHistoryChartContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <p>No positions in portfolio. Add positions to view history.</p>
                        </div>
                    `;
                }
                return;
            }
            
            const container = document.getElementById('portfolioHistoryChartContainer');
            if (!container) return;
            
            try {
                const result = await fetchJSON('/api/portfolio-history', {
                    method: 'POST',
                    body: JSON.stringify({ positions: portfolioPositions })
                }, container);
                
                if (!result.success) {
                    return; // Error already displayed
                }
                
                const historyData = result.data;
                trackDataTimestamp('/api/portfolio-history', result.timestamp || Date.now());
                
                renderPortfolioHistoryChart(historyData);
            } catch (error) {
                console.error('Error loading portfolio history:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <p>Error loading portfolio history: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderPortfolioHistoryChart(historyData) {
            const container = document.getElementById('portfolioHistoryChartContainer');
            if (!container) return;
            
            const history = historyData.history || [];
            const sp500History = historyData.sp500_history || [];
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p>No history data available.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<canvas id="portfolioHistoryChart" style="max-height: 350px;"></canvas>';
            
            const ctx = document.getElementById('portfolioHistoryChart');
            if (!ctx) return;
            
            // Normalize portfolio values to percentage (start at 100)
            const baseValue = history[0]?.value || 1;
            const portfolioLabels = history.map(h => h.date);
            const portfolioValues = history.map(h => ((h.value / baseValue) * 100).toFixed(2));
            
            const datasets = [{
                label: 'Portfolio Value',
                data: portfolioValues,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }];
            
            // Add S&P 500 comparison if available
            if (sp500History.length > 0) {
                const sp500Labels = sp500History.map(h => h.date);
                const sp500Values = sp500History.map(h => h.value); // Already normalized
                
                // Match dates
                const alignedSp500Values = portfolioLabels.map(date => {
                    const match = sp500History.find(h => h.date === date);
                    return match ? match.value : null;
                });
                
                datasets.push({
                    label: 'S&P 500 (normalized)',
                    data: alignedSp500Values,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    borderDash: [5, 5]
                });
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: portfolioLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: 'var(--text-primary)'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + parseFloat(context.parsed.y).toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'var(--text-secondary)',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'var(--border-color)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'var(--text-secondary)',
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                }
                            },
                            grid: {
                                color: 'var(--border-color)'
                            }
                        }
                    }
                }
            });
        }

        function renderSectorChart(data) {
            const sectorMap = {};
            data.positions.forEach(pos => {
                const sector = pos.sector || 'Unknown';
                if (!sectorMap[sector]) {
                    sectorMap[sector] = 0;
                }
                sectorMap[sector] += pos.current_value;
            });
            
            const sectors = Object.keys(sectorMap);
            const values = sectors.map(s => sectorMap[s]);
            
            const ctx = document.getElementById('sectorChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sectors,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: 'var(--text-primary)'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: $${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderGainersLosersChart(data) {
            const sorted = [...data.positions].sort((a, b) => b.pnl_percent - a.pnl_percent);
            const top5 = sorted.slice(0, 5);
            const bottom5 = sorted.slice(-5).reverse();
            
            const allTickers = [...top5.map(p => p.ticker), ...bottom5.map(p => p.ticker)];
            const allPercents = [...top5.map(p => p.pnl_percent), ...bottom5.map(p => p.pnl_percent)];
            const colors = [
                ...top5.map(() => '#10b981'),
                ...bottom5.map(() => '#ef4444')
            ];
            
            const ctx = document.getElementById('gainersLosersChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allTickers,
                    datasets: [{
                        label: 'Return %',
                        data: allPercents,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.x > 0 ? '+' : ''}${context.parsed.x.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'var(--text-primary)',
                                callback: function(value) {
                                    return value > 0 ? '+' + value.toFixed(1) + '%' : value.toFixed(1) + '%';
                                }
                            },
                            grid: {
                                color: 'var(--border-color)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'var(--text-primary)'
                            },
                            grid: {
                                color: 'var(--border-color)'
                            }
                        }
                    }
                }
            });
        }

        // ==================== Global Search, Favorites, and Recent Searches ====================
        
        // Global state
        let recentSearches = [];
        let favoriteTickers = [];
        let searchDropdownTimeout = null;

        // Initialize on page load
        function initGlobalSearch() {
            loadRecentSearches();
            loadFavorites();
            renderSearchDropdown();
            
            // Keyboard shortcut: Ctrl+K or Cmd+K to focus search
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('globalSearchInput').focus();
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                const searchContainer = document.querySelector('.global-search-container');
                const dropdown = document.getElementById('globalSearchDropdown');
                if (searchContainer && dropdown && !searchContainer.contains(e.target)) {
                    hideSearchDropdown();
                }
            });
            
            // Prevent dropdown from closing when clicking inside it
            const dropdown = document.getElementById('globalSearchDropdown');
            if (dropdown) {
                dropdown.addEventListener('mousedown', function(e) {
                    e.preventDefault(); // Prevent blur on input
                });
                dropdown.addEventListener('click', function(e) {
                    cancelHideDropdown();
                });
            }
        }

        // Load recent searches from localStorage
        function loadRecentSearches() {
            try {
                const stored = localStorage.getItem('recentSearches');
                recentSearches = stored ? JSON.parse(stored) : [];
                // Keep only last 10
                if (recentSearches.length > 10) {
                    recentSearches = recentSearches.slice(0, 10);
                }
            } catch (error) {
                console.error('Error loading recent searches:', error);
                recentSearches = [];
            }
        }

        // Save recent searches to localStorage
        function saveRecentSearches() {
            try {
                localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            } catch (error) {
                console.error('Error saving recent searches:', error);
            }
        }

        // Add ticker to recent searches
        function addToRecentSearches(ticker, name) {
            if (!ticker) return;
            
            // Remove if already exists
            recentSearches = recentSearches.filter(item => item.ticker !== ticker);
            
            // Add to beginning
            recentSearches.unshift({
                ticker: ticker,
                name: name || ticker,
                timestamp: Date.now()
            });
            
            // Keep only last 10
            if (recentSearches.length > 10) {
                recentSearches = recentSearches.slice(0, 10);
            }
            
            saveRecentSearches();
            renderSearchDropdown();
        }

        // Remove specific recent search
        function removeRecentSearch(ticker) {
            recentSearches = recentSearches.filter(item => item.ticker !== ticker);
            saveRecentSearches();
            renderSearchDropdown();
        }

        // Clear all recent searches
        function clearRecentSearches() {
            recentSearches = [];
            saveRecentSearches();
            renderSearchDropdown();
        }

        // Load favorites from localStorage
        function loadFavorites() {
            try {
                const stored = localStorage.getItem('favoriteTickers');
                favoriteTickers = stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Error loading favorites:', error);
                favoriteTickers = [];
            }
        }

        // Save favorites to localStorage
        function saveFavorites() {
            try {
                localStorage.setItem('favoriteTickers', JSON.stringify(favoriteTickers));
            } catch (error) {
                console.error('Error saving favorites:', error);
            }
        }

        // Check if ticker is favorite
        function isFavorite(ticker) {
            return favoriteTickers.includes(ticker.toUpperCase());
        }

        // Add to favorites
        function addToFavorites(ticker) {
            const upperTicker = ticker.toUpperCase();
            if (!favoriteTickers.includes(upperTicker)) {
                favoriteTickers.push(upperTicker);
                saveFavorites();
                renderSearchDropdown();
                updateFavoriteBadges();
            }
        }

        // Remove from favorites
        function removeFromFavorites(ticker) {
            const upperTicker = ticker.toUpperCase();
            favoriteTickers = favoriteTickers.filter(t => t !== upperTicker);
            saveFavorites();
            renderSearchDropdown();
            updateFavoriteBadges();
        }

        // Toggle favorite
        function toggleFavorite(ticker, event) {
            if (event) {
                event.stopPropagation();
            }
            if (isFavorite(ticker)) {
                removeFromFavorites(ticker);
            } else {
                addToFavorites(ticker);
            }
        }

        // Handle global search input
        async function handleGlobalSearch(event) {
            const query = event.target.value.trim();
            const clearBtn = document.getElementById('clearSearchBtn');
            
            if (query.length > 0) {
                clearBtn.style.display = 'block';
                // Show search results
                await searchTickers(query);
            } else {
                clearBtn.style.display = 'none';
                // Show recent searches and favorites
                renderSearchDropdown();
            }
        }

        // Clear global search
        function clearGlobalSearch() {
            document.getElementById('globalSearchInput').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            renderSearchDropdown();
        }

        // Search tickers via API
        async function searchTickers(query) {
            try {
                const response = await fetch(`/api/search-ticker?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                renderSearchResults(data.results || []);
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('searchResultsList').innerHTML = 
                    '<div class="search-dropdown-item" style="color: var(--text-secondary);">Error searching. Please try again.</div>';
            }
        }

        // Render search results
        function renderSearchResults(results) {
            const container = document.getElementById('searchResultsList');
            const section = document.getElementById('searchResultsSection');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="search-dropdown-item" style="color: var(--text-secondary);">No results found</div>';
                section.classList.remove('hidden');
                return;
            }
            
            container.innerHTML = results.map(result => `
                <div class="search-dropdown-item" onclick="navigateToTicker('${result.ticker}', '${(result.name || '').replace(/'/g, "\\'")}')">
                    <div class="ticker-info">
                        <div class="ticker-name">${result.ticker}</div>
                        <div class="ticker-exchange">${result.name} â€¢ ${result.exchange}</div>
                    </div>
                    <button class="favorite-btn" onclick="toggleFavorite('${result.ticker}', event)" title="${isFavorite(result.ticker) ? 'Remove from favorites' : 'Add to favorites'}">
                        ${isFavorite(result.ticker) ? 'â­' : 'â˜†'}
                    </button>
                </div>
            `).join('');
            
            section.classList.remove('hidden');
        }

        // Show search dropdown
        function showSearchDropdown() {
            const dropdown = document.getElementById('globalSearchDropdown');
            if (searchDropdownTimeout) {
                clearTimeout(searchDropdownTimeout);
                searchDropdownTimeout = null;
            }
            dropdown.classList.remove('hidden');
            renderSearchDropdown();
        }

        // Hide search dropdown (with delay for click events)
        function hideSearchDropdown() {
            if (searchDropdownTimeout) {
                clearTimeout(searchDropdownTimeout);
            }
            searchDropdownTimeout = setTimeout(() => {
                const dropdown = document.getElementById('globalSearchDropdown');
                if (dropdown) {
                    dropdown.classList.add('hidden');
                }
                searchDropdownTimeout = null;
            }, 150);
        }

        // Cancel hide if clicking inside dropdown
        function cancelHideDropdown() {
            if (searchDropdownTimeout) {
                clearTimeout(searchDropdownTimeout);
                searchDropdownTimeout = null;
            }
        }

        // Render search dropdown (recent searches + favorites)
        function renderSearchDropdown() {
            const query = document.getElementById('globalSearchInput').value.trim();
            
            // Hide search results if no query
            if (query.length === 0) {
                document.getElementById('searchResultsSection').classList.add('hidden');
            }
            
            // Render recent searches
            const recentContainer = document.getElementById('recentSearchesList');
            const recentSection = document.getElementById('recentSearchesSection');
            
            if (recentSearches.length === 0) {
                recentContainer.innerHTML = '<div class="search-dropdown-item" style="color: var(--text-secondary);">No recent searches</div>';
            } else {
                recentContainer.innerHTML = recentSearches.map(item => `
                    <div class="search-dropdown-item" onclick="navigateToTicker('${item.ticker}', '${(item.name || '').replace(/'/g, "\\'")}')">
                        <div class="ticker-info">
                            <div class="ticker-name">${item.ticker}</div>
                            <div class="ticker-exchange">${item.name}</div>
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button class="favorite-btn" onclick="toggleFavorite('${item.ticker}', event)" title="${isFavorite(item.ticker) ? 'Remove from favorites' : 'Add to favorites'}">
                                ${isFavorite(item.ticker) ? 'â­' : 'â˜†'}
                            </button>
                            <button class="remove-recent-btn" onclick="removeRecentSearch('${item.ticker}'); event.stopPropagation();" title="Remove from recent">Ã—</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Render favorites
            const favoritesContainer = document.getElementById('favoritesList');
            const favoritesSection = document.getElementById('favoritesSection');
            
            if (favoriteTickers.length === 0) {
                favoritesContainer.innerHTML = '<div class="search-dropdown-item" style="color: var(--text-secondary);">No favorites yet</div>';
            } else {
                // Get names for favorites (try to get from recent searches first)
                favoritesContainer.innerHTML = favoriteTickers.map(ticker => {
                    const recentItem = recentSearches.find(item => item.ticker === ticker);
                    const name = recentItem ? recentItem.name : ticker;
                    return `
                        <div class="search-dropdown-item" onclick="navigateToTicker('${ticker}', '${(name || '').replace(/'/g, "\\'")}')">
                            <div class="ticker-info">
                                <div class="ticker-name">${ticker} â­</div>
                                <div class="ticker-exchange">${name}</div>
                            </div>
                            <button class="favorite-btn" onclick="toggleFavorite('${ticker}', event)" title="Remove from favorites">
                                â­
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }

        // Navigate to ticker (Stock Analysis)
        function navigateToTicker(ticker, name) {
            if (!ticker) return;
            
            // Cancel any pending hide
            cancelHideDropdown();
            
            // Add to recent searches
            addToRecentSearches(ticker, name);
            
            // Hide dropdown immediately
            const dropdown = document.getElementById('globalSearchDropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            document.getElementById('globalSearchInput').blur();
            
            // Navigate to Stock Analysis
            showStockAnalysis();
            
            // Set ticker and search
            const tickerInput = document.getElementById('tickerInput');
            if (tickerInput) {
                tickerInput.value = ticker;
                searchStock();
            }
        }

        // Handle keyboard events in search
        function handleSearchKeydown(event) {
            if (event.key === 'Enter') {
                const query = event.target.value.trim();
                if (query.length > 0) {
                    // Try to navigate to first result or search
                    const firstItem = document.querySelector('.search-dropdown-item');
                    if (firstItem) {
                        firstItem.click();
                    }
                }
            } else if (event.key === 'Escape') {
                hideSearchDropdown();
                event.target.blur();
            }
        }

        // Update favorite badges across the page
        function updateFavoriteBadges() {
            // This will be called after favorites change
            // Badges will be updated when sections are rendered
            const currentTicker = document.getElementById('tickerInput')?.value?.trim().toUpperCase();
            if (currentTicker) {
                // Update favorite button in Stock Analysis if visible
                const favoriteBtn = document.getElementById('favoriteBtn');
                if (favoriteBtn) {
                    favoriteBtn.innerHTML = isFavorite(currentTicker) ? 'â­ Remove from Favorites' : 'â˜† Add to Favorites';
                }
            }
        }

        // Watchlist Section Functions
        function addToWatchlistFromInput() {
            const input = document.getElementById('watchlistTickerInput');
            if (!input) return;
            
            const ticker = input.value.trim().toUpperCase();
            if (!ticker) {
                showToast('Please enter a ticker symbol', 'error');
                return;
            }
            
            // Use existing addToWatchlist function
            const event = { preventDefault: () => {} };
            addToWatchlist(event, null);
            input.value = '';
            
            // Refresh watchlist display
            if (typeof loadWatchlistFromStorage === 'function') {
                loadWatchlistFromStorage();
            }
            if (typeof updateWatchlistMainContent === 'function') {
                updateWatchlistMainContent();
            }
        }

        function filterWatchlistMain() {
            const searchInput = document.getElementById('watchlistSearchInputMain');
            if (!searchInput) return;
            
            const query = searchInput.value.toLowerCase().trim();
            const watchlistContent = document.getElementById('watchlistMainContent');
            if (!watchlistContent) return;
            
            // Get watchlist from storage
            const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
            
            if (watchlist.length === 0) {
                watchlistContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 3em; margin-bottom: 20px;">â­</div>
                        <p>Your watchlist is empty. Add stocks to track them here.</p>
                    </div>
                `;
                return;
            }
            
            // Filter watchlist
            const filtered = query ? watchlist.filter(item => 
                item.ticker.toLowerCase().includes(query) || 
                (item.name && item.name.toLowerCase().includes(query))
            ) : watchlist;
            
            if (filtered.length === 0) {
                watchlistContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p>No stocks found matching "${query}"</p>
                    </div>
                `;
                return;
            }
            
            // Display filtered watchlist
            updateWatchlistMainContent(filtered);
        }

        function updateWatchlistMainContent(watchlistData = null) {
            const watchlistContent = document.getElementById('watchlistMainContent');
            if (!watchlistContent) return;
            
            const watchlist = watchlistData || JSON.parse(localStorage.getItem('watchlist') || '[]');
            
            if (watchlist.length === 0) {
                watchlistContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 3em; margin-bottom: 20px;">â­</div>
                        <p>Your watchlist is empty. Add stocks to track them here.</p>
                    </div>
                `;
                return;
            }
            
            // Group by group name
            const groups = {};
            watchlist.forEach(item => {
                const group = item.group || 'Default';
                if (!groups[group]) {
                    groups[group] = [];
                }
                groups[group].push(item);
            });
            
            let html = '';
            Object.keys(groups).sort().forEach(groupName => {
                html += `<div style="margin-bottom: 30px;">`;
                html += `<h3 style="color: var(--text-primary); margin-bottom: 15px; font-size: 1.1em; font-weight: 600;">${groupName === 'Default' ? 'â­ Watchlist' : 'ðŸ“ ' + groupName}</h3>`;
                html += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">`;
                
                groups[groupName].forEach(item => {
                    html += `
                        <div class="card" style="padding: 15px; cursor: pointer; transition: all 0.3s ease;" onclick="document.getElementById('tickerInput').value='${item.ticker}'; showStockAnalysis(); searchStock(event);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: var(--text-primary); font-size: 1.1em;">${item.ticker}</strong>
                                <button onclick="event.stopPropagation(); removeFromWatchlist('${item.ticker}', event); updateWatchlistMainContent(); return false;" style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2em; padding: 5px;">Ã—</button>
                            </div>
                            ${item.name ? `<div style="color: var(--text-secondary); font-size: 0.9em;">${item.name}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            watchlistContent.innerHTML = html;
        }

        function createSectorComparisonChart(data, ticker) {
            const ctx = document.getElementById('sectorComparisonBars');
            if (!ctx) {
                console.error('sectorComparisonBars canvas element not found!');
                return;
            }
            
            // Destroy existing chart if it exists
            if (window.sectorComparisonChartInstance) {
                window.sectorComparisonChartInstance.destroy();
            }
            
            const peerComparison = data.peer_comparison;
            if (!peerComparison || !peerComparison.peers || peerComparison.peers.length === 0) {
                ctx.parentElement.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No peer comparison data available</div>';
                return;
            }
            
            const peers = peerComparison.peers;
            const category = peerComparison.category || 'Industry';
            
            // Prepare data for grouped bar chart - compare multiple metrics across peers
            const metrics = ['revenue_ttm', 'net_income_ttm', 'fcf_ttm', 'gross_margin', 'fcf_margin'];
            const metricLabels = {
                'revenue_ttm': 'Revenue (TTM)',
                'net_income_ttm': 'Net Income (TTM)',
                'fcf_ttm': 'Free Cash Flow (TTM)',
                'gross_margin': 'Gross Margin',
                'fcf_margin': 'FCF Margin'
            };
            
            // Get tickers (current ticker first, then peers)
            const currentPeer = peers.find(p => p.is_current);
            const otherPeers = peers.filter(p => !p.is_current);
            const sortedPeers = currentPeer ? [currentPeer, ...otherPeers] : peers;
            const tickers = sortedPeers.map(p => p.ticker);
            
            // Create datasets for each metric
            const datasets = [];
            const colors = ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
            
            metrics.forEach((metric, idx) => {
                const values = sortedPeers.map(peer => {
                    const value = peer[metric];
                    if (value === null || value === undefined) return null;
                    // For margin metrics, use as-is; for dollar amounts, convert to billions
                    if (metric.includes('margin')) {
                        return value;
                    } else {
                        return value / 1e9; // Convert to billions
                    }
                });
                
                // Only add dataset if at least one peer has data
                if (values.some(v => v !== null)) {
                    datasets.push({
                        label: metricLabels[metric],
                        data: values,
                        backgroundColor: colors[idx] + '80',
                        borderColor: colors[idx],
                        borderWidth: 2,
                        borderRadius: 4
                    });
                }
            });
            
            if (datasets.length === 0) {
                ctx.parentElement.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No data available for peer comparison</div>';
                return;
            }
            
            const chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary') || '#1f2937';
            
            window.sectorComparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tickers.map(t => t === ticker.toUpperCase() ? `${t} (You)` : t),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: chartTextColor,
                                usePointStyle: true,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (value === null) return label + ': N/A';
                                    
                                    // Format based on metric type
                                    if (label.includes('Margin')) {
                                        return `${label}: ${value.toFixed(1)}%`;
                                    } else {
                                        return `${label}: $${value.toFixed(2)}B`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: chartTextColor,
                                callback: function(value) {
                                    // Check if any dataset has margin values (they're percentages)
                                    const hasMargins = datasets.some(d => d.label.includes('Margin'));
                                    if (hasMargins && value < 100) {
                                        return value + '%';
                                    }
                                    return '$' + value.toFixed(1) + 'B';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: chartTextColor
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createAnalystEstimatesTable(estimates, ticker, incomeData = null) {
            console.log('[DEBUG] createAnalystEstimatesTable: Function entry', {
                ticker: ticker,
                hasEstimates: !!estimates,
                revenueKeys: estimates?.revenue ? Object.keys(estimates.revenue) : [],
                epsKeys: estimates?.eps ? Object.keys(estimates.eps) : [],
                hasIncomeData: !!incomeData,
                incomeDataLength: incomeData?.length || 0
            });
            
            const container = document.getElementById('analystEstimatesTable');
            if (!container) {
                console.error('analystEstimatesTable container not found!');
                return;
            }
            
            const revenueEstimates = estimates.revenue || {};
            const epsEstimates = estimates.eps || {};
            
            // Get current date to filter quarters
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentQuarter = Math.ceil(currentMonth / 3); // 1-4
            
            console.log('[DEBUG] createAnalystEstimatesTable: Current date calculated', {
                currentYear: currentYear,
                currentMonth: currentMonth,
                currentQuarter: currentQuarter,
                revenueCount: Object.keys(revenueEstimates).length,
                epsCount: Object.keys(epsEstimates).length
            });
            
            // Get all quarters from estimates
            const allQuarters = new Set([...Object.keys(revenueEstimates), ...Object.keys(epsEstimates)]);
            
            // Build a set of quarters that have actuals (from incomeData if available)
            const quartersWithActuals = new Set();
            if (incomeData && Array.isArray(incomeData)) {
                incomeData.forEach(item => {
                    const quarter = item.quarter || item.date;
                    if (quarter) {
                        quartersWithActuals.add(quarter);
                    }
                });
            }
            
            console.log('[DEBUG] createAnalystEstimatesTable: Quarters with actuals', {
                quartersWithActuals: Array.from(quartersWithActuals).sort(),
                allQuarters: Array.from(allQuarters).sort(),
                incomeDataLength: incomeData?.length || 0
            });
            const quartersWithActualsList = Array.from(quartersWithActuals).sort();
            const allQuartersList = Array.from(allQuarters).sort();
            console.log('[DEBUG] createAnalystEstimatesTable: Detailed quarters info', {
                quartersWithActualsList: quartersWithActualsList,
                allQuartersList: allQuartersList,
                revenueEstimatesKeys: Object.keys(revenueEstimates).sort(),
                epsEstimatesKeys: Object.keys(epsEstimates).sort()
            });
            console.log('[DEBUG] createAnalystEstimatesTable: Quarters with actuals (expanded):', JSON.stringify(quartersWithActualsList, null, 2));
            console.log('[DEBUG] createAnalystEstimatesTable: All quarters (expanded):', JSON.stringify(allQuartersList, null, 2));
            
            // Filter to show quarters that don't have actuals yet (like Finviz does)
            // Sort all quarters chronologically
            const sortedQuarters = Array.from(allQuarters).sort((a, b) => {
                if (!a.includes('-Q') || !b.includes('-Q')) return 0;
                const [yearA, qA] = a.split('-Q');
                const [yearB, qB] = b.split('-Q');
                if (yearA !== yearB) return parseInt(yearA) - parseInt(yearB);
                return parseInt(qA) - parseInt(qB);
            });
            
            // Filter to show quarters >= current quarter that don't have actuals yet (like Finviz)
            // This includes current quarter if it doesn't have actuals yet, and all future quarters
            // Note: Finviz typically only provides estimates for next 4-8 quarters, so we show whatever is available
            const futureQuarters = sortedQuarters.filter(quarter => {
                if (!quarter.includes('-Q')) return false;
                const [year, q] = quarter.split('-Q');
                const quarterYear = parseInt(year);
                const quarterNum = parseInt(q);
                
                // Check if quarter is current or future
                const isCurrentOrFuture = quarterYear > currentYear || (quarterYear === currentYear && quarterNum >= currentQuarter);
                
                // Check if quarter doesn't have actuals yet
                const hasNoActuals = !quartersWithActuals.has(quarter);
                
                // Show if it's current/future AND doesn't have actuals (like Finviz behavior)
                const shouldShow = isCurrentOrFuture && hasNoActuals;
                
                console.log(`[DEBUG] Quarter ${quarter}: isCurrentOrFuture=${isCurrentOrFuture}, hasNoActuals=${hasNoActuals}, shouldShow=${shouldShow}`);
                
                
                return shouldShow;
            }).slice(0, 4); // Take next 4 quarters
            
            console.log('[DEBUG] createAnalystEstimatesTable: After filtering', {
                allQuarters: sortedQuarters,
                futureQuarters: futureQuarters,
                futureCount: futureQuarters.length,
                currentQuarter: `${currentYear}-Q${currentQuarter}`,
                filteredOutQuarters: sortedQuarters.filter(q => !futureQuarters.includes(q))
            });
            const filterDetails = sortedQuarters.map(quarter => {
                if (!quarter.includes('-Q')) return {quarter, reason: 'invalid format'};
                const [year, q] = quarter.split('-Q');
                const quarterYear = parseInt(year);
                const quarterNum = parseInt(q);
                const isCurrentOrFuture = quarterYear > currentYear || (quarterYear === currentYear && quarterNum >= currentQuarter);
                const hasNoActuals = !quartersWithActuals.has(quarter);
                const shouldShow = isCurrentOrFuture && hasNoActuals;
                return {
                    quarter,
                    quarterYear,
                    quarterNum,
                    isCurrentOrFuture,
                    hasNoActuals,
                    shouldShow,
                    reason: !shouldShow ? (isCurrentOrFuture ? 'has actuals' : 'past quarter') : 'included'
                };
            });
            console.log('[DEBUG] createAnalystEstimatesTable: Filter details for each quarter', filterDetails);
            console.log('[DEBUG] createAnalystEstimatesTable: Filter details (JSON):', JSON.stringify(filterDetails, null, 2));
            
            if (futureQuarters.length === 0) {
                console.log('[DEBUG] createAnalystEstimatesTable: No future quarters found, showing message');
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No future analyst estimates available</div>';
                return;
            }
            
            console.log('[DEBUG] createAnalystEstimatesTable: Creating table with', futureQuarters.length, 'quarters');
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 0.9em;">
                    <thead>
                        <tr style="background: var(--metric-bg); border-bottom: 2px solid var(--border-color);">
                            <th style="padding: 8px 10px; text-align: left; font-weight: 600; color: var(--text-primary); font-size: 0.9em;">Quarter</th>
                            <th style="padding: 8px 10px; text-align: right; font-weight: 600; color: var(--text-primary); font-size: 0.9em;">Revenue Est.</th>
                            <th style="padding: 8px 10px; text-align: right; font-weight: 600; color: var(--text-primary); font-size: 0.9em;">EPS Est.</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            futureQuarters.forEach(quarter => {
                const revenueEst = revenueEstimates[quarter];
                const epsEst = epsEstimates[quarter];
                
                // Format quarter string (e.g., "2025-Q1" -> "Q1 '25")
                let quarterDisplay = quarter;
                if (quarter.includes('-Q')) {
                    const [year, q] = quarter.split('-Q');
                    quarterDisplay = `Q${q} '${year.slice(-2)}`;
                }
                
                // Format revenue estimate: use millions if < 1B, otherwise billions
                let revenueDisplay = 'N/A';
                if (revenueEst && revenueEst > 0) {
                    if (revenueEst >= 1e9) {
                        revenueDisplay = '$' + (revenueEst / 1e9).toFixed(2) + 'B';
                    } else {
                        revenueDisplay = '$' + (revenueEst / 1e6).toFixed(2) + 'M';
                    }
                }
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 8px 10px; font-weight: 600; color: var(--text-primary); font-size: 0.9em;">${quarterDisplay}</td>
                        <td style="padding: 8px 10px; text-align: right; color: var(--text-primary); font-size: 0.9em;">
                            ${revenueDisplay}
                        </td>
                        <td style="padding: 8px 10px; text-align: right; color: var(--text-primary); font-size: 0.9em;">
                            ${epsEst !== null && epsEst !== undefined ? '$' + epsEst.toFixed(2) : 'N/A'}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }

        // Backtest Functions
        async function loadFactorAnalysis() {
            const ticker = document.getElementById('factorAnalysisTicker').value.trim().toUpperCase();
            if (!ticker) {
                showToast('Please enter a ticker symbol', 'error');
                return;
            }
            
            const contentDiv = document.getElementById('factorAnalysisContent');
            contentDiv.innerHTML = '<div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div></div>';
            
            try {
                const response = await fetch(`/api/factor-analysis/${ticker}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load factor analysis');
                }
                
                const data = await response.json();
                displayFactorAnalysis(data, ticker);
            } catch (error) {
                console.error('Error loading factor analysis:', error);
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 3em; margin-bottom: 20px;">âŒ</div>
                        <h3>Error Loading Factor Analysis</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                showToast('Error loading factor analysis', 'error');
            }
        }
        
        function displayFactorAnalysis(data, ticker) {
            const contentDiv = document.getElementById('factorAnalysisContent');
            
            if (!data || !data.factors) {
                contentDiv.innerHTML = '<p style="color: var(--text-secondary);">Factor analysis data not available.</p>';
                return;
            }
            
            const factors = data.factors;
            const breakdown = data.factor_breakdown || {};
            const recommendation = data.recommendation || '';
            
            // Create radar chart data
            const factorLabels = ['Value', 'Growth', 'Momentum', 'Quality'];
            const factorValues = [
                factors.value || 0,
                factors.growth || 0,
                factors.momentum || 0,
                factors.quality || 0
            ];
            
            let html = `
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);">Factor Scores for ${ticker}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            `;
            
            // Display factor scores as cards
            factorLabels.forEach((label, index) => {
                const value = factorValues[index];
                const color = value >= 70 ? '#10b981' : value >= 40 ? '#f59e0b' : '#ef4444';
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 2px solid ${color};">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">${label}</div>
                        <div style="font-size: 2em; font-weight: 700; color: ${color};">${value}/100</div>
                        <div style="margin-top: 10px; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${value}%; background: ${color}; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Recommendation
            if (recommendation) {
                html += `
                    <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-left: 4px solid #667eea; border-radius: 8px; margin-bottom: 30px;">
                        <strong>ðŸ’¡ Recommendation:</strong> ${recommendation}
                    </div>
                `;
            }
            
            // Factor breakdown
            html += '<div style="margin-top: 30px;"><h3 style="margin-bottom: 15px;">Factor Breakdown</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            factorLabels.forEach((label, index) => {
                const factorKey = label.toLowerCase();
                const factorBreakdown = breakdown[factorKey] || {};
                html += `
                    <div style="padding: 20px; background: var(--metric-bg); border-radius: 12px; border: 1px solid var(--border-color);">
                        <h4 style="margin-bottom: 15px; color: var(--text-primary);">${label} Factors</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                `;
                
                if (Object.keys(factorBreakdown).length === 0) {
                    html += '<p style="color: var(--text-secondary); font-size: 0.9em;">No breakdown data available</p>';
                } else {
                    Object.entries(factorBreakdown).forEach(([key, value]) => {
                        const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                <span style="color: var(--text-secondary);">${formattedKey}:</span>
                                <span style="font-weight: 600; color: var(--text-primary);">${typeof value === 'number' ? value.toFixed(2) : value}</span>
                            </div>
                        `;
                    });
                }
                
                html += '</div></div>';
            });
            
            html += '</div></div>';
            
            // Fair Value Section
            if (data.fair_value) {
                const fv = data.fair_value;
                const valuationColor = fv.valuation === 'undervalued' ? '#10b981' : fv.valuation === 'overvalued' ? '#ef4444' : '#f59e0b';
                const valuationEmoji = fv.valuation === 'undervalued' ? 'ðŸ“‰' : fv.valuation === 'overvalued' ? 'ðŸ“ˆ' : 'âš–ï¸';
                
                html += `
                    <div style="margin-top: 40px; padding: 25px; background: linear-gradient(135deg, ${valuationColor}15 0%, ${valuationColor}05 100%); border-radius: 16px; border: 2px solid ${valuationColor}; box-shadow: 0 8px 32px ${valuationColor}20;">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; font-size: 1.3em; font-weight: 700;">
                            ${valuationEmoji} Fair Value Estimate
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); text-align: center;">
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Fair Value</div>
                                <div style="font-size: 2.5em; font-weight: 800; color: ${valuationColor};">$${fv.fair_value.toFixed(2)}</div>
                            </div>
                            <div style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); text-align: center;">
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Current Price</div>
                                <div style="font-size: 2.5em; font-weight: 800; color: var(--text-primary);">$${fv.current_price.toFixed(2)}</div>
                            </div>
                            <div style="padding: 20px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); text-align: center;">
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Valuation</div>
                                <div style="font-size: 1.8em; font-weight: 700; color: ${valuationColor}; text-transform: capitalize; margin-bottom: 5px;">${fv.valuation}</div>
                                <div style="font-size: 1.1em; font-weight: 600; color: ${fv.discount_premium_pct >= 0 ? '#ef4444' : '#10b981'};">
                                    ${fv.discount_premium_pct >= 0 ? '+' : ''}${fv.discount_premium_pct.toFixed(1)}%
                                </div>
                            </div>
                        </div>
                        ${fv.methods && fv.methods.length > 0 ? `
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <h4 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1em;">Valuation Methods:</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    ${fv.methods.map(method => `
                                        <div style="padding: 15px; background: var(--metric-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">${method.method}</div>
                                            <div style="font-size: 1.3em; font-weight: 700; color: ${valuationColor}; margin-bottom: 5px;">$${method.value.toFixed(2)}</div>
                                            <div style="font-size: 0.85em; color: var(--text-secondary);">${method.description}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Create radar chart with beautiful styling
            html += `
                <div style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 16px; border: 2px solid rgba(102, 126, 234, 0.3); box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15);">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; font-size: 1.3em; font-weight: 700;">
                        ðŸ“Š Factor Radar Chart
                    </h3>
                    <div style="position: relative; height: 500px; background: rgba(255, 255, 255, 0.02); border-radius: 12px; padding: 20px;">
                        <canvas id="factorRadarChart"></canvas>
                    </div>
                </div>
            `;
            
            // Factor Attribution Section
            if (data.attribution) {
                html += `
                    <div style="margin-top: 40px; padding: 25px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            ðŸ” Factor Attribution
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Factor Attribution:</strong> DetailnÃ­ rozklad kaÅ¾dÃ©ho factor score - kterÃ© metriky pÅ™ispÃ­vajÃ­ k vÃ½slednÃ©mu skÃ³re a jak moc.<br><br>
                                    <strong>Contribution:</strong> PoÄet bodÅ¯, kterÃ© danÃ¡ metrika pÅ™idÃ¡vÃ¡ k factor score.<br><br>
                                    <strong>Status:</strong> Excellent/Good/Fair/Poor - hodnocenÃ­ danÃ© metriky.
                                </span>
                            </span>
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                `;
                
                ['value', 'growth', 'momentum', 'quality'].forEach(factorName => {
                    const factorLabel = factorName.charAt(0).toUpperCase() + factorName.slice(1);
                    const attributions = data.attribution[factorName] || {};
                    
                    html += `
                        <div style="padding: 20px; background: var(--metric-bg); border-radius: 10px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 15px; color: var(--text-primary);">${factorLabel} Attribution</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                    `;
                    
                    if (Object.keys(attributions).length === 0) {
                        html += '<p style="color: var(--text-secondary); font-size: 0.9em;">No attribution data available</p>';
                    } else {
                        Object.entries(attributions).forEach(([metric, metricData]) => {
                            const contribution = metricData.contribution || 0;
                            const status = metricData.status || 'fair';
                            const value = metricData.value;
                            
                            const statusColors = {
                                'excellent': '#10b981',
                                'good': '#3b82f6',
                                'fair': '#f59e0b',
                                'poor': '#ef4444'
                            };
                            const statusColor = statusColors[status] || '#6b7280';
                            
                            html += `
                                <div style="padding: 12px; background: ${statusColor}10; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <span style="font-weight: 600; color: var(--text-primary);">${metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                        <span style="font-size: 1.1em; font-weight: 700; color: ${statusColor};">+${contribution}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85em;">
                                        <span style="color: var(--text-secondary);">Value: ${typeof value === 'number' ? value.toFixed(2) : value}</span>
                                        <span style="color: ${statusColor}; font-weight: 600; text-transform: capitalize;">${status}</span>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    html += '</div></div>';
                });
                
                html += '</div></div>';
            }
            
            // Top Contributors Section
            if (data.top_contributors) {
                html += `
                    <div style="margin-top: 40px; padding: 25px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            ðŸ† Top Contributors
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                `;
                
                ['value', 'growth', 'momentum', 'quality'].forEach(factorName => {
                    const factorLabel = factorName.charAt(0).toUpperCase() + factorName.slice(1);
                    const contributors = data.top_contributors[factorName] || [];
                    
                    html += `
                        <div style="padding: 20px; background: var(--metric-bg); border-radius: 10px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 15px; color: var(--text-primary);">${factorLabel}</h4>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                    `;
                    
                    if (contributors.length === 0) {
                        html += '<p style="color: var(--text-secondary); font-size: 0.9em;">No contributors available</p>';
                    } else {
                        contributors.forEach((contributor, idx) => {
                            const medal = idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰';
                            html += `
                                <div style="padding: 10px; background: rgba(102, 126, 234, 0.05); border-radius: 6px;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                        <span style="font-size: 1.2em;">${medal}</span>
                                        <span style="font-weight: 600; color: var(--text-primary);">${contributor.metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: var(--text-secondary);">
                                        <span>Contribution: <strong style="color: #667eea;">+${contributor.contribution}</strong></span>
                                        <span style="text-transform: capitalize; color: ${contributor.status === 'excellent' ? '#10b981' : contributor.status === 'good' ? '#3b82f6' : '#f59e0b'};">${contributor.status}</span>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    html += '</div></div>';
                });
                
                html += '</div></div>';
            }
            
            // Factor Rotation Analysis
            if (data.rotation && data.rotation.length > 0) {
                html += `
                    <div style="margin-top: 40px; padding: 25px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            ðŸ”„ Factor Rotation Analysis
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Factor Rotation:</strong> Jak se faktory mÄ›nÃ­ v Äase. Ukazuje, zda se faktor zlepÅ¡uje nebo zhorÅ¡uje v rÅ¯znÃ½ch ÄasovÃ½ch obdobÃ­ch.<br><br>
                                    <strong>Co hledat:</strong> RostoucÃ­ trend = faktor se zlepÅ¡uje. KlesajÃ­cÃ­ trend = faktor se zhorÅ¡uje.
                                </span>
                            </span>
                        </h3>
                        <div style="position: relative; height: 350px;">
                            <canvas id="factorRotationChart"></canvas>
                        </div>
                    </div>
                `;
            }
            
            // Factor Momentum Analysis
            if (data.momentum_analysis) {
                html += `
                    <div style="margin-top: 40px; padding: 25px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            âš¡ Factor Momentum
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Factor Momentum:</strong> KterÃ© faktory zrychlujÃ­ (accelerating) a kterÃ© zpomalujÃ­ (decelerating).<br><br>
                                    <strong>Accelerating:</strong> Faktor roste rychleji = pozitivnÃ­ signÃ¡l.<br><br>
                                    <strong>Decelerating:</strong> Faktor klesÃ¡ = negativnÃ­ signÃ¡l.
                                </span>
                            </span>
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                `;
                
                ['value', 'growth', 'momentum', 'quality'].forEach(factorName => {
                    const factorLabel = factorName.charAt(0).toUpperCase() + factorName.slice(1);
                    const momentum = data.momentum_analysis[factorName];
                    
                    if (momentum) {
                        const change = momentum.change || 0;
                        const trend = momentum.trend || 'stable';
                        const trendColor = trend === 'accelerating' ? '#10b981' : trend === 'decelerating' ? '#ef4444' : '#f59e0b';
                        const trendEmoji = trend === 'accelerating' ? 'ðŸ“ˆ' : trend === 'decelerating' ? 'ðŸ“‰' : 'âž¡ï¸';
                        
                        html += `
                            <div style="padding: 15px; background: ${trendColor}10; border-radius: 10px; border: 2px solid ${trendColor};">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px;">${factorLabel}</div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                    <span style="font-size: 1.2em;">${trendEmoji}</span>
                                    <span style="font-weight: 700; color: ${trendColor}; text-transform: capitalize;">${trend}</span>
                                </div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">
                                    Change: <strong style="color: ${change >= 0 ? '#10b981' : '#ef4444'};">${change >= 0 ? '+' : ''}${change.toFixed(1)}</strong>
                                </div>
                                <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 5px;">
                                    ${momentum.current.toFixed(0)} â†’ ${momentum.previous.toFixed(0)}
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div></div>';
            }
            
            // Optimal Factor Mix
            if (data.optimal_mix) {
                const optimalMix = data.optimal_mix;
                html += `
                    <div style="margin-top: 40px; padding: 25px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(16, 185, 129, 0.15) 100%); border-radius: 12px; border: 2px solid #667eea;">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            ðŸŽ¯ Optimal Factor Mix
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Optimal Factor Mix:</strong> DoporuÄenÃ¡ kombinace faktorÅ¯ pro tento ticker na zÃ¡kladÄ› sektoru/odvÄ›tvÃ­.<br><br>
                                    <strong>Co to znamenÃ¡:</strong> RÅ¯znÃ© sektory majÃ­ rÅ¯znÃ© optimÃ¡lnÃ­ faktory. NapÅ™. Technology preferuje Growth a Momentum, Financial preferuje Value a Quality.
                                </span>
                            </span>
                        </h3>
                        <div style="margin-bottom: 20px;">
                            <p style="color: var(--text-primary); line-height: 1.6;">${optimalMix.reasoning}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Recommended Factors</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${optimalMix.recommended_factors.map(f => `<span style="padding: 6px 12px; background: #667eea; color: white; border-radius: 6px; font-size: 0.85em; font-weight: 600;">${f.charAt(0).toUpperCase() + f.slice(1)}</span>`).join('')}
                                </div>
                            </div>
                            <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Top Factor</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: #10b981;">${optimalMix.top_factor ? optimalMix.top_factor.charAt(0).toUpperCase() + optimalMix.top_factor.slice(1) : 'N/A'}</div>
                            </div>
                            <div style="padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 5px;">Weakest Factor</div>
                                <div style="font-size: 1.2em; font-weight: 700; color: #ef4444;">${optimalMix.weakest_factor ? optimalMix.weakest_factor.charAt(0).toUpperCase() + optimalMix.weakest_factor.slice(1) : 'N/A'}</div>
                            </div>
                        </div>
                        ${optimalMix.improvement_areas && optimalMix.improvement_areas.length > 0 ? `
                            <div style="padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 3px solid #f59e0b;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">ðŸ’¡ Improvement Areas:</div>
                                <ul style="margin: 0; padding-left: 20px; color: var(--text-primary);">
                                    ${optimalMix.improvement_areas.map(area => `<li>${area}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Factor Sensitivity Analysis
            if (data.sensitivity_analysis) {
                html += `
                    <div style="margin-top: 40px; padding: 25px; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--border-color);">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            ðŸ“Š Factor Sensitivity Analysis
                            <span class="info-badge tooltip" style="cursor: help; font-size: 0.8em; margin-left: 5px;">â„¹ï¸
                                <span class="tooltiptext" style="max-width: 350px; white-space: normal;">
                                    <strong>Factor Sensitivity:</strong> Jak citlivÃ½ je kaÅ¾dÃ½ factor score na zmÄ›ny v jednotlivÃ½ch metrikÃ¡ch.<br><br>
                                    <strong>High Impact:</strong> MalÃ¡ zmÄ›na v metrice zpÅ¯sobÃ­ velkou zmÄ›nu ve factor score.<br><br>
                                    <strong>Low Impact:</strong> ZmÄ›na v metrice mÃ¡ malÃ½ vliv na factor score.
                                </span>
                            </span>
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                `;
                
                ['value', 'growth', 'momentum', 'quality'].forEach(factorName => {
                    const factorLabel = factorName.charAt(0).toUpperCase() + factorName.slice(1);
                    const sensitivities = data.sensitivity_analysis[factorName] || {};
                    
                    html += `
                        <div style="padding: 20px; background: var(--metric-bg); border-radius: 10px; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 15px; color: var(--text-primary);">${factorLabel} Sensitivity</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                    `;
                    
                    if (Object.keys(sensitivities).length === 0) {
                        html += '<p style="color: var(--text-secondary); font-size: 0.9em;">No sensitivity data available</p>';
                    } else {
                        Object.entries(sensitivities).forEach(([metric, sensData]) => {
                            const sensitivity = sensData.sensitivity || 0;
                            const impact = sensData.impact || 'low';
                            const impactColors = {
                                'high': '#ef4444',
                                'medium': '#f59e0b',
                                'low': '#10b981'
                            };
                            const impactColor = impactColors[impact] || '#6b7280';
                            
                            html += `
                                <div style="padding: 12px; background: ${impactColor}10; border-radius: 8px; border-left: 3px solid ${impactColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <span style="font-weight: 600; color: var(--text-primary);">${sensData.metric}</span>
                                        <span style="font-size: 1.1em; font-weight: 700; color: ${impactColor};">${sensitivity >= 0 ? '+' : ''}${sensitivity.toFixed(1)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85em;">
                                        <span style="color: var(--text-secondary);">Base: ${sensData.base_value}</span>
                                        <span style="color: ${impactColor}; font-weight: 600; text-transform: capitalize;">${impact} impact</span>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    html += '</div></div>';
                });
                
                html += '</div></div>';
            }
            
            contentDiv.innerHTML = html;
            
            // Create radar chart using Chart.js
            setTimeout(() => {
                const ctx = document.getElementById('factorRadarChart');
                if (ctx && typeof Chart !== 'undefined') {
                    // Get factor data again (in case it's not in scope)
                    const factors = data.factors || {};
                    const chartFactorLabels = ['Value', 'Growth', 'Momentum', 'Quality'];
                    const chartFactorValues = [
                        factors.value || 0,
                        factors.growth || 0,
                        factors.momentum || 0,
                        factors.quality || 0
                    ];
                    
                    const isDark = document.body.classList.contains('dark-mode');
                    const chartTextColor = isDark ? '#e5e7eb' : '#1f2937';
                    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                    
                    // Create gradient for fill
                    const chartCtx = ctx.getContext('2d');
                    const gradient = chartCtx.createLinearGradient(0, 0, 0, 500);
                    gradient.addColorStop(0, 'rgba(102, 126, 234, 0.4)');
                    gradient.addColorStop(0.5, 'rgba(118, 75, 162, 0.3)');
                    gradient.addColorStop(1, 'rgba(102, 126, 234, 0.1)');
                    
                    // Destroy existing chart if it exists
                    if (window.factorRadarChartInstance) {
                        window.factorRadarChartInstance.destroy();
                    }
                    
                    window.factorRadarChartInstance = new Chart(chartCtx, {
                        type: 'radar',
                        data: {
                            labels: chartFactorLabels,
                            datasets: [{
                                label: 'Factor Scores',
                                data: chartFactorValues,
                                backgroundColor: gradient,
                                borderColor: '#667eea',
                                borderWidth: 3,
                                pointBackgroundColor: '#667eea',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 3,
                                pointRadius: 8,
                                pointHoverRadius: 10,
                                pointHoverBackgroundColor: '#764ba2',
                                pointHoverBorderColor: '#ffffff',
                                pointHoverBorderWidth: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 2000,
                                easing: 'easeOutQuart',
                                animateRotate: true,
                                animateScale: true
                            },
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    min: 0,
                                    ticks: {
                                        stepSize: 20,
                                        color: chartTextColor,
                                        font: {
                                            size: 12,
                                            weight: '600',
                                            family: 'Inter'
                                        },
                                        backdropColor: 'transparent',
                                        showLabelBackdrop: false
                                    },
                                    grid: {
                                        color: gridColor,
                                        lineWidth: 1.5,
                                        circular: true
                                    },
                                    angleLines: {
                                        color: gridColor,
                                        lineWidth: 1.5
                                    },
                                    pointLabels: {
                                        color: chartTextColor,
                                        font: {
                                            size: 14,
                                            weight: '700',
                                            family: 'Inter'
                                        },
                                        padding: 15
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: isDark ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.85)',
                                    padding: 15,
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: '#667eea',
                                    borderWidth: 2,
                                    cornerRadius: 10,
                                    displayColors: true,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold',
                                        family: 'Inter'
                                    },
                                    bodyFont: {
                                        size: 13,
                                        weight: '600',
                                        family: 'Inter'
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.r;
                                            const label = context.label;
                                            const emoji = {
                                                'Value': 'ðŸ’°',
                                                'Growth': 'ðŸ“ˆ',
                                                'Momentum': 'âš¡',
                                                'Quality': 'â­'
                                            }[label] || 'ðŸ“Š';
                                            return `${emoji} ${label}: ${value.toFixed(1)}/100`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Create Factor Rotation Chart
                if (data.rotation && data.rotation.length > 0) {
                    const rotationCtx = document.getElementById('factorRotationChart');
                    if (rotationCtx) {
                        const rotationLabels = data.rotation.map(r => r.period.toUpperCase());
                        const valueData = data.rotation.map(r => r.value);
                        const growthData = data.rotation.map(r => r.growth);
                        const momentumData = data.rotation.map(r => r.momentum);
                        const qualityData = data.rotation.map(r => r.quality);
                        
                        const isDark = document.body.classList.contains('dark-mode');
                        const chartTextColor = isDark ? '#e5e7eb' : '#1f2937';
                        const gridColor = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)';
                        
                        new Chart(rotationCtx, {
                            type: 'line',
                            data: {
                                labels: rotationLabels,
                                datasets: [
                                    {
                                        label: 'Value',
                                        data: valueData,
                                        borderColor: '#ef4444',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 3,
                                        fill: false,
                                        tension: 0.4,
                                        pointRadius: 6,
                                        pointHoverRadius: 8
                                    },
                                    {
                                        label: 'Growth',
                                        data: growthData,
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                        borderWidth: 3,
                                        fill: false,
                                        tension: 0.4,
                                        pointRadius: 6,
                                        pointHoverRadius: 8
                                    },
                                    {
                                        label: 'Momentum',
                                        data: momentumData,
                                        borderColor: '#667eea',
                                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                        borderWidth: 3,
                                        fill: false,
                                        tension: 0.4,
                                        pointRadius: 6,
                                        pointHoverRadius: 8
                                    },
                                    {
                                        label: 'Quality',
                                        data: qualityData,
                                        borderColor: '#f59e0b',
                                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                        borderWidth: 3,
                                        fill: false,
                                        tension: 0.4,
                                        pointRadius: 6,
                                        pointHoverRadius: 8
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: {
                                            color: chartTextColor,
                                            stepSize: 20
                                        },
                                        grid: {
                                            color: gridColor
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            color: chartTextColor
                                        },
                                        grid: {
                                            display: false
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            color: chartTextColor,
                                            padding: 15,
                                            usePointStyle: true
                                        }
                                    },
                                    tooltip: {
                                        backgroundColor: isDark ? 'rgba(0, 0, 0, 0.9)' : 'rgba(0, 0, 0, 0.85)',
                                        padding: 12,
                                        titleColor: '#ffffff',
                                        bodyColor: '#ffffff',
                                        borderColor: 'rgba(255, 255, 255, 0.1)',
                                        borderWidth: 1,
                                        cornerRadius: 8
                                    }
                                }
                            }
                        });
                    }
                }
            }, 100);
        }

        async function loadBacktest() {
            const ticker = document.getElementById('backtestTicker').value.trim().toUpperCase();
            if (!ticker) {
                alert('Please enter a ticker symbol');
                return;
            }
            
            const content = document.getElementById('backtestContent');
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">Loading backtest results...</div>';
            
            const result = await fetchJSON(`/api/backtest/${ticker}`, {}, content);
            
            if (!result.success) {
                // fetchJSON already displayed error, but check for specific backtest error details
                if (result.error && result.error.includes('days_old')) {
                    // Try to extract additional info from the error response
            try {
                        const response = await safeFetch(`/api/backtest/${ticker}`);
                if (!response.ok) {
                            const errorData = await response.json();
                            if (errorData.days_old !== undefined) {
                                const errorMsg = `${result.error}<br><br><strong>Latest prediction:</strong> ${errorData.latest_prediction_date || 'N/A'}<br><strong>Days old:</strong> ${errorData.days_old}<br><br>Backtest requires predictions that are at least 21 days old to compare with actual prices.`;
                    content.innerHTML = `<div style="padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; color: #ef4444;">${errorMsg}</div>`;
                    return;
                }
                        }
                    } catch (e) {
                        // Fallback to default error message
                    }
                }
                return; // Error already displayed by fetchJSON
            }
                
            displayBacktestResults(result.data);
        }
        
        function displayBacktestResults(data) {
            const content = document.getElementById('backtestContent');
            
            if (!data.success || !data.predictions || data.predictions.length === 0) {
                content.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No backtest results available</div>';
                return;
            }
            
            const perf = data.performance_metrics || {};
            const baseline = data.baseline_comparison || {};
            const trading = data.trading_metrics || {};
            const summary = data.summary || {};
            
            let html = `
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">ðŸ“Š Performance Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="card" style="padding: 15px;">
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">Total Predictions</div>
                            <div style="font-size: 1.5em; font-weight: 600; color: var(--text-primary);">${data.predictions_count || data.predictions.length}</div>
                        </div>
                        <div class="card" style="padding: 15px;">
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">RÂ² Score</div>
                            <div style="font-size: 1.5em; font-weight: 600; color: ${(perf.r2_score || 0) >= 0 ? '#10b981' : '#ef4444'};">
                                ${summary.r2_score || (perf.r2_score ? perf.r2_score.toFixed(4) : 'N/A')}
                            </div>
                        </div>
                        <div class="card" style="padding: 15px;">
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">Mean Absolute Error</div>
                            <div style="font-size: 1.5em; font-weight: 600; color: var(--text-primary);">
                                ${summary.mean_absolute_error || (perf.mae ? '$' + perf.mae.toFixed(2) : 'N/A')}
                            </div>
                        </div>
                        <div class="card" style="padding: 15px;">
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">Direction Accuracy</div>
                            <div style="font-size: 1.5em; font-weight: 600; color: ${(perf.direction_accuracy || 0) >= 50 ? '#10b981' : '#ef4444'};">
                                ${summary.direction_accuracy || (perf.direction_accuracy ? perf.direction_accuracy.toFixed(1) + '%' : 'N/A')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Performance Metrics
            if (perf && Object.keys(perf).length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px;">ðŸ“ˆ Performance Metrics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div class="card" style="padding: 20px;">
                                <h4 style="margin-bottom: 15px; color: var(--text-primary);">ML Model</h4>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-secondary);">RMSE:</span>
                                        <span style="font-weight: 600; color: var(--text-primary);">${summary.root_mean_squared_error || (perf.rmse ? '$' + perf.rmse.toFixed(2) : 'N/A')}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-secondary);">MAPE:</span>
                                        <span style="font-weight: 600; color: var(--text-primary);">${summary.mean_absolute_percentage_error || (perf.mape ? perf.mape.toFixed(2) + '%' : 'N/A')}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-secondary);">Correlation:</span>
                                        <span style="font-weight: 600; color: var(--text-primary);">${summary.correlation || (perf.correlation ? perf.correlation.toFixed(4) : 'N/A')}</span>
                                    </div>
                                </div>
                            </div>
                `;
                
                // Baseline Comparisons
                if (baseline.naive_baseline) {
                    html += `
                        <div class="card" style="padding: 20px;">
                                <h4 style="margin-bottom: 15px; color: var(--text-primary);">Naive Baseline</h4>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px;">${baseline.naive_baseline.description || 'Predicts price stays the same'}</div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-secondary);">RÂ²:</span>
                                        <span style="font-weight: 600; color: var(--text-primary);">${baseline.naive_baseline.r2_score ? baseline.naive_baseline.r2_score.toFixed(4) : 'N/A'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-secondary);">RMSE:</span>
                                        <span style="font-weight: 600; color: var(--text-primary);">${baseline.naive_baseline.rmse ? '$' + baseline.naive_baseline.rmse.toFixed(2) : 'N/A'}</span>
                                </div>
                                </div>
                            </div>
                    `;
                }
                
                if (baseline.momentum_baseline) {
                    html += `
                            <div class="card" style="padding: 20px;">
                                <h4 style="margin-bottom: 15px; color: var(--text-primary);">Momentum Baseline</h4>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px;">${baseline.momentum_baseline.description || 'Predicts price continues previous trend'}</div>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-secondary);">RÂ²:</span>
                                        <span style="font-weight: 600; color: var(--text-primary);">${baseline.momentum_baseline.r2_score ? baseline.momentum_baseline.r2_score.toFixed(4) : 'N/A'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-secondary);">RMSE:</span>
                                        <span style="font-weight: 600; color: var(--text-primary);">${baseline.momentum_baseline.rmse ? '$' + baseline.momentum_baseline.rmse.toFixed(2) : 'N/A'}</span>
                                </div>
                                </div>
                            </div>
                    `;
                }
                
                // Trading Metrics
                if (trading && Object.keys(trading).length > 0) {
                    html += `
                            <div class="card" style="padding: 20px;">
                                <h4 style="margin-bottom: 15px; color: var(--text-primary);">Trading Metrics</h4>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-secondary);">Sharpe Ratio:</span>
                                        <span style="font-weight: 600; color: var(--text-primary);">${summary.sharpe_ratio || (trading.sharpe_ratio ? trading.sharpe_ratio.toFixed(2) : 'N/A')}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-secondary);">Max Drawdown:</span>
                                        <span style="font-weight: 600; color: ${(trading.max_drawdown_pct || 0) >= 0 ? '#10b981' : '#ef4444'};">
                                            ${summary.max_drawdown || (trading.max_drawdown_pct ? trading.max_drawdown_pct.toFixed(2) + '%' : 'N/A')}
                                        </span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--text-secondary);">Total Return:</span>
                                        <span style="font-weight: 600; color: ${(trading.total_return_pct || 0) >= 0 ? '#10b981' : '#ef4444'};">
                                            ${trading.total_return_pct ? (trading.total_return_pct >= 0 ? '+' : '') + trading.total_return_pct.toFixed(2) + '%' : 'N/A'}
                                        </span>
                                </div>
                            </div>
                                ${trading.note ? `<div style="font-size: 0.75em; color: var(--text-secondary); margin-top: 10px; font-style: italic;">${trading.note}</div>` : ''}
                        </div>
                    `;
                }
                
                html += `</div></div>`;
            }
            
            // Model vs Baselines Comparison
            if (baseline.ml_model_vs_baselines) {
                const vs = baseline.ml_model_vs_baselines;
            html += `
                <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px;">ðŸŽ¯ Model vs Baselines</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="card" style="padding: 15px; background: ${vs.better_than_naive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'};">
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">vs Naive Baseline</div>
                                <div style="font-size: 1.2em; font-weight: 600; color: ${vs.better_than_naive ? '#10b981' : '#ef4444'};">
                                    ${vs.better_than_naive ? 'âœ… Better' : 'âŒ Worse'}
                                </div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                                    RÂ² improvement: ${vs.improvement_vs_naive_r2 >= 0 ? '+' : ''}${vs.improvement_vs_naive_r2.toFixed(4)}
                                </div>
                            </div>
                            <div class="card" style="padding: 15px; background: ${vs.better_than_momentum ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'};">
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">vs Momentum Baseline</div>
                                <div style="font-size: 1.2em; font-weight: 600; color: ${vs.better_than_momentum ? '#10b981' : '#ef4444'};">
                                    ${vs.better_than_momentum ? 'âœ… Better' : 'âŒ Worse'}
                                </div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                                    RÂ² improvement: ${vs.improvement_vs_momentum_r2 >= 0 ? '+' : ''}${vs.improvement_vs_momentum_r2.toFixed(4)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Detailed predictions table
            if (data.predictions && data.predictions.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px;">ðŸ“‹ Detailed Predictions (Last 50)</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr style="background: var(--metric-bg); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">Date</th>
                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">Predicted</th>
                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">Actual</th>
                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">Error</th>
                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">Error %</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
                // Show last 50 predictions (most recent first)
                const predictionsToShow = data.predictions.slice(-50).reverse();
                for (const pred of predictionsToShow) {
                    const errorColor = Math.abs(pred.error_pct || 0) < 5 ? '#10b981' : (Math.abs(pred.error_pct || 0) < 10 ? '#f59e0b' : '#ef4444');
                html += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 12px; font-weight: 600; color: var(--text-primary);">${pred.date}</td>
                            <td style="padding: 12px; text-align: right; color: var(--text-primary);">$${pred.predicted ? pred.predicted.toFixed(2) : 'N/A'}</td>
                            <td style="padding: 12px; text-align: right; color: var(--text-primary);">$${pred.actual ? pred.actual.toFixed(2) : 'N/A'}</td>
                            <td style="padding: 12px; text-align: right; color: ${errorColor};">
                                ${pred.error !== undefined ? (pred.error >= 0 ? '+' : '') + '$' + pred.error.toFixed(2) : 'N/A'}
                        </td>
                            <td style="padding: 12px; text-align: right; color: ${errorColor};">
                                ${pred.error_pct !== undefined ? (pred.error_pct >= 0 ? '+' : '') + pred.error_pct.toFixed(2) + '%' : 'N/A'}
                        </td>
                    </tr>
                `;
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            }
            
            content.innerHTML = html;
        }

        // Load watchlist when watchlist section is shown - extend navigateToSection
        const originalNavigateToSectionFunc = window.navigateToSection;
        window.navigateToSection = function(sectionId) {
            originalNavigateToSectionFunc(sectionId);
            
            if (sectionId === 'watchlistSection') {
                setTimeout(() => {
                    if (typeof updateWatchlistMainContent === 'function') {
                        updateWatchlistMainContent();
                    }
                }, 100);
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initGlobalSearch();
            
            // Ensure toggle functions are available globally
            if (typeof toggleVolumeOverlay === 'function') {
                window.toggleVolumeOverlay = toggleVolumeOverlay;
            }
            if (typeof toggleSupportResistance === 'function') {
                window.toggleSupportResistance = toggleSupportResistance;
            }
            if (typeof toggleAnnotationMode === 'function') {
                window.toggleAnnotationMode = toggleAnnotationMode;
            }
            
            // Debug: Check if functions are available
            console.log('Toggle functions available:', {
                toggleVolumeOverlay: typeof window.toggleVolumeOverlay,
                toggleSupportResistance: typeof window.toggleSupportResistance,
                toggleAnnotationMode: typeof window.toggleAnnotationMode
            });
        });

        // Stock Screener Functions
        let screenerResults = [];
        let screenerSortColumn = null;
        let screenerSortDirection = 'asc';
        let screenerCurrentPage = 1;
        let screenerPerPage = 20;
        let screenerTotalPages = 0;
        let screenerTotalCount = 0;
        
        async function runScreener(page = 1) {
            const loadingDiv = document.getElementById('screenerLoading');
            const resultsDiv = document.getElementById('screenerResults');
            const tableBody = document.getElementById('screenerResultsTableBody');
            
            // Collect filters
            const filters = {};
            
            const marketCapMin = document.getElementById('filter_market_cap_min').value;
            const marketCapMax = document.getElementById('filter_market_cap_max').value;
            if (marketCapMin) filters.market_cap_min = parseFloat(marketCapMin) * 1e9; // Convert billions to actual
            if (marketCapMax) filters.market_cap_max = parseFloat(marketCapMax) * 1e9;
            
            const peMin = document.getElementById('filter_pe_min').value;
            const peMax = document.getElementById('filter_pe_max').value;
            if (peMin) filters.pe_min = parseFloat(peMin);
            if (peMax) filters.pe_max = parseFloat(peMax);
            
            const pbMin = document.getElementById('filter_pb_min').value;
            const pbMax = document.getElementById('filter_pb_max').value;
            if (pbMin) filters.pb_min = parseFloat(pbMin);
            if (pbMax) filters.pb_max = parseFloat(pbMax);
            
            const psMin = document.getElementById('filter_ps_min').value;
            const psMax = document.getElementById('filter_ps_max').value;
            if (psMin) filters.ps_min = parseFloat(psMin);
            if (psMax) filters.ps_max = parseFloat(psMax);
            
            const divYieldMin = document.getElementById('filter_dividend_yield_min').value;
            const divYieldMax = document.getElementById('filter_dividend_yield_max').value;
            if (divYieldMin) filters.dividend_yield_min = parseFloat(divYieldMin);
            if (divYieldMax) filters.dividend_yield_max = parseFloat(divYieldMax);
            
            const revGrowthMin = document.getElementById('filter_revenue_growth_min').value;
            const revGrowthMax = document.getElementById('filter_revenue_growth_max').value;
            if (revGrowthMin) filters.revenue_growth_min = parseFloat(revGrowthMin);
            if (revGrowthMax) filters.revenue_growth_max = parseFloat(revGrowthMax);
            
            const epsGrowthMin = document.getElementById('filter_eps_growth_min').value;
            const epsGrowthMax = document.getElementById('filter_eps_growth_max').value;
            if (epsGrowthMin) filters.eps_growth_min = parseFloat(epsGrowthMin);
            if (epsGrowthMax) filters.eps_growth_max = parseFloat(epsGrowthMax);
            
            const roeMin = document.getElementById('filter_roe_min').value;
            const roeMax = document.getElementById('filter_roe_max').value;
            if (roeMin) filters.roe_min = parseFloat(roeMin);
            if (roeMax) filters.roe_max = parseFloat(roeMax);
            
            const debtEquityMin = document.getElementById('filter_debt_equity_min').value;
            const debtEquityMax = document.getElementById('filter_debt_equity_max').value;
            if (debtEquityMin) filters.debt_equity_min = parseFloat(debtEquityMin);
            if (debtEquityMax) filters.debt_equity_max = parseFloat(debtEquityMax);
            
            const betaMin = document.getElementById('filter_beta_min').value;
            const betaMax = document.getElementById('filter_beta_max').value;
            if (betaMin) filters.beta_min = parseFloat(betaMin);
            if (betaMax) filters.beta_max = parseFloat(betaMax);
            
            const rsiMin = document.getElementById('filter_rsi_min').value;
            const rsiMax = document.getElementById('filter_rsi_max').value;
            if (rsiMin) filters.rsi_min = parseFloat(rsiMin);
            if (rsiMax) filters.rsi_max = parseFloat(rsiMax);
            
            const shortFloatMin = document.getElementById('filter_short_float_min').value;
            const shortFloatMax = document.getElementById('filter_short_float_max').value;
            if (shortFloatMin) filters.short_float_min = parseFloat(shortFloatMin);
            if (shortFloatMax) filters.short_float_max = parseFloat(shortFloatMax);
            
            const volumeMin = document.getElementById('filter_volume_min').value;
            const volumeMax = document.getElementById('filter_volume_max').value;
            if (volumeMin) filters.volume_min = parseInt(volumeMin);
            if (volumeMax) filters.volume_max = parseInt(volumeMax);
            
            const priceMin = document.getElementById('filter_price_min').value;
            const priceMax = document.getElementById('filter_price_max').value;
            if (priceMin) filters.price_min = parseFloat(priceMin);
            if (priceMax) filters.price_max = parseFloat(priceMax);
            
            const sector = document.getElementById('filter_sector').value.trim();
            if (sector) filters.sector = sector;
            
            const industry = document.getElementById('filter_industry').value.trim();
            if (industry) filters.industry = industry;
            
            // Show loading
            loadingDiv.classList.remove('hidden');
            resultsDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/screener', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filters)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to run screener');
                }
                
                screenerResults = data.results || [];
                screenerCurrentPage = data.page || 1;
                screenerTotalPages = data.total_pages || 0;
                screenerTotalCount = data.count || 0;
                displayScreenerResults(screenerResults);
                
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="9" style="padding: 20px; text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`;
                resultsDiv.style.display = 'block';
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        function displayScreenerResults(results) {
            const resultsDiv = document.getElementById('screenerResults');
            const countDiv = document.getElementById('screenerResultsCount');
            const tableBody = document.getElementById('screenerResultsTableBody');
            
            // Update count with pagination info
            if (countDiv) {
                countDiv.textContent = `Results: ${screenerTotalCount} stocks (Page ${screenerCurrentPage} of ${screenerTotalPages})`;
            }
            
            if (results.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="padding: 20px; text-align: center; color: var(--text-secondary);">No stocks found matching your criteria</td></tr>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '';
            for (const stock of results) {
                const marketCapFormatted = stock.market_cap ? formatNumber(stock.market_cap) : 'N/A';
                const priceFormatted = stock.price ? `$${stock.price.toFixed(2)}` : 'N/A';
                const peFormatted = stock.pe_ratio ? stock.pe_ratio.toFixed(2) : 'N/A';
                const revGrowthFormatted = stock.revenue_growth !== null && stock.revenue_growth !== undefined ? `${stock.revenue_growth >= 0 ? '+' : ''}${stock.revenue_growth.toFixed(2)}%` : 'N/A';
                const roeFormatted = stock.roe !== null && stock.roe !== undefined ? `${stock.roe.toFixed(2)}%` : 'N/A';
                const rsiFormatted = stock.rsi !== null && stock.rsi !== undefined ? stock.rsi.toFixed(2) : 'N/A';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='var(--table-row-hover)'" onmouseout="this.style.background=''">
                        <td style="padding: 12px; font-weight: 600; color: var(--text-primary);">
                            <a href="#" onclick="event.preventDefault(); document.getElementById('tickerInput').value='${stock.ticker}'; analyzeStock(); return false;" style="color: var(--primary-500); text-decoration: none;">
                                ${stock.ticker}
                            </a>
                        </td>
                        <td style="padding: 12px; color: var(--text-primary);">${stock.name}</td>
                        <td style="padding: 12px; text-align: right; color: var(--text-primary);">${priceFormatted}</td>
                        <td style="padding: 12px; text-align: right; color: var(--text-primary);">${marketCapFormatted}</td>
                        <td style="padding: 12px; text-align: right; color: var(--text-primary);">${peFormatted}</td>
                        <td style="padding: 12px; text-align: right; color: ${stock.revenue_growth >= 0 ? '#10b981' : '#ef4444'};">
                            ${revGrowthFormatted}
                        </td>
                        <td style="padding: 12px; text-align: right; color: var(--text-primary);">${roeFormatted}</td>
                        <td style="padding: 12px; text-align: right; color: ${stock.rsi ? (stock.rsi > 70 ? '#ef4444' : stock.rsi < 30 ? '#10b981' : 'var(--text-primary)') : 'var(--text-primary)'};">
                            ${rsiFormatted}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="document.getElementById('tickerInput').value='${stock.ticker}'; analyzeStock();" class="ripple-effect" style="padding: 6px 12px; background: var(--primary-500); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                Analyze
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function sortScreenerResults(column) {
            if (screenerSortColumn === column) {
                screenerSortDirection = screenerSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                screenerSortColumn = column;
                screenerSortDirection = 'asc';
            }
            
            screenerResults.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle null/undefined values
                if (aVal === null || aVal === undefined) aVal = -Infinity;
                if (bVal === null || bVal === undefined) bVal = -Infinity;
                
                if (screenerSortDirection === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            displayScreenerResults(screenerResults);
        }

        function clearScreenerFilters() {
            document.getElementById('filter_market_cap_min').value = '';
            document.getElementById('filter_market_cap_max').value = '';
            document.getElementById('filter_pe_min').value = '';
            document.getElementById('filter_pe_max').value = '';
            document.getElementById('filter_pb_min').value = '';
            document.getElementById('filter_pb_max').value = '';
            document.getElementById('filter_ps_min').value = '';
            document.getElementById('filter_ps_max').value = '';
            document.getElementById('filter_dividend_yield_min').value = '';
            document.getElementById('filter_dividend_yield_max').value = '';
            document.getElementById('filter_revenue_growth_min').value = '';
            document.getElementById('filter_revenue_growth_max').value = '';
            document.getElementById('filter_eps_growth_min').value = '';
            document.getElementById('filter_eps_growth_max').value = '';
            document.getElementById('filter_roe_min').value = '';
            document.getElementById('filter_roe_max').value = '';
            document.getElementById('filter_debt_equity_min').value = '';
            document.getElementById('filter_debt_equity_max').value = '';
            document.getElementById('filter_beta_min').value = '';
            document.getElementById('filter_beta_max').value = '';
            document.getElementById('filter_rsi_min').value = '';
            document.getElementById('filter_rsi_max').value = '';
            document.getElementById('filter_short_float_min').value = '';
            document.getElementById('filter_short_float_max').value = '';
            document.getElementById('filter_volume_min').value = '';
            document.getElementById('filter_volume_max').value = '';
            document.getElementById('filter_price_min').value = '';
            document.getElementById('filter_price_max').value = '';
            document.getElementById('filter_sector').value = '';
            document.getElementById('filter_industry').value = '';
        }

        function saveScreenerPreset() {
            const presetName = prompt('Enter a name for this preset:');
            if (!presetName || !presetName.trim()) return;
            
            const filters = {};
            const inputs = document.querySelectorAll('#screenerSection input[type="number"], #screenerSection input[type="text"]');
            inputs.forEach(input => {
                const id = input.id.replace('filter_', '');
                if (input.value.trim()) {
                    filters[id] = input.value.trim();
                }
            });
            
            const presets = JSON.parse(localStorage.getItem('screenerPresets') || '{}');
            presets[presetName] = filters;
            localStorage.setItem('screenerPresets', JSON.stringify(presets));
            
            updateScreenerPresetSelect();
            alert('Preset saved!');
        }

        function loadScreenerPreset() {
            const select = document.getElementById('screenerPresetSelect');
            const presetName = select.value;
            if (!presetName) return;
            
            const presets = JSON.parse(localStorage.getItem('screenerPresets') || '{}');
            const filters = presets[presetName];
            if (!filters) return;
            
            // Clear all filters first
            clearScreenerFilters();
            
            // Load preset values
            Object.keys(filters).forEach(key => {
                const input = document.getElementById(`filter_${key}`);
                if (input) {
                    input.value = filters[key];
                }
            });
            
            select.value = '';
        }

        function updateScreenerPresetSelect() {
            const select = document.getElementById('screenerPresetSelect');
            const presets = JSON.parse(localStorage.getItem('screenerPresets') || '{}');
            
            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            Object.keys(presets).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        function exportScreenerResults() {
            if (screenerResults.length === 0) {
                alert('No results to export');
                return;
            }
            
            // Create CSV header
            const headers = ['Ticker', 'Name', 'Sector', 'Industry', 'Price', 'Market Cap', 'P/E', 'P/B', 'P/S', 'Dividend Yield %', 'Revenue Growth %', 'EPS Growth %', 'ROE %', 'Debt/Equity', 'Beta', 'RSI', 'Short Float %', 'Volume'];
            const rows = [headers.join(',')];
            
            // Add data rows
            screenerResults.forEach(stock => {
                const row = [
                    stock.ticker,
                    `"${stock.name}"`,
                    `"${stock.sector || 'N/A'}"`,
                    `"${stock.industry || 'N/A'}"`,
                    stock.price || 'N/A',
                    stock.market_cap || 'N/A',
                    stock.pe_ratio || 'N/A',
                    stock.pb_ratio || 'N/A',
                    stock.ps_ratio || 'N/A',
                    stock.dividend_yield || 'N/A',
                    stock.revenue_growth || 'N/A',
                    stock.eps_growth || 'N/A',
                    stock.roe || 'N/A',
                    stock.debt_equity || 'N/A',
                    stock.beta || 'N/A',
                    stock.rsi || 'N/A',
                    stock.short_float_pct || 'N/A',
                    stock.volume || 'N/A'
                ];
                rows.push(row.join(','));
            });
            
            // Create and download file
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stock_screener_results_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Load presets on page load
        window.addEventListener('DOMContentLoaded', () => {
            updateScreenerPresetSelect();
            adjustTooltipPositions();
        });
        
        // Function to adjust tooltip positions to prevent overflow
        function adjustTooltipPositions() {
            const tooltips = document.querySelectorAll('.tooltip');
            
            tooltips.forEach(tooltip => {
                const tooltipText = tooltip.querySelector('.tooltiptext');
                if (!tooltipText) return;
                
                // Add event listener for mouseenter to adjust position
                tooltip.addEventListener('mouseenter', function() {
                    // Small delay to let tooltip render first
                    setTimeout(() => {
                        const rect = tooltip.getBoundingClientRect();
                        const tooltipRect = tooltipText.getBoundingClientRect();
                        const viewportWidth = window.innerWidth;
                        const viewportHeight = window.innerHeight;
                        
                        // Reset any previous positioning
                        tooltipText.style.left = '';
                        tooltipText.style.right = '';
                        tooltipText.style.top = '';
                        tooltipText.style.bottom = '';
                        tooltipText.style.transform = '';
                        
                        // Calculate expected tooltip position (centered by default)
                        const expectedLeft = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                        const expectedRight = expectedLeft + tooltipRect.width;
                        
                        // Check if tooltip would overflow right edge
                        if (expectedRight > viewportWidth - 10) {
                            tooltipText.style.left = 'auto';
                            tooltipText.style.right = '0';
                            tooltipText.style.transform = 'translateY(0)';
                        }
                        // Check if tooltip would overflow left edge
                        else if (expectedLeft < 10) {
                            tooltipText.style.left = '0';
                            tooltipText.style.right = 'auto';
                            tooltipText.style.transform = 'translateY(0)';
                        }
                        // Default: center horizontally
                        else {
                            tooltipText.style.left = '50%';
                            tooltipText.style.right = 'auto';
                            tooltipText.style.transform = 'translateX(-50%) translateY(0)';
                        }
                        
                        // Check if tooltip would overflow top edge (show below instead)
                        const expectedTop = rect.top - tooltipRect.height - 10;
                        if (expectedTop < 10) {
                            tooltipText.style.bottom = 'auto';
                            tooltipText.style.top = '125%';
                            // Adjust horizontal position for bottom tooltip
                            if (tooltipText.style.left === '50%') {
                                tooltipText.style.transform = 'translateX(-50%) translateY(0)';
                            } else {
                                tooltipText.style.transform = 'translateY(0)';
                            }
                        }
                        
                        // Ensure tooltip doesn't exceed viewport width
                        const maxWidth = Math.min(350, viewportWidth - 40);
                        tooltipText.style.maxWidth = maxWidth + 'px';
                    }, 10);
                });
            });
        }
        
        // Re-adjust tooltips when content is dynamically loaded
        const originalDisplayFinancials = window.displayFinancials;
        if (originalDisplayFinancials) {
            window.displayFinancials = function(...args) {
                const result = originalDisplayFinancials.apply(this, args);
                setTimeout(() => {
                    adjustTooltipPositions();
                }, 100);
                return result;
            };
        }

        // Export all critical functions to window scope for onclick handlers
        // This ensures all functions are accessible from HTML onclick attributes
        if (typeof loadAIRecommendations !== 'undefined') window.loadAIRecommendations = loadAIRecommendations;
        if (typeof loadFinancials !== 'undefined') window.loadFinancials = loadFinancials;
        if (typeof loadBacktest !== 'undefined') window.loadBacktest = loadBacktest;
        if (typeof loadAlertsDashboard !== 'undefined') window.loadAlertsDashboard = loadAlertsDashboard;
        if (typeof loadNewsForTicker !== 'undefined') window.loadNewsForTicker = loadNewsForTicker;
        if (typeof loadEarningsCalendar !== 'undefined') window.loadEarningsCalendar = loadEarningsCalendar;
        if (typeof loadEconomicCalendar !== 'undefined') window.loadEconomicCalendar = loadEconomicCalendar;
        if (typeof loadSocialSentiment !== 'undefined') window.loadSocialSentiment = loadSocialSentiment;
        if (typeof loadWatchlistSocialSentiment !== 'undefined') window.loadWatchlistSocialSentiment = loadWatchlistSocialSentiment;
        if (typeof loadPredictionHistory !== 'undefined') window.loadPredictionHistory = loadPredictionHistory;
        if (typeof loadScoreHistory !== 'undefined') window.loadScoreHistory = loadScoreHistory;
        if (typeof loadAnalystInsider !== 'undefined') window.loadAnalystInsider = loadAnalystInsider;
        if (typeof loadFactorAnalysis !== 'undefined') window.loadFactorAnalysis = loadFactorAnalysis;
        if (typeof loadInvestmentThesis !== 'undefined') window.loadInvestmentThesis = loadInvestmentThesis;
        if (typeof loadNewsPage !== 'undefined') window.loadNewsPage = loadNewsPage;
        if (typeof loadEarningsStock !== 'undefined') window.loadEarningsStock = loadEarningsStock;
        if (typeof loadAlertsStock !== 'undefined') window.loadAlertsStock = loadAlertsStock;
        if (typeof toggleFavorite !== 'undefined') window.toggleFavorite = toggleFavorite;
        if (typeof toggleIndicator !== 'undefined') window.toggleIndicator = toggleIndicator;
        if (typeof showNews !== 'undefined') window.showNews = showNews;
        if (typeof navigateToTicker !== 'undefined') window.navigateToTicker = navigateToTicker;
        if (typeof showAlertsHistory !== 'undefined') window.showAlertsHistory = showAlertsHistory;
        if (typeof toggleExplanation !== 'undefined') window.toggleExplanation = toggleExplanation;
        if (typeof toggleWatchlistGroup !== 'undefined') window.toggleWatchlistGroup = toggleWatchlistGroup;
        if (typeof showWatchlistGroupManager !== 'undefined') window.showWatchlistGroupManager = showWatchlistGroupManager;
        
        console.log('âœ… Functions exported to window scope');
    </script>
</body>
</html>

